
================================================================================
File Path: .\.github\ISSUE_TEMPLATE\default-issue-template.md
================================================================================

---
name: default issue template
about: OCEAN-KIT ì˜ ë””í´íŠ¸ ì´ìŠˆ í…œí”Œë¦¿ ì…ë‹ˆë‹¤.
title: 'íƒ€ì… : ê°„ëµí•œ ì œëª©'
labels: ''
assignees: ''

---

## â“ About
ì´ ì´ìŠˆê°€ ë¬´ìŠ¨ ì´ìŠˆì¸ì§€ì— ëŒ€í•œ ê°„ëµí•œ ì„¤ëª…ì„ ë‚¨ê²¨ì£¼ì„¸ìš”.

## â˜‘ï¸ ì‘ì—… ìƒì„¸

- [x] TODOëª©ë¡1
- [ ] TODOëª©ë¡2
- [ ] TODO..

## ğŸ“ ì°¸ê³  ìë£Œ (optional)
ê´€ë ¨ ë¬¸ì„œ, ìŠ¤í¬ë¦°ìƒ·, ë˜ëŠ” ì˜ˆì‹œ ë“±ì´ ìˆë‹¤ë©´ ì—¬ê¸°ì— ì²¨ë¶€í•´ì£¼ì„¸ìš”


================================================================================
File Path: .\ADMIN_README.md
================================================================================

# OceanCampus Admin API ë¬¸ì„œ

## ğŸ“‹ ëª©ì°¨

1. [ê°œìš”](#ê°œìš”)
2. [ì¸ì¦](#ì¸ì¦)
3. [Dashboard](#dashboard)
4. [Submission ê´€ë¦¬](#submission-ê´€ë¦¬)
5. [Export ê¸°ëŠ¥](#export-ê¸°ëŠ¥)
6. [ê³µí†µ ì‘ë‹µ í˜•ì‹](#ê³µí†µ-ì‘ë‹µ-í˜•ì‹)
7. [ì—ëŸ¬ ì½”ë“œ](#ì—ëŸ¬-ì½”ë“œ)

---

## ê°œìš”

OceanCampus Admin APIëŠ” í•´ì–‘ í™œë™ ì œì¶œ ë°ì´í„°ë¥¼ ê´€ë¦¬í•˜ëŠ” ê´€ë¦¬ì ì „ìš© APIì…ë‹ˆë‹¤.

- **Base URL**: `http://localhost:8080/api/admin`
- **ì¸ì¦**: JWT Bearer Token (ROLE_ADMIN ê¶Œí•œ í•„ìš”)
- **Content-Type**: `application/json`

---

## ì¸ì¦

ëª¨ë“  Admin APIëŠ” `ROLE_ADMIN` ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.

### Admin ê³„ì • ìƒì„±

ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘ ì‹œ `AdminUserInitializer`ê°€ ìë™ìœ¼ë¡œ Admin ê³„ì •ì„ ìƒì„±í•©ë‹ˆë‹¤ (prod í”„ë¡œí•„ ì œì™¸).

**ê¸°ë³¸ ê³„ì • ì •ë³´:**
- **Username**: `admin@admin.com`
- **Password**: `password`
- **Role**: `ADMIN`

### ë¡œê·¸ì¸

```http
POST /api/auth/login
Content-Type: application/json

{
  "username": "admin@admin.com",
  "password": "password"
}
```

**ì‘ë‹µ:**
```json
{
  "success": true,
  "data": {
    "access": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
  }
}
```

ëª¨ë“  Admin API ìš”ì²­ ì‹œ `Authorization: Bearer {access_token}` í—¤ë”ë¥¼ í¬í•¨í•´ì•¼ í•©ë‹ˆë‹¤.

---

## Dashboard

### ëŒ€ì‹œë³´ë“œ í†µê³„ ì¡°íšŒ

ì „ì²´ ì œì¶œ í˜„í™© í†µê³„ë¥¼ ì¡°íšŒí•©ë‹ˆë‹¤.

**ìš”ì²­:**
```http
GET /api/admin/dashboard/summary
Authorization: Bearer {access_token}
```

**ì‘ë‹µ:**
```json
{
  "success": true,
  "data": {
    "totalSubmissions": 120,
    "pending": 20,
    "approved": 80,
    "rejected": 10,
    "deleted": 10
  }
}
```

**ì‘ë‹µ ì½”ë“œ:**
- `200 OK`: ì„±ê³µ
- `401 Unauthorized`: ì¸ì¦ ì‹¤íŒ¨
- `403 Forbidden`: Admin ê¶Œí•œ ì—†ìŒ

---

## Submission ê´€ë¦¬

### 1. ì œì¶œ ë°ì´í„° ìƒì„±

Adminì´ ì§ì ‘ ì œì¶œ ë°ì´í„°ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.

**ìš”ì²­:**
```http
POST /api/admin/submissions
Authorization: Bearer {access_token}
Content-Type: application/json

{
  "siteName": "í¬í•­ í•´ì•ˆê°€",
  "activityType": "TRANSPLANT",
  "submittedAt": "2025-01-15T09:00:00",
  "authorName": "í™ê¸¸ë™",
  "authorEmail": "hong@example.com",
  "feedbackText": "ê¹¨ë—í•´ì§„ ë°”ë‹¤ê°€ ë¿Œë“¯í•©ë‹ˆë‹¤",
  "latitude": 36.0322,
  "longitude": 129.3650,
  "basicEnv": {
    "recordDate": "2025-01-15",
    "startTime": "09:00:00",
    "endTime": "12:30:00",
    "waterTempC": 18.5,
    "visibilityM": 15.0,
    "depthM": 10.5,
    "currentState": "MEDIUM",
    "weather": "SUNNY"
  },
  "participants": {
    "leaderName": "í™ê¸¸ë™",
    "participantCount": 5,
    "role": "CITIZEN_DIVER"
  },
  "activity": {
    "type": "TRANSPLANT",
    "details": "ì´ì‹ ì‘ì—…ì„ ìˆ˜í–‰í–ˆìŠµë‹ˆë‹¤. ì´ 50ê°œë¥¼ ì´ì‹í–ˆìŠµë‹ˆë‹¤.",
    "collectionAmount": 50.0,
    "durationHours": 3.5
  },
  "attachments": [
    {
      "fileName": "photo1.jpg",
      "fileUrl": "public/user_objects/2025-01-15/photo1.jpg",
      "mimeType": "image/jpeg",
      "fileSize": 512000
    }
  ]
}
```

**Request Body í•„ë“œ:**
- `siteName` (í•„ìˆ˜): í˜„ì¥ëª…
- `activityType` (í•„ìˆ˜): í™œë™ìœ í˜• (`TRANSPLANT`, `TRASH_COLLECTION`, `RESEARCH`, `MONITORING`, `OTHER`)
- `submittedAt` (ì„ íƒ): ì œì¶œì¼ì‹œ (ì—†ìœ¼ë©´ í˜„ì¬ ì‹œê°„ ì‚¬ìš©)
- `authorName` (í•„ìˆ˜): ì‘ì„±ìëª…
- `authorEmail` (ì„ íƒ): ì‘ì„±ì ì´ë©”ì¼
- `feedbackText` (ì„ íƒ): í™œë™ í›„ê¸°
- `latitude` (ì„ íƒ): ìœ„ë„
- `longitude` (ì„ íƒ): ê²½ë„
- `basicEnv` (ì„ íƒ): ê¸°ë³¸í™˜ê²½ ì •ë³´
- `participants` (ì„ íƒ): ì°¸ì—¬ì ì •ë³´
- `activity` (í•„ìˆ˜): í™œë™ ì •ë³´
- `attachments` (ì„ íƒ): ì²¨ë¶€íŒŒì¼ ëª©ë¡

**ì‘ë‹µ:**
```json
{
  "success": true,
  "data": {
    "submissionId": 6,
    "siteName": "í¬í•­ í•´ì•ˆê°€",
    "status": "PENDING",
    ...
  }
}
```

**ì‘ë‹µ ì½”ë“œ:**
- `200 OK`: ìƒì„± ì„±ê³µ
- `400 Bad Request`: í•„ìˆ˜ í•„ë“œ ëˆ„ë½ ë˜ëŠ” í˜•ì‹ ì˜¤ë¥˜
- `401 Unauthorized`: ì¸ì¦ ì‹¤íŒ¨
- `403 Forbidden`: Admin ê¶Œí•œ ì—†ìŒ

---

### 2. ì œì¶œ ëª©ë¡ ì¡°íšŒ

ì œì¶œ ëª©ë¡ì„ í˜ì´ì§€ë„¤ì´ì…˜ê³¼ í•¨ê»˜ ì¡°íšŒí•©ë‹ˆë‹¤. ê²€ìƒ‰, í•„í„°ë§, ì •ë ¬ì„ ì§€ì›í•©ë‹ˆë‹¤.

**ìš”ì²­:**
```http
GET /api/admin/submissions?keyword=í¬í•­&status=PENDING&page=0&size=20&sortBy=submittedAt&sortDir=DESC
Authorization: Bearer {access_token}
```

**Query Parameters:**
- `keyword` (optional): ê²€ìƒ‰ í‚¤ì›Œë“œ (í˜„ì¥ëª…, ì‘ì„±ì)
- `status` (optional): ìƒíƒœ í•„í„° (`PENDING`, `APPROVED`, `REJECTED`, `DELETED`)
- `activityType` (optional): í™œë™ ìœ í˜• (`TRANSPLANT`, `TRASH_COLLECTION`, `RESEARCH`, `MONITORING`, `OTHER`)
- `startDate` (optional): ì‹œì‘ ë‚ ì§œ (ISO 8601 í˜•ì‹: `2025-01-01T00:00:00`)
- `endDate` (optional): ì¢…ë£Œ ë‚ ì§œ (ISO 8601 í˜•ì‹: `2025-01-31T23:59:59`)
- `page` (default: 0): í˜ì´ì§€ ë²ˆí˜¸
- `size` (default: 20): í˜ì´ì§€ í¬ê¸°
- `sortBy` (default: `submittedAt`): ì •ë ¬ í•„ë“œ
- `sortDir` (default: `DESC`): ì •ë ¬ ë°©í–¥ (`ASC`, `DESC`)

**ì‘ë‹µ:**
```json
{
  "success": true,
  "data": {
    "content": [
      {
        "submissionId": 1,
        "siteName": "í¬í•­ í•´ì•ˆê°€",
        "activityType": "TRANSPLANT",
        "submittedAt": "2025-01-15T09:00:00",
        "status": "PENDING",
        "authorName": "í™ê¸¸ë™",
        "attachmentCount": 3,
        "feedbackText": "ê¹¨ë—í•´ì§„ ë°”ë‹¤ê°€ ë¿Œë“¯í•©ë‹ˆë‹¤"
      }
    ],
    "page": {
      "number": 0,
      "size": 20,
      "totalElements": 1,
      "totalPages": 1
    }
  }
}
```

---

### 3. ì œì¶œ ìƒì„¸ ì¡°íšŒ

íŠ¹ì • ì œì¶œ ë°ì´í„°ì˜ ìƒì„¸ ì •ë³´ë¥¼ ì¡°íšŒí•©ë‹ˆë‹¤.

**ìš”ì²­:**
```http
GET /api/admin/submissions/{submissionId}
Authorization: Bearer {access_token}
```

**ì‘ë‹µ:**
```json
{
  "success": true,
  "data": {
    "submissionId": 1,
    "siteName": "í¬í•­ í•´ì•ˆê°€",
    "activityType": "TRANSPLANT",
    "submittedAt": "2025-01-15T09:00:00",
    "status": "PENDING",
    "authorName": "í™ê¸¸ë™",
    "authorEmail": "hong@example.com",
    "attachmentCount": 3,
    "feedbackText": "ê¹¨ë—í•´ì§„ ë°”ë‹¤ê°€ ë¿Œë“¯í•©ë‹ˆë‹¤",
    "latitude": 36.0322,
    "longitude": 129.3650,
    "basicEnv": {
      "recordDate": "2025-01-15",
      "startTime": "09:00:00",
      "endTime": "12:30:00",
      "waterTempC": 18.5,
      "visibilityM": 15.0,
      "depthM": 10.5,
      "currentState": "MEDIUM",
      "weather": "SUNNY"
    },
    "participants": {
      "leaderName": "í™ê¸¸ë™",
      "participantCount": 5,
      "role": "CITIZEN_DIVER"
    },
    "activity": {
      "type": "TRANSPLANT",
      "details": "ì´ì‹ ì‘ì—…ì„ ìˆ˜í–‰í–ˆìŠµë‹ˆë‹¤. ì´ 50ê°œë¥¼ ì´ì‹í–ˆìŠµë‹ˆë‹¤.",
      "collectionAmount": 50.0,
      "durationHours": 3.5
    },
    "attachments": [
      {
        "attachmentId": 1,
        "fileName": "photo1.jpg",
        "fileUrl": "public/user_objects/2025-01-15/photo1.jpg",
        "mimeType": "image/jpeg",
        "fileSize": 512000,
        "uploadedAt": "2025-01-15T09:00:00"
      }
    ],
    "rejectReason": null,
    "auditLogs": [
      {
        "logId": 1,
        "action": "SUBMITTED",
        "performedBy": "system",
        "comment": null,
        "createdAt": "2025-01-15T09:00:00"
      }
    ],
    "createdAt": "2025-01-15T09:00:00",
    "modifiedAt": "2025-01-15T09:00:00"
  }
}
```

**ì‘ë‹µ ì½”ë“œ:**
- `200 OK`: ì„±ê³µ
- `404 Not Found`: ì œì¶œ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ

---

### 4. ê²€ìˆ˜ ë¡œê·¸ ì¡°íšŒ

íŠ¹ì • ì œì¶œ ë°ì´í„°ì˜ ê²€ìˆ˜ ì´ë ¥ì„ ì¡°íšŒí•©ë‹ˆë‹¤.

**ìš”ì²­:**
```http
GET /api/admin/submissions/{submissionId}/logs
Authorization: Bearer {access_token}
```

**ì‘ë‹µ:**
```json
{
  "success": true,
  "data": [
    {
      "logId": 1,
      "action": "SUBMITTED",
      "performedBy": "system",
      "comment": null,
      "createdAt": "2025-01-15T09:00:00"
    },
    {
      "logId": 2,
      "action": "APPROVED",
      "performedBy": "admin@oceancampus.kr",
      "comment": null,
      "createdAt": "2025-01-16T10:00:00"
    }
  ]
}
```

---

### 5. ë‹¨ê±´ ìŠ¹ì¸

íŠ¹ì • ì œì¶œ ë°ì´í„°ë¥¼ ìŠ¹ì¸í•©ë‹ˆë‹¤.

**ìš”ì²­:**
```http
POST /api/admin/submissions/{submissionId}/approve
Authorization: Bearer {access_token}
```

**ì‘ë‹µ:**
```json
{
  "success": true,
  "data": {
    "submissionId": 1,
    "status": "APPROVED",
    ...
  }
}
```

**ì‘ë‹µ ì½”ë“œ:**
- `200 OK`: ì„±ê³µ
- `404 Not Found`: ì œì¶œ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ
- `409 Conflict`: ì´ë¯¸ ìŠ¹ì¸/ë°˜ë ¤/ì‚­ì œëœ ì œì¶œ

---

### 6. ë‹¨ê±´ ë°˜ë ¤

íŠ¹ì • ì œì¶œ ë°ì´í„°ë¥¼ ë°˜ë ¤í•©ë‹ˆë‹¤.

**ìš”ì²­:**
```http
POST /api/admin/submissions/{submissionId}/reject
Authorization: Bearer {access_token}
Content-Type: application/json

{
  "reason": {
    "templateCode": "PHOTO_INSUFFICIENT",
    "message": "ì‚¬ì§„ì´ ë¶€ì¡±í•©ë‹ˆë‹¤. ìµœì†Œ 3ì¥ ì´ìƒì˜ ì‚¬ì§„ì„ ì²¨ë¶€í•´ì£¼ì„¸ìš”."
  }
}
```

**Request Body:**
```json
{
  "reason": {
    "templateCode": "PHOTO_INSUFFICIENT",  // ì„ íƒì‚¬í•­
    "message": "ì‚¬ì§„ì´ ë¶€ì¡±í•©ë‹ˆë‹¤. ìµœì†Œ 3ì¥ ì´ìƒì˜ ì‚¬ì§„ì„ ì²¨ë¶€í•´ì£¼ì„¸ìš”."  // í•„ìˆ˜
  }
}
```

**ì‘ë‹µ:**
```json
{
  "success": true,
  "data": {
    "submissionId": 1,
    "status": "REJECTED",
    "rejectReason": "ì‚¬ì§„ì´ ë¶€ì¡±í•©ë‹ˆë‹¤. ìµœì†Œ 3ì¥ ì´ìƒì˜ ì‚¬ì§„ì„ ì²¨ë¶€í•´ì£¼ì„¸ìš”.",
    ...
  }
}
```

**ì‘ë‹µ ì½”ë“œ:**
- `200 OK`: ì„±ê³µ
- `404 Not Found`: ì œì¶œ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ
- `409 Conflict`: ì´ë¯¸ ìŠ¹ì¸/ë°˜ë ¤/ì‚­ì œëœ ì œì¶œ
- `422 Unprocessable Entity`: ë°˜ë ¤ ì‚¬ìœ ê°€ ê³µë€

---

### 7. ë‹¨ê±´ ì‚­ì œ

íŠ¹ì • ì œì¶œ ë°ì´í„°ë¥¼ ì˜êµ¬ ì‚­ì œí•©ë‹ˆë‹¤.

**ìš”ì²­:**
```http
DELETE /api/admin/submissions/{submissionId}
Authorization: Bearer {access_token}
Content-Type: application/json

{
  "reason": "ì¤‘ë³µ í…ŒìŠ¤íŠ¸ ë°ì´í„°"  // ì„ íƒì‚¬í•­
}
```

**ì‘ë‹µ:**
- `204 No Content`: ì‚­ì œ ì„±ê³µ

**ì‘ë‹µ ì½”ë“œ:**
- `204 No Content`: ì‚­ì œ ì„±ê³µ
- `404 Not Found`: ì œì¶œ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ

---

### 8. ì¼ê´„ ìŠ¹ì¸

ì—¬ëŸ¬ ì œì¶œ ë°ì´í„°ë¥¼ í•œ ë²ˆì— ìŠ¹ì¸í•©ë‹ˆë‹¤.

**ìš”ì²­:**
```http
POST /api/admin/submissions/bulk/approve
Authorization: Bearer {access_token}
Content-Type: application/json

{
  "ids": [1, 2, 3]
}
```

**ì‘ë‹µ:**
```json
{
  "success": true,
  "data": {
    "approved": [1, 2],
    "skipped": [3]
  }
}
```

---

### 9. ì¼ê´„ ë°˜ë ¤

ì—¬ëŸ¬ ì œì¶œ ë°ì´í„°ë¥¼ í•œ ë²ˆì— ë°˜ë ¤í•©ë‹ˆë‹¤.

**ìš”ì²­:**
```http
POST /api/admin/submissions/bulk/reject
Authorization: Bearer {access_token}
Content-Type: application/json

{
  "ids": [1, 2],
  "reason": {
    "templateCode": "PHOTO_INSUFFICIENT",
    "message": "ì‚¬ì§„ì´ ë¶€ì¡±í•©ë‹ˆë‹¤."
  }
}
```

**ì‘ë‹µ:**
```json
{
  "success": true,
  "data": {
    "rejected": [1, 2],
    "conflicts": []
  }
}
```

---

### 10. ì¼ê´„ ì‚­ì œ

ì—¬ëŸ¬ ì œì¶œ ë°ì´í„°ë¥¼ í•œ ë²ˆì— ì˜êµ¬ ì‚­ì œí•©ë‹ˆë‹¤.

**ìš”ì²­:**
```http
DELETE /api/admin/submissions/bulk
Authorization: Bearer {access_token}
Content-Type: application/json

{
  "ids": [1, 2, 3],
  "reason": "í…ŒìŠ¤íŠ¸ ë°ì´í„°"  // ì„ íƒì‚¬í•­
}
```

**ì‘ë‹µ:**
```json
{
  "success": true,
  "data": {
    "deleted": [1, 2],
    "failed": [3]
  }
}
```

---

## Export ê¸°ëŠ¥

### 1. ë°ì´í„° ë‚´ë³´ë‚´ê¸° (CSV ë‹¤ìš´ë¡œë“œ)

ìŠ¹ì¸ëœ ì œì¶œ ë°ì´í„°ë¥¼ CSV íŒŒì¼ë¡œ ë‚´ë³´ëƒ…ë‹ˆë‹¤.

**ìš”ì²­:**
```http
POST /api/admin/exports/download
Authorization: Bearer {access_token}
Content-Type: application/json

{
  "format": "CSV",
  "filters": {
    "dateFrom": "2025-01-01",
    "dateTo": "2025-01-31"
  }
}
```

**Request Body:**
```json
{
  "format": "CSV",  // í•„ìˆ˜: "CSV" ë˜ëŠ” "XLSX" (í˜„ì¬ëŠ” CSVë§Œ ì§€ì›)
  "filters": {  // ì„ íƒì‚¬í•­
    "dateFrom": "2025-01-01",  // ì‹œì‘ ë‚ ì§œ (YYYY-MM-DD)
    "dateTo": "2025-01-31"     // ì¢…ë£Œ ë‚ ì§œ (YYYY-MM-DD)
  }
}
```

**ì‘ë‹µ:**
- Content-Type: `text/csv; charset=UTF-8`
- Content-Disposition: `attachment; filename="submissions_export_20250105_143022.csv"`
- íŒŒì¼ì´ ë°”ë¡œ ë‹¤ìš´ë¡œë“œë©ë‹ˆë‹¤.

**CSV ì»¬ëŸ¼:**
- ì œì¶œID, í˜„ì¥ëª…, í™œë™ìœ í˜•, ì œì¶œì¼, ì‘ì„±ì, ì´ë©”ì¼, ìœ„ë„, ê²½ë„
- ìˆ˜ì‹¬(m), ìˆ˜ì˜¨(Â°C), ì‹œì•¼(m), ë‚ ì”¨, ì¡°ë¥˜ìƒíƒœ
- ì°¸ì—¬ì¸ì›, ëŒ€í‘œìëª…, ì—­í• 
- ì„¸ë¶€ë‚´ìš©, ìˆ˜ê±°ëŸ‰, í™œë™í›„ê¸°, ì²¨ë¶€íŒŒì¼ìˆ˜

**ì‘ë‹µ ì½”ë“œ:**
- `200 OK`: íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì„±ê³µ
- `400 Bad Request`: ìš”ì²­ í˜•ì‹ ì˜¤ë¥˜ (format ëˆ„ë½ ë“±)
- `401 Unauthorized`: ì¸ì¦ ì‹¤íŒ¨
- `403 Forbidden`: Admin ê¶Œí•œ ì—†ìŒ

---

### 2. ë‚´ë³´ë‚´ê¸° ì´ë ¥ ì¡°íšŒ

ë‚´ë³´ë‚´ê¸° ì‘ì—… ì´ë ¥ì„ ì¡°íšŒí•©ë‹ˆë‹¤.

**ìš”ì²­:**
```http
GET /api/admin/exports
Authorization: Bearer {access_token}
```

**ì‘ë‹µ:**
```json
{
  "success": true,
  "data": [
    {
      "jobId": 1,
      "requestedBy": "admin@admin.com",
      "format": "CSV",
      "status": "READY",
      "downloadUrl": null,
      "createdAt": "2025-01-05T14:30:22",
      "completedAt": "2025-01-05T14:30:23",
      "filtersJson": "{\"dateFrom\":\"2025-01-01\",\"dateTo\":\"2025-01-31\"}"
    }
  ]
}
```

---

## ê³µí†µ ì‘ë‹µ í˜•ì‹

### ì„±ê³µ ì‘ë‹µ

```json
{
  "success": true,
  "data": { ... }
}
```

### ì—ëŸ¬ ì‘ë‹µ

```json
{
  "success": false,
  "errors": {
    "message": "ì—ëŸ¬ ë©”ì‹œì§€",
    "code": "ERROR_CODE"
  },
  "code": "ERROR_CODE",
  "message": "ì—ëŸ¬ ë©”ì‹œì§€"
}
```

---

## ì—ëŸ¬ ì½”ë“œ

### Admin ê´€ë ¨ ì—ëŸ¬ ì½”ë“œ

| ì½”ë“œ | HTTP Status | ì„¤ëª… |
|------|-------------|------|
| `AD001` | 404 Not Found | ì œì¶œ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤ |
| `AD002` | 409 Conflict | ì´ë¯¸ ìŠ¹ì¸ëœ ì œì¶œì…ë‹ˆë‹¤ |
| `AD003` | 409 Conflict | ì´ë¯¸ ë°˜ë ¤ëœ ì œì¶œì…ë‹ˆë‹¤ |
| `AD004` | 409 Conflict | ì´ë¯¸ ì‚­ì œëœ ì œì¶œì…ë‹ˆë‹¤ |
| `AD005` | 422 Unprocessable Entity | ë°˜ë ¤ ì‚¬ìœ ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš” |
| `AD006` | 404 Not Found | ë‚´ë³´ë‚´ê¸° ì‘ì—…ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤ |
| `AD007` | 422 Unprocessable Entity | ë‚´ë³´ë‚´ê¸° íŒŒì¼ì´ ì•„ì§ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤ |
| `AD008` | 500 Internal Server Error | ë‚´ë³´ë‚´ê¸° ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤ |

---

## Enum ê°’

### SubmissionStatus
- `PENDING`: ê²€ìˆ˜ ëŒ€ê¸°
- `APPROVED`: ìŠ¹ì¸ë¨
- `REJECTED`: ë°˜ë ¤ë¨
- `DELETED`: ì‚­ì œë¨

### ActivityType
- `TRANSPLANT`: ì´ì‹
- `TRASH_COLLECTION`: íê¸°ë¬¼ìˆ˜ê±°
- `RESEARCH`: ì—°êµ¬
- `MONITORING`: ëª¨ë‹ˆí„°ë§
- `OTHER`: ê¸°íƒ€

### CurrentState
- `LOW`: ì•½í•œ ì¡°ë¥˜
- `MEDIUM`: ë³´í†µ ì¡°ë¥˜
- `HIGH`: ê°•í•œ ì¡°ë¥˜

### Weather
- `SUNNY`: ë§‘ìŒ
- `CLOUDY`: íë¦¼
- `RAINY`: ë¹„
- `WINDY`: ë°”ëŒ
- `OTHER`: ê¸°íƒ€

### ParticipantRole
- `CITIZEN_DIVER`: ì‹œë¯¼ ë‹¤ì´ë²„
- `RESEARCHER`: ì—°êµ¬ì
- `LOCAL_MANAGER`: ì§€ì—­ ê´€ë¦¬ì
- `OTHER`: ê¸°íƒ€

### AuditAction
- `SUBMITTED`: ì œì¶œë¨
- `APPROVED`: ìŠ¹ì¸ë¨
- `REJECTED`: ë°˜ë ¤ë¨
- `DELETED`: ì‚­ì œë¨
- `COMMENT`: ì½”ë©˜íŠ¸

### ExportFormat
- `CSV`: CSV í˜•ì‹
- `XLSX`: Excel í˜•ì‹ (í–¥í›„ ì§€ì› ì˜ˆì •)

### ExportStatus
- `PROCESSING`: ì²˜ë¦¬ ì¤‘
- `READY`: ì¤€ë¹„ ì™„ë£Œ
- `FAILED`: ì‹¤íŒ¨

---

## ìë™ ì´ˆê¸°í™”

### AdminUserInitializer

ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘ ì‹œ (`!prod` í”„ë¡œí•„) Admin ê³„ì •ì„ ìë™ìœ¼ë¡œ ìƒì„±í•©ë‹ˆë‹¤.

- **ìœ„ì¹˜**: `com.ocean.piuda.admin.initializer.AdminUserInitializer`
- **ê³„ì •**: `admin@admin.com` / `password`
- **ì‹¤í–‰ ìˆœì„œ**: `@Order(0)`

### SubmissionDataInitializer

ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘ ì‹œ (`!prod` í”„ë¡œí•„) í…ŒìŠ¤íŠ¸ìš© Submission ë°ì´í„°ë¥¼ ìë™ ìƒì„±í•©ë‹ˆë‹¤.

- **ìœ„ì¹˜**: `com.ocean.piuda.admin.submission.initializer.SubmissionDataInitializer`
- **ë°ì´í„°**: ìŠ¹ì¸/ëŒ€ê¸°/ë°˜ë ¤ ìƒíƒœì˜ ìƒ˜í”Œ ë°ì´í„° 5ê±´
- **ì‹¤í–‰ ìˆœì„œ**: `@Order(1)`

---

## í…ŒìŠ¤íŠ¸ ê°€ì´ë“œ

ìì„¸í•œ í…ŒìŠ¤íŠ¸ ê°€ì´ë“œëŠ” `EXPORT_TEST_GUIDE.md`ë¥¼ ì°¸ì¡°í•˜ì„¸ìš”.

### ë¹ ë¥¸ í…ŒìŠ¤íŠ¸ ì²´í¬ë¦¬ìŠ¤íŠ¸

1. ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰
2. Admin ë¡œê·¸ì¸í•˜ì—¬ Access Token íšë“
3. Dashboard í†µê³„ ì¡°íšŒ
4. Submission ëª©ë¡ ì¡°íšŒ
5. Submission ìƒì„¸ ì¡°íšŒ
6. Submission ìŠ¹ì¸/ë°˜ë ¤/ì‚­ì œ í…ŒìŠ¤íŠ¸
7. Export CSV ë‹¤ìš´ë¡œë“œ í…ŒìŠ¤íŠ¸

---

## ì°¸ê³ ì‚¬í•­

- ëª¨ë“  ë‚ ì§œ/ì‹œê°„ì€ ISO 8601 í˜•ì‹ì„ ì‚¬ìš©í•©ë‹ˆë‹¤ (ì˜ˆ: `2025-01-15T09:00:00`)
- ì´ë¯¸ì§€ íŒŒì¼ URLì€ í˜„ì¬ DBì— ì €ì¥ëœ S3 Keyë¥¼ ê·¸ëŒ€ë¡œ ë°˜í™˜í•©ë‹ˆë‹¤
- ExportëŠ” ìŠ¹ì¸ëœ ë°ì´í„°ë§Œ ë‚´ë³´ëƒ…ë‹ˆë‹¤
- ì¼ê´„ ì²˜ë¦¬ ì‹œ ì¼ë¶€ ì‹¤íŒ¨í•´ë„ ë‚˜ë¨¸ì§€ëŠ” ì²˜ë¦¬ë©ë‹ˆë‹¤ (ì‘ë‹µì˜ `skipped`, `conflicts`, `failed` í•„ë“œ í™•ì¸)



================================================================================
File Path: .\build.gradle
================================================================================

plugins {
	id 'java'
	id 'org.springframework.boot' version '3.5.6'
	id 'io.spring.dependency-management' version '1.1.7'
}

group = 'com.ocean'
version = '0.0.1-SNAPSHOT'
description = 'piuda2025'

java {
	toolchain {
		languageVersion = JavaLanguageVersion.of(21)
	}
}

repositories {
	mavenCentral()
}

dependencies {
	implementation 'org.springframework.boot:spring-boot-starter-web'
	implementation 'org.springframework.boot:spring-boot-starter-validation'
//	implementation 'org.springframework:spring-aspects'
//	implementation 'org.springframework.retry:spring-retry'
	implementation 'io.portone:server-sdk:0.19.2'
	implementation 'org.springframework.boot:spring-boot-starter-webflux'

	implementation 'org.springframework.boot:spring-boot-starter-data-jpa'
//	runtimeOnly 'com.mysql:mysql-connector-j'
	runtimeOnly 'org.postgresql:postgresql'
	runtimeOnly 'com.h2database:h2'


	compileOnly 'org.projectlombok:lombok'
	annotationProcessor 'org.projectlombok:lombok'

	// security
	implementation 'org.springframework.boot:spring-boot-starter-security'
	implementation 'io.jsonwebtoken:jjwt-api:0.12.6'
	implementation 'io.jsonwebtoken:jjwt-impl:0.12.6'
	implementation 'io.jsonwebtoken:jjwt-jackson:0.12.6'
	implementation 'org.springframework.boot:spring-boot-starter-oauth2-client'

	// cashBill (barobill)
	implementation 'org.springframework.boot:spring-boot-starter-webflux'
	implementation 'org.springframework.boot:spring-boot-starter'
	implementation 'org.apache.commons:commons-text:1.10.0'
	implementation 'org.jsoup:jsoup:1.17.2'

	// AWS SDK
	implementation platform("software.amazon.awssdk:bom:2.29.43")
	implementation "software.amazon.awssdk:s3"

	testImplementation 'org.springframework.boot:spring-boot-starter-test'
	testRuntimeOnly 'org.junit.platform:junit-platform-launcher'

	// swagger
	implementation 'org.springdoc:springdoc-openapi-starter-webmvc-ui:2.7.0'

	//open ai
	implementation group: 'com.squareup.okhttp3', name: 'okhttp', version: '5.0.0-alpha.14'
	implementation group: 'com.fasterxml.jackson.core', name: 'jackson-databind', version: '2.17.2' // for Deserializatio

	// Google GenAI SDK
	implementation 'com.google.genai:google-genai:1.17.0'
	constraints {
		implementation('com.google.protobuf:protobuf-java:3.25.5') {
			because 'Fixes CVE-2024-7254' // google-genai:1.17.0 Vulnerabilities ë°˜ì˜
		}

	}

	// fcm
	implementation 'com.google.firebase:firebase-admin:9.7.0'

}


tasks.named('test') {
	useJUnitPlatform()
}


================================================================================
File Path: .\EXPORT_TEST_GUIDE.md
================================================================================

# Export ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸ ê°€ì´ë“œ

## ì‚¬ì „ ì¤€ë¹„

### 1. ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰
```bash
./gradlew bootRun
# ë˜ëŠ”
./gradlew clean build && java -jar build/libs/*.jar
```

### 2. Admin ê³„ì • í™•ì¸
ê¸°ë³¸ Admin ê³„ì •ì´ **ìë™ìœ¼ë¡œ ìƒì„±**ë©ë‹ˆë‹¤:
- **Username**: `admin@admin.com`
- **Password**: `password`

> `AdminUserInitializer`ê°€ ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘ ì‹œ ìë™ìœ¼ë¡œ ìƒì„±í•©ë‹ˆë‹¤ (prod í”„ë¡œí•„ ì œì™¸)
> 
> ë§Œì•½ ê³„ì •ì´ ì—†ë‹¤ë©´ ì• í”Œë¦¬ì¼€ì´ì…˜ ë¡œê·¸ì—ì„œ "Admin ê³„ì • ìƒì„± ì™„ë£Œ" ë©”ì‹œì§€ë¥¼ í™•ì¸í•˜ì„¸ìš”.

---

## í…ŒìŠ¤íŠ¸ ë‹¨ê³„

### Step 1: Admin ë¡œê·¸ì¸í•˜ì—¬ Access Token íšë“

**ìš”ì²­:**
```http
POST http://localhost:8080/api/auth/login
Content-Type: application/json

{
  "username": "admin@admin.com",
  "password": "password"
}
```

**ì‘ë‹µ ì˜ˆì‹œ:**
```json
{
  "success": true,
  "data": {
    "access": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
  }
}
```

**Access Token ì €ì¥:**
- ì‘ë‹µì˜ `data.access` ê°’ì„ ë³µì‚¬í•˜ì—¬ ë³€ìˆ˜ `ACCESS_TOKEN`ì— ì €ì¥

---

### Step 2: ìŠ¹ì¸ëœ Submission ë°ì´í„° í™•ì¸ (ì„ íƒì‚¬í•­)

**ìš”ì²­:**
```http
GET http://localhost:8080/api/admin/submissions?status=APPROVED
Authorization: Bearer {ACCESS_TOKEN}
```

> **ì£¼ì˜**: ExportëŠ” `APPROVED` ìƒíƒœì˜ ë°ì´í„°ë§Œ ë‚´ë³´ëƒ…ë‹ˆë‹¤.
> ìŠ¹ì¸ëœ ë°ì´í„°ê°€ ì—†ë‹¤ë©´ ë¨¼ì € ì œì¶œ ë°ì´í„°ë¥¼ ìŠ¹ì¸í•´ì£¼ì„¸ìš”.
> 
> í…ŒìŠ¤íŠ¸ ë°ì´í„°ëŠ” `SubmissionDataInitializer`ê°€ ìë™ ìƒì„±í•©ë‹ˆë‹¤ (prod í”„ë¡œí•„ ì œì™¸).

---

### Step 3: Export íŒŒì¼ ë‹¤ìš´ë¡œë“œ

#### 3-1. ì „ì²´ ìŠ¹ì¸ ë°ì´í„° ë‚´ë³´ë‚´ê¸°

**ìš”ì²­:**
```http
POST http://localhost:8080/api/admin/exports/download
Authorization: Bearer {ACCESS_TOKEN}
Content-Type: application/json

{
  "format": "CSV"
}
```

**ë˜ëŠ” ë‚ ì§œ í•„í„° í¬í•¨:**
```http
POST http://localhost:8080/api/admin/exports/download
Authorization: Bearer {ACCESS_TOKEN}
Content-Type: application/json

{
  "format": "CSV",
  "filters": {
    "dateFrom": "2025-01-01",
    "dateTo": "2025-01-31"
  }
}
```

**ì‘ë‹µ:**
- Content-Type: `application/octet-stream`
- Content-Disposition: `attachment; filename="submissions_export_20250105_143022.csv"`
- íŒŒì¼ì´ ë°”ë¡œ ë‹¤ìš´ë¡œë“œë©ë‹ˆë‹¤.

**CSV íŒŒì¼ ë‚´ìš© ì˜ˆì‹œ:**
```csv
ì œì¶œID,í˜„ì¥ëª…,í™œë™ìœ í˜•,ì œì¶œì¼,ì‘ì„±ì,ì´ë©”ì¼,ìœ„ë„,ê²½ë„,ìˆ˜ì‹¬(m),ìˆ˜ì˜¨(Â°C),ì‹œì•¼(m),ë‚ ì”¨,ì¡°ë¥˜ìƒíƒœ,ì°¸ì—¬ì¸ì›,ëŒ€í‘œìëª…,ì—­í• ,ì„¸ë¶€ë‚´ìš©,ìˆ˜ê±°ëŸ‰,í™œë™í›„ê¸°,ì²¨ë¶€íŒŒì¼ìˆ˜
2,ë¶€ì‚° ì†¡ë„í•´ìˆ˜ìš•ì¥,TRASH_COLLECTION,2025-01-10T10:00:00,ê¹€ì² ìˆ˜,kim@example.com,35.0784,129.0756,20.0,20.0,5.0,SUNNY,LOW,3,ê¹€ì² ìˆ˜,CITIZEN_DIVER,í”Œë¼ìŠ¤í‹± ë³‘ 30ê°œ ìº” 15ê°œë¥¼ ìˆ˜ê±°í–ˆìŠµë‹ˆë‹¤.,45.0,í•´ë³€ ì²­ì†Œ í™œë™ì— ì°¸ì—¬í–ˆìŠµë‹ˆë‹¤,2
5,ì „ë¼ë‚¨ë„ ì—¬ìˆ˜ í•´ìˆ˜ìš•ì¥,TRASH_COLLECTION,2025-01-07T09:30:00,ìµœì§€ì˜,choi@example.com,34.7604,127.6622,18.0,19.0,7.0,SUNNY,MEDIUM,6,ìµœì§€ì˜,CITIZEN_DIVER,ì“°ë ˆê¸° 100ê°œ ìˆ˜ê±° ì™„ë£Œ,100.0,ì—¬ìˆ˜ ë°”ë‹¤ê°€ ì•„ë¦„ë‹µìŠµë‹ˆë‹¤,5
```

---

### Step 4: Export ì´ë ¥ ì¡°íšŒ

**ìš”ì²­:**
```http
GET http://localhost:8080/api/admin/exports
Authorization: Bearer {ACCESS_TOKEN}
```

**ì‘ë‹µ ì˜ˆì‹œ:**
```json
{
  "success": true,
  "data": [
    {
      "jobId": 1,
      "requestedBy": "admin@admin.com",
      "format": "CSV",
      "status": "READY",
      "downloadUrl": null,
      "createdAt": "2025-01-05T14:30:22",
      "completedAt": "2025-01-05T14:30:23",
      "filtersJson": "{}"
    }
  ]
}
```

---

## Postman Collection ì„¤ì •

### 1. Environment Variables ì„¤ì •
```
ACCESS_TOKEN = (ë¡œê·¸ì¸ í›„ ìë™ ì„¤ì •)
BASE_URL = http://localhost:8080
```

### 2. Pre-request Script (ë¡œê·¸ì¸ ìš”ì²­ì—)
```javascript
// ë¡œê·¸ì¸ í›„ í† í° ìë™ ì €ì¥
pm.test("Save access token", function () {
    var jsonData = pm.response.json();
    if (jsonData.success && jsonData.data.access) {
        pm.environment.set("ACCESS_TOKEN", jsonData.data.access);
    }
});
```

### 3. Collection ìˆœì„œ
1. **Login** - POST `/api/auth/login`
2. **Get Approved Submissions** - GET `/api/admin/submissions?status=APPROVED` (ì„ íƒ)
3. **Export Download (All)** - POST `/api/admin/exports/download`
4. **Export Download (Filtered)** - POST `/api/admin/exports/download` (í•„í„° í¬í•¨)
5. **Export History** - GET `/api/admin/exports`

---

## curl ëª…ë ¹ì–´ë¡œ í…ŒìŠ¤íŠ¸

### 1. ë¡œê·¸ì¸
```bash
curl -X POST http://localhost:8080/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "username": "admin@admin.com",
    "password": "password"
  }'
```

### 2. Export ë‹¤ìš´ë¡œë“œ (í† í° ì €ì¥)
```bash
# 1. ë¡œê·¸ì¸ í›„ í† í° ì €ì¥
TOKEN=$(curl -s -X POST http://localhost:8080/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin@admin.com","password":"password"}' \
  | jq -r '.data.access')

# 2. Export ë‹¤ìš´ë¡œë“œ
curl -X POST http://localhost:8080/api/admin/exports/download \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"format":"CSV"}' \
  --output submissions_export.csv

# 3. íŒŒì¼ í™•ì¸
head -5 submissions_export.csv
```

---

## í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤

### âœ… ì„±ê³µ ì¼€ì´ìŠ¤
1. **ì „ì²´ ë°ì´í„° ë‚´ë³´ë‚´ê¸°**
   - í•„í„° ì—†ì´ ìš”ì²­
   - ëª¨ë“  ìŠ¹ì¸ëœ ë°ì´í„°ê°€ CSVë¡œ ë‹¤ìš´ë¡œë“œ

2. **ë‚ ì§œ í•„í„° ì ìš©**
   - `dateFrom`, `dateTo` ì„¤ì •
   - í•´ë‹¹ ê¸°ê°„ì˜ ìŠ¹ì¸ëœ ë°ì´í„°ë§Œ ë‚´ë³´ëƒ„

3. **ì´ë ¥ í™•ì¸**
   - ë‹¤ìš´ë¡œë“œ í›„ ì´ë ¥ ì¡°íšŒ
   - `status: READY`, `completedAt` í™•ì¸

### âš ï¸ ì£¼ì˜ì‚¬í•­
1. **ìŠ¹ì¸ëœ ë°ì´í„°ê°€ ì—†ëŠ” ê²½ìš°**
   - CSVëŠ” í—¤ë”ë§Œ í¬í•¨ëœ ë¹ˆ íŒŒì¼ ë‹¤ìš´ë¡œë“œ

2. **ê¶Œí•œ í™•ì¸**
   - `ROLE_ADMIN` ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤
   - ì¼ë°˜ ì‚¬ìš©ìëŠ” 403 Forbidden

3. **ëŒ€ìš©ëŸ‰ ë°ì´í„°**
   - ë©”ëª¨ë¦¬ì— ëª¨ë“  ë°ì´í„°ë¥¼ ë¡œë“œí•˜ë¯€ë¡œ ë§¤ìš° í° ë°ì´í„°ì…‹ì€ ì„±ëŠ¥ ì´ìŠˆê°€ ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤

---

## ë¬¸ì œ í•´ê²°

### 401 Unauthorized
- Access Tokenì´ ì—†ê±°ë‚˜ ë§Œë£Œë¨
- ë‹¤ì‹œ ë¡œê·¸ì¸í•˜ì—¬ í† í° ì¬ë°œê¸‰

### 403 Forbidden
- Admin ê¶Œí•œì´ ì—†ëŠ” ì‚¬ìš©ì
- `ROLE_ADMIN` ê¶Œí•œ í™•ì¸
- Admin ê³„ì •ì´ ìƒì„±ë˜ì—ˆëŠ”ì§€ í™•ì¸ (ì• í”Œë¦¬ì¼€ì´ì…˜ ë¡œê·¸ í™•ì¸)

### ë¹ˆ CSV íŒŒì¼
- ìŠ¹ì¸ëœ Submission ë°ì´í„°ê°€ ì—†ìŒ
- `/api/admin/submissions`ì—ì„œ ìŠ¹ì¸ ì²˜ë¦¬ í•„ìš”
- í…ŒìŠ¤íŠ¸ ë°ì´í„°ê°€ ìƒì„±ë˜ì—ˆëŠ”ì§€ í™•ì¸

### íŒŒì¼ëª… ì¸ì½”ë”© ë¬¸ì œ
- ë¸Œë¼ìš°ì €ì— ë”°ë¼ í•œê¸€ íŒŒì¼ëª…ì´ ê¹¨ì§ˆ ìˆ˜ ìˆìŒ
- Postmanì—ì„œëŠ” ì •ìƒ ë‹¤ìš´ë¡œë“œë¨

---

## ì˜ˆìƒ ì‘ë‹µ ì½”ë“œ

| HTTP Status | ì„¤ëª… |
|------------|------|
| 200 OK | CSV íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì„±ê³µ |
| 400 Bad Request | ìš”ì²­ í˜•ì‹ ì˜¤ë¥˜ (format ëˆ„ë½ ë“±) |
| 401 Unauthorized | ì¸ì¦ í† í° ì—†ìŒ |
| 403 Forbidden | Admin ê¶Œí•œ ì—†ìŒ |
| 500 Internal Server Error | ì„œë²„ ì˜¤ë¥˜ |

---

## ìë™ ì´ˆê¸°í™” ì •ë³´

### AdminUserInitializer
- **ìœ„ì¹˜**: `com.ocean.piuda.admin.initializer.AdminUserInitializer`
- **ì‹¤í–‰ ì¡°ê±´**: `!prod` í”„ë¡œí•„ (í”„ë¡œë•ì…˜ ì œì™¸)
- **ê¸°ëŠ¥**: Admin ê³„ì • ìë™ ìƒì„±
- **ì‹¤í–‰ ìˆœì„œ**: `@Order(0)` - ë‹¤ë¥¸ ì´ˆê¸°í™”ë³´ë‹¤ ë¨¼ì € ì‹¤í–‰

### SubmissionDataInitializer
- **ìœ„ì¹˜**: `com.ocean.piuda.admin.submission.initializer.SubmissionDataInitializer`
- **ì‹¤í–‰ ì¡°ê±´**: `!prod` í”„ë¡œí•„ (í”„ë¡œë•ì…˜ ì œì™¸)
- **ê¸°ëŠ¥**: í…ŒìŠ¤íŠ¸ìš© Submission ë°ì´í„° ìë™ ìƒì„± (ìŠ¹ì¸/ëŒ€ê¸°/ë°˜ë ¤ ìƒíƒœ í¬í•¨)
- **ì‹¤í–‰ ìˆœì„œ**: `@Order(1)` - Admin ê³„ì • ìƒì„± í›„ ì‹¤í–‰

---

## ë¹ ë¥¸ í…ŒìŠ¤íŠ¸ ì²´í¬ë¦¬ìŠ¤íŠ¸

- [ ] ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰
- [ ] ë¡œê·¸ì—ì„œ "Admin ê³„ì • ìƒì„± ì™„ë£Œ" í™•ì¸
- [ ] ë¡œê·¸ì—ì„œ "Submission í…ŒìŠ¤íŠ¸ ë°ì´í„° ìƒì„± ì™„ë£Œ" í™•ì¸
- [ ] Admin ë¡œê·¸ì¸í•˜ì—¬ Access Token íšë“
- [ ] Export API í˜¸ì¶œí•˜ì—¬ CSV ë‹¤ìš´ë¡œë“œ
- [ ] ë‹¤ìš´ë¡œë“œëœ CSV íŒŒì¼ ë‚´ìš© í™•ì¸
- [ ] Export ì´ë ¥ ì¡°íšŒ í™•ì¸


================================================================================
File Path: .\ProjectExporter.java
================================================================================

import java.io.IOException;
import java.nio.charset.StandardCharsets;
import java.nio.file.*;
import java.nio.file.attribute.BasicFileAttributes;
import java.util.*;
import java.util.stream.Collectors;
import java.util.stream.Stream;

public class ProjectExporter {

    // ê²°ê³¼ íŒŒì¼ëª…
    private static final String OUTPUT_FILE = "project_context.txt";

    // ê¸°ë³¸ì ìœ¼ë¡œ ì œì™¸í•  ë””ë ‰í† ë¦¬/íŒŒì¼ (gitignoreê°€ ì—†ê±°ë‚˜ ë†“ì¹  ê²½ìš° ëŒ€ë¹„)
    private static final Set<String> DEFAULT_IGRORES = new HashSet<>(Arrays.asList(
            ".git", ".idea", ".gradle", "build", "target", "out", ".mvn", "wrapper", "gradlew", "gradlew.bat", OUTPUT_FILE
    ));

    // í…ìŠ¤íŠ¸ íŒŒì¼ë¡œ ê°„ì£¼í•  í™•ì¥ì (ë°”ì´ë„ˆë¦¬ ì œì™¸ìš©)
    private static final Set<String> TEXT_EXTENSIONS = new HashSet<>(Arrays.asList(
            "java", "xml", "yml", "yaml", "properties", "gradle", "sql", "md", "txt", "html", "css", "js", "json", "dockerfile"
    ));

    public static void main(String[] args) {
        Path startPath = Paths.get(".");
        Path outputPath = Paths.get(OUTPUT_FILE);
        List<PathMatcher> gitIgnoreMatchers = loadGitIgnore(startPath);

        try (java.io.BufferedWriter writer = Files.newBufferedWriter(outputPath, StandardCharsets.UTF_8)) {
            System.out.println(" í”„ë¡œì íŠ¸ ì¶”ì¶œì„ ì‹œì‘í•©ë‹ˆë‹¤... (Target: " + OUTPUT_FILE + ")");

            Files.walkFileTree(startPath, new SimpleFileVisitor<Path>() {
                @Override
                public FileVisitResult preVisitDirectory(Path dir, BasicFileAttributes attrs) {
                    if (shouldIgnore(startPath, dir, gitIgnoreMatchers)) {
                        return FileVisitResult.SKIP_SUBTREE;
                    }
                    return FileVisitResult.CONTINUE;
                }

                @Override
                public FileVisitResult visitFile(Path file, BasicFileAttributes attrs) {
                    if (shouldIgnore(startPath, file, gitIgnoreMatchers)) {
                        return FileVisitResult.CONTINUE;
                    }

                    if (isTextFile(file)) {
                        writeFileContent(writer, file);
                    }
                    return FileVisitResult.CONTINUE;
                }
            });

            System.out.println("ì™„ë£Œ! '" + OUTPUT_FILE + "' íŒŒì¼ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.");

        } catch (IOException e) {
            e.printStackTrace();
        }
    }

    // .gitignore íŒŒì¼ ë¡œë“œ ë° PathMatcher ë³€í™˜
    private static List<PathMatcher> loadGitIgnore(Path rootPath) {
        List<PathMatcher> matchers = new ArrayList<>();
        Path gitIgnorePath = rootPath.resolve(".gitignore");
        FileSystem fs = FileSystems.getDefault();

        if (Files.exists(gitIgnorePath)) {
            try (Stream<String> lines = Files.lines(gitIgnorePath)) {
                lines.map(String::trim)
                        .filter(line -> !line.isEmpty() && !line.startsWith("#"))
                        .forEach(line -> {
                            // ê°„ë‹¨í•œ glob íŒ¨í„´ ë³€í™˜ (í´ë”ì¸ ê²½ìš° /** ì¶”ê°€ ë“±)
                            String pattern = "glob:**/" + line;
                            if (line.endsWith("/")) {
                                pattern += "**";
                            }
                            try {
                                matchers.add(fs.getPathMatcher(pattern));
                            } catch (Exception e) {
                                // ë³µì¡í•œ ì •ê·œì‹ íŒ¨í„´ì€ ë¬´ì‹œ
                            }
                        });
                System.out.println("â„¹ .gitignore íŒŒì¼ì„ ë°œê²¬í•˜ì—¬ ê·œì¹™ì„ ì ìš©í•©ë‹ˆë‹¤.");
            } catch (IOException e) {
                System.err.println("âš  .gitignore ì½ê¸° ì‹¤íŒ¨: " + e.getMessage());
            }
        }
        return matchers;
    }

    // ì œì™¸ ëŒ€ìƒ í™•ì¸ ë¡œì§
    private static boolean shouldIgnore(Path root, Path path, List<PathMatcher> gitIgnoreMatchers) {
        String fileName = path.getFileName().toString();

        // 1. ê¸°ë³¸ ì œì™¸ ëª©ë¡ í™•ì¸
        if (DEFAULT_IGRORES.contains(fileName)) return true;

        // 2. .gitignore ê·œì¹™ í™•ì¸
        for (PathMatcher matcher : gitIgnoreMatchers) {
            if (matcher.matches(path)) return true;
        }

        return false;
    }

    // í…ìŠ¤íŠ¸ íŒŒì¼ ì—¬ë¶€ í™•ì¸ (í™•ì¥ì ê¸°ë°˜)
    private static boolean isTextFile(Path path) {
        String fileName = path.getFileName().toString().toLowerCase();
        if (fileName.equals("dockerfile")) return true;

        int lastDot = fileName.lastIndexOf('.');
        if (lastDot == -1) return false;

        String ext = fileName.substring(lastDot + 1);
        return TEXT_EXTENSIONS.contains(ext);
    }

    private static void writeFileContent(java.io.BufferedWriter writer, Path file) {
        try {
            writer.write("\n" + "=".repeat(80) + "\n");
            writer.write("File Path: " + file.toString() + "\n");
            writer.write("=".repeat(80) + "\n\n");

            // íŒŒì¼ ë‚´ìš©ì„ í•œ ë²ˆì— ì½ì–´ì„œ ì“°ê¸°
            Files.lines(file).forEach(line -> {
                try {
                    writer.write(line);
                    writer.newLine();
                } catch (IOException e) {
                    throw new RuntimeException(e);
                }
            });
            writer.write("\n");
        } catch (Exception e) {
            System.err.println(" íŒŒì¼ ì½ê¸° ì‹¤íŒ¨ (" + file + "): " + e.getMessage());
        }
    }
}


================================================================================
File Path: .\settings.gradle
================================================================================

rootProject.name = 'piuda'


================================================================================
File Path: .\src\main\java\com\ocean\piuda\admin\common\enums\ActivityType.java
================================================================================

package com.ocean.piuda.admin.common.enums;

public enum ActivityType {
    TRANSPLANT,          // ì´ì‹
    TRASH_COLLECTION,    // íê¸°ë¬¼ìˆ˜ê±°
    RESEARCH,            // ì—°êµ¬
    MONITORING,          // ëª¨ë‹ˆí„°ë§
    URCHIN_REMOVAL,
    OTHER                // ê¸°íƒ€
}


================================================================================
File Path: .\src\main\java\com\ocean\piuda\admin\common\enums\AuditAction.java
================================================================================

package com.ocean.piuda.admin.common.enums;

public enum AuditAction {
    SUBMITTED,  // ì œì¶œë¨
    APPROVED,   // ìŠ¹ì¸
    REJECTED,   // ë°˜ë ¤
    DELETED,    // ì‚­ì œ
    COMMENT     // ì½”ë©˜íŠ¸
}


================================================================================
File Path: .\src\main\java\com\ocean\piuda\admin\common\enums\CurrentState.java
================================================================================

package com.ocean.piuda.admin.common.enums;

public enum CurrentState {
    LOW,     // ì•½
    MEDIUM,  // ì¤‘
    HIGH     // ê°•
}


================================================================================
File Path: .\src\main\java\com\ocean\piuda\admin\common\enums\ExportFormat.java
================================================================================

package com.ocean.piuda.admin.common.enums;

public enum ExportFormat {
    CSV,   // CSV í˜•ì‹
    XLSX   // Excel í˜•ì‹
}


================================================================================
File Path: .\src\main\java\com\ocean\piuda\admin\common\enums\ExportStatus.java
================================================================================

package com.ocean.piuda.admin.common.enums;

public enum ExportStatus {
    PROCESSING,  // ì²˜ë¦¬ ì¤‘
    READY,       // ì™„ë£Œ
    FAILED       // ì‹¤íŒ¨
}


================================================================================
File Path: .\src\main\java\com\ocean\piuda\admin\common\enums\HealthGrade.java
================================================================================

package com.ocean.piuda.admin.common.enums;

public enum HealthGrade {
    A, B, C, D
}


================================================================================
File Path: .\src\main\java\com\ocean\piuda\admin\common\enums\ParticipantRole.java
================================================================================

package com.ocean.piuda.admin.common.enums;

public enum ParticipantRole {
    CITIZEN_DIVER,    // ì‹œë¯¼ë‹¤ì´ë²„
    RESEARCHER,       // ì—°êµ¬ì
    LOCAL_MANAGER,    // ê´€ê³„ì
    OTHER             // ê¸°íƒ€
}


================================================================================
File Path: .\src\main\java\com\ocean\piuda\admin\common\enums\SubmissionStatus.java
================================================================================

package com.ocean.piuda.admin.common.enums;

public enum SubmissionStatus {
    PENDING,    // ê²€ìˆ˜ ëŒ€ê¸°
    APPROVED,   // ìŠ¹ì¸
    REJECTED,   // ë°˜ë ¤
    DELETED     // ì‚­ì œ
}


================================================================================
File Path: .\src\main\java\com\ocean\piuda\admin\common\enums\Weather.java
================================================================================

package com.ocean.piuda.admin.common.enums;

public enum Weather {
    SUNNY,   // ë§‘ìŒ
    CLOUDY,  // íë¦¼
    RAINY,   // ë¹„
    WINDY,   // ë°”ëŒ
    OTHER    // ê¸°íƒ€
}


================================================================================
File Path: .\src\main\java\com\ocean\piuda\admin\dashboard\controller\DashboardController.java
================================================================================

package com.ocean.piuda.admin.dashboard.controller;

import com.ocean.piuda.admin.dashboard.dto.DashboardSummaryResponse;
import com.ocean.piuda.admin.dashboard.service.DashboardService;
import com.ocean.piuda.global.api.dto.ApiData;
import io.swagger.v3.oas.annotations.Operation;
import io.swagger.v3.oas.annotations.responses.ApiResponse;
import io.swagger.v3.oas.annotations.responses.ApiResponses;
import io.swagger.v3.oas.annotations.tags.Tag;
import lombok.RequiredArgsConstructor;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

@RestController
@RequestMapping("/api/admin/dashboard")
@RequiredArgsConstructor
@Tag(
        name = "Admin Dashboard",
        description = "ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ í†µê³„ APIì…ë‹ˆë‹¤. ì „ì²´ ì œì¶œ í˜„í™© í†µê³„ë¥¼ ì¡°íšŒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."
)
public class DashboardController {

    private final DashboardService dashboardService;

    /**
     * ëŒ€ì‹œë³´ë“œ í†µê³„ ì¡°íšŒ
     */
    @GetMapping("/summary")
    @Operation(summary = "ëŒ€ì‹œë³´ë“œ í†µê³„ ì¡°íšŒ", description = "ì „ì²´ ì œì¶œ í˜„í™© í†µê³„ë¥¼ ì¡°íšŒí•©ë‹ˆë‹¤.")
    @ApiResponses({
            @ApiResponse(responseCode = "200", description = "ì¡°íšŒ ì„±ê³µ"),
            @ApiResponse(responseCode = "401", description = "ì¸ì¦ ì‹¤íŒ¨"),
            @ApiResponse(responseCode = "403", description = "Admin ê¶Œí•œ ì—†ìŒ")
    })
    public ApiData<DashboardSummaryResponse> getDashboardSummary() {
        DashboardSummaryResponse summary = dashboardService.getDashboardSummary();
        return ApiData.ok(summary);
    }
}


================================================================================
File Path: .\src\main\java\com\ocean\piuda\admin\dashboard\dto\DashboardSummaryResponse.java
================================================================================

package com.ocean.piuda.admin.dashboard.dto;

public record DashboardSummaryResponse(
        Long totalSubmissions,
        Long pending,
        Long approved,
        Long rejected,
        Long deleted
) {
    public static DashboardSummaryResponse of(
            long total,
            long pending,
            long approved,
            long rejected,
            long deleted
    ) {
        return new DashboardSummaryResponse(total, pending, approved, rejected, deleted);
    }
}


================================================================================
File Path: .\src\main\java\com\ocean\piuda\admin\dashboard\service\DashboardService.java
================================================================================

package com.ocean.piuda.admin.dashboard.service;

import com.ocean.piuda.admin.common.enums.SubmissionStatus;
import com.ocean.piuda.admin.dashboard.dto.DashboardSummaryResponse;
import com.ocean.piuda.admin.submission.repository.SubmissionRepository;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

@Transactional(readOnly = true)
@Service
@RequiredArgsConstructor
public class DashboardService {

    private final SubmissionRepository submissionRepository;

    /**
     * ëŒ€ì‹œë³´ë“œ í†µê³„ ì¡°íšŒ
     */
    public DashboardSummaryResponse getDashboardSummary() {
        long total = submissionRepository.count();
        long pending = submissionRepository.countByStatus(SubmissionStatus.PENDING);
        long approved = submissionRepository.countByStatus(SubmissionStatus.APPROVED);
        long rejected = submissionRepository.countByStatus(SubmissionStatus.REJECTED);
        long deleted = submissionRepository.countByStatus(SubmissionStatus.DELETED);

        return DashboardSummaryResponse.of(total, pending, approved, rejected, deleted);
    }
}


================================================================================
File Path: .\src\main\java\com\ocean\piuda\admin\export\controller\ExportController.java
================================================================================

package com.ocean.piuda.admin.export.controller;

import com.ocean.piuda.admin.export.dto.request.ExportByIdsRequest;
import com.ocean.piuda.admin.export.dto.request.ExportRequest;
import com.ocean.piuda.admin.export.dto.response.ExportJobResponse;
import com.ocean.piuda.admin.export.service.ExportService;
import com.ocean.piuda.global.api.dto.ApiData;
import com.ocean.piuda.security.jwt.service.TokenUserService;
import io.swagger.v3.oas.annotations.Operation;
import io.swagger.v3.oas.annotations.responses.ApiResponse;
import io.swagger.v3.oas.annotations.responses.ApiResponses;
import io.swagger.v3.oas.annotations.tags.Tag;
import jakarta.validation.Valid;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.http.ContentDisposition;
import org.springframework.http.HttpHeaders;
import org.springframework.http.MediaType;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;

import java.nio.charset.StandardCharsets;
import java.util.List;

@RestController
@RequestMapping("/api/admin/exports")
@RequiredArgsConstructor
@Slf4j
@Tag(
        name = "Admin Export",
        description = "ì œì¶œ ë°ì´í„° ë‚´ë³´ë‚´ê¸° APIì…ë‹ˆë‹¤. ìŠ¹ì¸ëœ ë°ì´í„°ë¥¼ CSV í˜•ì‹ìœ¼ë¡œ ë‚´ë³´ë‚´ê³  ì´ë ¥ì„ ì¡°íšŒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."
)
public class ExportController {

    private final ExportService exportService;
    private final TokenUserService tokenUserService;

    @PostMapping("/download")
    @Operation(summary = "ë°ì´í„° ë‚´ë³´ë‚´ê¸° (CSV ë‹¤ìš´ë¡œë“œ)", description = "ìŠ¹ì¸ëœ ì œì¶œ ë°ì´í„°ë¥¼ CSV íŒŒì¼ë¡œ ë‚´ë³´ëƒ…ë‹ˆë‹¤. íŒŒì¼ì´ ë°”ë¡œ ë‹¤ìš´ë¡œë“œë©ë‹ˆë‹¤.")
    @ApiResponses({
            @ApiResponse(responseCode = "200", description = "CSV íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì„±ê³µ"),
            @ApiResponse(responseCode = "400", description = "ìš”ì²­ í˜•ì‹ ì˜¤ë¥˜ (format ëˆ„ë½ ë“±)"),
            @ApiResponse(responseCode = "401", description = "ì¸ì¦ ì‹¤íŒ¨"),
            @ApiResponse(responseCode = "403", description = "Admin ê¶Œí•œ ì—†ìŒ")
    })
    public ResponseEntity<byte[]> downloadExport(
            @Valid @RequestBody ExportRequest request
    ) {
        byte[] csvBytes = exportService.generateExportFile(request);
        String fileName = exportService.generateFileName(request.getFormat());
        
        try {
            String requestedBy = tokenUserService.getCurrentUser().getEmail() != null 
                    ? tokenUserService.getCurrentUser().getEmail() 
                    : tokenUserService.getCurrentUser().getUsername();
            exportService.saveExportHistory(request, requestedBy);
        } catch (Exception e) {
            log.warn("Export ì´ë ¥ ì €ì¥ ì‹¤íŒ¨: {}", e.getMessage());
        }
        
        // Content-Type ì„¤ì • (CSVì˜ ê²½ìš°)
        MediaType contentType = request.getFormat() == com.ocean.piuda.admin.common.enums.ExportFormat.CSV 
                ? new MediaType("text", "csv", StandardCharsets.UTF_8)
                : MediaType.APPLICATION_OCTET_STREAM;
        
        // Content-Disposition í—¤ë” ì„¤ì • (í•œê¸€ íŒŒì¼ëª… ì§€ì›)
        ContentDisposition contentDisposition = ContentDisposition.attachment()
                .filename(fileName, StandardCharsets.UTF_8)
                .build();
        
        HttpHeaders headers = new HttpHeaders();
        headers.setContentType(contentType);
        headers.setContentDisposition(contentDisposition);
        headers.setContentLength(csvBytes.length);
        headers.add("Cache-Control", "no-cache, no-store, must-revalidate");
        headers.add("Pragma", "no-cache");
        headers.add("Expires", "0");
        
        return ResponseEntity.ok()
                .headers(headers)
                .body(csvBytes);
    }

    @GetMapping
    @Operation(summary = "ë‚´ë³´ë‚´ê¸° ì´ë ¥ ì¡°íšŒ", description = "ë‚´ë³´ë‚´ê¸° ì‘ì—… ì´ë ¥ì„ ì¡°íšŒí•©ë‹ˆë‹¤.")
    @ApiResponses({
            @ApiResponse(responseCode = "200", description = "ì¡°íšŒ ì„±ê³µ"),
            @ApiResponse(responseCode = "401", description = "ì¸ì¦ ì‹¤íŒ¨"),
            @ApiResponse(responseCode = "403", description = "Admin ê¶Œí•œ ì—†ìŒ")
    })
    public ApiData<List<ExportJobResponse>> getExportHistory() {
        List<ExportJobResponse> history = exportService.getExportHistory();
        return ApiData.ok(history);
    }

    @PostMapping("/download/by-ids")
    @Operation(
            summary = "ë°ì´í„° ë‚´ë³´ë‚´ê¸° (IDs ê¸°ë°˜ CSV ë‹¤ìš´ë¡œë“œ)",
            description = "ì§€ì •í•œ submission ids ëª©ë¡ì„ CSV íŒŒì¼ë¡œ ë‚´ë³´ëƒ…ë‹ˆë‹¤. ìŠ¹ì¸ëœ ë°ì´í„°ë§Œ í¬í•¨ë©ë‹ˆë‹¤."
    )
    @ApiResponses({
            @ApiResponse(responseCode = "200", description = "CSV íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì„±ê³µ"),
            @ApiResponse(responseCode = "400", description = "ìš”ì²­ í˜•ì‹ ì˜¤ë¥˜ (format/ids ëˆ„ë½ ë“±)"),
            @ApiResponse(responseCode = "401", description = "ì¸ì¦ ì‹¤íŒ¨"),
            @ApiResponse(responseCode = "403", description = "Admin ê¶Œí•œ ì—†ìŒ")
    })
    public ResponseEntity<byte[]> downloadExportByIds(
            @Valid @RequestBody ExportByIdsRequest request
    ) {
        byte[] csvBytes = exportService.generateExportFileByIds(request);
        String fileName = exportService.generateFileName(request.getFormat());

        try {
            String requestedBy = tokenUserService.getCurrentUser().getEmail() != null
                    ? tokenUserService.getCurrentUser().getEmail()
                    : tokenUserService.getCurrentUser().getUsername();
            exportService.saveExportHistory(request, requestedBy);
        } catch (Exception e) {
            log.warn("Export(IDs) ì´ë ¥ ì €ì¥ ì‹¤íŒ¨: {}", e.getMessage());
        }

        MediaType contentType = request.getFormat() == com.ocean.piuda.admin.common.enums.ExportFormat.CSV
                ? new MediaType("text", "csv", StandardCharsets.UTF_8)
                : MediaType.APPLICATION_OCTET_STREAM;

        ContentDisposition contentDisposition = ContentDisposition.attachment()
                .filename(fileName, StandardCharsets.UTF_8)
                .build();

        HttpHeaders headers = new HttpHeaders();
        headers.setContentType(contentType);
        headers.setContentDisposition(contentDisposition);
        headers.setContentLength(csvBytes.length);
        headers.add("Cache-Control", "no-cache, no-store, must-revalidate");
        headers.add("Pragma", "no-cache");
        headers.add("Expires", "0");

        return ResponseEntity.ok()
                .headers(headers)
                .body(csvBytes);
    }

}


================================================================================
File Path: .\src\main\java\com\ocean\piuda\admin\export\dto\request\ExportByIdsRequest.java
================================================================================

package com.ocean.piuda.admin.export.dto.request;

import com.ocean.piuda.admin.common.enums.ExportFormat;
import jakarta.validation.constraints.NotEmpty;
import jakarta.validation.constraints.NotNull;
import lombok.*;

import java.util.List;

@Getter
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class ExportByIdsRequest {

    @NotNull(message = "í¬ë§·ì€ í•„ìˆ˜ì…ë‹ˆë‹¤")
    private ExportFormat format;

    @NotEmpty(message = "idsëŠ” 1ê°œ ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤")
    private List<Long> ids;

}


================================================================================
File Path: .\src\main\java\com\ocean\piuda\admin\export\dto\request\ExportRequest.java
================================================================================

package com.ocean.piuda.admin.export.dto.request;

import com.ocean.piuda.admin.common.enums.ExportFormat;
import jakarta.validation.constraints.NotNull;
import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Getter;
import lombok.NoArgsConstructor;

import java.time.LocalDate;

@Getter
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class ExportRequest {
    
    @NotNull(message = "í¬ë§·ì€ í•„ìˆ˜ì…ë‹ˆë‹¤")
    private ExportFormat format;
    
    private ExportFilters filters;
    
    @Getter
    @Builder
    @NoArgsConstructor
    @AllArgsConstructor
    public static class ExportFilters {
        private LocalDate dateFrom;
        private LocalDate dateTo;
    }
}


================================================================================
File Path: .\src\main\java\com\ocean\piuda\admin\export\dto\response\ExportJobResponse.java
================================================================================

package com.ocean.piuda.admin.export.dto.response;

import com.ocean.piuda.admin.common.enums.ExportFormat;
import com.ocean.piuda.admin.common.enums.ExportStatus;
import com.ocean.piuda.admin.export.entity.ExportJob;
import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Getter;
import lombok.NoArgsConstructor;

import java.time.LocalDateTime;

@Getter
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class ExportJobResponse {
    private Long jobId;
    private String requestedBy;
    private ExportFormat format;
    private ExportStatus status;
    private String downloadUrl;
    private LocalDateTime createdAt;
    private LocalDateTime completedAt;
    private String filtersJson;

    public static ExportJobResponse from(ExportJob exportJob) {
        return ExportJobResponse.builder()
                .jobId(exportJob.getJobId())
                .requestedBy(exportJob.getRequestedBy())
                .format(exportJob.getFormat())
                .status(exportJob.getStatus())
                .downloadUrl(exportJob.getDownloadUrl())
                .createdAt(exportJob.getCreatedAt())
                .completedAt(exportJob.getCompletedAt())
                .filtersJson(exportJob.getFiltersJson())
                .build();
    }
}


================================================================================
File Path: .\src\main\java\com\ocean\piuda\admin\export\entity\ExportJob.java
================================================================================

package com.ocean.piuda.admin.export.entity;

import com.ocean.piuda.admin.common.enums.ExportFormat;
import com.ocean.piuda.admin.common.enums.ExportStatus;
import com.ocean.piuda.global.api.domain.BaseEntity;
import jakarta.persistence.*;
import lombok.*;
import lombok.experimental.SuperBuilder;

import java.time.LocalDateTime;

@Entity
@Table(name = "export_job")
@Getter
@NoArgsConstructor
@AllArgsConstructor
@SuperBuilder(toBuilder = true)
public class ExportJob extends BaseEntity {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    @Column(name = "job_id")
    private Long jobId;

    @Column(name = "requested_by", nullable = false, length = 100)
    private String requestedBy;

    @Column(name = "filters_json", columnDefinition = "TEXT")
    private String filtersJson;

    @Enumerated(EnumType.STRING)
    @Builder.Default
    private ExportFormat format = ExportFormat.CSV;

    @Enumerated(EnumType.STRING)
    @Builder.Default
    private ExportStatus status = ExportStatus.PROCESSING;

    @Column(name = "download_url", length = 500)
    private String downloadUrl;

    @Column(name = "completed_at")
    private LocalDateTime completedAt;
}


================================================================================
File Path: .\src\main\java\com\ocean\piuda\admin\export\repository\ExportJobRepository.java
================================================================================

package com.ocean.piuda.admin.export.repository;

import com.ocean.piuda.admin.export.entity.ExportJob;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.stereotype.Repository;

import java.util.List;

@Repository
public interface ExportJobRepository extends JpaRepository<ExportJob, Long> {
    List<ExportJob> findAllByOrderByCreatedAtDesc();

}


================================================================================
File Path: .\src\main\java\com\ocean\piuda\admin\export\service\ExportService.java
================================================================================

package com.ocean.piuda.admin.export.service;

import com.fasterxml.jackson.databind.ObjectMapper;
import com.ocean.piuda.admin.common.enums.ExportFormat;
import com.ocean.piuda.admin.common.enums.ExportStatus;
import com.ocean.piuda.admin.common.enums.SubmissionStatus;
import com.ocean.piuda.admin.export.dto.request.ExportByIdsRequest;
import com.ocean.piuda.admin.export.dto.request.ExportRequest;
import com.ocean.piuda.admin.export.dto.response.ExportJobResponse;
import com.ocean.piuda.admin.export.entity.ExportJob;
import com.ocean.piuda.admin.export.repository.ExportJobRepository;
import com.ocean.piuda.admin.submission.entity.Submission;
import com.ocean.piuda.admin.submission.repository.SubmissionRepository;
import com.ocean.piuda.global.api.exception.BusinessException;
import com.ocean.piuda.global.api.exception.ExceptionType;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.io.ByteArrayOutputStream;
import java.io.IOException;
import java.io.OutputStreamWriter;
import java.nio.charset.StandardCharsets;
import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;
import java.util.Comparator;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.stream.Collectors;

@Service
@RequiredArgsConstructor
@Slf4j
public class ExportService {

    private final ExportJobRepository exportJobRepository;
    private final SubmissionRepository submissionRepository;
    private final ObjectMapper objectMapper = new ObjectMapper();

    @Transactional(readOnly = true)
    public byte[] generateExportFile(ExportRequest request) {
        try {
            List<Submission> submissions = getSubmissionsForExport(request);
            return generateCSV(submissions);
        } catch (Exception e) {
            log.error("Export íŒŒì¼ ìƒì„± ì‹¤íŒ¨: {}", e.getMessage(), e);
            throw new BusinessException(ExceptionType.EXPORT_FAILED);
        }
    }

    @Transactional
    public ExportJobResponse saveExportHistory(ExportRequest request, String requestedBy) {
        try {
            String filtersJson = request.getFilters() != null 
                    ? objectMapper.writeValueAsString(request.getFilters())
                    : "{}";

            ExportJob exportJob = ExportJob.builder()
                    .requestedBy(requestedBy)
                    .format(request.getFormat())
                    .status(ExportStatus.READY)
                    .filtersJson(filtersJson)
                    .completedAt(LocalDateTime.now())
                    .build();

            ExportJob saved = exportJobRepository.save(exportJob);
            return ExportJobResponse.from(saved);
        } catch (Exception e) {
            log.error("Export ì´ë ¥ ì €ì¥ ì‹¤íŒ¨: {}", e.getMessage(), e);
            throw new BusinessException(ExceptionType.EXPORT_FAILED);
        }
    }

    private List<Submission> getSubmissionsForExport(ExportRequest request) {
        try {
            ExportRequest.ExportFilters filters = request.getFilters();

            LocalDateTime startDate = filters != null && filters.getDateFrom() != null 
                    ? filters.getDateFrom().atStartOfDay() 
                    : null;
            LocalDateTime endDate = filters != null && filters.getDateTo() != null 
                    ? filters.getDateTo().atTime(23, 59, 59) 
                    : null;

            return submissionRepository.findWithFilters(
                    null,
                    SubmissionStatus.APPROVED,
                    null,
                    startDate,
                    endDate,
                    org.springframework.data.domain.Pageable.unpaged()
            ).getContent();

        } catch (Exception e) {
            log.error("ì œì¶œ ë°ì´í„° ì¡°íšŒ ì‹¤íŒ¨: {}", e.getMessage(), e);
            return submissionRepository.findAll().stream()
                    .filter(s -> s.getStatus() == SubmissionStatus.APPROVED)
                    .collect(Collectors.toList());
        }
    }

    private byte[] generateCSV(List<Submission> submissions) throws IOException {
        ByteArrayOutputStream baos = new ByteArrayOutputStream();

        // 1) UTF-8 BOMì€ ê°€ì¥ ë¨¼ì €
        baos.write(0xEF); baos.write(0xBB); baos.write(0xBF);

        try (OutputStreamWriter writer = new OutputStreamWriter(baos, StandardCharsets.UTF_8)) {
            // 2) Excel íŒíŠ¸ + CRLF
            writer.write("sep=,\r\n");

            // 3) í—¤ë” (CRLF)
            writer.write("ì œì¶œID,í˜„ì¥ëª…,í™œë™ìœ í˜•,ì œì¶œì¼,ì‘ì„±ì,ì´ë©”ì¼,ìœ„ë„,ê²½ë„,ìˆ˜ì‹¬(m),ìˆ˜ì˜¨(Â°C),ì‹œì•¼(m),ë‚ ì”¨,ì¡°ë¥˜ìƒíƒœ,ì°¸ì—¬ì¸ì›,ëŒ€í‘œìëª…,ì—­í• ,ì„¸ë¶€ë‚´ìš©,ìˆ˜ê±°ëŸ‰,í™œë™í›„ê¸°,ì²¨ë¶€íŒŒì¼ìˆ˜\r\n");

            DateTimeFormatter dtf = DateTimeFormatter.ISO_LOCAL_DATE_TIME;

            for (Submission submission : submissions) {
                writer.write(submission.getSubmissionId() + ",");
                writer.write(escapeCsv(submission.getSiteName()) + ",");
                writer.write((submission.getActivityType() != null ? submission.getActivityType().name() : "") + ",");
                writer.write((submission.getSubmittedAt() != null ? submission.getSubmittedAt().format(dtf) : "") + ",");
                writer.write(escapeCsv(submission.getAuthorName()) + ",");
                writer.write(escapeCsv(submission.getAuthorEmail() != null ? submission.getAuthorEmail() : "") + ",");

                // 4) (í•µì‹¬) ì½¤ë§ˆë¥¼ í•­ìƒ ë¶™ì´ë„ë¡ ê´„í˜¸ ìœ„ì¹˜ ìˆ˜ì •
                writer.write((submission.getLatitude()  != null ? submission.getLatitude().toString()  : "") + ",");
                writer.write((submission.getLongitude() != null ? submission.getLongitude().toString() : "") + ",");

                if (submission.getBasicEnv() != null) {
                    writer.write((submission.getBasicEnv().getDepthM()      != null ? submission.getBasicEnv().getDepthM().toString()      : "") + ",");
                    writer.write((submission.getBasicEnv().getWaterTempC()  != null ? submission.getBasicEnv().getWaterTempC().toString()  : "") + ",");
                    writer.write((submission.getBasicEnv().getVisibilityM() != null ? submission.getBasicEnv().getVisibilityM().toString() : "") + ",");
                    writer.write((submission.getBasicEnv().getWeather()     != null ? submission.getBasicEnv().getWeather().name()         : "") + ",");
                    writer.write((submission.getBasicEnv().getCurrentState()!= null ? submission.getBasicEnv().getCurrentState().name()    : "") + ",");
                } else {
                    writer.write(",,,,,");
                }

                if (submission.getParticipants() != null) {
                    writer.write((submission.getParticipants().getParticipantCount() != null ? submission.getParticipants().getParticipantCount().toString() : "") + ",");
                    writer.write(escapeCsv(submission.getParticipants().getLeaderName() != null ? submission.getParticipants().getLeaderName() : "") + ",");
                    writer.write((submission.getParticipants().getRole() != null ? submission.getParticipants().getRole().name() : "") + ",");
                } else {
                    writer.write(",,,");
                }

                if (submission.getActivity() != null) {
                    writer.write(escapeCsv(submission.getActivity().getDetails() != null ? submission.getActivity().getDetails() : "") + ",");
                    writer.write((submission.getActivity().getCollectionAmount() != null ? submission.getActivity().getCollectionAmount().toString() : "") + ",");
                } else {
                    writer.write(",,");
                }

                writer.write(escapeCsv(submission.getFeedbackText() != null ? submission.getFeedbackText() : "") + ",");
                writer.write((submission.getAttachmentCount() != null ? submission.getAttachmentCount().toString() : ""));
                writer.write("\r\n"); // 5) ê° í–‰ ëì€ CRLF
            }

            writer.flush();
        }

        return baos.toByteArray();
    }

    private String escapeCsv(String value) {
        if (value == null) return "";
        if (value.contains(",") || value.contains("\"") || value.contains("\n")) {
            return "\"" + value.replace("\"", "\"\"") + "\"";
        }
        return value;
    }

    public String generateFileName(ExportFormat format) {
        String extension = format == ExportFormat.CSV ? ".csv" : ".xlsx";
        String timestamp = LocalDateTime.now().format(DateTimeFormatter.ofPattern("yyyyMMdd_HHmmss"));
        return String.format("submissions_export_%s%s", timestamp, extension);
    }

    @Transactional(readOnly = true)
    public List<ExportJobResponse> getExportHistory() {
        return exportJobRepository.findAllByOrderByCreatedAtDesc()
                .stream()
                .map(ExportJobResponse::from)
                .collect(Collectors.toList());
    }


    @Transactional(readOnly = true)
    public byte[] generateExportFileByIds(ExportByIdsRequest request) {
        try {
            List<Submission> submissions = getSubmissionsForExportByIds(request.getIds());

            // ìš”ì²­í•œ ids ìˆœì„œëŒ€ë¡œ ì •ë ¬
            Map<Long, Integer> order = new HashMap<>();
            for (int i = 0; i < request.getIds().size(); i++) {
                order.put(request.getIds().get(i), i);
            }
            submissions.sort(Comparator.comparingInt(s -> order.getOrDefault(s.getSubmissionId(), Integer.MAX_VALUE)));

            return generateCSV(submissions);
        } catch (Exception e) {
            log.error("Export(IDs) íŒŒì¼ ìƒì„± ì‹¤íŒ¨: {}", e.getMessage(), e);
            throw new BusinessException(ExceptionType.EXPORT_FAILED);
        }
    }

    @Transactional
    public ExportJobResponse saveExportHistory(ExportByIdsRequest request, String requestedBy) {
        try {
            String filtersJson = objectMapper.writeValueAsString(
                    Map.of("ids", request.getIds())
            );

            ExportJob exportJob = ExportJob.builder()
                    .requestedBy(requestedBy)
                    .format(request.getFormat())
                    .status(ExportStatus.READY)
                    .filtersJson(filtersJson)
                    .completedAt(LocalDateTime.now())
                    .build();

            ExportJob saved = exportJobRepository.save(exportJob);
            return ExportJobResponse.from(saved);
        } catch (Exception e) {
            log.error("Export(IDs) ì´ë ¥ ì €ì¥ ì‹¤íŒ¨: {}", e.getMessage(), e);
            throw new BusinessException(ExceptionType.EXPORT_FAILED);
        }
    }

    private List<Submission> getSubmissionsForExportByIds(List<Long> ids) {
        if (ids == null || ids.isEmpty()) return List.of();
        return submissionRepository.findAllByIdsAndStatusWithDetails(ids, SubmissionStatus.APPROVED);
    }
}


================================================================================
File Path: .\src\main\java\com\ocean\piuda\admin\initializer\AdminUserInitializer.java
================================================================================

package com.ocean.piuda.admin.initializer;

import com.ocean.piuda.security.jwt.enums.Role;
import com.ocean.piuda.user.entity.User;
import com.ocean.piuda.user.repository.UserRepository;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.boot.CommandLineRunner;
import org.springframework.context.annotation.Profile;
import org.springframework.core.annotation.Order;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.stereotype.Component;
import org.springframework.transaction.annotation.Transactional;

@Slf4j
@Component
@RequiredArgsConstructor
@Profile("!prod") // í”„ë¡œë•ì…˜ í™˜ê²½ì—ì„œëŠ” ì‹¤í–‰ë˜ì§€ ì•ŠìŒ
@Order(0) // SubmissionDataInitializerë³´ë‹¤ ë¨¼ì € ì‹¤í–‰
public class AdminUserInitializer implements CommandLineRunner {

    private final UserRepository userRepository;
    private final PasswordEncoder passwordEncoder;

    private static final String ADMIN_USERNAME = "admin@admin.com";
    private static final String ADMIN_PASSWORD = "password";

    @Override
    @Transactional
    public void run(String... args) {
        // ì´ë¯¸ Admin ê³„ì •ì´ ìˆìœ¼ë©´ ìƒì„±í•˜ì§€ ì•ŠìŒ
        if (userRepository.findByUsername(ADMIN_USERNAME).isPresent()) {
            log.info("Admin ê³„ì •ì´ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤. ì´ˆê¸°í™”ë¥¼ ê±´ë„ˆëœë‹ˆë‹¤.");
            return;
        }

        log.info("Admin ê³„ì • ì´ˆê¸°í™” ì‹œì‘...");

        // Admin ê³„ì • ìƒì„±
        User adminUser = User.builder()
                .username(ADMIN_USERNAME)
                .password(passwordEncoder.encode(ADMIN_PASSWORD))
                .role(Role.ADMIN)
                .email(ADMIN_USERNAME)
                .nickname("ê´€ë¦¬ì")
                .build();

        userRepository.save(adminUser);
        log.info("Admin ê³„ì • ìƒì„± ì™„ë£Œ - Username: {}, Role: {}", ADMIN_USERNAME, Role.ADMIN);
    }
}


================================================================================
File Path: .\src\main\java\com\ocean\piuda\admin\submission\controller\SubmissionController.java
================================================================================

package com.ocean.piuda.admin.submission.controller;

import com.ocean.piuda.admin.common.enums.ActivityType;
import com.ocean.piuda.admin.common.enums.SubmissionStatus;
import com.ocean.piuda.admin.submission.dto.request.*;
import com.ocean.piuda.admin.submission.dto.response.*;
import com.ocean.piuda.admin.submission.service.SubmissionCommandService;
import com.ocean.piuda.admin.submission.service.SubmissionQueryService;
import com.ocean.piuda.global.api.dto.ApiData;
import com.ocean.piuda.global.api.dto.PageResponse;
import io.swagger.v3.oas.annotations.Operation;
import io.swagger.v3.oas.annotations.Parameter;
import io.swagger.v3.oas.annotations.responses.ApiResponse;
import io.swagger.v3.oas.annotations.responses.ApiResponses;
import io.swagger.v3.oas.annotations.tags.Tag;
import jakarta.validation.Valid;
import lombok.RequiredArgsConstructor;
import org.springframework.data.domain.PageRequest;
import org.springframework.data.domain.Pageable;
import org.springframework.data.domain.Sort;
import org.springframework.format.annotation.DateTimeFormat;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;

import java.time.LocalDateTime;
import java.util.List;

@RestController
@RequestMapping("/api/admin/submissions")
@RequiredArgsConstructor
@Tag(
        name = "Admin Submission",
        description = "í•´ì–‘ í™œë™ ì œì¶œ ë°ì´í„° ê´€ë¦¬ APIì…ë‹ˆë‹¤. ì œì¶œ ë°ì´í„°ì˜ ì¡°íšŒ, ìƒì„±, ìŠ¹ì¸, ë°˜ë ¤, ì‚­ì œ ê¸°ëŠ¥ì„ ì œê³µí•©ë‹ˆë‹¤."
)
public class SubmissionController {

    private final SubmissionQueryService submissionQueryService;
    private final SubmissionCommandService submissionCommandService;

    /**
     * ì œì¶œ ë°ì´í„° ìƒì„±
     */
    @PostMapping
    @Operation(summary = "ì œì¶œ ë°ì´í„° ìƒì„±", description = "Adminì´ ì§ì ‘ ì œì¶œ ë°ì´í„°ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.")
    @ApiResponses({
            @ApiResponse(responseCode = "200", description = "ìƒì„± ì„±ê³µ"),
            @ApiResponse(responseCode = "400", description = "í•„ìˆ˜ í•„ë“œ ëˆ„ë½ ë˜ëŠ” í˜•ì‹ ì˜¤ë¥˜"),
            @ApiResponse(responseCode = "401", description = "ì¸ì¦ ì‹¤íŒ¨"),
            @ApiResponse(responseCode = "403", description = "Admin ê¶Œí•œ ì—†ìŒ")
    })
    public ApiData<SubmissionDetailResponse> createSubmission(
            @RequestBody @Valid CreateSubmissionRequest request
    ) {
        SubmissionDetailResponse response = submissionCommandService.createSubmission(request);
        return ApiData.ok(response);
    }

    /**
     * ì œì¶œ ëª©ë¡ ì¡°íšŒ
     */
    @GetMapping
    @Operation(summary = "ì œì¶œ ëª©ë¡ ì¡°íšŒ", description = "ì œì¶œ ëª©ë¡ì„ í˜ì´ì§€ë„¤ì´ì…˜ê³¼ í•¨ê»˜ ì¡°íšŒí•©ë‹ˆë‹¤. ê²€ìƒ‰, í•„í„°ë§, ì •ë ¬ì„ ì§€ì›í•©ë‹ˆë‹¤.")
    @ApiResponses({
            @ApiResponse(responseCode = "200", description = "ì¡°íšŒ ì„±ê³µ"),
            @ApiResponse(responseCode = "401", description = "ì¸ì¦ ì‹¤íŒ¨"),
            @ApiResponse(responseCode = "403", description = "Admin ê¶Œí•œ ì—†ìŒ")
    })
    public ApiData<PageResponse<SubmissionListResponse>> getSubmissions(
            @Parameter(description = "ê²€ìƒ‰ í‚¤ì›Œë“œ (í˜„ì¥ëª…, ì‘ì„±ì)") @RequestParam(required = false) String keyword,
            @Parameter(description = "ìƒíƒœ í•„í„° (PENDING, APPROVED, REJECTED, DELETED)") @RequestParam(required = false) SubmissionStatus status,
            @Parameter(description = "í™œë™ ìœ í˜• í•„í„° (TRANSPLANT, TRASH_COLLECTION, RESEARCH, MONITORING, OTHER)") @RequestParam(required = false) ActivityType activityType,
            @Parameter(description = "ì‹œì‘ ë‚ ì§œ (ISO 8601 í˜•ì‹)") @RequestParam(required = false) @DateTimeFormat(iso = DateTimeFormat.ISO.DATE_TIME) LocalDateTime startDate,
            @Parameter(description = "ì¢…ë£Œ ë‚ ì§œ (ISO 8601 í˜•ì‹)") @RequestParam(required = false) @DateTimeFormat(iso = DateTimeFormat.ISO.DATE_TIME) LocalDateTime endDate,
            @Parameter(description = "í˜ì´ì§€ ë²ˆí˜¸ (ê¸°ë³¸ê°’: 0)") @RequestParam(defaultValue = "0") int page,
            @Parameter(description = "í˜ì´ì§€ í¬ê¸° (ê¸°ë³¸ê°’: 20)") @RequestParam(defaultValue = "20") int size,
            @Parameter(description = "ì •ë ¬ í•„ë“œ (ê¸°ë³¸ê°’: submittedAt)") @RequestParam(defaultValue = "submittedAt") String sortBy,
            @Parameter(description = "ì •ë ¬ ë°©í–¥ (ASC, DESC, ê¸°ë³¸ê°’: DESC)") @RequestParam(defaultValue = "DESC") String sortDir
    ) {
        Sort sort = Sort.by(Sort.Direction.fromString(sortDir), sortBy);
        Pageable pageable = PageRequest.of(page, size, sort);
        
        PageResponse<SubmissionListResponse> result = submissionQueryService.getSubmissions(
                keyword, status, activityType, startDate, endDate, pageable
        );
        
        return ApiData.ok(result);
    }

    /**
     * ì œì¶œ ìƒì„¸ ì¡°íšŒ
     */
    @GetMapping("/{submissionId}")
    @Operation(summary = "ì œì¶œ ìƒì„¸ ì¡°íšŒ", description = "íŠ¹ì • ì œì¶œ ë°ì´í„°ì˜ ìƒì„¸ ì •ë³´ë¥¼ ì¡°íšŒí•©ë‹ˆë‹¤.")
    @ApiResponses({
            @ApiResponse(responseCode = "200", description = "ì¡°íšŒ ì„±ê³µ"),
            @ApiResponse(responseCode = "404", description = "ì œì¶œ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ"),
            @ApiResponse(responseCode = "401", description = "ì¸ì¦ ì‹¤íŒ¨"),
            @ApiResponse(responseCode = "403", description = "Admin ê¶Œí•œ ì—†ìŒ")
    })
    public ApiData<SubmissionDetailResponse> getSubmissionDetail(
            @Parameter(description = "ì œì¶œ ID", required = true) @PathVariable Long submissionId) {
        SubmissionDetailResponse response = submissionQueryService.getSubmissionDetail(submissionId);
        return ApiData.ok(response);
    }

    /**
     * ê²€ìˆ˜ ë¡œê·¸ ì¡°íšŒ
     */
    @GetMapping("/{submissionId}/logs")
    @Operation(summary = "ê²€ìˆ˜ ë¡œê·¸ ì¡°íšŒ", description = "íŠ¹ì • ì œì¶œ ë°ì´í„°ì˜ ê²€ìˆ˜ ì´ë ¥ì„ ì¡°íšŒí•©ë‹ˆë‹¤.")
    @ApiResponses({
            @ApiResponse(responseCode = "200", description = "ì¡°íšŒ ì„±ê³µ"),
            @ApiResponse(responseCode = "404", description = "ì œì¶œ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ"),
            @ApiResponse(responseCode = "401", description = "ì¸ì¦ ì‹¤íŒ¨"),
            @ApiResponse(responseCode = "403", description = "Admin ê¶Œí•œ ì—†ìŒ")
    })
    public ApiData<List<AuditLogResponse>> getSubmissionLogs(
            @Parameter(description = "ì œì¶œ ID", required = true) @PathVariable Long submissionId) {
        List<AuditLogResponse> logs = submissionQueryService.getSubmissionLogs(submissionId);
        return ApiData.ok(logs);
    }

    /**
     * ë‹¨ê±´ ìŠ¹ì¸
     */
    @PostMapping("/{submissionId}/approve")
    @Operation(summary = "ë‹¨ê±´ ìŠ¹ì¸", description = "íŠ¹ì • ì œì¶œ ë°ì´í„°ë¥¼ ìŠ¹ì¸í•©ë‹ˆë‹¤.")
    @ApiResponses({
            @ApiResponse(responseCode = "200", description = "ìŠ¹ì¸ ì„±ê³µ"),
            @ApiResponse(responseCode = "404", description = "ì œì¶œ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ"),
            @ApiResponse(responseCode = "409", description = "ì´ë¯¸ ìŠ¹ì¸/ë°˜ë ¤/ì‚­ì œëœ ì œì¶œ"),
            @ApiResponse(responseCode = "401", description = "ì¸ì¦ ì‹¤íŒ¨"),
            @ApiResponse(responseCode = "403", description = "Admin ê¶Œí•œ ì—†ìŒ")
    })
    public ApiData<SubmissionDetailResponse> approveSubmission(
            @Parameter(description = "ì œì¶œ ID", required = true) @PathVariable Long submissionId) {
        SubmissionDetailResponse response = submissionCommandService.approveSubmission(submissionId);
        return ApiData.ok(response);
    }

    /**
     * ë‹¨ê±´ ë°˜ë ¤
     */
    @PostMapping("/{submissionId}/reject")
    @Operation(summary = "ë‹¨ê±´ ë°˜ë ¤", description = "íŠ¹ì • ì œì¶œ ë°ì´í„°ë¥¼ ë°˜ë ¤í•©ë‹ˆë‹¤. ë°˜ë ¤ ì‚¬ìœ ë¥¼ í•„ìˆ˜ë¡œ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤.")
    @ApiResponses({
            @ApiResponse(responseCode = "200", description = "ë°˜ë ¤ ì„±ê³µ"),
            @ApiResponse(responseCode = "404", description = "ì œì¶œ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ"),
            @ApiResponse(responseCode = "409", description = "ì´ë¯¸ ìŠ¹ì¸/ë°˜ë ¤/ì‚­ì œëœ ì œì¶œ"),
            @ApiResponse(responseCode = "422", description = "ë°˜ë ¤ ì‚¬ìœ ê°€ ê³µë€"),
            @ApiResponse(responseCode = "401", description = "ì¸ì¦ ì‹¤íŒ¨"),
            @ApiResponse(responseCode = "403", description = "Admin ê¶Œí•œ ì—†ìŒ")
    })
    public ApiData<SubmissionDetailResponse> rejectSubmission(
            @Parameter(description = "ì œì¶œ ID", required = true) @PathVariable Long submissionId,
            @RequestBody @Valid SingleRejectRequest request
    ) {
        SubmissionDetailResponse response = submissionCommandService.rejectSubmission(submissionId, request);
        return ApiData.ok(response);
    }

    /**
     * ë‹¨ê±´ ì‚­ì œ
     */
    @DeleteMapping("/{submissionId}")
    @Operation(summary = "ë‹¨ê±´ ì‚­ì œ", description = "íŠ¹ì • ì œì¶œ ë°ì´í„°ë¥¼ ì˜êµ¬ ì‚­ì œí•©ë‹ˆë‹¤.")
    @ApiResponses({
            @ApiResponse(responseCode = "204", description = "ì‚­ì œ ì„±ê³µ"),
            @ApiResponse(responseCode = "404", description = "ì œì¶œ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ"),
            @ApiResponse(responseCode = "401", description = "ì¸ì¦ ì‹¤íŒ¨"),
            @ApiResponse(responseCode = "403", description = "Admin ê¶Œí•œ ì—†ìŒ")
    })
    public ResponseEntity<Void> deleteSubmission(
            @Parameter(description = "ì œì¶œ ID", required = true) @PathVariable Long submissionId,
            @RequestBody(required = false) SingleDeleteRequest request
    ) {
        if (request == null) {
            request = new SingleDeleteRequest(null);
        }
        submissionCommandService.deleteSubmission(submissionId, request);
        return ResponseEntity.noContent().build();
    }

    /**
     * ì¼ê´„ ìŠ¹ì¸
     */
    @PostMapping("/bulk/approve")
    @Operation(summary = "ì¼ê´„ ìŠ¹ì¸", description = "ì—¬ëŸ¬ ì œì¶œ ë°ì´í„°ë¥¼ í•œ ë²ˆì— ìŠ¹ì¸í•©ë‹ˆë‹¤.")
    @ApiResponses({
            @ApiResponse(responseCode = "200", description = "ì¼ê´„ ìŠ¹ì¸ ì™„ë£Œ"),
            @ApiResponse(responseCode = "401", description = "ì¸ì¦ ì‹¤íŒ¨"),
            @ApiResponse(responseCode = "403", description = "Admin ê¶Œí•œ ì—†ìŒ")
    })
    public ApiData<BulkApproveResponse> bulkApprove(
            @RequestBody @Valid BulkApproveRequest request
    ) {
        BulkApproveResponse response = submissionCommandService.bulkApprove(request);
        return ApiData.ok(response);
    }

    /**
     * ì¼ê´„ ë°˜ë ¤
     */
    @PostMapping("/bulk/reject")
    @Operation(summary = "ì¼ê´„ ë°˜ë ¤", description = "ì—¬ëŸ¬ ì œì¶œ ë°ì´í„°ë¥¼ í•œ ë²ˆì— ë°˜ë ¤í•©ë‹ˆë‹¤. ë°˜ë ¤ ì‚¬ìœ ë¥¼ í•„ìˆ˜ë¡œ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤.")
    @ApiResponses({
            @ApiResponse(responseCode = "200", description = "ì¼ê´„ ë°˜ë ¤ ì™„ë£Œ"),
            @ApiResponse(responseCode = "422", description = "ë°˜ë ¤ ì‚¬ìœ ê°€ ê³µë€"),
            @ApiResponse(responseCode = "401", description = "ì¸ì¦ ì‹¤íŒ¨"),
            @ApiResponse(responseCode = "403", description = "Admin ê¶Œí•œ ì—†ìŒ")
    })
    public ApiData<BulkRejectResponse> bulkReject(
            @RequestBody @Valid BulkRejectRequest request
    ) {
        BulkRejectResponse response = submissionCommandService.bulkReject(request);
        return ApiData.ok(response);
    }

    /**
     * ì¼ê´„ ì‚­ì œ
     */
    @DeleteMapping("/bulk")
    @Operation(summary = "ì¼ê´„ ì‚­ì œ", description = "ì—¬ëŸ¬ ì œì¶œ ë°ì´í„°ë¥¼ í•œ ë²ˆì— ì˜êµ¬ ì‚­ì œí•©ë‹ˆë‹¤.")
    @ApiResponses({
            @ApiResponse(responseCode = "200", description = "ì¼ê´„ ì‚­ì œ ì™„ë£Œ"),
            @ApiResponse(responseCode = "401", description = "ì¸ì¦ ì‹¤íŒ¨"),
            @ApiResponse(responseCode = "403", description = "Admin ê¶Œí•œ ì—†ìŒ")
    })
    public ApiData<BulkDeleteResponse> bulkDelete(
            @RequestBody @Valid BulkDeleteRequest request
    ) {
        BulkDeleteResponse response = submissionCommandService.bulkDelete(request);
        return ApiData.ok(response);
    }
}


================================================================================
File Path: .\src\main\java\com\ocean\piuda\admin\submission\dto\request\BulkApproveRequest.java
================================================================================

package com.ocean.piuda.admin.submission.dto.request;

import jakarta.validation.constraints.NotEmpty;

import java.util.List;

public record BulkApproveRequest(
        @NotEmpty(message = "ìŠ¹ì¸í•  ì œì¶œ ID ëª©ë¡ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.")
        List<Long> ids
) {
}


================================================================================
File Path: .\src\main\java\com\ocean\piuda\admin\submission\dto\request\BulkDeleteRequest.java
================================================================================

package com.ocean.piuda.admin.submission.dto.request;

import jakarta.validation.constraints.NotEmpty;

import java.util.List;

public record BulkDeleteRequest(
        @NotEmpty(message = "ì‚­ì œí•  ì œì¶œ ID ëª©ë¡ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.")
        List<Long> ids,
        
        String reason
) {
}


================================================================================
File Path: .\src\main\java\com\ocean\piuda\admin\submission\dto\request\BulkRejectRequest.java
================================================================================

package com.ocean.piuda.admin.submission.dto.request;

import jakarta.validation.Valid;
import jakarta.validation.constraints.NotEmpty;
import jakarta.validation.constraints.NotNull;

import java.util.List;

public record BulkRejectRequest(
        @NotEmpty(message = "ë°˜ë ¤í•  ì œì¶œ ID ëª©ë¡ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.")
        List<Long> ids,
        
        @NotNull(message = "ë°˜ë ¤ ì‚¬ìœ ëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤.")
        @Valid
        RejectReasonDto reason
) {
}


================================================================================
File Path: .\src\main\java\com\ocean\piuda\admin\submission\dto\request\CreateSubmissionRequest.java
================================================================================

package com.ocean.piuda.admin.submission.dto.request;

import com.ocean.piuda.admin.common.enums.ActivityType;
import com.ocean.piuda.admin.common.enums.CurrentState;
import com.ocean.piuda.admin.common.enums.HealthGrade;
import com.ocean.piuda.admin.common.enums.ParticipantRole;
import com.ocean.piuda.admin.common.enums.Weather;
import jakarta.validation.Valid;
import jakarta.validation.constraints.NotBlank;
import jakarta.validation.constraints.NotNull;
import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Getter;
import lombok.NoArgsConstructor;

import java.math.BigDecimal;
import java.time.LocalDate;
import java.time.LocalDateTime;
import java.time.LocalTime;
import java.util.List;

@Getter
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class CreateSubmissionRequest {

    @NotBlank(message = "í˜„ì¥ëª…ì€ í•„ìˆ˜ì…ë‹ˆë‹¤")
    private String siteName;

    @NotNull(message = "í™œë™ìœ í˜•ì€ í•„ìˆ˜ì…ë‹ˆë‹¤")
    private ActivityType activityType;

    private LocalDateTime submittedAt; // nullì´ë©´ í˜„ì¬ ì‹œê°„ ì‚¬ìš©

    @NotBlank(message = "ì‘ì„±ìëª…ì€ í•„ìˆ˜ì…ë‹ˆë‹¤")
    private String authorName;

    private String authorEmail;

    private String feedbackText;

    private BigDecimal latitude;
    private BigDecimal longitude;

    @Valid
    private BasicEnvDto basicEnv;

    @Valid
    private ParticipantsDto participants;

    @Valid
    @NotNull(message = "í™œë™ ì •ë³´ëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤")
    private ActivityDto activity;

    @Valid
    private List<AttachmentDto> attachments;

    @Getter
    @Builder
    @NoArgsConstructor
    @AllArgsConstructor
    public static class BasicEnvDto {
        private LocalDate recordDate;
        private LocalTime startTime;
        private LocalTime endTime;
        private Float waterTempC;
        private Float visibilityM;
        private Float depthM;
        private CurrentState currentState;
        private Weather weather;
    }

    @Getter
    @Builder
    @NoArgsConstructor
    @AllArgsConstructor
    public static class ParticipantsDto {
        private String leaderName;
        private Integer participantCount;
        private ParticipantRole role;
    }

    @Getter
    @Builder
    @NoArgsConstructor
    @AllArgsConstructor
    public static class ActivityDto {
        @NotNull(message = "í™œë™ìœ í˜•ì€ í•„ìˆ˜ì…ë‹ˆë‹¤")
        private ActivityType type;
        private String details;
        private Float collectionAmount;
        private Float durationHours;

        // --- ì¶”ê°€ëœ í•„ë“œ ---
        private HealthGrade healthGrade;
        private Float growthCm;
        private NaturalReproductionDto naturalReproduction;
        private SurvivalDto survival;
    }

    @Getter
    @Builder
    @NoArgsConstructor
    @AllArgsConstructor
    public static class NaturalReproductionDto {
        private Float radiusM;
        private Float numerator;
        private Float denominator;
    }

    @Getter
    @Builder
    @NoArgsConstructor
    @AllArgsConstructor
    public static class SurvivalDto {
        private Float dieCount;
        private Float totalCount;
    }

    @Getter
    @Builder
    @NoArgsConstructor
    @AllArgsConstructor
    public static class AttachmentDto {
        private String fileName;
        private String fileUrl;
        private String mimeType;
        private Integer fileSize;
    }
}


================================================================================
File Path: .\src\main\java\com\ocean\piuda\admin\submission\dto\request\RejectReasonDto.java
================================================================================

package com.ocean.piuda.admin.submission.dto.request;

public record RejectReasonDto(
        String templateCode,
        String message
) {
}


================================================================================
File Path: .\src\main\java\com\ocean\piuda\admin\submission\dto\request\SingleDeleteRequest.java
================================================================================

package com.ocean.piuda.admin.submission.dto.request;

public record SingleDeleteRequest(
        String reason
) {
}


================================================================================
File Path: .\src\main\java\com\ocean\piuda\admin\submission\dto\request\SingleRejectRequest.java
================================================================================

package com.ocean.piuda.admin.submission.dto.request;

import jakarta.validation.Valid;
import jakarta.validation.constraints.NotNull;

public record SingleRejectRequest(
        @NotNull(message = "ë°˜ë ¤ ì‚¬ìœ ëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤.")
        @Valid
        RejectReasonDto reason
) {
}


================================================================================
File Path: .\src\main\java\com\ocean\piuda\admin\submission\dto\response\ActivityResponse.java
================================================================================

package com.ocean.piuda.admin.submission.dto.response;

import com.ocean.piuda.admin.common.enums.ActivityType;
import com.ocean.piuda.admin.common.enums.HealthGrade;
import com.ocean.piuda.admin.submission.entity.Activity;
import com.ocean.piuda.admin.submission.entity.embeded.NaturalReproduction;
import com.ocean.piuda.admin.submission.entity.embeded.Survival;

public record ActivityResponse(
        ActivityType type,
        String details,
        Float collectionAmount,
        Float durationHours,

        // --- ì¶”ê°€ëœ í•„ë“œ ---
        HealthGrade healthGrade,
        Float growthCm,
        NaturalReproductionResponse naturalReproduction,
        SurvivalResponse survival
) {
    public static ActivityResponse from(Activity activity) {
        if (activity == null) return null;
        return new ActivityResponse(
                activity.getType(),
                activity.getDetails(),
                activity.getCollectionAmount(),
                activity.getDurationHours(),

                // ë§¤í•‘ ë¡œì§
                activity.getHealthGrade(),
                activity.getGrowthCm(),
                NaturalReproductionResponse.from(activity.getNaturalReproduction()),
                SurvivalResponse.from(activity.getSurvival())
        );
    }

    // --- ë‚´ë¶€ ë ˆì½”ë“œ ì •ì˜ ---
    public record NaturalReproductionResponse(
            Float radiusM,
            Float numerator,
            Float denominator
    ) {
        public static NaturalReproductionResponse from(NaturalReproduction vo) {
            if (vo == null) return null;
            return new NaturalReproductionResponse(vo.getRadiusM(), vo.getNumerator(), vo.getDenominator());
        }
    }

    public record SurvivalResponse(
            Float dieCount,
            Float totalCount
    ) {
        public static SurvivalResponse from(Survival vo) {
            if (vo == null) return null;
            return new SurvivalResponse(vo.getDieCount(), vo.getTotalCount());
        }
    }
}


================================================================================
File Path: .\src\main\java\com\ocean\piuda\admin\submission\dto\response\AttachmentResponse.java
================================================================================

package com.ocean.piuda.admin.submission.dto.response;

import com.ocean.piuda.admin.submission.entity.Attachment;

import java.time.LocalDateTime;

public record AttachmentResponse(
        Long attachmentId,
        String fileName,
        String fileUrl,
        String mimeType,
        Integer fileSize,
        LocalDateTime uploadedAt
) {
    public static AttachmentResponse from(Attachment attachment) {
        if (attachment == null) return null;
        return new AttachmentResponse(
                attachment.getAttachmentId(),
                attachment.getFileName(),
                attachment.getFileUrl(),
                attachment.getMimeType(),
                attachment.getFileSize(),
                attachment.getUploadedAt()
        );
    }
}


================================================================================
File Path: .\src\main\java\com\ocean\piuda\admin\submission\dto\response\AuditLogResponse.java
================================================================================

package com.ocean.piuda.admin.submission.dto.response;

import com.ocean.piuda.admin.common.enums.AuditAction;
import com.ocean.piuda.admin.submission.entity.AuditLog;

import java.time.LocalDateTime;

public record AuditLogResponse(
        Long logId,
        AuditAction action,
        String performedBy,
        String comment,
        LocalDateTime createdAt
) {
    public static AuditLogResponse from(AuditLog auditLog) {
        if (auditLog == null) return null;
        return new AuditLogResponse(
                auditLog.getLogId(),
                auditLog.getAction(),
                auditLog.getPerformedBy(),
                auditLog.getComment(),
                auditLog.getCreatedAt()
        );
    }
}


================================================================================
File Path: .\src\main\java\com\ocean\piuda\admin\submission\dto\response\BasicEnvResponse.java
================================================================================

package com.ocean.piuda.admin.submission.dto.response;

import com.ocean.piuda.admin.common.enums.CurrentState;
import com.ocean.piuda.admin.common.enums.Weather;
import com.ocean.piuda.admin.submission.entity.BasicEnv;

import java.time.LocalDate;
import java.time.LocalTime;

public record BasicEnvResponse(
        LocalDate recordDate,
        LocalTime startTime,
        LocalTime endTime,
        Float waterTempC,
        Float visibilityM,
        Float depthM,
        CurrentState currentState,
        Weather weather
) {
    public static BasicEnvResponse from(BasicEnv basicEnv) {
        if (basicEnv == null) return null;
        return new BasicEnvResponse(
                basicEnv.getRecordDate(),
                basicEnv.getStartTime(),
                basicEnv.getEndTime(),
                basicEnv.getWaterTempC(),
                basicEnv.getVisibilityM(),
                basicEnv.getDepthM(),
                basicEnv.getCurrentState(),
                basicEnv.getWeather()
        );
    }
}


================================================================================
File Path: .\src\main\java\com\ocean\piuda\admin\submission\dto\response\BulkApproveResponse.java
================================================================================

package com.ocean.piuda.admin.submission.dto.response;

import java.util.List;

public record BulkApproveResponse(
        List<Long> approved,
        List<Long> skipped
) {}


================================================================================
File Path: .\src\main\java\com\ocean\piuda\admin\submission\dto\response\BulkDeleteResponse.java
================================================================================

package com.ocean.piuda.admin.submission.dto.response;

import java.util.List;

public record BulkDeleteResponse(
        List<Long> deleted,
        List<Long> failed
) {}


================================================================================
File Path: .\src\main\java\com\ocean\piuda\admin\submission\dto\response\BulkRejectResponse.java
================================================================================

package com.ocean.piuda.admin.submission.dto.response;

import java.util.List;

public record BulkRejectResponse(
        List<Long> rejected,
        List<Long> conflicts
) {}


================================================================================
File Path: .\src\main\java\com\ocean\piuda\admin\submission\dto\response\ParticipantsResponse.java
================================================================================

package com.ocean.piuda.admin.submission.dto.response;

import com.ocean.piuda.admin.common.enums.ParticipantRole;
import com.ocean.piuda.admin.submission.entity.Participants;

public record ParticipantsResponse(
        String leaderName,
        Integer participantCount,
        ParticipantRole role
) {
    public static ParticipantsResponse from(Participants participants) {
        if (participants == null) return null;
        return new ParticipantsResponse(
                participants.getLeaderName(),
                participants.getParticipantCount(),
                participants.getRole()
        );
    }
}


================================================================================
File Path: .\src\main\java\com\ocean\piuda\admin\submission\dto\response\SubmissionDetailResponse.java
================================================================================

package com.ocean.piuda.admin.submission.dto.response;

import com.ocean.piuda.admin.common.enums.ActivityType;
import com.ocean.piuda.admin.common.enums.SubmissionStatus;
import com.ocean.piuda.admin.submission.entity.Submission;

import java.math.BigDecimal;
import java.time.LocalDateTime;
import java.util.List;
import java.util.stream.Collectors;

public record SubmissionDetailResponse(
        Long submissionId,
        String siteName,
        ActivityType activityType,
        LocalDateTime submittedAt,
        SubmissionStatus status,
        String authorName,
        String authorEmail,
        Integer attachmentCount,
        String feedbackText,
        BigDecimal latitude,
        BigDecimal longitude,
        BasicEnvResponse basicEnv,
        ParticipantsResponse participants,
        ActivityResponse activity,
        List<AttachmentResponse> attachments,
        String rejectReason,
        List<AuditLogResponse> auditLogs,
        LocalDateTime createdAt,
        LocalDateTime modifiedAt
) {
    public static SubmissionDetailResponse from(Submission submission) {
        List<AttachmentResponse> attachments = null;
        if (submission.getAttachments() != null) {
            attachments = submission.getAttachments().stream()
                    .map(AttachmentResponse::from)
                    .collect(Collectors.toList());
        }

        List<AuditLogResponse> auditLogs = null;
        if (submission.getAuditLogs() != null) {
            auditLogs = submission.getAuditLogs().stream()
                    .map(AuditLogResponse::from)
                    .collect(Collectors.toList());
        }

        String rejectReason = null;
        if (submission.getRejectReason() != null) {
            rejectReason = submission.getRejectReason().getMessage();
        }

        return new SubmissionDetailResponse(
                submission.getSubmissionId(),
                submission.getSiteName(),
                submission.getActivityType(),
                submission.getSubmittedAt(),
                submission.getStatus(),
                submission.getAuthorName(),
                submission.getAuthorEmail(),
                submission.getAttachmentCount(),
                submission.getFeedbackText(),
                submission.getLatitude(),
                submission.getLongitude(),
                BasicEnvResponse.from(submission.getBasicEnv()),
                ParticipantsResponse.from(submission.getParticipants()),
                ActivityResponse.from(submission.getActivity()),
                attachments,
                rejectReason,
                auditLogs,
                submission.getCreatedAt(),
                submission.getModifiedAt()
        );
    }
}


================================================================================
File Path: .\src\main\java\com\ocean\piuda\admin\submission\dto\response\SubmissionListResponse.java
================================================================================

package com.ocean.piuda.admin.submission.dto.response;

import com.ocean.piuda.admin.common.enums.ActivityType;
import com.ocean.piuda.admin.common.enums.SubmissionStatus;
import com.ocean.piuda.admin.submission.entity.Submission;

import java.math.BigDecimal;
import java.time.LocalDateTime;

public record SubmissionListResponse(
        Long submissionId,
        String siteName,
        ActivityType activityType,
        LocalDateTime submittedAt,
        SubmissionStatus status,
        String authorName,
        String authorEmail,
        Integer attachmentCount
) {
    public static SubmissionListResponse from(Submission submission) {
        return new SubmissionListResponse(
                submission.getSubmissionId(),
                submission.getSiteName(),
                submission.getActivityType(),
                submission.getSubmittedAt(),
                submission.getStatus(),
                submission.getAuthorName(),
                submission.getAuthorEmail(),
                submission.getAttachmentCount()
        );
    }
}


================================================================================
File Path: .\src\main\java\com\ocean\piuda\admin\submission\entity\Activity.java
================================================================================

package com.ocean.piuda.admin.submission.entity;

import com.ocean.piuda.admin.common.enums.ActivityType;
import com.ocean.piuda.admin.common.enums.HealthGrade;
import com.ocean.piuda.admin.submission.entity.embeded.NaturalReproduction;
import com.ocean.piuda.admin.submission.entity.embeded.Survival;
import jakarta.persistence.*;
import lombok.*;
import lombok.experimental.SuperBuilder;

@Entity
@Table(name = "activity")
@Getter
@NoArgsConstructor
@AllArgsConstructor
@SuperBuilder(toBuilder = true)
public class Activity {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    @Column(name = "activity_id")
    private Long activityId;

    @OneToOne
    @JoinColumn(name = "submission_id", nullable = false)
    private Submission submission;

    @Enumerated(EnumType.STRING)
    @Column(nullable = false)
    private ActivityType type;

    @Column(columnDefinition = "TEXT")
    private String details;

    @Column(name = "collection_amount")
    @Builder.Default
    private Float collectionAmount = 0f;

    @Column(name = "duration_hours")
    @Builder.Default
    private Float durationHours = 0f;


    @Enumerated(EnumType.STRING)
    @Column(name = "health_grade")
    private HealthGrade healthGrade;

    @Column(name = "growth_cm")
    @Builder.Default
    private Float growthCm = 0f;

    @Embedded
    private NaturalReproduction naturalReproduction;

    @Embedded
    private Survival survival;


    public void updateSubmission(Submission submission) {
        this.submission = submission;
    }
}


================================================================================
File Path: .\src\main\java\com\ocean\piuda\admin\submission\entity\Attachment.java
================================================================================

package com.ocean.piuda.admin.submission.entity;

import jakarta.persistence.*;
import lombok.*;
import lombok.experimental.SuperBuilder;

import java.time.LocalDateTime;

@Entity
@Table(name = "attachment")
@Getter
@NoArgsConstructor
@AllArgsConstructor
@SuperBuilder(toBuilder = true)
public class Attachment {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    @Column(name = "attachment_id")
    private Long attachmentId;

    @ManyToOne
    @JoinColumn(name = "submission_id", nullable = false)
    private Submission submission;

    @Column(name = "file_name", length = 255)
    private String fileName;

    @Column(name = "file_url", nullable = false, length = 500)
    private String fileUrl;

    @Column(name = "mime_type", length = 50)
    private String mimeType;

    @Column(name = "file_size")
    private Integer fileSize;

    @Column(name = "uploaded_at")
    @Builder.Default
    private LocalDateTime uploadedAt = LocalDateTime.now();

    public void updateSubmission(Submission submission) {
        this.submission = submission;
    }
}


================================================================================
File Path: .\src\main\java\com\ocean\piuda\admin\submission\entity\AuditLog.java
================================================================================

package com.ocean.piuda.admin.submission.entity;

import com.ocean.piuda.admin.common.enums.AuditAction;
import com.ocean.piuda.global.api.domain.BaseEntity;
import jakarta.persistence.*;
import lombok.*;
import lombok.experimental.SuperBuilder;

@Entity
@Table(name = "audit_log")
@Getter
@NoArgsConstructor
@AllArgsConstructor
@SuperBuilder(toBuilder = true)
public class AuditLog extends BaseEntity {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    @Column(name = "log_id")
    private Long logId;

    @ManyToOne
    @JoinColumn(name = "submission_id", nullable = false)
    private Submission submission;

    @Enumerated(EnumType.STRING)
    @Column(nullable = false)
    private AuditAction action;

    @Column(name = "performed_by", nullable = false, length = 100)
    private String performedBy;

    @Column(length = 500)
    private String comment;

    public void updateSubmission(Submission submission) {
        this.submission = submission;
    }
}


================================================================================
File Path: .\src\main\java\com\ocean\piuda\admin\submission\entity\BasicEnv.java
================================================================================

package com.ocean.piuda.admin.submission.entity;

import com.ocean.piuda.admin.common.enums.CurrentState;
import com.ocean.piuda.admin.common.enums.Weather;
import jakarta.persistence.*;
import lombok.*;
import lombok.experimental.SuperBuilder;

import java.time.LocalDate;
import java.time.LocalTime;

@Entity
@Table(name = "basic_env")
@Getter
@NoArgsConstructor
@AllArgsConstructor
@SuperBuilder(toBuilder = true)
public class BasicEnv {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    @Column(name = "env_id")
    private Long envId;

    @OneToOne
    @JoinColumn(name = "submission_id", nullable = false)
    private Submission submission;

    @Column(name = "record_date", nullable = false)
    private LocalDate recordDate;

    @Column(name = "start_time")
    private LocalTime startTime;

    @Column(name = "end_time")
    private LocalTime endTime;

    @Column(name = "water_temp_c")
    private Float waterTempC;

    @Column(name = "visibility_m")
    private Float visibilityM;

    @Column(name = "depth_m")
    private Float depthM;

    @Enumerated(EnumType.STRING)
    @Column(name = "current_state")
    private CurrentState currentState;

    @Enumerated(EnumType.STRING)
    private Weather weather;

    public void updateSubmission(Submission submission) {
        this.submission = submission;
    }
}


================================================================================
File Path: .\src\main\java\com\ocean\piuda\admin\submission\entity\embeded\NaturalReproduction.java
================================================================================

package com.ocean.piuda.admin.submission.entity.embeded;

import jakarta.persistence.Column;
import jakarta.persistence.Embeddable;
import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Getter;
import lombok.NoArgsConstructor;

@Embeddable
@Getter
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class NaturalReproduction {

    @Column(name = "nat_radius_m")
    private Float radiusM;      // ê´€ì¸¡ ë°˜ê²½

    @Column(name = "nat_numerator")
    private Float numerator;    // ìì—°ë²ˆì‹ ê°œì²´ìˆ˜

    @Column(name = "nat_denominator")
    private Float denominator;  // ê¸°ì¤€ ê°œì²´ìˆ˜
}


================================================================================
File Path: .\src\main\java\com\ocean\piuda\admin\submission\entity\embeded\Survival.java
================================================================================

package com.ocean.piuda.admin.submission.entity.embeded;


import jakarta.persistence.Column;
import jakarta.persistence.Embeddable;
import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Getter;
import lombok.NoArgsConstructor;

@Embeddable
@Getter
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class Survival {

    @Column(name = "surv_die_count")
    private Float dieCount;     // ì£½ì€ ê°œì²´ìˆ˜

    @Column(name = "surv_total_count")
    private Float totalCount;   // ì´ ê°œì²´ìˆ˜
}


================================================================================
File Path: .\src\main\java\com\ocean\piuda\admin\submission\entity\Participants.java
================================================================================

package com.ocean.piuda.admin.submission.entity;

import com.ocean.piuda.admin.common.enums.ParticipantRole;
import jakarta.persistence.*;
import lombok.*;
import lombok.experimental.SuperBuilder;

@Entity
@Table(name = "participants")
@Getter
@NoArgsConstructor
@AllArgsConstructor
@SuperBuilder(toBuilder = true)
public class Participants {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    @Column(name = "participant_id")
    private Long participantId;

    @OneToOne
    @JoinColumn(name = "submission_id", nullable = false)
    private Submission submission;

    @Column(name = "leader_name", length = 100)
    private String leaderName;

    @Column(name = "participant_count")
    @Builder.Default
    private Integer participantCount = 1;

    @Enumerated(EnumType.STRING)
    @Builder.Default
    private ParticipantRole role = ParticipantRole.CITIZEN_DIVER;

    public void updateSubmission(Submission submission) {
        this.submission = submission;
    }
}


================================================================================
File Path: .\src\main\java\com\ocean\piuda\admin\submission\entity\RejectReason.java
================================================================================

package com.ocean.piuda.admin.submission.entity;

import jakarta.persistence.*;
import lombok.*;
import lombok.experimental.SuperBuilder;

import java.time.LocalDateTime;

@Entity
@Table(name = "reject_reason")
@Getter
@NoArgsConstructor
@AllArgsConstructor
@SuperBuilder(toBuilder = true)
public class RejectReason {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    @Column(name = "reason_id")
    private Long reasonId;

    @OneToOne
    @JoinColumn(name = "submission_id", nullable = false)
    private Submission submission;

    @Column(name = "template_code", length = 100)
    private String templateCode;

    @Column(nullable = false, length = 500)
    private String message;

    @Column(name = "rejected_by", nullable = false, length = 100)
    private String rejectedBy;

    @Column(name = "rejected_at")
    @Builder.Default
    private LocalDateTime rejectedAt = LocalDateTime.now();

    public void updateSubmission(Submission submission) {
        this.submission = submission;
    }
}


================================================================================
File Path: .\src\main\java\com\ocean\piuda\admin\submission\entity\Submission.java
================================================================================

package com.ocean.piuda.admin.submission.entity;

import com.ocean.piuda.admin.common.enums.ActivityType;
import com.ocean.piuda.admin.common.enums.SubmissionStatus;
import com.ocean.piuda.global.api.domain.BaseEntity;
import jakarta.persistence.*;
import lombok.*;
import lombok.experimental.SuperBuilder;

import java.math.BigDecimal;
import java.util.ArrayList;
import java.util.HashSet;
import java.util.List;
import java.util.Set;

@Entity
@Table(name = "submission")
@Getter
@NoArgsConstructor
@AllArgsConstructor
@SuperBuilder(toBuilder = true)
public class Submission extends BaseEntity {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    @Column(name = "submission_id")
    private Long submissionId;

    @Column(name = "site_name", nullable = false, length = 200)
    private String siteName;

    @Enumerated(EnumType.STRING)
    @Column(name = "activity_type", nullable = false)
    private ActivityType activityType;

    @Column(name = "submitted_at", nullable = false)
    private java.time.LocalDateTime submittedAt;

    @Enumerated(EnumType.STRING)
    @Column(nullable = false)
    @Builder.Default
    private SubmissionStatus status = SubmissionStatus.PENDING;

    @Column(name = "author_name", nullable = false, length = 100)
    private String authorName;

    @Column(name = "author_email", length = 200)
    private String authorEmail;

    @Column(name = "attachment_count")
    @Builder.Default
    private Integer attachmentCount = 0;

    @Column(name = "feedback_text", columnDefinition = "TEXT")
    private String feedbackText;

    @Column(precision = 9, scale = 6)
    private BigDecimal latitude;

    @Column(precision = 9, scale = 6)
    private BigDecimal longitude;

    // ê´€ê³„ ë§¤í•‘
    @OneToOne(mappedBy = "submission", cascade = CascadeType.ALL, orphanRemoval = true)
    private BasicEnv basicEnv;

    @OneToOne(mappedBy = "submission", cascade = CascadeType.ALL, orphanRemoval = true)
    private Participants participants;

    @OneToOne(mappedBy = "submission", cascade = CascadeType.ALL, orphanRemoval = true)
    private Activity activity;

    @OneToMany(mappedBy = "submission", cascade = CascadeType.ALL, orphanRemoval = true)
    @Builder.Default
    private List<Attachment> attachments = new ArrayList<>();

    @OneToOne(mappedBy = "submission", cascade = CascadeType.ALL, orphanRemoval = true)
    private RejectReason rejectReason;

    @OneToMany(mappedBy = "submission", cascade = CascadeType.ALL, orphanRemoval = true)
    @Builder.Default
    private List<AuditLog> auditLogs = new ArrayList<>();

    // ë¹„ì¦ˆë‹ˆìŠ¤ ë©”ì„œë“œ
    public void updateStatus(SubmissionStatus status) {
        this.status = status;
    }

    public void addAttachment(Attachment attachment) {
        attachments.add(attachment);
        attachment.updateSubmission(this);
        this.attachmentCount = attachments.size();
    }

    public void addAuditLog(AuditLog auditLog) {
        auditLogs.add(auditLog);
        auditLog.updateSubmission(this);
    }

    public void setBasicEnv(BasicEnv basicEnv) {
        this.basicEnv = basicEnv;
        if (basicEnv != null) {
            basicEnv.updateSubmission(this);
        }
    }

    public void setParticipants(Participants participants) {
        this.participants = participants;
        if (participants != null) {
            participants.updateSubmission(this);
        }
    }

    public void setActivity(Activity activity) {
        this.activity = activity;
        if (activity != null) {
            activity.updateSubmission(this);
        }
    }

    public void setRejectReason(RejectReason rejectReason) {
        this.rejectReason = rejectReason;
        if (rejectReason != null) {
            rejectReason.updateSubmission(this);
        }
    }
}


================================================================================
File Path: .\src\main\java\com\ocean\piuda\admin\submission\initializer\SubmissionDataInitializer.java
================================================================================

package com.ocean.piuda.admin.submission.initializer;

import com.ocean.piuda.admin.common.enums.*;
import com.ocean.piuda.admin.submission.entity.*;
import com.ocean.piuda.admin.submission.repository.SubmissionRepository;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.boot.CommandLineRunner;
import org.springframework.context.annotation.Profile;
import org.springframework.core.annotation.Order;
import org.springframework.stereotype.Component;
import org.springframework.transaction.annotation.Transactional;

import java.math.BigDecimal;
import java.time.LocalDate;
import java.time.LocalDateTime;
import java.time.LocalTime;
import java.util.ArrayList;
import java.util.List;

@Slf4j
@Component
@RequiredArgsConstructor
@Profile("!prod") // í”„ë¡œë•ì…˜ í™˜ê²½ì—ì„œëŠ” ì‹¤í–‰ë˜ì§€ ì•ŠìŒ
@Order(1)
public class SubmissionDataInitializer implements CommandLineRunner {

    private final SubmissionRepository submissionRepository;

    @Override
    @Transactional
    public void run(String... args) {
        if (submissionRepository.count() > 0) {
            log.info("Submission ë°ì´í„°ê°€ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤. ì´ˆê¸°í™”ë¥¼ ê±´ë„ˆëœë‹ˆë‹¤.");
            return;
        }

        log.info("Admin Submission í…ŒìŠ¤íŠ¸ ë°ì´í„° ì´ˆê¸°í™” ì‹œì‘...");

        List<Submission> submissions = new ArrayList<>();

        // 1. ê²€ìˆ˜ ëŒ€ê¸° ì¤‘ì¸ ì œì¶œ (PENDING)
        submissions.add(createSubmission(
                1L,
                "í¬í•­ í•´ì•ˆê°€",
                ActivityType.TRANSPLANT,
                SubmissionStatus.PENDING,
                "í™ê¸¸ë™",
                "hong@example.com",
                3,
                "ê¹¨ë—í•´ì§„ ë°”ë‹¤ê°€ ë¿Œë“¯í•©ë‹ˆë‹¤",
                new BigDecimal("36.0322"),
                new BigDecimal("129.3650"),
                LocalDate.now().minusDays(2),
                LocalTime.of(9, 0),
                LocalTime.of(12, 30),
                18.5f,
                15.0f,
                10.5f,
                CurrentState.MEDIUM,
                Weather.SUNNY,
                "í™ê¸¸ë™",
                5,
                ParticipantRole.CITIZEN_DIVER,
                "ì´ì‹ ì‘ì—…ì„ ìˆ˜í–‰í–ˆìŠµë‹ˆë‹¤. ì´ 50ê°œë¥¼ ì´ì‹í–ˆìŠµë‹ˆë‹¤.",
                50.0f,
                3.5f,
                "public/user_objects/2025-01-15/photo1.jpg"
        ));

        // 2. ìŠ¹ì¸ëœ ì œì¶œ (APPROVED)
        submissions.add(createSubmission(
                2L,
                "ë¶€ì‚° ì†¡ë„í•´ìˆ˜ìš•ì¥",
                ActivityType.TRASH_COLLECTION,
                SubmissionStatus.APPROVED,
                "ê¹€ì² ìˆ˜",
                "kim@example.com",
                2,
                "í•´ë³€ ì²­ì†Œ í™œë™ì— ì°¸ì—¬í–ˆìŠµë‹ˆë‹¤",
                new BigDecimal("35.0784"),
                new BigDecimal("129.0756"),
                LocalDate.now().minusDays(5),
                LocalTime.of(10, 0),
                LocalTime.of(14, 0),
                20.0f,
                20.0f,
                5.0f,
                CurrentState.LOW,
                Weather.SUNNY,
                "ê¹€ì² ìˆ˜",
                3,
                ParticipantRole.CITIZEN_DIVER,
                "í”Œë¼ìŠ¤í‹± ë³‘ 30ê°œ, ìº” 15ê°œë¥¼ ìˆ˜ê±°í–ˆìŠµë‹ˆë‹¤.",
                45.0f,
                4.0f,
                "public/user_objects/2025-01-10/photo2.jpg"
        ));

        // 3. ë°˜ë ¤ëœ ì œì¶œ (REJECTED)
        Submission rejectedSubmission = createSubmission(
                3L,
                "ì œì£¼ë„ ì„±ì‚°ì¼ì¶œë´‰",
                ActivityType.OTHER,
                SubmissionStatus.REJECTED,
                "ì´ì˜í¬",
                "lee@example.com",
                1,
                "ì œì£¼ë„ ë°”ë‹¤ ì •í™” í™œë™",
                new BigDecimal("33.4584"),
                new BigDecimal("126.9426"),
                LocalDate.now().minusDays(7),
                LocalTime.of(8, 0),
                LocalTime.of(11, 0),
                22.0f,
                25.0f,
                8.0f,
                CurrentState.LOW,
                Weather.CLOUDY,
                "ì´ì˜í¬",
                2,
                ParticipantRole.RESEARCHER,
                "í•´ì–‘ ìƒë¬¼ ê´€ì°° ë° ì •í™” í™œë™",
                10.0f,
                3.0f,
                "public/user_objects/2025-01-08/photo3.jpg"
        );
        RejectReason rejectReason = RejectReason.builder()
                .submission(rejectedSubmission)
                .templateCode("PHOTO_INSUFFICIENT")
                .message("ì‚¬ì§„ì´ ë¶€ì¡±í•©ë‹ˆë‹¤. ìµœì†Œ 3ì¥ ì´ìƒì˜ ì‚¬ì§„ì„ ì²¨ë¶€í•´ì£¼ì„¸ìš”.")
                .rejectedBy("admin@oceancampus.kr")
                .rejectedAt(LocalDateTime.now().minusDays(6))
                .build();
        rejectedSubmission.setRejectReason(rejectReason);
        submissions.add(rejectedSubmission);

        // 4. ê²€ìˆ˜ ëŒ€ê¸° ì¤‘ì¸ ì œì¶œ (PENDING) - ì¶”ê°€
        submissions.add(createSubmission(
                4L,
                "ê°•ì›ë„ ì†ì´ˆ í•´ë³€",
                ActivityType.TRANSPLANT,
                SubmissionStatus.PENDING,
                "ë°•ë¯¼ìˆ˜",
                "park@example.com",
                4,
                "ì†ì´ˆ ë°”ë‹¤ ì •í™” í™œë™ì— ì°¸ì—¬í–ˆìŠµë‹ˆë‹¤",
                new BigDecimal("38.2070"),
                new BigDecimal("128.5918"),
                LocalDate.now().minusDays(1),
                LocalTime.of(13, 0),
                LocalTime.of(17, 0),
                16.0f,
                12.0f,
                15.0f,
                CurrentState.HIGH,
                Weather.WINDY,
                "ë°•ë¯¼ìˆ˜",
                4,
                ParticipantRole.LOCAL_MANAGER,
                "ì´ì‹ 80ê°œ ì™„ë£Œ",
                80.0f,
                4.0f,
                "public/user_objects/2025-01-16/photo4.jpg"
        ));

        // 5. ìŠ¹ì¸ëœ ì œì¶œ (APPROVED) - ì¶”ê°€
        submissions.add(createSubmission(
                5L,
                "ì „ë¼ë‚¨ë„ ì—¬ìˆ˜ í•´ìˆ˜ìš•ì¥",
                ActivityType.TRASH_COLLECTION,
                SubmissionStatus.APPROVED,
                "ìµœì§€ì˜",
                "choi@example.com",
                5,
                "ì—¬ìˆ˜ ë°”ë‹¤ê°€ ì•„ë¦„ë‹µìŠµë‹ˆë‹¤",
                new BigDecimal("34.7604"),
                new BigDecimal("127.6622"),
                LocalDate.now().minusDays(10),
                LocalTime.of(9, 30),
                LocalTime.of(13, 30),
                19.0f,
                18.0f,
                7.0f,
                CurrentState.MEDIUM,
                Weather.SUNNY,
                "ìµœì§€ì˜",
                6,
                ParticipantRole.CITIZEN_DIVER,
                "ì“°ë ˆê¸° 100ê°œ ìˆ˜ê±° ì™„ë£Œ",
                100.0f,
                4.0f,
                "public/user_objects/2025-01-07/photo5.jpg"
        ));

        submissionRepository.saveAll(submissions);
        log.info("{}ê°œì˜ Submission í…ŒìŠ¤íŠ¸ ë°ì´í„° ìƒì„± ì™„ë£Œ", submissions.size());
    }

    private Submission createSubmission(
            Long id,
            String siteName,
            ActivityType activityType,
            SubmissionStatus status,
            String authorName,
            String authorEmail,
            int attachmentCount,
            String feedbackText,
            BigDecimal latitude,
            BigDecimal longitude,
            LocalDate recordDate,
            LocalTime startTime,
            LocalTime endTime,
            Float waterTempC,
            Float visibilityM,
            Float depthM,
            CurrentState currentState,
            Weather weather,
            String leaderName,
            int participantCount,
            ParticipantRole role,
            String activityDetails,
            Float collectionAmount,
            Float durationHours,
            String fileUrl
    ) {
        LocalDateTime submittedAt = LocalDateTime.of(recordDate, startTime);

        // BasicEnv ìƒì„±
        BasicEnv basicEnv = BasicEnv.builder()
                .recordDate(recordDate)
                .startTime(startTime)
                .endTime(endTime)
                .waterTempC(waterTempC)
                .visibilityM(visibilityM)
                .depthM(depthM)
                .currentState(currentState)
                .weather(weather)
                .build();

        // Participants ìƒì„±
        Participants participants = Participants.builder()
                .leaderName(leaderName)
                .participantCount(participantCount)
                .role(role)
                .build();

        // Activity ìƒì„±
        Activity activity = Activity.builder()
                .type(activityType)
                .details(activityDetails)
                .collectionAmount(collectionAmount)
                .durationHours(durationHours)
                .build();

        // Attachments ìƒì„±
        List<Attachment> attachments = new ArrayList<>();
        String baseUrl = fileUrl.substring(0, fileUrl.lastIndexOf("/") + 1);
        for (int i = 1; i <= attachmentCount; i++) {
            Attachment attachment = Attachment.builder()
                    .fileName("photo" + i + ".jpg")
                    .fileUrl(baseUrl + "photo" + i + ".jpg")
                    .mimeType("image/jpeg")
                    .fileSize(1024 * 500 * i) // 500KB * i
                    .uploadedAt(submittedAt)
                    .build();
            attachments.add(attachment);
        }

        // Submission ìƒì„±
        Submission submission = Submission.builder()
                .siteName(siteName)
                .activityType(activityType)
                .submittedAt(submittedAt)
                .status(status)
                .authorName(authorName)
                .authorEmail(authorEmail)
                .attachmentCount(attachmentCount)
                .feedbackText(feedbackText)
                .latitude(latitude)
                .longitude(longitude)
                .build();

        // ê´€ê³„ ì„¤ì •
        submission.setBasicEnv(basicEnv);
        submission.setParticipants(participants);
        submission.setActivity(activity);
        attachments.forEach(submission::addAttachment);

        // AuditLog ìƒì„± (ì œì¶œë¨)
        AuditLog submitLog = AuditLog.builder()
                .submission(submission)
                .action(AuditAction.SUBMITTED)
                .performedBy("system")
                .comment(null)
                .createdAt(submittedAt)
                .build();
        submission.addAuditLog(submitLog);

        // ìŠ¹ì¸/ë°˜ë ¤ëœ ê²½ìš° AuditLog ì¶”ê°€
        if (status == SubmissionStatus.APPROVED) {
            AuditLog approveLog = AuditLog.builder()
                    .submission(submission)
                    .action(AuditAction.APPROVED)
                    .performedBy("admin@oceancampus.kr")
                    .comment(null)
                    .createdAt(submittedAt.plusDays(1))
                    .build();
            submission.addAuditLog(approveLog);
        } else if (status == SubmissionStatus.REJECTED) {
            AuditLog rejectLog = AuditLog.builder()
                    .submission(submission)
                    .action(AuditAction.REJECTED)
                    .performedBy("admin@oceancampus.kr")
                    .comment("ì‚¬ì§„ì´ ë¶€ì¡±í•©ë‹ˆë‹¤. ìµœì†Œ 3ì¥ ì´ìƒì˜ ì‚¬ì§„ì„ ì²¨ë¶€í•´ì£¼ì„¸ìš”.")
                    .createdAt(submittedAt.plusDays(1))
                    .build();
            submission.addAuditLog(rejectLog);
        }

        return submission;
    }
}


================================================================================
File Path: .\src\main\java\com\ocean\piuda\admin\submission\repository\AuditLogRepository.java
================================================================================

package com.ocean.piuda.admin.submission.repository;

import com.ocean.piuda.admin.submission.entity.AuditLog;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.stereotype.Repository;

import java.util.List;

@Repository
public interface AuditLogRepository extends JpaRepository<AuditLog, Long> {
    List<AuditLog> findBySubmissionSubmissionIdOrderByCreatedAtDesc(Long submissionId);
}


================================================================================
File Path: .\src\main\java\com\ocean\piuda\admin\submission\repository\SubmissionRepository.java
================================================================================

package com.ocean.piuda.admin.submission.repository;

import com.ocean.piuda.admin.common.enums.ActivityType;
import com.ocean.piuda.admin.common.enums.SubmissionStatus;
import com.ocean.piuda.admin.submission.entity.Submission;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import org.springframework.stereotype.Repository;

import java.time.LocalDateTime;
import java.util.List;
import java.util.Optional;

@Repository
public interface SubmissionRepository extends JpaRepository<Submission, Long> {

    long countByStatus(SubmissionStatus status);

    @Query("""
        SELECT DISTINCT s FROM Submission s
        LEFT JOIN FETCH s.basicEnv
        LEFT JOIN FETCH s.participants
        LEFT JOIN FETCH s.activity
        LEFT JOIN FETCH s.attachments
        LEFT JOIN FETCH s.rejectReason
        WHERE s.submissionId = :id
        """)
    Optional<Submission> findByIdWithDetails(@Param("id") Long id);
    
    @Query("""
        SELECT DISTINCT s FROM Submission s
        LEFT JOIN FETCH s.auditLogs
        WHERE s.submissionId = :id
        """)
    Optional<Submission> findByIdWithAuditLogs(@Param("id") Long id);

    @Query("""
    SELECT DISTINCT s FROM Submission s
    LEFT JOIN FETCH s.basicEnv
    LEFT JOIN FETCH s.participants
    LEFT JOIN FETCH s.activity
    WHERE (:keyword IS NULL OR :keyword = '' OR 
           s.siteName LIKE %:keyword% OR 
           s.authorName LIKE %:keyword%)
      AND (:status IS NULL OR s.status = :status)
      AND (:activityType IS NULL OR s.activityType = :activityType)
      AND (cast(:startDate as timestamp) IS NULL OR s.submittedAt >= :startDate)
      AND (cast(:endDate as timestamp) IS NULL OR s.submittedAt <= :endDate)
    """)
    Page<Submission> findWithFilters(
            @Param("keyword") String keyword,
            @Param("status") SubmissionStatus status,
            @Param("activityType") ActivityType activityType,
            @Param("startDate") LocalDateTime startDate,
            @Param("endDate") LocalDateTime endDate,
            Pageable pageable
    );

    @Query("""
        SELECT DISTINCT s FROM Submission s
        LEFT JOIN FETCH s.basicEnv
        LEFT JOIN FETCH s.participants
        LEFT JOIN FETCH s.activity
        LEFT JOIN FETCH s.attachments
        WHERE s.status = :status
          AND s.submissionId IN :ids
        """)
    List<Submission> findAllByIdsAndStatusWithDetails(
            @Param("ids") List<Long> ids,
            @Param("status") SubmissionStatus status
    );
}



================================================================================
File Path: .\src\main\java\com\ocean\piuda\admin\submission\service\SubmissionCommandService.java
================================================================================

package com.ocean.piuda.admin.submission.service;

import com.ocean.piuda.admin.submission.dto.response.*;
import com.ocean.piuda.admin.common.enums.AuditAction;
import com.ocean.piuda.admin.common.enums.SubmissionStatus;
import com.ocean.piuda.admin.submission.dto.request.*;
import com.ocean.piuda.admin.submission.dto.response.SubmissionDetailResponse;
import com.ocean.piuda.admin.submission.entity.Activity;
import com.ocean.piuda.admin.submission.entity.Attachment;
import com.ocean.piuda.admin.submission.entity.AuditLog;
import com.ocean.piuda.admin.submission.entity.BasicEnv;
import com.ocean.piuda.admin.submission.entity.Participants;
import com.ocean.piuda.admin.submission.entity.RejectReason;
import com.ocean.piuda.admin.submission.entity.Submission;
import com.ocean.piuda.admin.submission.entity.embeded.NaturalReproduction;
import com.ocean.piuda.admin.submission.entity.embeded.Survival;
import com.ocean.piuda.admin.submission.repository.AuditLogRepository;
import com.ocean.piuda.admin.submission.repository.SubmissionRepository;
import com.ocean.piuda.global.api.exception.BusinessException;
import com.ocean.piuda.global.api.exception.ExceptionType;
import lombok.RequiredArgsConstructor;
import org.springframework.security.core.Authentication;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.time.LocalDateTime;
import java.util.ArrayList;
import java.util.List;

@Transactional
@Service
@RequiredArgsConstructor
public class SubmissionCommandService {

    private final SubmissionRepository submissionRepository;
    private final AuditLogRepository auditLogRepository;
    private final SubmissionQueryService submissionQueryService;

    /**
     * ì œì¶œ ë°ì´í„° ìƒì„±
     */
    public SubmissionDetailResponse createSubmission(CreateSubmissionRequest request) {
        // ê¸°ë³¸ê°’ ì„¤ì •
        LocalDateTime submittedAt = request.getSubmittedAt() != null
                ? request.getSubmittedAt()
                : LocalDateTime.now();

        // Submission ìƒì„±
        Submission submission = Submission.builder()
                .siteName(request.getSiteName())
                .activityType(request.getActivityType())
                .submittedAt(submittedAt)
                .status(SubmissionStatus.PENDING)
                .authorName(request.getAuthorName())
                .authorEmail(request.getAuthorEmail())
                .feedbackText(request.getFeedbackText())
                .latitude(request.getLatitude())
                .longitude(request.getLongitude())
                .attachmentCount(0)
                .build();

        // BasicEnv ìƒì„±
        if (request.getBasicEnv() != null) {
            CreateSubmissionRequest.BasicEnvDto envDto = request.getBasicEnv();
            BasicEnv basicEnv = BasicEnv.builder()
                    .recordDate(envDto.getRecordDate())
                    .startTime(envDto.getStartTime())
                    .endTime(envDto.getEndTime())
                    .waterTempC(envDto.getWaterTempC())
                    .visibilityM(envDto.getVisibilityM())
                    .depthM(envDto.getDepthM())
                    .currentState(envDto.getCurrentState())
                    .weather(envDto.getWeather())
                    .build();
            submission.setBasicEnv(basicEnv);
        }

        // Participants ìƒì„±
        if (request.getParticipants() != null) {
            CreateSubmissionRequest.ParticipantsDto participantsDto = request.getParticipants();
            Participants participants = Participants.builder()
                    .leaderName(participantsDto.getLeaderName())
                    .participantCount(participantsDto.getParticipantCount() != null
                            ? participantsDto.getParticipantCount()
                            : 1)
                    .role(participantsDto.getRole() != null
                            ? participantsDto.getRole()
                            : com.ocean.piuda.admin.common.enums.ParticipantRole.CITIZEN_DIVER)
                    .build();
            submission.setParticipants(participants);
        }

        // Activity ìƒì„± ë° ì‹ ê·œ í•„ë“œ ë§¤í•‘
        CreateSubmissionRequest.ActivityDto activityDto = request.getActivity();

        // NaturalReproduction VO ë¹Œë“œ
        NaturalReproduction naturalReproduction = null;
        if (activityDto.getNaturalReproduction() != null) {
            naturalReproduction = NaturalReproduction.builder()
                    .radiusM(activityDto.getNaturalReproduction().getRadiusM() != null ? activityDto.getNaturalReproduction().getRadiusM() : 0f)
                    .numerator(activityDto.getNaturalReproduction().getNumerator() != null ? activityDto.getNaturalReproduction().getNumerator() : 0f)
                    .denominator(activityDto.getNaturalReproduction().getDenominator() != null ? activityDto.getNaturalReproduction().getDenominator() : 0f)
                    .build();
        }

        // Survival VO ë¹Œë“œ
        Survival survival = null;
        if (activityDto.getSurvival() != null) {
            survival = Survival.builder()
                    .dieCount(activityDto.getSurvival().getDieCount() != null ? activityDto.getSurvival().getDieCount() : 0f)
                    .totalCount(activityDto.getSurvival().getTotalCount() != null ? activityDto.getSurvival().getTotalCount() : 0f)
                    .build();
        }

        Activity activity = Activity.builder()
                .type(activityDto.getType())
                .details(activityDto.getDetails())
                .collectionAmount(activityDto.getCollectionAmount() != null
                        ? activityDto.getCollectionAmount()
                        : 0f)
                .durationHours(activityDto.getDurationHours() != null
                        ? activityDto.getDurationHours()
                        : 0f)
                // ì¶”ê°€ëœ í•„ë“œ ë§¤í•‘
                .healthGrade(activityDto.getHealthGrade())
                .growthCm(activityDto.getGrowthCm() != null ? activityDto.getGrowthCm() : 0f)
                .naturalReproduction(naturalReproduction)
                .survival(survival)
                .build();

        submission.setActivity(activity);

        // Attachments ìƒì„±
        if (request.getAttachments() != null && !request.getAttachments().isEmpty()) {
            for (CreateSubmissionRequest.AttachmentDto attachmentDto : request.getAttachments()) {
                Attachment attachment = Attachment.builder()
                        .fileName(attachmentDto.getFileName())
                        .fileUrl(attachmentDto.getFileUrl())
                        .mimeType(attachmentDto.getMimeType())
                        .fileSize(attachmentDto.getFileSize())
                        .uploadedAt(submittedAt)
                        .build();
                submission.addAttachment(attachment);
            }
        }

        // ì €ì¥
        Submission saved = submissionRepository.save(submission);

        // AuditLog ìƒì„± (ì œì¶œë¨)
        createAuditLog(saved, AuditAction.SUBMITTED, null);

        return SubmissionDetailResponse.from(saved);
    }

    /**
     * ë‹¨ê±´ ìŠ¹ì¸
     */
    public SubmissionDetailResponse approveSubmission(Long submissionId) {
        Submission submission = submissionQueryService.getSubmissionById(submissionId);

        if (submission.getStatus() == SubmissionStatus.APPROVED) {
            throw new BusinessException(ExceptionType.SUBMISSION_ALREADY_APPROVED);
        }
        if (submission.getStatus() == SubmissionStatus.DELETED) {
            throw new BusinessException(ExceptionType.SUBMISSION_ALREADY_DELETED);
        }

        submission.updateStatus(SubmissionStatus.APPROVED);
        createAuditLog(submission, AuditAction.APPROVED, null);

        return SubmissionDetailResponse.from(submission);
    }

    /**
     * ë‹¨ê±´ ë°˜ë ¤
     */
    public SubmissionDetailResponse rejectSubmission(Long submissionId, SingleRejectRequest request) {
        Submission submission = submissionQueryService.getSubmissionById(submissionId);

        if (submission.getStatus() == SubmissionStatus.REJECTED) {
            throw new BusinessException(ExceptionType.SUBMISSION_ALREADY_REJECTED);
        }
        if (submission.getStatus() == SubmissionStatus.DELETED) {
            throw new BusinessException(ExceptionType.SUBMISSION_ALREADY_DELETED);
        }

        if (request.reason() == null || request.reason().message() == null || request.reason().message().isBlank()) {
            throw new BusinessException(ExceptionType.REJECT_REASON_REQUIRED);
        }

        submission.updateStatus(SubmissionStatus.REJECTED);

        RejectReason rejectReason = RejectReason.builder()
                .submission(submission)
                .templateCode(request.reason().templateCode())
                .message(request.reason().message())
                .rejectedBy(getCurrentUsername())
                .rejectedAt(LocalDateTime.now())
                .build();
        submission.setRejectReason(rejectReason);

        createAuditLog(submission, AuditAction.REJECTED, request.reason().message());

        return SubmissionDetailResponse.from(submission);
    }

    /**
     * ë‹¨ê±´ ì‚­ì œ
     */
    public void deleteSubmission(Long submissionId, SingleDeleteRequest request) {
        Submission submission = submissionQueryService.getSubmissionById(submissionId);

        if (submission.getStatus() == SubmissionStatus.DELETED) {
            throw new BusinessException(ExceptionType.SUBMISSION_ALREADY_DELETED);
        }

        createAuditLog(submission, AuditAction.DELETED, request.reason());
        submissionRepository.delete(submission);
    }

    /**
     * ì¼ê´„ ìŠ¹ì¸
     */
    public BulkApproveResponse bulkApprove(BulkApproveRequest request) {
        List<Long> approved = new ArrayList<>();
        List<Long> skipped = new ArrayList<>();

        for (Long id : request.ids()) {
            try {
                Submission submission = submissionRepository.findById(id).orElse(null);
                if (submission == null || submission.getStatus() == SubmissionStatus.DELETED) {
                    skipped.add(id);
                    continue;
                }
                if (submission.getStatus() == SubmissionStatus.APPROVED) {
                    skipped.add(id);
                    continue;
                }

                submission.updateStatus(SubmissionStatus.APPROVED);
                createAuditLog(submission, AuditAction.APPROVED, null);
                approved.add(id);
            } catch (Exception e) {
                skipped.add(id);
            }
        }

        return new BulkApproveResponse(approved, skipped);
    }

    /**
     * ì¼ê´„ ë°˜ë ¤
     */
    public BulkRejectResponse bulkReject(BulkRejectRequest request) {
        if (request.reason() == null || request.reason().message() == null || request.reason().message().isBlank()) {
            throw new BusinessException(ExceptionType.REJECT_REASON_REQUIRED);
        }

        List<Long> rejected = new ArrayList<>();
        List<Long> conflicts = new ArrayList<>();

        for (Long id : request.ids()) {
            try {
                Submission submission = submissionRepository.findById(id).orElse(null);
                if (submission == null || submission.getStatus() == SubmissionStatus.DELETED) {
                    conflicts.add(id);
                    continue;
                }
                if (submission.getStatus() == SubmissionStatus.REJECTED) {
                    conflicts.add(id);
                    continue;
                }

                submission.updateStatus(SubmissionStatus.REJECTED);

                RejectReason rejectReason = RejectReason.builder()
                        .submission(submission)
                        .templateCode(request.reason().templateCode())
                        .message(request.reason().message())
                        .rejectedBy(getCurrentUsername())
                        .rejectedAt(LocalDateTime.now())
                        .build();
                submission.setRejectReason(rejectReason);

                createAuditLog(submission, AuditAction.REJECTED, request.reason().message());
                rejected.add(id);
            } catch (Exception e) {
                conflicts.add(id);
            }
        }

        return new BulkRejectResponse(rejected, conflicts);
    }

    /**
     * ì¼ê´„ ì‚­ì œ
     */
    public BulkDeleteResponse bulkDelete(BulkDeleteRequest request) {
        List<Long> deleted = new ArrayList<>();
        List<Long> failed = new ArrayList<>();

        for (Long id : request.ids()) {
            try {
                Submission submission = submissionRepository.findById(id).orElse(null);
                if (submission == null || submission.getStatus() == SubmissionStatus.DELETED) {
                    failed.add(id);
                    continue;
                }

                createAuditLog(submission, AuditAction.DELETED, request.reason());
                submissionRepository.delete(submission);
                deleted.add(id);
            } catch (Exception e) {
                failed.add(id);
            }
        }

        return new BulkDeleteResponse(deleted, failed);
    }

    private void createAuditLog(Submission submission, AuditAction action, String comment) {
        AuditLog auditLog = AuditLog.builder()
                .submission(submission)
                .action(action)
                .performedBy(getCurrentUsername())
                .comment(comment)
                .build();
        auditLog.updateSubmission(submission);
        auditLogRepository.save(auditLog);
    }

    private String getCurrentUsername() {
        Authentication authentication = SecurityContextHolder.getContext().getAuthentication();
        if (authentication != null && authentication.isAuthenticated()) {
            return authentication.getName();
        }
        return "SYSTEM";
    }

}


================================================================================
File Path: .\src\main\java\com\ocean\piuda\admin\submission\service\SubmissionQueryService.java
================================================================================

package com.ocean.piuda.admin.submission.service;

import com.ocean.piuda.admin.common.enums.ActivityType;
import com.ocean.piuda.admin.common.enums.SubmissionStatus;
import com.ocean.piuda.admin.submission.dto.response.AuditLogResponse;
import com.ocean.piuda.admin.submission.dto.response.SubmissionDetailResponse;
import com.ocean.piuda.admin.submission.dto.response.SubmissionListResponse;
import com.ocean.piuda.admin.submission.entity.Submission;
import com.ocean.piuda.admin.submission.repository.AuditLogRepository;
import com.ocean.piuda.admin.submission.repository.SubmissionRepository;
import com.ocean.piuda.global.api.dto.PageResponse;
import com.ocean.piuda.global.api.exception.BusinessException;
import com.ocean.piuda.global.api.exception.ExceptionType;
import lombok.RequiredArgsConstructor;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.time.LocalDateTime;
import java.util.List;

@Transactional(readOnly = true)
@Service
@RequiredArgsConstructor
public class SubmissionQueryService {

    private final SubmissionRepository submissionRepository;
    private final AuditLogRepository auditLogRepository;

    /**
     * ì œì¶œ ëª©ë¡ ì¡°íšŒ (í•„í„°ë§, ê²€ìƒ‰, ì •ë ¬ í¬í•¨)
     */
    public PageResponse<SubmissionListResponse> getSubmissions(
            String keyword,
            SubmissionStatus status,
            ActivityType activityType,
            LocalDateTime startDate,
            LocalDateTime endDate,
            Pageable pageable
    ) {
        Page<Submission> page = submissionRepository.findWithFilters(
                keyword, status, activityType, startDate, endDate, pageable
        );

        Page<SubmissionListResponse> mapped = page.map(SubmissionListResponse::from);
        return PageResponse.of(mapped);
    }

    /**
     * ì œì¶œ ìƒì„¸ ì¡°íšŒ
     */
    public SubmissionDetailResponse getSubmissionDetail(Long submissionId) {
        // attachmentsëŠ” fetch joinìœ¼ë¡œ ì¡°íšŒ (auditLogsëŠ” ì œì™¸í•˜ì—¬ MultipleBagFetchException ë°©ì§€)
        Submission submission = submissionRepository.findByIdWithDetails(submissionId)
                .orElseThrow(() -> new BusinessException(ExceptionType.SUBMISSION_NOT_FOUND));
        
        // auditLogsëŠ” ë³„ë„ Repositoryë¡œ ì¡°íšŒí•˜ì—¬ ì´ˆê¸°í™”
        List<com.ocean.piuda.admin.submission.entity.AuditLog> auditLogs = 
                auditLogRepository.findBySubmissionSubmissionIdOrderByCreatedAtDesc(submissionId);
        
        // submissionì˜ auditLogs ì»¬ë ‰ì…˜ ì´ˆê¸°í™”
        submission.getAuditLogs().clear();
        submission.getAuditLogs().addAll(auditLogs);

        return SubmissionDetailResponse.from(submission);
    }

    /**
     * ê²€ìˆ˜ ë¡œê·¸ ì¡°íšŒ
     */
    public List<AuditLogResponse> getSubmissionLogs(Long submissionId) {
        return auditLogRepository.findBySubmissionSubmissionIdOrderByCreatedAtDesc(submissionId)
                .stream()
                .map(AuditLogResponse::from)
                .toList();
    }

    /**
     * Submission ì—”í‹°í‹° ì¡°íšŒ (ë‚´ë¶€ìš©)
     */
    public Submission getSubmissionById(Long submissionId) {
        return submissionRepository.findById(submissionId)
                .orElseThrow(() -> new BusinessException(ExceptionType.SUBMISSION_NOT_FOUND));
    }
}


================================================================================
File Path: .\src\main\java\com\ocean\piuda\ai\gemini\config\GeminiConfig.java
================================================================================

package com.ocean.piuda.ai.gemini.config;


import com.google.genai.Client;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

@Configuration
public class GeminiConfig {

    @Bean
    public Client geminiClient(
            @Value("${gemini.api.key}") String apiKey
    ) {
        return Client.builder()
                .apiKey(apiKey)   // Developer API í‚¤
                .build();
    }
}


================================================================================
File Path: .\src\main\java\com\ocean\piuda\ai\gemini\controller\GeminiTextController.java
================================================================================

package com.ocean.piuda.ai.gemini.controller;

import com.ocean.piuda.ai.gemini.dto.request.GeminiRequest;
import com.ocean.piuda.ai.gemini.dto.response.GeminiResponse;
import com.ocean.piuda.ai.gemini.service.GeminiTextService;
import com.ocean.piuda.global.api.dto.ApiData;
import io.swagger.v3.oas.annotations.Operation;
import io.swagger.v3.oas.annotations.tags.Tag;
import jakarta.validation.Valid;
import lombok.RequiredArgsConstructor;
import org.springframework.web.bind.annotation.*;

@RestController
@RequestMapping("/api/ai/gemini")
@RequiredArgsConstructor
@Tag(name = "Gemini Text API", description = "Gemini ê¸°ë°˜ ìì—°ì–´ ì²˜ë¦¬ AI API")
public class GeminiTextController {

    private final GeminiTextService service;

    @PostMapping("/text/complete")
    @Operation(
            summary = "í”„ë¡¬í”„íŠ¸ ì²˜ë¦¬",
            description = """
                    í…ìŠ¤íŠ¸ í”„ë¡¬í”„íŠ¸ë¥¼ Gemini ëª¨ë¸ë¡œ ë³´ëƒ…ë‹ˆë‹¤.
                    """
    )
    public ApiData<GeminiResponse> complete(
            @RequestBody @Valid GeminiRequest request
    ) {
        return ApiData.ok(service.complete(request));
    }
}


================================================================================
File Path: .\src\main\java\com\ocean\piuda\ai\gemini\controller\GeminiVisionController.java
================================================================================

package com.ocean.piuda.ai.gemini.controller;

import com.ocean.piuda.ai.gemini.dto.request.GeminiRequest;
import com.ocean.piuda.ai.gemini.dto.response.GeminiResponse;
import com.ocean.piuda.ai.gemini.service.GeminiVisionService;
import com.ocean.piuda.global.api.dto.ApiData;
import io.swagger.v3.oas.annotations.Operation;
import io.swagger.v3.oas.annotations.Parameter;
import io.swagger.v3.oas.annotations.media.Content;
import io.swagger.v3.oas.annotations.media.Schema;
import io.swagger.v3.oas.annotations.tags.Tag;
import jakarta.validation.Valid;
import lombok.RequiredArgsConstructor;
import org.springframework.http.MediaType;
import org.springframework.web.bind.annotation.*;
import org.springframework.web.multipart.MultipartFile;

@RestController
@RequestMapping("/api/ai/gemini")
@RequiredArgsConstructor
@Tag(name = "Gemini Vision API", description = "Gemini ê¸°ë°˜ ë‹¨ì¼ ì´ë¯¸ì§€ ì„¤ëª…/ë¶„ì„ API")
public class GeminiVisionController {

    private final GeminiVisionService service;

    @PostMapping(
            value = "/vision/describe",
            consumes = MediaType.MULTIPART_FORM_DATA_VALUE
    )
    @Operation(
            summary = "ì´ë¯¸ì§€ ì„¤ëª…/ë¶„ì„",
            description = """
                    ë‹¨ì¼ ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•˜ê³ , í”„ë¡¬í”„íŠ¸ë¥¼ JSON íŒŒíŠ¸ë¡œ í•¨ê»˜ ì „ë‹¬í•˜ì„¸ìš”.
                    - Multipart íŒŒíŠ¸: image(íŒŒì¼), request(JSON)
                    - 20MB ì´ˆê³¼ íŒŒì¼ì€ Files API ì‚¬ìš©ì„ ê¶Œì¥í•©ë‹ˆë‹¤.
                    """
    )
    public ApiData<GeminiResponse> describe(
            @Parameter(name = "image", required = true,
                    content = @Content(mediaType = "image/*",
                            schema = @Schema(type = "string", format = "binary")))
            @RequestPart("image") MultipartFile image,
            @Parameter(name = "request", required = false,
                    content = @Content(mediaType = "application/json",
                            schema = @Schema(implementation = GeminiRequest.class)))
            @RequestPart(name = "request", required = false) @Valid GeminiRequest request
    ) {
        GeminiRequest req = request == null ? GeminiRequest.builder().build() : request;
        return ApiData.ok(service.describe(image, req));
    }
}


================================================================================
File Path: .\src\main\java\com\ocean\piuda\ai\gemini\dto\request\GeminiRequest.java
================================================================================

package com.ocean.piuda.ai.gemini.dto.request;


import jakarta.validation.constraints.*;
import lombok.Builder;

/**
 * ë‹¨ì¼ ì´ë¯¸ì§€ + í”„ë¡¬í”„íŠ¸ë¡œ ì„¤ëª…/ë¶„ì„ ìš”ì²­
 */
@Builder
public record GeminiRequest(
        @Size(max = 2000, message = "promptëŠ” 2000ì ì´í•˜ì—¬ì•¼ í•©ë‹ˆë‹¤.")
        String prompt
) { }


================================================================================
File Path: .\src\main\java\com\ocean\piuda\ai\gemini\dto\response\GeminiMeta.java
================================================================================

package com.ocean.piuda.ai.gemini.dto.response;

import lombok.Builder;

@Builder
public record GeminiMeta(
        String model,
        Integer promptTokens,
        Integer candidatesTokens,
        Integer totalTokens
) { }


================================================================================
File Path: .\src\main\java\com\ocean\piuda\ai\gemini\dto\response\GeminiResponse.java
================================================================================

package com.ocean.piuda.ai.gemini.dto.response;


import lombok.Builder;

@Builder
public record GeminiResponse(
        String content,
        GeminiMeta meta
) { }


================================================================================
File Path: .\src\main\java\com\ocean\piuda\ai\gemini\service\GeminiTextService.java
================================================================================

package com.ocean.piuda.ai.gemini.service;


import com.google.genai.Client;
import com.google.genai.types.Content;
import com.google.genai.types.GenerateContentConfig;
import com.google.genai.types.GenerateContentResponse;
import com.ocean.piuda.ai.gemini.dto.request.GeminiRequest;
import com.ocean.piuda.ai.gemini.dto.response.GeminiMeta;
import com.ocean.piuda.ai.gemini.dto.response.GeminiResponse;
import com.ocean.piuda.ai.gemini.util.GeminiSdkUtil;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Service;

import java.util.List;

@Slf4j
@Service
@RequiredArgsConstructor
public class GeminiTextService {

    private final Client client;

    @Value("${gemini.model.text}")
    private String defaultTextModel;


    private static final String SYS_TEXT =
            "ë„ˆëŠ” ì‹ ë¢°í•  ìˆ˜ ìˆëŠ” AI ì–´ì‹œìŠ¤í„´íŠ¸ë‹¤. ì‚¬ì‹¤ê³¼ ë…¼ë¦¬ë¥¼ ì¤‘ì‹œí•˜ê³ , ëª¨ë¥´ëŠ” ê²ƒì€ ëª¨ë¥¸ë‹¤ê³  ë§í•˜ë¼.";


    public GeminiResponse complete(GeminiRequest req) {
        String model = defaultTextModel;
        GenerateContentResponse resp = client.models.generateContent(model, req.prompt(), null);

        String text = GeminiSdkUtil.extractText(resp);
        GeminiMeta meta = GeminiSdkUtil.toMeta(model, resp);
        return GeminiResponse.builder().content(text).meta(meta).build();
    }
}


================================================================================
File Path: .\src\main\java\com\ocean\piuda\ai\gemini\service\GeminiVisionService.java
================================================================================

package com.ocean.piuda.ai.gemini.service;

import com.google.genai.Client;
import com.google.genai.types.Content;
import com.google.genai.types.GenerateContentResponse;
import com.ocean.piuda.ai.gemini.dto.request.GeminiRequest;
import com.ocean.piuda.ai.gemini.dto.response.GeminiMeta;
import com.ocean.piuda.ai.gemini.dto.response.GeminiResponse;
import com.ocean.piuda.ai.gemini.util.GeminiSdkUtil;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.http.MediaType;
import org.springframework.stereotype.Service;
import org.springframework.web.multipart.MultipartFile;

import java.io.IOException;
import java.util.List;

@Slf4j
@Service
@RequiredArgsConstructor
public class GeminiVisionService {

    private final Client client;

    @Value("${gemini.model.vision}")
    private String defaultVisionModel;

    private static final long MAX_INLINE_BYTES = 20L * 1024 * 1024;

    public GeminiResponse describe(MultipartFile image, GeminiRequest req) {

        byte[] bytes = readBytesWithLimit(image);
        String mime = safeMime(image);

        List<Content> contents =
                GeminiSdkUtil.buildUserContents(bytes, mime, req.prompt());



        GenerateContentResponse resp = client.models.generateContent(defaultVisionModel, contents, null);

        String text = GeminiSdkUtil.extractText(resp);
        GeminiMeta meta = GeminiSdkUtil.toMeta(defaultVisionModel, resp);
        return GeminiResponse.builder().content(text).meta(meta).build();
    }

    private static byte[] readBytesWithLimit(MultipartFile image) {
        if (image == null || image.isEmpty()) throw new IllegalArgumentException("image íŒŒì¼ì´ í•„ìš”í•©ë‹ˆë‹¤.");
        if (image.getSize() > MAX_INLINE_BYTES) {
            throw new IllegalArgumentException("ì´ë¯¸ì§€ ìš©ëŸ‰ì´ ë„ˆë¬´ í½ë‹ˆë‹¤(<=20MB). Files API ì‚¬ìš© ê¶Œì¥");
        }
        try { return image.getBytes(); }
        catch (IOException e) { throw new IllegalStateException("ì´ë¯¸ì§€ ë°”ì´íŠ¸ë¥¼ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.", e); }
    }

    private static String safeMime(MultipartFile file) {
        String c = file.getContentType();
        return (c == null || c.isBlank()) ? MediaType.IMAGE_JPEG_VALUE : c;
    }
}


================================================================================
File Path: .\src\main\java\com\ocean\piuda\ai\gemini\util\GeminiSdkUtil.java
================================================================================

package com.ocean.piuda.ai.gemini.util;


import com.google.genai.types.Content;
import com.google.genai.types.GenerateContentResponse;
import com.google.genai.types.Part;
import com.ocean.piuda.ai.gemini.dto.response.GeminiMeta;

import java.util.List;
import java.util.Objects;

public class GeminiSdkUtil {

    // ì´ë¯¸ì§€ + í”„ë¡¬í”„íŠ¸
    public static List<Content> buildUserContents(byte[] imageBytes, String mimeType, String promptOrNull) {
        Part image = Part.fromBytes(imageBytes, mimeType);
        if (promptOrNull == null || promptOrNull.isBlank()) {
            return List.of(Content.fromParts(image));
        }
         return List.of(
             Content.builder()
                    .role("user")
                    .parts(image, Part.fromText(promptOrNull))
                    .build()
         );
    }



    public static String extractText(GenerateContentResponse resp) {
        try { return Objects.toString(resp.text(), ""); }
        catch (Exception e) { return ""; }
    }

    public static GeminiMeta toMeta(String model, GenerateContentResponse resp) {
        var usageOpt = resp.usageMetadata();
        Integer pt = null, ct = null, tt = null;
        if (usageOpt.isPresent()) {
            var u = usageOpt.get();
            pt = u.promptTokenCount().orElse(null);
            ct = u.candidatesTokenCount().orElse(null);
            tt = u.totalTokenCount().orElse(null);
        }
        return GeminiMeta.builder()
                .model(model)
                .promptTokens(pt)
                .candidatesTokens(ct)
                .totalTokens(tt)
                .build();
    }
}


================================================================================
File Path: .\src\main\java\com\ocean\piuda\ai\groq\controller\GroqApiController.java
================================================================================

package com.ocean.piuda.ai.groq.controller;

import com.ocean.piuda.ai.groq.dto.request.EvaluateHarmfulnessRequest;
import com.ocean.piuda.ai.groq.dto.request.GroqPromptRequest;
import com.ocean.piuda.ai.groq.dto.response.EvaluateHarmfulnessResponse;
import com.ocean.piuda.ai.groq.dto.response.GroqPromptResponse;
import com.ocean.piuda.ai.groq.service.GroqApiService;
import com.ocean.piuda.global.api.dto.ApiData;
import io.swagger.v3.oas.annotations.Operation;
import io.swagger.v3.oas.annotations.tags.Tag;
import jakarta.validation.Valid;
import lombok.RequiredArgsConstructor;
import org.springframework.web.bind.annotation.*;

@RestController
@RequestMapping("/api/ai/groq")
@RequiredArgsConstructor
@Tag(name = "Groq AI API", description = "Groq ê¸°ë°˜ ìì—°ì–´ ì²˜ë¦¬ AI API")
public class GroqApiController {

    private final GroqApiService groqApiService;

    @PostMapping("/complete")
    @Operation(
            summary = "í”„ë¡¬í”„íŠ¸ ì²˜ë¦¬",
            description = """
                    ì‚¬ìš©ì í”„ë¡¬í”„íŠ¸ë¥¼ Groq ëª¨ë¸ì— ì „ë‹¬í•´ ì‘ë‹µì„ ìƒì„±í•©ë‹ˆë‹¤.
                    - `useRealtime=true`ë©´ ì‹¤ì‹œê°„ ì›¹ ê²€ìƒ‰ì„ í†µí•œ ìµœì‹  ì •ë³´ê°€ ë°˜ì˜ëœ ì‘ë‹µì„ ìƒì„±í•˜ë©°, í•´ë‹¹ ì‘ë‹µì˜ ì¶œì²˜ëŠ” `meta.executedTools`ì—ë§Œ ë‹´ê²¨ ë°˜í™˜ë©ë‹ˆë‹¤.
                    - ìµœì‹ ì •ë³´ ë°˜ì˜ì´ í•„ìš” ì—†ëŠ” ì²˜ë¦¬ëŠ” `useRealtime` ì„ ëª…ì‹œí•˜ì§€ ì•Šìœ¼ë©´ ë©ë‹ˆë‹¤.
                    """
    )
    public ApiData<GroqPromptResponse> complete(
            @io.swagger.v3.oas.annotations.parameters.RequestBody(
                    description = "í”„ë¡¬í”„íŠ¸/ì˜µì…˜(useRealtime)",
                    required = true
            )
            @RequestBody @Valid GroqPromptRequest request
    ) {
        return ApiData.ok(groqApiService.complete(request));
    }

    @PostMapping("/harmfulness")
    @Operation(
            summary = "ë¬¸ì¥ ìœ í•´ì„± í‰ê°€",
            description = """
                    ì…ë ¥ ë¬¸ì¥ì˜ ìœ í•´ì„± ì •ë„ë¥¼ 0~10 ì‚¬ì´ ì •ìˆ˜ë¡œ í‰ê°€í•©ë‹ˆë‹¤.
                    - ì‹¤ì‹œê°„ ê²€ìƒ‰ì€ ì‚¬ìš©í•˜ì§€ ì•Šìœ¼ë©°, ë„êµ¬ í˜¸ì¶œì„ ì°¨ë‹¨í•©ë‹ˆë‹¤.
                    """
    )
    public ApiData<EvaluateHarmfulnessResponse> evaluateHarmfulness(
            @io.swagger.v3.oas.annotations.parameters.RequestBody(
                    description = "ìœ í•´ì„± í‰ê°€í•  ë¬¸ì¥",
                    required = true
            )
            @RequestBody @Valid EvaluateHarmfulnessRequest request
    ) {
        return ApiData.ok(groqApiService.evaluateHarmfulness(request));
    }
}


================================================================================
File Path: .\src\main\java\com\ocean\piuda\ai\groq\dto\request\EvaluateHarmfulnessRequest.java
================================================================================

package com.ocean.piuda.ai.groq.dto.request;

import jakarta.validation.constraints.NotBlank;
import lombok.Builder;


@Builder
public record EvaluateHarmfulnessRequest (
        @NotBlank(message = "sentenceëŠ” ë¹„ì–´ ìˆì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
        String sentence
){ }


================================================================================
File Path: .\src\main\java\com\ocean\piuda\ai\groq\dto\request\GroqPromptRequest.java
================================================================================

package com.ocean.piuda.ai.groq.dto.request;

import jakarta.validation.constraints.*;
import lombok.Builder;

@Builder
public record GroqPromptRequest(

        @NotBlank(message = "promptëŠ” ë¹„ì–´ ìˆì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
        String prompt,          // í•„ìˆ˜: ì‚¬ìš©ì í”„ë¡¬í”„íŠ¸

        // ì„ íƒ: ê¸°ë³¸ false. trueë©´ groq/compound + Web Search ì‚¬ìš©
        Boolean useRealtime

) { }


================================================================================
File Path: .\src\main\java\com\ocean\piuda\ai\groq\dto\response\EvaluateHarmfulnessResponse.java
================================================================================

package com.ocean.piuda.ai.groq.dto.response;

import lombok.Builder;


@Builder
public record EvaluateHarmfulnessResponse(
        int degree,
        GroqMeta meta

) { }


================================================================================
File Path: .\src\main\java\com\ocean\piuda\ai\groq\dto\response\GroqMeta.java
================================================================================

package com.ocean.piuda.ai.groq.dto.response;

import com.fasterxml.jackson.databind.JsonNode;
import lombok.Builder;

/**
 * ëª¨ë“  ì‘ë‹µì— ê³µí†µìœ¼ë¡œ ë‹´ê¸¸ ë©”íƒ€ ì •ë³´
 */
@Builder
public record GroqMeta(
        String model,                         // í˜¸ì¶œí•œ ëª¨ë¸
        Integer promptTokens,                 // usage.prompt_tokens
        Integer completionTokens,             // usage.completion_tokens
        Integer totalTokens,                  // usage.total_tokens
        String requestId,                     // x-request-id
        String rateLimitRequestsRemaining,    // x-ratelimit-remaining-requests
        String rateLimitTokensRemaining,      // x-ratelimit-remaining-tokens (ìˆì„ ë•Œ)
        String rateLimitReset ,                // x-ratelimit-reset (ìˆì„ ë•Œ)
        JsonNode executedTools                  // â† choices[0].message.executed_tools ì›ë³¸ JSON(ìˆìœ¼ë©´)

) { }


================================================================================
File Path: .\src\main\java\com\ocean\piuda\ai\groq\dto\response\GroqPromptResponse.java
================================================================================

package com.ocean.piuda.ai.groq.dto.response;

import lombok.Builder;

@Builder
public record GroqPromptResponse(
        String content,   // ëª¨ë¸ ì‘ë‹µ í…ìŠ¤íŠ¸
        GroqMeta meta
) { }


================================================================================
File Path: .\src\main\java\com\ocean\piuda\ai\groq\service\GroqApiService.java
================================================================================

package com.ocean.piuda.ai.groq.service;

import com.fasterxml.jackson.databind.JsonNode;
import com.fasterxml.jackson.databind.ObjectMapper;
import com.fasterxml.jackson.databind.node.ArrayNode;
import com.fasterxml.jackson.databind.node.ObjectNode;
import com.ocean.piuda.ai.groq.dto.request.EvaluateHarmfulnessRequest;
import com.ocean.piuda.ai.groq.dto.request.GroqPromptRequest;
import com.ocean.piuda.ai.groq.dto.response.EvaluateHarmfulnessResponse;
import com.ocean.piuda.ai.groq.dto.response.GroqMeta;
import com.ocean.piuda.ai.groq.dto.response.GroqPromptResponse;
import com.ocean.piuda.ai.groq.util.GroqApiUtil;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.http.*;
import org.springframework.stereotype.Service;
import org.springframework.web.client.RestTemplate;

import java.util.List;
import java.util.Objects;

@Slf4j
@Service
@RequiredArgsConstructor
public class GroqApiService {

    private final RestTemplate restTemplate;
    private final GroqApiUtil groqApiUtil;

    @Value("${groq.api.key}")
    private String apiKey;

    /** ë””í´íŠ¸ ëª¨ë¸ */
    @Value("${groq.api.model}")
    private String defaultModel;
    private String REAL_TIME_MODEL= "groq/compound";

    private static final ObjectMapper MAPPER = new ObjectMapper();
    private static final String GROQ_CHAT_URL = "https://api.groq.com/openai/v1/chat/completions";

    /** ì„œë²„ ê³ ì • ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸(ì˜¤í”„ë¼ì¸ ëª¨ë¸ìš©) */
    private static final String SYS_OFFLINE =
            "ì¸í„°ë„·ì´ë‚˜ ìµœì‹  ë°ì´í„°ì— ì§ì ‘ ì ‘ê·¼í•  ìˆ˜ ì—†ë‹¤. ìµœì‹ /ì‹¤ì‹œê°„ ì •ë³´ë¥¼ ìš”êµ¬ë°›ìœ¼ë©´ "
                    + "'ì‹¤ì‹œê°„ ì •ë³´ì— ì ‘ê·¼ ë¶ˆê°€'ë¼ê³  ë¶„ëª…íˆ ì•Œë¦¬ê³ , ë¹„ì‹¤ì‹œê°„ ì¼ë°˜ ì§€ì‹ë§Œ ë‹µí•˜ë¼. "
                    + "ìµœì¢… ë‹µë³€ ë³¸ë¬¸ì—ëŠ” ì ˆëŒ€ URLì„ í¬í•¨í•˜ì§€ ë§ë¼.";

    /** ì„œë²„ ê³ ì • ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸(compound ëª¨ë¸ìš©) */
    private static final String SYS_COMPOUND =
            "ìµœì‹  ì •ë³´ê°€ í•„ìš”í•œ ê²½ìš° ë‚´ì¥ ì›¹ê²€ìƒ‰/ë¸Œë¼ìš°ì € ë„êµ¬ë¥¼ ì‚¬ìš©í•´ ì‚¬ì‹¤ì„ ê²€ì¦í•˜ë¼. "
                    + "ê·¸ëŸ¬ë‚˜ ìµœì¢… ë‹µë³€ ë³¸ë¬¸ì—ëŠ” URLì„ í¬í•¨í•˜ì§€ ë§ê³ , ì¶œì²˜ëŠ” ë„êµ¬ ì‹¤í–‰ ê²°ê³¼(executed_tools)ì—ë§Œ ë‚¨ê²¨ë¼.";

    /** ìœ í•´ì„± í‰ê°€: í•­ìƒ ì˜¤í”„ë¼ì¸(íˆ´ ì°¨ë‹¨) */
    public EvaluateHarmfulnessResponse evaluateHarmfulness(EvaluateHarmfulnessRequest request) {
        final String model = defaultModel; // ê³ ì •
        final String userPrompt =
                "Return only a number from 0 to 10 indicating the degree of harmfulness of the text. "
                        + "Higher means more harmful. No explanations.\n\nText:\n"
                        + String.valueOf(request.sentence());

        ArrayNode messages = groqApiUtil.buildMessages(SYS_OFFLINE, userPrompt);
        ObjectNode payload = groqApiUtil.buildRequestPayload(model, messages);

        ResponseEntity<String> resp = groqApiUtil.postChat(payload);
        String raw = resp.getBody();

        int degree = -1;
        try {
            JsonNode rootNode = MAPPER.readTree(raw);
            String content = rootNode.path("choices").path(0).path("message").path("content").asText("");
            String digits = content.replaceAll("[^0-9]", "");
            if (!digits.isEmpty()) degree = Integer.parseInt(digits);
        } catch (Exception e) {
            log.warn("Failed to parse harmfulness score", e);
        }

        GroqMeta meta = groqApiUtil.buildMeta(resp, raw, model);
        return EvaluateHarmfulnessResponse.builder()
                .degree(degree)
                .meta(meta)
                .build();
    }

    /** ì¼ë°˜ í”„ë¡¬í”„íŠ¸: useRealtime=trueë©´ compound, ì•„ë‹ˆë©´ ì˜¤í”„ë¼ì¸ */
    public GroqPromptResponse complete(GroqPromptRequest req) {
        final boolean useRealtime = Boolean.TRUE.equals(req.useRealtime());
        final String model = groqApiUtil.resolveModel(useRealtime);
        final String sysPrompt = groqApiUtil.resolveSystemPrompt(model);

        ArrayNode messages = groqApiUtil.buildMessages(sysPrompt, String.valueOf(req.prompt()));
        ObjectNode payload = groqApiUtil.buildRequestPayload(
                model, messages
        );

        ResponseEntity<String> resp = groqApiUtil.postChat(payload);
        String raw = resp.getBody();

        String content = groqApiUtil.extractCleanContent(raw); // URL ì œê±°
        GroqMeta meta = groqApiUtil.buildMeta(resp, raw, model);

        return GroqPromptResponse.builder()
                .content(content)
                .meta(meta)
                .build();
    }

}


================================================================================
File Path: .\src\main\java\com\ocean\piuda\ai\groq\util\GroqApiUtil.java
================================================================================

package com.ocean.piuda.ai.groq.util;

import com.fasterxml.jackson.databind.JsonNode;
import com.fasterxml.jackson.databind.ObjectMapper;
import com.fasterxml.jackson.databind.node.ArrayNode;
import com.fasterxml.jackson.databind.node.ObjectNode;
import com.ocean.piuda.ai.groq.dto.response.GroqMeta;
import com.ocean.piuda.global.api.exception.BusinessException;
import com.ocean.piuda.global.api.exception.ExceptionType;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.http.*;
import org.springframework.stereotype.Service;
import org.springframework.web.client.HttpClientErrorException;
import org.springframework.web.client.HttpServerErrorException;
import org.springframework.web.client.RestTemplate;

import java.util.List;
import java.util.Map;
import java.util.Objects;

@Slf4j
@Service
@RequiredArgsConstructor
public class GroqApiUtil {
    private final RestTemplate restTemplate;

    @Value("${groq.api.key}")
    private String apiKey;

    /** ë””í´íŠ¸ ëª¨ë¸ (ì˜¤í”„ë¼ì¸/ê¸°ë³¸) */
    @Value("${groq.api.model}")
    private String defaultModel;

    /** ì‹¤ì‹œê°„ ê²€ìƒ‰ ëª¨ë¸ */
    private static final String REAL_TIME_MODEL = "groq/compound";

    private static final ObjectMapper MAPPER = new ObjectMapper();
    private static final String GROQ_CHAT_URL = "https://api.groq.com/openai/v1/chat/completions";

    /** ì„œë²„ ê³ ì • ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸(ì˜¤í”„ë¼ì¸ ëª¨ë¸ìš©) */
    private static final String SYS_OFFLINE =
            "ì¸í„°ë„·ì´ë‚˜ ìµœì‹  ë°ì´í„°ì— ì§ì ‘ ì ‘ê·¼í•  ìˆ˜ ì—†ë‹¤. ìµœì‹ /ì‹¤ì‹œê°„ ì •ë³´ë¥¼ ìš”êµ¬ë°›ìœ¼ë©´ "
                    + "'ì‹¤ì‹œê°„ ì •ë³´ì— ì ‘ê·¼ ë¶ˆê°€'ë¼ê³  ë¶„ëª…íˆ ì•Œë¦¬ê³ , ë¹„ì‹¤ì‹œê°„ ì¼ë°˜ ì§€ì‹ë§Œ ë‹µí•˜ë¼. "
                    + "ìµœì¢… ë‹µë³€ ë³¸ë¬¸ì—ëŠ” ì ˆëŒ€ URLì„ í¬í•¨í•˜ì§€ ë§ë¼.";

    /** ì„œë²„ ê³ ì • ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸(compound ëª¨ë¸ìš©) */
    private static final String SYS_COMPOUND =
            "ìµœì‹  ì •ë³´ê°€ í•„ìš”í•œ ê²½ìš° ë‚´ì¥ ì›¹ê²€ìƒ‰/ë¸Œë¼ìš°ì € ë„êµ¬ë¥¼ ì‚¬ìš©í•´ ì‚¬ì‹¤ì„ ê²€ì¦í•˜ë¼. "
                    + "ê·¸ëŸ¬ë‚˜ ìµœì¢… ë‹µë³€ ë³¸ë¬¸ì—ëŠ” URLì„ í¬í•¨í•˜ì§€ ë§ê³ , ì¶œì²˜ëŠ” ë„êµ¬ ì‹¤í–‰ ê²°ê³¼(executed_tools)ì—ë§Œ ë‚¨ê²¨ë¼.";

    /* ============================== ìœ í‹¸ ============================== */

    public static boolean isCompound(String model) {
        return model != null && model.startsWith("groq/compound");
    }

    public HttpHeaders buildHeaders() {
        HttpHeaders headers = new HttpHeaders();
        headers.setBearerAuth(apiKey);
        headers.setContentType(MediaType.APPLICATION_JSON);
        headers.setAccept(List.of(MediaType.APPLICATION_JSON));
        return headers;
    }

    public static String header(ResponseEntity<?> resp, String name) {
        if (resp == null || resp.getHeaders() == null) return null;
        List<String> v = resp.getHeaders().get(name);
        if (v != null && !v.isEmpty()) return v.get(0);
        return resp.getHeaders().entrySet().stream()
                .filter(e -> e.getKey() != null && e.getKey().equalsIgnoreCase(name))
                .map(e -> (e.getValue() != null && !e.getValue().isEmpty()) ? e.getValue().get(0) : null)
                .filter(Objects::nonNull)
                .findFirst().orElse(null);
    }

    /** ë³¸ë¬¸ ë‚´ URL ì œê±°(ë§ˆí¬ë‹¤ìš´ ë§í¬ ë° ë§¨ëª¸ URL) */
    public static String stripUrls(String text) {
        if (text == null) return "";
        // [text](url) -> text
        text = text.replaceAll("\\[([^\\]]+)\\]\\((https?://[^)\\s]+)\\)", "$1");
        // bare URL ì œê±°
        text = text.replaceAll("https?://\\S+", "");
        // ì‰ì—¬ ê³µë°± ì •ë¦¬
        return text.replaceAll("[ \\t]+\\n", "\n").trim();
    }

    /** ëª¨ë¸ ì„ íƒ (useRealtime=trueë©´ compoundë¡œ ê°•ì œ) */
    public String resolveModel(boolean useRealtime) {
        return useRealtime ? REAL_TIME_MODEL : defaultModel;
    }

    /** ì„œë²„ ê³ ì • ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ */
    public String resolveSystemPrompt(String model) {
        return isCompound(model) ? SYS_COMPOUND : SYS_OFFLINE;
    }

    /** ê³µí†µ: messages ìƒì„± */
    public ArrayNode buildMessages(String systemContent, String userContent) {
        ArrayNode messages = MAPPER.createArrayNode();

        ObjectNode sys = MAPPER.createObjectNode();
        sys.put("role", "system");
        sys.put("content", systemContent);
        messages.add(sys);

        ObjectNode user = MAPPER.createObjectNode();
        user.put("role", "user");
        user.put("content", userContent);
        messages.add(user);

        return messages;
    }

    /** ê³µí†µ: ìš”ì²­ payload ìƒì„± */
    public ObjectNode buildRequestPayload(String model, ArrayNode messages) {
        ObjectNode root = MAPPER.createObjectNode();
        root.put("model", model);
        root.set("messages", messages);
        if (!isCompound(model)) {
            // ì˜¤í”„ë¼ì¸ ëª¨ë¸ì€ íˆ´ ì‚¬ìš© ì°¨ë‹¨
            root.put("tool_choice", "none");
        }
        return root;
    }

    /** ê³µí†µ: HTTP í˜¸ì¶œ */
    public ResponseEntity<String> postChat(ObjectNode payload) {
        try {
            return restTemplate.exchange(
                    GROQ_CHAT_URL, HttpMethod.POST,
                    new HttpEntity<>(payload.toString(), buildHeaders()),
                    String.class
            );
        } catch (HttpClientErrorException e) {
            throw new BusinessException(
                    ExceptionType.NOT_VALID_REQUEST_FIELDS_ERROR,
                    Map.of("status", e.getStatusCode().value(),
                            "reason", "Groq 4xx",
                            "body", e.getResponseBodyAsString())
            );
        } catch (HttpServerErrorException e) {
            throw new BusinessException(
                    ExceptionType.UNEXPECTED_SERVER_ERROR,
                    Map.of("status", e.getStatusCode().value(),
                            "reason", "Groq 5xx",
                            "body", e.getResponseBodyAsString())
            );
        } catch (Exception e) {
            throw new BusinessException(
                    ExceptionType.UNEXPECTED_SERVER_ERROR,
                    Map.of("reason", "Groq call failed",
                            "message", e.getMessage())
            );
        }
    }

    /** ê³µí†µ: content ì¶”ì¶œ(+URL ì œê±°) */
    public String extractCleanContent(String raw) {
        try {
            JsonNode rootNode = MAPPER.readTree(raw);
            String content = rootNode.path("choices").path(0).path("message").path("content").asText("");
            return stripUrls(content);
        } catch (Exception e) {
            log.warn("Failed to parse content from Groq response", e);
            return "";
        }
    }

    /** ê³µí†µ: ë©”íƒ€ ìƒì„± (usage, executed_tools í¬í•¨) */
    public GroqMeta buildMeta(ResponseEntity<String> resp, String raw, String modelUsed) {
        Integer pt = null, ct = null, tt = null;
        JsonNode executedTools = null;

        try {
            if (raw != null) {
                JsonNode rootNode = MAPPER.readTree(raw);
                JsonNode usage = rootNode.path("usage");
                if (!usage.isMissingNode()) {
                    pt = usage.path("prompt_tokens").isInt() ? usage.path("prompt_tokens").asInt() : null;
                    ct = usage.path("completion_tokens").isInt() ? usage.path("completion_tokens").asInt() : null;
                    tt = usage.path("total_tokens").isInt() ? usage.path("total_tokens").asInt() : null;
                }
                JsonNode executed = rootNode.path("choices").path(0).path("message").path("executed_tools");
                if (executed.isArray() && executed.size() > 0) {
                    executedTools = executed;
                }
            }
        } catch (Exception e) {
            log.warn("Failed to parse usage/executed_tools", e);
        }

        String requestId = header(resp, "x-request-id");
        String rlReqRemain = header(resp, "x-ratelimit-remaining-requests");
        String rlTokRemain = header(resp, "x-ratelimit-remaining-tokens");
        String rlReset     = header(resp, "x-ratelimit-reset");

        return GroqMeta.builder()
                .model(modelUsed)
                .promptTokens(pt)
                .completionTokens(ct)
                .totalTokens(tt)
                .requestId(requestId)
                .rateLimitRequestsRemaining(rlReqRemain)
                .rateLimitTokensRemaining(rlTokRemain)
                .rateLimitReset(rlReset)
                .executedTools(executedTools) 
                .build();
    }

}


================================================================================
File Path: .\src\main\java\com\ocean\piuda\ai\openAI\controller\OpenAIApiController.java
================================================================================

//package com.ocean.piuda.ai.openAI.controller;
//
//import com.ocean.piuda.ai.openAI.dto.request.OpenAIRequest;
//import com.ocean.piuda.ai.openAI.service.OpenAIApiService;
//import lombok.RequiredArgsConstructor;
//import org.springframework.web.bind.annotation.PostMapping;
//import org.springframework.web.bind.annotation.RequestBody;
//import org.springframework.web.bind.annotation.RequestMapping;
//import org.springframework.web.bind.annotation.RestController;
//
//import java.io.IOException;
//
//@RequiredArgsConstructor
//@RestController
//@RequestMapping("/api/ai/openai")
//public class OpenAIApiController {
//
//    private final OpenAIApiService openAIService;
//
//
//    // í”„ë¡¬í”„íŠ¸ ì§ì ‘
//    @PostMapping("/complete")
//    public String complete(@RequestBody OpenAIRequest.Basic openAIRequest) throws IOException {
//        return openAIService.complete(openAIRequest);
//    }
//
//
//    // ê¸€ì„ ì²¨ì‚­
//    @PostMapping("/advice")
//    public String enhanceWriting(@RequestBody OpenAIRequest.Basic openAIRequest) throws IOException {
//        return openAIService.enhanceWriting(openAIRequest);
//    }
//
//
//    //ê¸€ì˜ ìœ í•´ì„± íŒë‹¨
//    @PostMapping("/harmfulness")
//    public String evaluateHarmfulness(@RequestBody String prompt) throws IOException {
//        return openAIService.evaluateHarmfulness(prompt);
//    }
//
//    // ì—¬ëŸ¬ ë¬¸ì¥ì„ í•˜ë‚˜ë¡œ í•©ì³ ê¸€ì„ ì‘ì„±
//    @PostMapping("/compose")
//    public String composeText(@RequestBody  OpenAIRequest.TextCompose request) throws IOException {
//        return openAIService.composeText(request);
//    }
//
//
//
//
//
//
//
//}


================================================================================
File Path: .\src\main\java\com\ocean\piuda\ai\openAI\dto\request\OpenAIRequest.java
================================================================================

package com.ocean.piuda.ai.openAI.dto.request;

import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;

import java.util.List;

public class OpenAIRequest {

    @Data
    @Builder
    @NoArgsConstructor
    @AllArgsConstructor
    public static class ChatMessage {
        // "system" | "user" | "assistant"
        private String role;
        private String content;
    }

    @Data
    @Builder
    @NoArgsConstructor
    @AllArgsConstructor
    public static class Basic {
        private String model;
        private String prompt;                // ê¸°ì¡´ í˜¸í™˜ìš©
        private List<ChatMessage> messages;   // ì‹ ê·œ ë©”ì‹œì§€ ë°°ì—´
    }

    @Data
    @Builder
    @NoArgsConstructor
    @AllArgsConstructor
    public static class TextCompose {
        private String model;
        private List<String> sentences;
    }
}


================================================================================
File Path: .\src\main\java\com\ocean\piuda\ai\openAI\service\OpenAIApiService.java
================================================================================

package com.ocean.piuda.ai.openAI.service;

import com.fasterxml.jackson.databind.JsonNode;
import com.fasterxml.jackson.databind.ObjectMapper;
import com.fasterxml.jackson.databind.node.ArrayNode;
import com.fasterxml.jackson.databind.node.ObjectNode;
import com.ocean.piuda.ai.openAI.dto.request.OpenAIRequest;
import lombok.extern.slf4j.Slf4j;
import okhttp3.*;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Service;

import java.io.IOException;
import java.time.Duration;
import java.util.Optional;

@Slf4j
@Service
public class OpenAIApiService {
    @Value("${openai.api.key}")
    private String apiKey;

    private static final String OPENAI_API_URL = "https://api.openai.com/v1/chat/completions";
    private static final MediaType JSON = MediaType.get("application/json; charset=utf-8");
    private static final ObjectMapper MAPPER = new ObjectMapper();

    private final OkHttpClient client = new OkHttpClient.Builder()
            .connectTimeout(Duration.ofSeconds(10))
            .readTimeout(Duration.ofSeconds(60))
            .writeTimeout(Duration.ofSeconds(30))
            .build();

    /** ì¬ì‹œë„ ì—†ì´ ë‹¨ í•œ ë²ˆë§Œ í˜¸ì¶œí•˜ëŠ” executeRequest */
    private String executeRequest(ObjectNode json) throws IOException {
        RequestBody body = RequestBody.create(JSON, MAPPER.writeValueAsBytes(json));

        Request request = new Request.Builder()
                .url(OPENAI_API_URL)
                .header("Authorization", "Bearer " + apiKey)
                .header("Content-Type", "application/json")
                .post(body)
                .build();

        try (Response response = client.newCall(request).execute()) {
            if (response.isSuccessful()) {
                ResponseBody rb = response.body();
                return rb != null ? rb.string() : "";
            }
            int code = response.code();
            String respText = safeBody(response);
            log.warn("OpenAI non-2xx: code={}, body={}", code, respText);
            throw buildApiException(code, respText);
        }
    }

    /** ì—ëŸ¬ ë³¸ë¬¸ ì•ˆì „ ì¶”ì¶œ */
    private static String safeBody(Response response) {
        try {
            ResponseBody rb = response.body();
            return rb != null ? rb.string() : "";
        } catch (Exception e) {
            return "";
        }
    }

    /** OpenAI í˜•ì‹ì˜ ì—ëŸ¬ ë³¸ë¬¸ì„ ì½ì–´ ì˜ë¯¸ ìˆëŠ” ë©”ì‹œì§€ë¡œ ë˜í•‘ */
    private static IOException buildApiException(int code, String respText) {
        try {
            JsonNode node = MAPPER.readTree(respText == null ? "{}" : respText);
            String msg = node.path("error").path("message").asText("");
            String type = node.path("error").path("type").asText("");
            String param = node.path("error").path("param").asText("");
            String full = String.format("OpenAI API error %d: %s (type=%s, param=%s)", code, msg, type, param);
            return new IOException(full);
        } catch (Exception e) {
            return new IOException("OpenAI API error " + code + ": " + respText);
        }
    }

    /** ê³µí†µ í˜ì´ë¡œë“œ ë¹Œë” */
    private static ObjectNode basePayload(String model, Integer maxTokens) {
        ObjectNode root = MAPPER.createObjectNode();
        root.put("model", model);
        ArrayNode messages = MAPPER.createArrayNode();
        root.set("messages", messages);
        if (maxTokens != null && maxTokens > 0) root.put("max_tokens", maxTokens);
        return root;
    }

    /** ë©”ì‹œì§€ ë…¸ë“œ */
    private static ObjectNode message(String role, String content) {
        ObjectNode m = MAPPER.createObjectNode();
        m.put("role", role);
        m.put("content", content == null ? "" : content);
        return m;
    }

    // ===================== í¼ë¸”ë¦­ API =====================

    public String enhanceWriting(OpenAIRequest.Basic openAIRequest) throws IOException {
        ObjectNode root = basePayload(openAIRequest.getModel(), 512);
        ArrayNode messages = (ArrayNode) root.get("messages");
        messages.add(message("system",
                "You are a helpful assistant. Your task is to edit the user's text to improve clarity, grammar, and flow while maintaining the original meaning and tone. Do not change the context or style unless asked."));
        messages.add(message("user", Optional.ofNullable(openAIRequest.getPrompt()).orElse("")));
        log.info("Request Body: {}", root);
        return executeRequest(root);
    }

    public String complete(OpenAIRequest.Basic openAIRequest) throws IOException {
        ObjectNode root = basePayload(openAIRequest.getModel(), 512);
        ArrayNode messages = (ArrayNode) root.get("messages");
        messages.add(message("system", "You are a helpful assistant."));
        messages.add(message("user", Optional.ofNullable(openAIRequest.getPrompt()).orElse("")));
        log.info("Request Body: {}", root);
        return executeRequest(root);
    }

    /** gpt-4o-mini ê³ ì • ì‚¬ìš© */
    public String evaluateHarmfulness(String prompt) throws IOException {
        ObjectNode root = basePayload("gpt-4o-mini", 32);
        ArrayNode messages = (ArrayNode) root.get("messages");
        messages.add(message("system",
                "You are a content moderation assistant. Analyze the following text for any harmful, offensive, or inappropriate content. Rate the harmfulness on a scale from 0 to 10 without further explanation."));
        messages.add(message("user", Optional.ofNullable(prompt).orElse("")));
        log.info("Request Body for Harmfulness Evaluation: {}", root);
        String responseBody = executeRequest(root);
        return extractHarmfulnessRating(responseBody);
    }

    public String composeText(OpenAIRequest.TextCompose openAIRequest) throws IOException {
        String prompt = String.join(" ", openAIRequest.getSentences()).trim();
        ObjectNode root = basePayload(openAIRequest.getModel(), 512);
        ArrayNode messages = (ArrayNode) root.get("messages");
        messages.add(message("system",
                "You are a writing assistant. Please assist in composing a coherent text from the following list of sentences. The final text should flow naturally and maintain the original meaning of the sentences."));
        messages.add(message("user", prompt));
        log.info("Compose Text Request Body: {}", root);
        return executeRequest(root);
    }

    private String extractHarmfulnessRating(String responseBody) throws IOException {
        JsonNode rootNode = MAPPER.readTree(responseBody);
        String content = rootNode.path("choices").get(0).path("message").path("content").asText();
        String ratingText = content.replaceAll("[^0-9]", "");
        return ratingText.isEmpty() ? "0" : ratingText;
    }
}


================================================================================
File Path: .\src\main\java\com\ocean\piuda\aws\config\AwsCredentialConfig.java
================================================================================

package com.ocean.piuda.aws.config;

import com.ocean.piuda.aws.properties.AwsConfigProperties;
import lombok.RequiredArgsConstructor;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import software.amazon.awssdk.auth.credentials.AwsBasicCredentials;
import software.amazon.awssdk.auth.credentials.AwsCredentialsProvider;
import software.amazon.awssdk.auth.credentials.StaticCredentialsProvider;

@Configuration
@RequiredArgsConstructor
public class AwsCredentialConfig {

    private final AwsConfigProperties awsConfigProperties;

    @Bean
    public AwsCredentialsProvider awsCredentialProvider() {
        return StaticCredentialsProvider.create(
                AwsBasicCredentials.builder()
                        .accessKeyId(this.awsConfigProperties.getAccessKey())
                        .secretAccessKey(this.awsConfigProperties.getSecretKey())
                        .build()
        );
    }
}


================================================================================
File Path: .\src\main\java\com\ocean\piuda\aws\config\S3Config.java
================================================================================

package com.ocean.piuda.aws.config;

import com.ocean.piuda.aws.properties.AwsConfigProperties;
import lombok.RequiredArgsConstructor;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import software.amazon.awssdk.auth.credentials.AwsBasicCredentials;
import software.amazon.awssdk.auth.credentials.AwsCredentialsProvider;
import software.amazon.awssdk.auth.credentials.StaticCredentialsProvider;
import software.amazon.awssdk.regions.Region;
import software.amazon.awssdk.services.s3.S3Client;
import software.amazon.awssdk.services.s3.presigner.S3Presigner;

@Configuration
@RequiredArgsConstructor
public class S3Config {

  private final AwsConfigProperties awsConfigProperties;

  @Bean
  public S3Client s3Client() {
    AwsCredentialsProvider credentialsProvider = StaticCredentialsProvider.create(
        AwsBasicCredentials.create(awsConfigProperties.getAccessKey(), awsConfigProperties.getSecretKey())
    );

    return S3Client.builder()
        .region(Region.of(awsConfigProperties.getRegion()))
        .credentialsProvider(credentialsProvider)
        .build();
  }

  @Bean
  public S3Presigner s3Presigner() {
    AwsCredentialsProvider credentialsProvider = StaticCredentialsProvider.create(
        AwsBasicCredentials.create(
            awsConfigProperties.getAccessKey(),
            awsConfigProperties.getSecretKey()
        )
    );

    return S3Presigner.builder()
        .region(Region.of(awsConfigProperties.getRegion()))
        .credentialsProvider(credentialsProvider)
        .build();
  }
}


================================================================================
File Path: .\src\main\java\com\ocean\piuda\aws\controller\ImageController.java
================================================================================

package com.ocean.piuda.aws.controller;

import com.ocean.piuda.aws.dto.response.GeneratePresignedPutUrlResponse;
import com.ocean.piuda.aws.service.S3Service;
import com.ocean.piuda.global.api.dto.ApiData;
import io.swagger.v3.oas.annotations.Operation;
import io.swagger.v3.oas.annotations.Parameter;
import io.swagger.v3.oas.annotations.media.Content;
import io.swagger.v3.oas.annotations.media.ExampleObject;
import io.swagger.v3.oas.annotations.media.Schema;
import io.swagger.v3.oas.annotations.responses.ApiResponse;
import io.swagger.v3.oas.annotations.responses.ApiResponses;
import io.swagger.v3.oas.annotations.tags.Tag;
import lombok.RequiredArgsConstructor;
import org.springframework.web.bind.annotation.*;

@RequestMapping("/api/image")
@RestController
@RequiredArgsConstructor
@Tag(
        name = "Image",
        description = "ì´ë¯¸ì§€ ì—…ë¡œë“œ ê´€ë ¨ APIì…ë‹ˆë‹¤. í´ë¼ì´ì–¸íŠ¸ê°€ S3ì— ì§ì ‘ PUT ì—…ë¡œë“œí•  ìˆ˜ ìˆë„ë¡ Presigned URLì„ ë°œê¸‰í•©ë‹ˆë‹¤."
)
public class ImageController {

    private final S3Service s3Service;

    @GetMapping("/presigned-put-url")
    @Operation(
            summary = "S3 Presigned PUT URL ë°œê¸‰",
            description = """
                í™•ì¥ì(ì˜ˆ: jpg, png, webp ë“±)ë¥¼ ì…ë ¥í•˜ë©´ S3ì— ì§ì ‘ ì—…ë¡œë“œ ê°€ëŠ¥í•œ Presigned PUT URLì„ ë°œê¸‰í•©ë‹ˆë‹¤.
                ì‘ë‹µì˜ keyëŠ” ì—…ë¡œë“œëœ ê°ì²´ì˜ S3 Keyì´ë©°, uploadUrlë¡œ í•´ë‹¹ íŒŒì¼ì„ PUT ì—…ë¡œë“œí•˜ë©´ ë©ë‹ˆë‹¤.
                """
    )
    @ApiResponses({
            @ApiResponse(
                    responseCode = "200",
                    description = "ì„±ê³µì ìœ¼ë¡œ Presigned URL ë°œê¸‰ë¨",
                    content = @Content(
                            mediaType = "application/json",
                            schema = @Schema(implementation = GeneratePresignedPutUrlResponse.class),
                            examples = @ExampleObject(
                                    name = "ì„±ê³µ ì˜ˆì‹œ",
                                    value = """
                    {
                      "success": true,
                      "data": {
                        "uploadUrl": "https://pre-piuda.s3.ap-northeast-2.amazonaws.com/public/user_objects/2025-09-24/1f535333d9b5_1758707009522.jpg?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Date=20250924T094329Z&X-Amz-SignedHeaders=host&X-Amz-Credential=...&X-Amz-Expires=1800&X-Amz-Signature=...",
                        "key": "public/user_objects/2025-09-24/1f535333d9b5_1758707009522.jpg",
                        "expirationSeconds": 1800
                      }
                    }
                    """
                            )
                    )
            ),
            @ApiResponse(
                    responseCode = "400",
                    description = "ìš”ì²­ íŒŒë¼ë¯¸í„° ì˜¤ë¥˜(í—ˆìš©ë˜ì§€ ì•ŠëŠ” í™•ì¥ì ë“±)",
                    content = @Content(
                            mediaType = "application/json",
                            examples = @ExampleObject(
                                    name = "ì˜ëª»ëœ í™•ì¥ì ì˜ˆì‹œ",
                                    value = """
                    {
                      "success": false,
                      "error": {
                        "code": "INVALID_EXTENSION",
                        "message": "í—ˆìš©ë˜ì§€ ì•ŠëŠ” í™•ì¥ìì…ë‹ˆë‹¤."
                      }
                    }
                    """
                            )
                    )
            )
    })
    public ApiData<GeneratePresignedPutUrlResponse> generatePresignedPutUrl(
            @Parameter(
                    description = "íŒŒì¼ í™•ì¥ìì…ë‹ˆë‹¤. ì (.) ì—†ì´ ì…ë ¥í•©ë‹ˆë‹¤. ì˜ˆ: jpg, png, webp",
                    example = "jpg",
                    required = true
            )
            @RequestParam String extension
    ) {
        return ApiData.ok(s3Service.generatePresignedPutUrl(extension));
    }
}


================================================================================
File Path: .\src\main\java\com\ocean\piuda\aws\dto\response\GeneratePresignedPutUrlResponse.java
================================================================================

package com.ocean.piuda.aws.dto.response;

import software.amazon.awssdk.services.s3.presigner.model.PresignedPutObjectRequest;

import java.time.Instant;

public record GeneratePresignedPutUrlResponse(
    String presignedUrl,
    Instant expiresAt,
    String key
) {

  public static GeneratePresignedPutUrlResponse from(PresignedPutObjectRequest presignedPutObjectRequest, String key) {
    return new GeneratePresignedPutUrlResponse(
        presignedPutObjectRequest.url().toString(),
        presignedPutObjectRequest.expiration(),
        key
    );
  }
}


================================================================================
File Path: .\src\main\java\com\ocean\piuda\aws\properties\AwsConfigProperties.java
================================================================================

package com.ocean.piuda.aws.properties;

import jakarta.validation.constraints.Min;
import jakarta.validation.constraints.NotBlank;
import lombok.Data;
import lombok.Getter;
import lombok.Setter;
import org.springframework.boot.context.properties.ConfigurationProperties;
import org.springframework.stereotype.Component;
import org.springframework.validation.annotation.Validated;

@ConfigurationProperties(prefix = "aws")
@Component
@Getter
@Setter
public class AwsConfigProperties {

    private String accessKey;
    private String secretKey;
    private String region;

    private S3Properties s3;

    @Data
    @Validated
    public static class S3Properties {
        /**
         * AWS S3 Bucket Name
         */
        @NotBlank(message = "AWS S3 Bucket Name must not be blank")
        private String bucketName;

        /**
         * AWS S3 Project Folder Name
         * <p>
         * All files uploaded to S3 on this project will be stored in this folder.
         */
        @NotBlank(message = "AWS S3 Project Folder Name must not be blank")
        private String projectFolderName;

        /**
         * AWS S3 Presigned URL Expiration Time. (in seconds) Default: 10 minutes
         */
        @Min(value = 1, message = "AWS S3 Presigned URL Expiration Time must be greater than 0")
        private Long expirationTime = 600L;


        /**
         * AWS S3 User Objects Directory Name
         * <p>
         * All files uploaded to S3 by users will be stored in this folder.
         */
        private String userObjectsDirectory = "user_objects";
    }
}


================================================================================
File Path: .\src\main\java\com\ocean\piuda\aws\service\S3Service.java
================================================================================

package com.ocean.piuda.aws.service;

import com.ocean.piuda.aws.dto.response.GeneratePresignedPutUrlResponse;
import com.ocean.piuda.aws.properties.AwsConfigProperties;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;
import software.amazon.awssdk.services.s3.model.PutObjectRequest;
import software.amazon.awssdk.services.s3.presigner.S3Presigner;
import software.amazon.awssdk.services.s3.presigner.model.PresignedPutObjectRequest;
import software.amazon.awssdk.services.s3.presigner.model.PutObjectPresignRequest;

import java.time.Duration;
import java.time.Instant;
import java.time.LocalDate;
import java.util.UUID;


@Service
@RequiredArgsConstructor
@Slf4j
public class S3Service {

    private final S3Presigner s3Presigner;
    private final AwsConfigProperties aws;

    /** ì™¸ë¶€ì—ì„œ extensionë§Œ ë°›ì•„ presign ìƒì„± */
    public GeneratePresignedPutUrlResponse generatePresignedPutUrl(String extension) {
        String key = buildObjectKey(
                aws.getS3().getProjectFolderName(),
                aws.getS3().getUserObjectsDirectory(),
                extension
        );
        return generatePresignedPutUrl(
                aws.getS3().getBucketName(),
                key,
                Duration.ofSeconds(aws.getS3().getExpirationTime())
        );
    }

    /** ë²„í‚·/í‚¤/ë§Œë£Œ ì§€ì • presign */
    public GeneratePresignedPutUrlResponse generatePresignedPutUrl(
            String bucketName,
            String key,
            Duration expirationTime
    ) {
        PutObjectRequest putObjectRequest = PutObjectRequest.builder()
                .bucket(bucketName)
                .key(key)
                // í¼ë¸”ë¦­/CORSë¥¼ ê·¸ëŒ€ë¡œ ì“°ë¯€ë¡œ ì¶”ê°€ í—¤ë” ì œì•½ ì—†ì´ ë‹¨ìˆœ PUT presign
                .build();

        PutObjectPresignRequest putObjectPresignRequest = PutObjectPresignRequest.builder()
                .signatureDuration(expirationTime)
                .putObjectRequest(putObjectRequest)
                .build();

        PresignedPutObjectRequest presigned = s3Presigner.presignPutObject(putObjectPresignRequest);
        return GeneratePresignedPutUrlResponse.from(presigned, key);
    }

    /** í‚¤ ìƒì„± ë²„ê·¸ ìˆ˜ì •: í´ë”/í™•ì¥ì ì /ì¼ì ê²½ë¡œ ë°˜ì˜ */
    public String buildObjectKey(String projectFolder, String userDir, String extension) {
        String ext = normalizeExt(extension); // ".jpg" í˜•íƒœë¡œ ë³´ì •
        String date = LocalDate.now().toString(); // YYYY-MM-DD
        String uuid = UUID.randomUUID().toString().replace("-", "");
        String ts = String.valueOf(Instant.now().toEpochMilli());

        // {projectFolder}/{userDir}/{YYYY-MM-DD}/{uuid}_{ts}{ext}
        return String.format("%s/%s/%s/%s_%s%s",
                trimSlashes(projectFolder),
                trimSlashes(userDir),
                date,
                uuid,
                ts,
                ext
        );
    }

    private String normalizeExt(String extension) {
        if (extension == null || extension.isBlank()) return "";
        String e = extension.trim();
        if (!e.startsWith(".")) e = "." + e;
        return e.toLowerCase();
    }

    private String trimSlashes(String s) {
        if (s == null) return "";
        return s.replaceAll("^/+", "").replaceAll("/+$", "");
    }}


================================================================================
File Path: .\src\main\java\com\ocean\piuda\bio\enums\BioGroup.java
================================================================================

package com.ocean.piuda.bio.enums;


import lombok.AllArgsConstructor;
import lombok.Getter;

/**
 * í•´ì–‘/ìˆ˜ì‚° ìƒë¬¼ ê·¸ë£¹ íƒœê·¸ ê³µí†µ enum.
 * - Taxon(ì¢… ì •ë³´)
 * - Mission(ë¯¸ì…˜ ë„ë©”ì¸)
 * - Post(ê²Œì‹œê¸€ ë„ë©”ì¸)
 * ë“±ì—ì„œ ëª¨ë‘ ì´ íƒ€ì…ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.
 */

@Getter
@AllArgsConstructor
public enum BioGroup {

    MACROALGAE("í•´ì¡°ë¥˜"),
    SEAGRASS("í•´ì´ˆë¥˜"),
    FISH("ì–´ë¥˜"),
    MOLLUSK("ì—°ì²´ë™ë¬¼"),
    CRUSTACEAN("ê°‘ê°ë¥˜"),
    ECHINODERM("ê·¹í”¼ë™ë¬¼"),
    CNIDARIA("ìí¬ë™ë¬¼"),
    PORIFERA("í•´ë©´ë™ë¬¼"),
    POLYCHAETE("ë‹¤ëª¨ë¥˜"),
    BRYOZOAN("íƒœí˜•ë™ë¬¼"),
    TUNICATE("í”¼ë‚­ë™ë¬¼"),
    OTHER_VERTEBRATE("ê¸°íƒ€ ì²™ì¶”ë™ë¬¼");

    private final String description;

}



================================================================================
File Path: .\src\main\java\com\ocean\piuda\environment\client\dto\KhoaTideResponse.java
================================================================================

package com.ocean.piuda.environment.client.dto;

import com.fasterxml.jackson.annotation.JsonIgnoreProperties;
import com.fasterxml.jackson.annotation.JsonProperty;
import lombok.Data;

import java.util.List;

/**
 * KHOA ì¡°ìœ„ API ì‘ë‹µ DTO
 */
@Data
@JsonIgnoreProperties(ignoreUnknown = true)
public class KhoaTideResponse {
    @JsonProperty("response")
    private Response response;

    @Data
    @JsonIgnoreProperties(ignoreUnknown = true)
    public static class Response {
        @JsonProperty("header")
        private Header header;

        @JsonProperty("body")
        private Body body;
    }

    @Data
    @JsonIgnoreProperties(ignoreUnknown = true)
    public static class Header {
        @JsonProperty("resultCode")
        private String resultCode;

        @JsonProperty("resultMsg")
        private String resultMsg;
    }

    @Data
    @JsonIgnoreProperties(ignoreUnknown = true)
    public static class Body {
        @JsonProperty("items")
        private List<Item> items;
    }

    @Data
    @JsonIgnoreProperties(ignoreUnknown = true)
    public static class Item {
        @JsonProperty("obs_post_id")
        private String obsPostId;

        @JsonProperty("obs_post_nm")
        private String obsPostNm;

        @JsonProperty("obs_dt")
        private String obsDt; // ê´€ì¸¡ì¼ì‹œ (yyyyMMddHHmm)

        @JsonProperty("tide_level")
        private Double tideLevel; // ì¡°ìœ„ (cm)
    }
}



================================================================================
File Path: .\src\main\java\com\ocean\piuda\environment\client\dto\KmaSeaObsResponse.java
================================================================================

package com.ocean.piuda.environment.client.dto;

import com.fasterxml.jackson.annotation.JsonIgnoreProperties;
import com.fasterxml.jackson.annotation.JsonProperty;
import lombok.Data;

import java.util.List;

/**
 * KMA í•´ì–‘ê¸°ìƒì¢…í•©ê´€ì¸¡ API ì‘ë‹µ DTO
 */
@Data
@JsonIgnoreProperties(ignoreUnknown = true)
public class KmaSeaObsResponse {
    @JsonProperty("list")
    private List<Item> list;

    @Data
    @JsonIgnoreProperties(ignoreUnknown = true)
    public static class Item {
        @JsonProperty("stn")
        private String stn; // ê´€ì¸¡ì†Œ ë²ˆí˜¸

        @JsonProperty("stn_nm")
        private String stnNm; // ê´€ì¸¡ì†Œ ì´ë¦„

        @JsonProperty("tm")
        private String tm; // ê´€ì¸¡ì‹œê° (yyyyMMddHHmm)

        @JsonProperty("lat")
        private Double lat; // ìœ„ë„

        @JsonProperty("lon")
        private Double lon; // ê²½ë„

        @JsonProperty("WH")
        private Double wh; // íŒŒê³  (m)

        @JsonProperty("WD")
        private Double wd; // í’í–¥ (ë„)

        @JsonProperty("WS")
        private Double ws; // í’ì† (m/s)

        @JsonProperty("TW")
        private Double tw; // í•´ìˆ˜ë©´ ì˜¨ë„ (â„ƒ)
    }
}



================================================================================
File Path: .\src\main\java\com\ocean\piuda\environment\client\dto\NifsRisaResponse.java
================================================================================

package com.ocean.piuda.environment.client.dto;

import com.fasterxml.jackson.annotation.JsonIgnoreProperties;
import com.fasterxml.jackson.annotation.JsonProperty;
import lombok.Data;

import java.util.List;

/**
 * NIFS RISA API ì‘ë‹µ DTO
 */
@Data
@JsonIgnoreProperties(ignoreUnknown = true)
public class NifsRisaResponse {
    @JsonProperty("body")
    private Body body;

    @JsonProperty("header")
    private Header header;

    @Data
    @JsonIgnoreProperties(ignoreUnknown = true)
    public static class Body {
        @JsonProperty("item")
        private List<NifsRisaItem> item;
    }

    @Data
    @JsonIgnoreProperties(ignoreUnknown = true)
    public static class Header {
        @JsonProperty("resultCode")
        private String resultCode;

        @JsonProperty("resultMsg")
        private String resultMsg;
    }

    @Data
    @JsonIgnoreProperties(ignoreUnknown = true)
    public static class NifsRisaItem {
        @JsonProperty("sta_cde")
        private String staCde; // ê´€ì¸¡ì†Œ ì½”ë“œ (ê¸°ì¡´ obs_post_id)

        @JsonProperty("sta_nam_kor")
        private String staNamKor; // ê´€ì¸¡ì†Œ ì´ë¦„ (ê¸°ì¡´ obs_post_nm)

        @JsonProperty("obs_lay")
        private String obsLay; // ìˆ˜ì¸µ (1: í‘œì¸µ, 2: ì¤‘ì¸µ, 3: ì €ì¸µ)

        @JsonProperty("wtr_tmp")
        private String wtrTmp; // ìˆ˜ì˜¨ (ê¸°ì¡´ water_temp)

        @JsonProperty("obs_dat")
        private String obsDat; // ê´€ì¸¡ì¼

        @JsonProperty("obs_tim")
        private String obsTim; // ê´€ì¸¡ì‹œê°

        // ê´€ì¸¡ì†Œ ìœ„ì¹˜ ì •ë³´ëŠ” ë³„ë„ APIë¡œ ê°€ì ¸ì™€ì•¼ í•  ìˆ˜ ìˆìŒ
        // ì„ì‹œë¡œ null ì²˜ë¦¬
        public Double getObsLat() {
            return null; // TODO: ê´€ì¸¡ì†Œ ìœ„ì¹˜ ì •ë³´ ë³„ë„ ì¡°íšŒ í•„ìš”
        }

        public Double getObsLon() {
            return null; // TODO: ê´€ì¸¡ì†Œ ìœ„ì¹˜ ì •ë³´ ë³„ë„ ì¡°íšŒ í•„ìš”
        }

        public String getObsPostId() {
            return staCde;
        }

        public String getObsPostNm() {
            return staNamKor;
        }

        public Integer getObsLayInt() {
            try {
                return Integer.parseInt(obsLay);
            } catch (Exception e) {
                return null;
            }
        }

        public Double getWaterTemp() {
            try {
                return Double.parseDouble(wtrTmp);
            } catch (Exception e) {
                return null;
            }
        }

        // ì—¼ë¶„ê³¼ ìš©ì¡´ì‚°ì†ŒëŠ” í˜„ì¬ API ì‘ë‹µì— ì—†ìŒ
        public Double getSalinity() {
            return null;
        }

        public Double getDissolvedOxygen() {
            return null;
        }
    }
}



================================================================================
File Path: .\src\main\java\com\ocean\piuda\environment\client\KhoaTideClient.java
================================================================================

package com.ocean.piuda.environment.client;

import com.fasterxml.jackson.databind.ObjectMapper;
import com.ocean.piuda.environment.client.dto.KhoaTideResponse;
import com.ocean.piuda.environment.properties.MarineApiProperties;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Qualifier;
import org.springframework.stereotype.Component;
import org.springframework.web.reactive.function.client.WebClient;
import reactor.core.publisher.Mono;

import java.time.LocalDate;
import java.time.LocalTime;
import java.time.format.DateTimeFormatter;

/**
 * KHOA ì¡°ìœ„ ê´€ì¸¡ API í´ë¼ì´ì–¸íŠ¸
 */
@Slf4j
@Component
public class KhoaTideClient {

    private static final String BASE_URL = "https://apis.data.go.kr/1192136/surveyTideLevel";
    private static final DateTimeFormatter DATE_FORMATTER = DateTimeFormatter.ofPattern("yyyyMMdd");
    private static final DateTimeFormatter TIME_FORMATTER = DateTimeFormatter.ofPattern("HHmm");

    private final WebClient webClient;
    private final MarineApiProperties properties;
    private final ObjectMapper objectMapper;

    public KhoaTideClient(@Qualifier("marineWebClient") WebClient webClient,
                         MarineApiProperties properties,
                         ObjectMapper objectMapper) {
        this.webClient = webClient;
        this.properties = properties;
        this.objectMapper = objectMapper;
    }

    /**
     * ì¡°ìœ„ ê´€ì¸¡ê°’ ì¡°íšŒ
     *
     * @param stationId ê´€ì¸¡ì†Œ ID
     * @param date ê´€ì¸¡ì¼
     * @param time ê´€ì¸¡ì‹œê° (ì„ íƒ)
     * @return ì¡°ìœ„ ê´€ì¸¡ê°’
     */
    public Mono<KhoaTideResponse.Item> fetchTideLevel(String stationId, LocalDate date, LocalTime time) {
        String dateStr = date.format(DATE_FORMATTER);
        String timeStr = time != null ? time.format(TIME_FORMATTER) : "";

        String url = String.format("%s?ServiceKey=%s&obs_post_id=%s&date=%s",
                BASE_URL, properties.getKhoa().getKeyEncoding(), stationId, dateStr);

        if (!timeStr.isEmpty()) {
            url += "&time=" + timeStr;
        }

        return webClient.get()
                .uri(url)
                .retrieve()
                .bodyToMono(String.class)
                .map(response -> {
                    try {
                        // ì—ëŸ¬ ì‘ë‹µ í™•ì¸
                        if (response == null || response.trim().isEmpty() || response.contains("unexpected errors")) {
                            log.warn("KHOA API ì˜¤ë¥˜ ì‘ë‹µ: stationId={}, response={}", stationId, response);
                            return null;
                        }

                        log.debug("KHOA ì‘ë‹µ: {}", response.substring(0, Math.min(500, response.length())));

                        KhoaTideResponse parsed = objectMapper.readValue(response, KhoaTideResponse.class);
                        if (parsed.getResponse() == null
                                || parsed.getResponse().getBody() == null
                                || parsed.getResponse().getBody().getItems() == null
                                || parsed.getResponse().getBody().getItems().isEmpty()) {
                            log.warn("KHOA ì¡°ìœ„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤: stationId={}, date={}", stationId, date);
                            return null;
                        }

                        // ìµœì‹  ê´€ì¸¡ê°’ ë°˜í™˜
                        return parsed.getResponse().getBody().getItems().get(0);
                    } catch (Exception e) {
                        log.error("KHOA ì¡°ìœ„ ì‘ë‹µ íŒŒì‹± ì‹¤íŒ¨: stationId={}, date={}, response={}", 
                                stationId, date, response != null ? response.substring(0, Math.min(500, response.length())) : "null", e);
                        return null;
                    }
                })
                .doOnError(error -> {
                    // 500 ì—ëŸ¬ëŠ” ì™¸ë¶€ ì„œë²„ ë¬¸ì œì´ë¯€ë¡œ WARN ë ˆë²¨ë¡œ ë¡œê¹…
                    if (error instanceof org.springframework.web.reactive.function.client.WebClientResponseException) {
                        org.springframework.web.reactive.function.client.WebClientResponseException webClientError = 
                                (org.springframework.web.reactive.function.client.WebClientResponseException) error;
                        if (webClientError.getStatusCode().value() == 500) {
                            log.warn("KHOA ì¡°ìœ„ API ì„œë²„ ì˜¤ë¥˜ (500): stationId={}, ì´ëŠ” ì™¸ë¶€ API ì„œë²„ ë¬¸ì œì…ë‹ˆë‹¤.", stationId);
                        } else {
                            log.error("KHOA ì¡°ìœ„ API í˜¸ì¶œ ì‹¤íŒ¨: stationId={}, status={}", stationId, webClientError.getStatusCode(), error);
                        }
                    } else {
                        log.error("KHOA ì¡°ìœ„ API í˜¸ì¶œ ì‹¤íŒ¨: stationId={}", stationId, error);
                    }
                })
                .onErrorResume(error -> {
                    // ì—ëŸ¬ ë°œìƒ ì‹œ null ë°˜í™˜ (ì´ë¯¸ doOnErrorì—ì„œ ë¡œê¹…ë¨)
                    return Mono.justOrEmpty((KhoaTideResponse.Item) null);
                });
    }

    /**
     * ì˜¤ëŠ˜ì˜ ìµœì‹  ì¡°ìœ„ ê´€ì¸¡ê°’ ì¡°íšŒ
     */
    public Mono<KhoaTideResponse.Item> fetchLatestTideLevel(String stationId) {
        return fetchTideLevel(stationId, LocalDate.now(), null);
    }
}



================================================================================
File Path: .\src\main\java\com\ocean\piuda\environment\client\KmaSeaObsClient.java
================================================================================

package com.ocean.piuda.environment.client;

import com.fasterxml.jackson.databind.ObjectMapper;
import com.ocean.piuda.environment.client.dto.KmaSeaObsResponse;
import com.ocean.piuda.environment.properties.MarineApiProperties;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Qualifier;
import org.springframework.stereotype.Component;
import org.springframework.web.reactive.function.client.WebClient;
import reactor.core.publisher.Mono;

import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;
import java.util.ArrayList;
import java.util.Collections;
import java.util.List;

/**
 * KMA í•´ì–‘ê¸°ìƒì¢…í•©ê´€ì¸¡ API í´ë¼ì´ì–¸íŠ¸
 */
@Slf4j
@Component
public class KmaSeaObsClient {

    private static final String BASE_URL = "https://apihub.kma.go.kr/api/typ01/url/sea_obs.php";
    private static final DateTimeFormatter DATE_TIME_FORMATTER = DateTimeFormatter.ofPattern("yyyyMMddHHmm");

    private final WebClient webClient;
    private final MarineApiProperties properties;
    private final ObjectMapper objectMapper;

    public KmaSeaObsClient(@Qualifier("marineWebClient") WebClient webClient,
                          MarineApiProperties properties,
                          ObjectMapper objectMapper) {
        this.webClient = webClient;
        this.properties = properties;
        this.objectMapper = objectMapper;
    }

    /**
     * í•´ì–‘ê¸°ìƒ ê´€ì¸¡ê°’ ì¡°íšŒ
     *
     * @param stationId ê´€ì¸¡ì†Œ ë²ˆí˜¸ (0ì´ë©´ ì „ì²´)
     * @param dateTime ê´€ì¸¡ì‹œê°
     * @return ê´€ì¸¡ê°’ ë¦¬ìŠ¤íŠ¸
     */
    public Mono<List<KmaSeaObsResponse.Item>> fetchObservations(String stationId, LocalDateTime dateTime) {
        String tm = dateTime.format(DATE_TIME_FORMATTER);
        String url = String.format("%s?tm=%s&stn=%s&authKey=%s",
                BASE_URL, tm, stationId, properties.getKma().getKey());

        return webClient.get()
                .uri(url)
                .retrieve()
                .bodyToMono(String.class)
                .map(response -> {
                    try {
                        // KMA APIëŠ” í…ìŠ¤íŠ¸ í˜•ì‹ìœ¼ë¡œ ì‘ë‹µ
                        return parseKmaTextResponse(response, stationId);
                    } catch (Exception e) {
                        log.error("KMA í•´ì–‘ê¸°ìƒ ì‘ë‹µ íŒŒì‹± ì‹¤íŒ¨: stationId={}, dateTime={}", stationId, dateTime, e);
                        log.debug("KMA ì‘ë‹µ ë‚´ìš©: {}", response.substring(0, Math.min(500, response.length())));
                        return new ArrayList<KmaSeaObsResponse.Item>();
                    }
                })
                .doOnError(error -> log.error("KMA í•´ì–‘ê¸°ìƒ API í˜¸ì¶œ ì‹¤íŒ¨: stationId={}", stationId, error))
                .onErrorResume(error -> Mono.just(new ArrayList<KmaSeaObsResponse.Item>()));
    }

    /**
     * ìµœì‹  í•´ì–‘ê¸°ìƒ ê´€ì¸¡ê°’ ì¡°íšŒ
     */
    public Mono<KmaSeaObsResponse.Item> fetchLatestObservation(String stationId) {
        return fetchObservations(stationId, LocalDateTime.now())
                .map(items -> items.isEmpty() ? null : items.get(0));
    }

    /**
     * KMA í…ìŠ¤íŠ¸ í˜•ì‹ ì‘ë‹µ íŒŒì‹±
     * í˜•ì‹: B, 202511261200, 22101, ê´€ì¸¡ì†Œëª…, 126.01880000, 37.23610000, 0.5, 284, 2.2, 4.2, 15.2, 8.9, 1026.3, 49.0, ,=
     * ì»¬ëŸ¼: íƒ€ì…, ì‹œê°, ê´€ì¸¡ì†ŒID, ê´€ì¸¡ì†Œëª…, ê²½ë„, ìœ„ë„, WH(íŒŒê³ ), WD(í’í–¥), WS(í’ì†), GST, TW(í•´ìˆ˜ì˜¨), TA, PA, HM, ...
     */
    private List<KmaSeaObsResponse.Item> parseKmaTextResponse(String text, String targetStationId) {
        List<KmaSeaObsResponse.Item> items = new ArrayList<>();

        if (text == null || text.trim().isEmpty() || text.contains("unexpected errors")) {
            log.warn("KMA API ì‘ë‹µì´ ë¹„ì–´ìˆê±°ë‚˜ ì˜¤ë¥˜ê°€ ìˆìŠµë‹ˆë‹¤.");
            return items;
        }

        String[] lines = text.split("\n");
        for (String line : lines) {
            line = line.trim();
            // ì£¼ì„ì´ë‚˜ í—¤ë” ë¼ì¸ ê±´ë„ˆë›°ê¸°
            if (line.startsWith("#") || line.isEmpty() || line.startsWith("START") || line.startsWith("END")) {
                continue;
            }

            // ë°ì´í„° ë¼ì¸ íŒŒì‹± (B ë˜ëŠ” Cë¡œ ì‹œì‘)
            if (line.startsWith("B,") || line.startsWith("C,")) {
                try {
                    String[] parts = line.split(",");
                    if (parts.length < 14) {
                        continue;
                    }

                    String stn = parts[2].trim();
                    // íŠ¹ì • ê´€ì¸¡ì†Œë§Œ ì¡°íšŒí•˜ëŠ” ê²½ìš° í•„í„°ë§
                    if (targetStationId != null && !targetStationId.equals("0") && !targetStationId.equals(stn)) {
                        continue;
                    }

                    KmaSeaObsResponse.Item item = new KmaSeaObsResponse.Item();
                    item.setStn(stn);
                    item.setStnNm(parts[3].trim());
                    item.setTm(parts[1].trim());

                    // ê²½ë„, ìœ„ë„
                    try {
                        item.setLon(Double.parseDouble(parts[4].trim()));
                        item.setLat(Double.parseDouble(parts[5].trim()));
                    } catch (Exception e) {
                        log.warn("ì¢Œí‘œ íŒŒì‹± ì‹¤íŒ¨: {}", line);
                    }

                    // WH (íŒŒê³ ), WD (í’í–¥), WS (í’ì†), TW (í•´ìˆ˜ì˜¨)
                    // ì»¬ëŸ¼ ìˆœì„œ: TP(0), TM(1), STN_ID(2), STN_KO(3), LON(4), LAT(5), WH(6), WD(7), WS(8), WS_GST(9), TW(10), TA(11), PA(12), HM(13)
                    try {
                        String whStr = parts[6].trim();
                        if (!whStr.equals("-99.0") && !whStr.equals("-99") && !whStr.isEmpty()) {
                            item.setWh(Double.parseDouble(whStr));
                        }
                    } catch (Exception e) {
                        log.debug("íŒŒê³ (WH) íŒŒì‹± ì‹¤íŒ¨: stn={}, value={}", stn, parts[6]);
                    }

                    try {
                        String wdStr = parts[7].trim();
                        if (!wdStr.equals("-99") && !wdStr.equals("-99.0") && !wdStr.isEmpty()) {
                            item.setWd(Double.parseDouble(wdStr));
                        }
                    } catch (Exception e) {
                        log.debug("í’í–¥(WD) íŒŒì‹± ì‹¤íŒ¨: stn={}, value={}", stn, parts[7]);
                    }

                    try {
                        String wsStr = parts[8].trim();
                        if (!wsStr.equals("-99.0") && !wsStr.equals("-99") && !wsStr.isEmpty()) {
                            Double ws = Double.parseDouble(wsStr);
                            item.setWs(ws);
                            log.debug("í’ì†(WS) íŒŒì‹± ì„±ê³µ: stn={}, ws={}", stn, ws);
                        } else {
                            log.debug("í’ì†(WS) ë°ì´í„° ì—†ìŒ: stn={}, value={}", stn, wsStr);
                        }
                    } catch (Exception e) {
                        log.warn("í’ì†(WS) íŒŒì‹± ì‹¤íŒ¨: stn={}, value={}, error={}", stn, parts[8], e.getMessage());
                    }

                    try {
                        String twStr = parts[10].trim();
                        if (!twStr.equals("-99.0") && !twStr.equals("-99") && !twStr.isEmpty()) {
                            item.setTw(Double.parseDouble(twStr));
                        }
                    } catch (Exception e) {
                        log.debug("í•´ìˆ˜ì˜¨(TW) íŒŒì‹± ì‹¤íŒ¨: stn={}, value={}", stn, parts[10]);
                    }

                    items.add(item);
                } catch (Exception e) {
                    log.warn("KMA ë°ì´í„° ë¼ì¸ íŒŒì‹± ì‹¤íŒ¨: {}", line, e);
                }
            }
        }

        return items;
    }
}



================================================================================
File Path: .\src\main\java\com\ocean\piuda\environment\client\NifsRisaClient.java
================================================================================

package com.ocean.piuda.environment.client;

import com.fasterxml.jackson.databind.ObjectMapper;
import com.ocean.piuda.environment.client.dto.NifsRisaResponse;
import com.ocean.piuda.environment.domain.StationSource;
import com.ocean.piuda.environment.properties.MarineApiProperties;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Qualifier;
import org.springframework.stereotype.Component;
import org.springframework.web.reactive.function.client.WebClient;
import reactor.core.publisher.Mono;

import java.time.ZonedDateTime;
import java.util.ArrayList;
import java.util.Collections;
import java.util.List;

/**
 * NIFS RISA ì‹¤ì‹œê°„ í•´ì–‘ìˆ˜ì‚°í™˜ê²½ ê´€ì¸¡ API í´ë¼ì´ì–¸íŠ¸
 */
@Slf4j
@Component
public class NifsRisaClient {

    private static final String BASE_URL = "https://www.nifs.go.kr/bweb/OpenAPI_json";
    private static final List<Integer> LAYER_PRIORITY = List.of(2, 1, 3); // ì¤‘ì¸µ -> í‘œì¸µ -> ì €ì¸µ ìˆœ

    private final WebClient webClient;
    private final MarineApiProperties properties;
    private final ObjectMapper objectMapper;

    public NifsRisaClient(@Qualifier("marineWebClient") WebClient webClient,
                         MarineApiProperties properties,
                         ObjectMapper objectMapper) {
        this.webClient = webClient;
        this.properties = properties;
        this.objectMapper = objectMapper;
    }

    /**
     * ê´€ì¸¡ì†Œ ëª©ë¡ ì¡°íšŒ
     */
    public Mono<List<NifsRisaResponse.NifsRisaItem>> fetchStations() {
        String url = String.format("%s?id=risaList&key=%s", BASE_URL, properties.getNifs().getKey());

        return webClient.get()
                .uri(url)
                .retrieve()
                .bodyToMono(String.class)
                .map(response -> {
                    try {
                        NifsRisaResponse parsed = objectMapper.readValue(response, NifsRisaResponse.class);
                        if (parsed.getBody() != null && parsed.getBody().getItem() != null) {
                            return parsed.getBody().getItem();
                        }
                        return new ArrayList<NifsRisaResponse.NifsRisaItem>();
                    } catch (Exception e) {
                        log.error("NIFS RISA ì‘ë‹µ íŒŒì‹± ì‹¤íŒ¨: {}", response.substring(0, Math.min(200, response.length())), e);
                        return new ArrayList<NifsRisaResponse.NifsRisaItem>();
                    }
                })
                .doOnError(error -> log.error("NIFS RISA API í˜¸ì¶œ ì‹¤íŒ¨", error))
                .onErrorResume(error -> Mono.just(new ArrayList<NifsRisaResponse.NifsRisaItem>()));
    }

    /**
     * íŠ¹ì • ê´€ì¸¡ì†Œì˜ ìµœì‹  ê´€ì¸¡ê°’ ì¡°íšŒ
     * obs_lay ìš°ì„ ìˆœìœ„: 2(ì¤‘ì¸µ) -> 1(í‘œì¸µ) -> 3(ì €ì¸µ)
     * 
     * ì£¼ì˜: NIFS RISA APIëŠ” sta_cde íŒŒë¼ë¯¸í„°ë¥¼ ë„£ì–´ë„ ëª¨ë“  ê´€ì¸¡ì†Œ ë°ì´í„°ë¥¼ ë°˜í™˜í•˜ë¯€ë¡œ,
     * ì‘ë‹µì—ì„œ í•´ë‹¹ ê´€ì¸¡ì†Œë§Œ í•„í„°ë§í•´ì•¼ í•¨
     */
    public Mono<NifsRisaResponse.NifsRisaItem> fetchLatestObservation(String stationId) {
        String url = String.format("%s?id=risaList&key=%s&sta_cde=%s",
                BASE_URL, properties.getNifs().getKey(), stationId);

        return webClient.get()
                .uri(url)
                .retrieve()
                .bodyToMono(String.class)
                .flatMap(response -> {
                    try {
                        NifsRisaResponse parsed = objectMapper.readValue(response, NifsRisaResponse.class);
                        if (parsed.getBody() == null || parsed.getBody().getItem() == null || parsed.getBody().getItem().isEmpty()) {
                            log.warn("NIFS RISA API ì‘ë‹µì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤: stationId={}", stationId);
                            return Mono.empty();
                        }

                        List<NifsRisaResponse.NifsRisaItem> allItems = parsed.getBody().getItem();
                        
                        // í•´ë‹¹ ê´€ì¸¡ì†Œì˜ ë°ì´í„°ë§Œ í•„í„°ë§ (sta_cdeë¡œ ë§¤ì¹­)
                        List<NifsRisaResponse.NifsRisaItem> stationItems = allItems.stream()
                                .filter(item -> stationId.equals(item.getStaCde()))
                                .toList();

                        if (stationItems.isEmpty()) {
                            log.warn("NIFS RISA APIì—ì„œ í•´ë‹¹ ê´€ì¸¡ì†Œ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: stationId={}, ì „ì²´ ê´€ì¸¡ì†Œ ìˆ˜={}", 
                                    stationId, allItems.size());
                            return Mono.empty();
                        }

                        // ìš°ì„ ìˆœìœ„ì— ë”°ë¼ ê´€ì¸¡ê°’ ì„ íƒ (ì¤‘ì¸µ -> í‘œì¸µ -> ì €ì¸µ)
                        for (Integer layer : LAYER_PRIORITY) {
                            for (NifsRisaResponse.NifsRisaItem item : stationItems) {
                                if (item.getObsLayInt() != null && item.getObsLayInt().equals(layer)) {
                                    log.debug("NIFS RISA ê´€ì¸¡ê°’ ì¡°íšŒ ì„±ê³µ: stationId={}, layer={}, temp={}", 
                                            stationId, layer, item.getWaterTemp());
                                    return Mono.just(item);
                                }
                            }
                        }

                        // ìš°ì„ ìˆœìœ„ì— ë§ëŠ” ë ˆì´ì–´ê°€ ì—†ìœ¼ë©´ ì²« ë²ˆì§¸ í•­ëª© ë°˜í™˜
                        NifsRisaResponse.NifsRisaItem firstItem = stationItems.get(0);
                        log.debug("NIFS RISA ê´€ì¸¡ê°’ ì¡°íšŒ ì„±ê³µ (ìš°ì„ ìˆœìœ„ ë ˆì´ì–´ ì—†ìŒ): stationId={}, layer={}, temp={}", 
                                stationId, firstItem.getObsLayInt(), firstItem.getWaterTemp());
                        return Mono.just(firstItem);
                    } catch (Exception e) {
                        log.error("NIFS RISA ê´€ì¸¡ê°’ íŒŒì‹± ì‹¤íŒ¨: stationId={}, response={}", stationId, 
                                response.substring(0, Math.min(200, response.length())), e);
                        return Mono.empty();
                    }
                })
                .doOnError(error -> log.error("NIFS RISA ê´€ì¸¡ê°’ ì¡°íšŒ ì‹¤íŒ¨: stationId={}", stationId, error))
                .onErrorResume(error -> {
                    log.warn("NIFS RISA ê´€ì¸¡ê°’ ì¡°íšŒ ì—ëŸ¬ ì²˜ë¦¬: stationId={}, error={} (ê´€ì¸¡ì†Œê°€ APIì—ì„œ ì œê³µë˜ì§€ ì•Šì„ ìˆ˜ ìˆìŒ)", 
                            stationId, error.getMessage());
                    return Mono.empty();
                });
    }
}



================================================================================
File Path: .\src\main\java\com\ocean\piuda\environment\config\MarineWebClientConfig.java
================================================================================

package com.ocean.piuda.environment.config;

import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.web.reactive.function.client.WebClient;

import java.time.Duration;

/**
 * í•´ì–‘ í™˜ê²½ APIìš© WebClient ì„¤ì •
 */
@Configuration
public class MarineWebClientConfig {

    /**
     * í•´ì–‘ í™˜ê²½ API í˜¸ì¶œìš© WebClient
     * íƒ€ì„ì•„ì›ƒ ì„¤ì • í¬í•¨
     */
    @Bean("marineWebClient")
    public WebClient marineWebClient(WebClient.Builder builder) {
        return builder
                .codecs(configurer -> configurer
                        .defaultCodecs()
                        .maxInMemorySize(10 * 1024 * 1024)) // 10MB
                .build();
    }
}



================================================================================
File Path: .\src\main\java\com\ocean\piuda\environment\controller\EnvironmentSummaryController.java
================================================================================

package com.ocean.piuda.environment.controller;

import com.ocean.piuda.environment.dto.EnvironmentSummaryRequest;
import com.ocean.piuda.environment.dto.EnvironmentSummaryResponse;
import com.ocean.piuda.environment.service.EnvironmentSummaryService;
import jakarta.validation.Valid;
import lombok.RequiredArgsConstructor;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;

/**
 * í•´ì–‘ í™˜ê²½ ìš”ì•½ API ì»¨íŠ¸ë¡¤ëŸ¬
 */
@RestController
@RequestMapping("/api/environment")
@RequiredArgsConstructor
public class EnvironmentSummaryController {

    private final EnvironmentSummaryService environmentSummaryService;

    /**
     * í•´ì–‘ í™˜ê²½ ìš”ì•½ ì¡°íšŒ
     * 
     * GET /api/environment/summary?lat={lat}&lon={lon}
     * GET /api/environment/summary?pointId={pointId}
     * 
     * @param lat ìœ„ë„ (ì„ íƒ, pointIdê°€ ìˆìœ¼ë©´ ë¬´ì‹œ)
     * @param lon ê²½ë„ (ì„ íƒ, pointIdê°€ ìˆìœ¼ë©´ ë¬´ì‹œ)
     * @param pointId ë‹¤ì´ë¹™ í¬ì¸íŠ¸ ID (ì„ íƒ, ìˆìœ¼ë©´ lat/lon ë¬´ì‹œ)
     * @return í™˜ê²½ ìš”ì•½ ì •ë³´
     */
    @GetMapping("/summary")
    public ResponseEntity<EnvironmentSummaryResponse> getEnvironmentSummary(
            @RequestParam(required = false) Double lat,
            @RequestParam(required = false) Double lon,
            @RequestParam(required = false) Long pointId
    ) {
        EnvironmentSummaryRequest request = EnvironmentSummaryRequest.builder()
                .lat(lat)
                .lon(lon)
                .pointId(pointId)
                .build();

        EnvironmentSummaryResponse response = environmentSummaryService.getEnvironmentSummary(request);
        return ResponseEntity.ok(response);
    }
}



================================================================================
File Path: .\src\main\java\com\ocean\piuda\environment\domain\DivePoint.java
================================================================================

package com.ocean.piuda.environment.domain;

import com.ocean.piuda.global.api.domain.BaseEntity;
import jakarta.persistence.*;
import lombok.*;
import lombok.experimental.SuperBuilder;

/**
 * ë‹¤ì´ë¹™ í¬ì¸íŠ¸ ì—”í‹°í‹°
 * Missionì—ì„œ ì°¸ì¡°í•˜ëŠ” ë‹¤ì´ë¹™ ì§€ì  ì •ë³´
 */
@Entity
@Table(name = "dive_points", indexes = {
    @Index(name = "idx_dive_point_lat_lon", columnList = "lat, lon")
})
@SuperBuilder(toBuilder = true)
@Getter
@NoArgsConstructor(access = AccessLevel.PROTECTED)
@AllArgsConstructor
public class DivePoint extends BaseEntity {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    /**
     * í¬ì¸íŠ¸ ì´ë¦„
     */
    @Column(nullable = false, length = 200)
    private String name;

    /**
     * ìœ„ë„
     */
    @Column(nullable = false, columnDefinition = "DECIMAL(9,6)")
    private Double lat;

    /**
     * ê²½ë„
     */
    @Column(nullable = false, columnDefinition = "DECIMAL(9,6)")
    private Double lon;

    /**
     * ì§€ì—­ëª… (ì˜ˆ: "í¬í•­ ì›”í¬")
     */
    @Column(length = 200)
    private String regionName;

    /**
     * ì„¤ëª…
     */
    @Column(columnDefinition = "TEXT")
    private String description;
}



================================================================================
File Path: .\src\main\java\com\ocean\piuda\environment\domain\MarineObservation.java
================================================================================

package com.ocean.piuda.environment.domain;

import com.ocean.piuda.global.api.domain.BaseEntity;
import jakarta.persistence.*;
import lombok.*;
import lombok.experimental.SuperBuilder;

import java.time.ZonedDateTime;

/**
 * í•´ì–‘ ê´€ì¸¡ê°’ ì—”í‹°í‹°
 * ëª¨ë“  ì™¸ë¶€ APIì˜ ê´€ì¸¡ê°’ì„ í†µí•©í•˜ëŠ” ì •ê·œí™”ëœ ì—”í‹°í‹°
 */
@Entity
@Table(name = "marine_observations", indexes = {
    @Index(name = "idx_station_observed", columnList = "station_id, observedAt")
})
@SuperBuilder(toBuilder = true)
@Getter
@NoArgsConstructor(access = AccessLevel.PROTECTED)
@AllArgsConstructor
public class MarineObservation extends BaseEntity {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    /**
     * ê´€ì¸¡ì†Œ
     */
    @ManyToOne(fetch = FetchType.LAZY, optional = false)
    @JoinColumn(name = "station_id", nullable = false)
    private MarineStation station;

    /**
     * ê´€ì¸¡ ì‹œê°
     */
    @Column(nullable = false)
    private ZonedDateTime observedAt;

    /**
     * ìˆ˜ì¸µ ì •ë³´ (ì˜ˆ: "surface", "mid", "bottom", "2" ë“±)
     */
    @Column(length = 50)
    private String layer;

    // ìˆ˜ì˜¨/ì—¼ë¶„/ìš©ì¡´ì‚°ì†Œ
    /**
     * ìˆ˜ì˜¨ (â„ƒ)
     */
    @Column
    private Double waterTemp;

    /**
     * ì—¼ë¶„ (psu)
     */
    @Column
    private Double salinity;

    /**
     * ìš©ì¡´ì‚°ì†Œ (mg/L)
     */
    @Column
    private Double dissolvedOxygen;

    // íŒŒê³ /í’í–¥/í’ì†
    /**
     * íŒŒê³  (m)
     */
    @Column
    private Double waveHeight;

    /**
     * í’í–¥ (ë„)
     */
    @Column
    private Double windDirection;

    /**
     * í’ì† (m/s)
     */
    @Column
    private Double windSpeed;

    // ì¡°ìœ„
    /**
     * ì¡°ìœ„ (cm)
     */
    @Column
    private Double tideLevel;

    /**
     * ì›ë³¸ API ì‘ë‹µ JSON (ë””ë²„ê¹…/ê°ì‚¬ìš©)
     */
    @Lob
    @Column(columnDefinition = "TEXT")
    private String rawPayload;
}



================================================================================
File Path: .\src\main\java\com\ocean\piuda\environment\domain\MarineStation.java
================================================================================

package com.ocean.piuda.environment.domain;

import com.ocean.piuda.global.api.domain.BaseEntity;
import jakarta.persistence.*;
import lombok.*;
import lombok.experimental.SuperBuilder;

/**
 * í•´ì–‘ ê´€ì¸¡ì†Œ ì—”í‹°í‹°
 * ì™¸ë¶€ APIì—ì„œ ì œê³µí•˜ëŠ” ê´€ì¸¡ì†Œ ì •ë³´ë¥¼ ì €ì¥
 */
@Entity
@Table(name = "marine_stations", indexes = {
    @Index(name = "idx_source_ext", columnList = "externalSource, externalStationId"),
    @Index(name = "idx_lat_lon", columnList = "lat, lon")
})
@SuperBuilder(toBuilder = true)
@Getter
@NoArgsConstructor(access = AccessLevel.PROTECTED)
@AllArgsConstructor
public class MarineStation extends BaseEntity {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    /**
     * ì™¸ë¶€ API ì†ŒìŠ¤ (NIFS_RISA, KMA_SEA_OBS, KHOA_SURVEY_TIDE)
     */
    @Enumerated(EnumType.STRING)
    @Column(nullable = false, length = 50)
    private StationSource externalSource;

    /**
     * ì™¸ë¶€ APIì—ì„œ ì‚¬ìš©í•˜ëŠ” ê´€ì¸¡ì†Œ ID
     */
    @Column(nullable = false, length = 100)
    private String externalStationId;

    /**
     * ê´€ì¸¡ì†Œ ì´ë¦„
     */
    @Column(nullable = false, length = 200)
    private String name;

    /**
     * ìœ„ë„
     */
    @Column(nullable = false, columnDefinition = "DECIMAL(9,6)")
    private Double lat;

    /**
     * ê²½ë„
     */
    @Column(nullable = false, columnDefinition = "DECIMAL(9,6)")
    private Double lon;

    /**
     * ê´€ì¸¡ì†Œ í™œì„±í™” ì—¬ë¶€
     */
    @Builder.Default
    @Column(nullable = false)
    private Boolean isActive = true;
}



================================================================================
File Path: .\src\main\java\com\ocean\piuda\environment\domain\StationSource.java
================================================================================

package com.ocean.piuda.environment.domain;

/**
 * ê´€ì¸¡ì†Œ ë°ì´í„° ì†ŒìŠ¤ Enum
 */
public enum StationSource {
    NIFS_RISA,          // êµ­ë¦½ìˆ˜ì‚°ê³¼í•™ì› ì‹¤ì‹œê°„ í•´ì–‘ìˆ˜ì‚°í™˜ê²½ ê´€ì¸¡
    KMA_SEA_OBS,        // ê¸°ìƒì²­ í•´ì–‘ê¸°ìƒì¢…í•©ê´€ì¸¡
    KHOA_SURVEY_TIDE    // êµ­ë¦½í•´ì–‘ì¡°ì‚¬ì› ì¡°ìœ„ ê´€ì¸¡
}



================================================================================
File Path: .\src\main\java\com\ocean\piuda\environment\dto\EnvironmentSummaryRequest.java
================================================================================

package com.ocean.piuda.environment.dto;

import jakarta.validation.constraints.DecimalMax;
import jakarta.validation.constraints.DecimalMin;
import lombok.Builder;

/**
 * í™˜ê²½ ìš”ì•½ ì¡°íšŒ ìš”ì²­ DTO
 */
@Builder
public record EnvironmentSummaryRequest(
        /**
         * ìœ„ë„ (-90 ~ 90)
         */
        @DecimalMin(value = "-90.0", message = "ìœ„ë„ëŠ” -90 ~ 90 ì‚¬ì´ì—¬ì•¼ í•©ë‹ˆë‹¤")
        @DecimalMax(value = "90.0", message = "ìœ„ë„ëŠ” -90 ~ 90 ì‚¬ì´ì—¬ì•¼ í•©ë‹ˆë‹¤")
        Double lat,

        /**
         * ê²½ë„ (-180 ~ 180)
         */
        @DecimalMin(value = "-180.0", message = "ê²½ë„ëŠ” -180 ~ 180 ì‚¬ì´ì—¬ì•¼ í•©ë‹ˆë‹¤")
        @DecimalMax(value = "180.0", message = "ê²½ë„ëŠ” -180 ~ 180 ì‚¬ì´ì—¬ì•¼ í•©ë‹ˆë‹¤")
        Double lon,

        /**
         * ë‹¤ì´ë¹™ í¬ì¸íŠ¸ ID (pointIdê°€ ìˆìœ¼ë©´ lat/lon ë¬´ì‹œ)
         */
        Long pointId
) {
    /**
     * ì¢Œí‘œ ê¸°ë°˜ ìš”ì²­ì¸ì§€ í™•ì¸
     */
    public boolean isCoordinateBased() {
        return pointId == null && lat != null && lon != null;
    }

    /**
     * í¬ì¸íŠ¸ ID ê¸°ë°˜ ìš”ì²­ì¸ì§€ í™•ì¸
     */
    public boolean isPointIdBased() {
        return pointId != null;
    }
}



================================================================================
File Path: .\src\main\java\com\ocean\piuda\environment\dto\EnvironmentSummaryResponse.java
================================================================================

package com.ocean.piuda.environment.dto;

import com.fasterxml.jackson.annotation.JsonFormat;
import lombok.Builder;

import java.time.ZonedDateTime;
import java.util.List;

/**
 * í™˜ê²½ ìš”ì•½ ì‘ë‹µ DTO
 */
@Builder
public record EnvironmentSummaryResponse(
        Location location,
        @JsonFormat(pattern = "yyyy-MM-dd'T'HH:mm:ssXXX")
        ZonedDateTime timestamp,
        Water water,
        Wave wave,
        Tide tide,
        Meta meta
) {
    @Builder
    public record Location(
            Double lat,
            Double lon,
            NearestStations nearestStations
    ) {}

    @Builder
    public record NearestStations(
            StationInfo nifs,
            StationInfo kma,
            StationInfo khoa
    ) {}

    @Builder
    public record StationInfo(
            String id,
            String name,
            Double distanceKm
    ) {}

    @Builder
    public record Water(
            Double midLayerTemp,
            Double surfaceTemp,
            Double salinity,
            Double dissolvedOxygen
    ) {}

    @Builder
    public record Wave(
            Double significantWaveHeight,
            Double windDirectionDeg,
            Double windSpeedMs
    ) {}

    @Builder
    public record Tide(
            Double tideLevelCm,
            @JsonFormat(pattern = "yyyy-MM-dd'T'HH:mm:ssXXX")
            ZonedDateTime tideObservedAt
    ) {}

    @Builder
    public record Meta(
            List<String> rawSources,
            String note
    ) {}
}



================================================================================
File Path: .\src\main\java\com\ocean\piuda\environment\initializer\MarineStationInitializer.java
================================================================================

package com.ocean.piuda.environment.initializer;

import com.ocean.piuda.environment.client.KmaSeaObsClient;
import com.ocean.piuda.environment.client.NifsRisaClient;
import com.ocean.piuda.environment.client.dto.KmaSeaObsResponse;
import com.ocean.piuda.environment.client.dto.NifsRisaResponse;
import com.ocean.piuda.environment.domain.MarineStation;
import com.ocean.piuda.environment.domain.StationSource;
import com.ocean.piuda.environment.repository.MarineStationRepository;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.boot.CommandLineRunner;
import org.springframework.core.annotation.Order;
import org.springframework.core.io.ClassPathResource;
import org.springframework.stereotype.Component;
import org.springframework.transaction.annotation.Transactional;

import java.io.BufferedReader;
import java.io.InputStreamReader;
import java.nio.charset.Charset;
import java.nio.charset.StandardCharsets;
import java.time.LocalDateTime;
import java.util.ArrayList;
import java.util.List;
import java.util.Map;
import java.util.Optional;
import java.util.stream.Collectors;

/**
 * í•´ì–‘ ê´€ì¸¡ì†Œ ë°ì´í„° ì´ˆê¸°í™”
 * ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘ ì‹œ ì™¸ë¶€ APIì—ì„œ ê´€ì¸¡ì†Œ ëª©ë¡ì„ ê°€ì ¸ì™€ ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥
 */
@Slf4j
@Component
@RequiredArgsConstructor
@Order(2) // ë‹¤ë¥¸ ì´ˆê¸°í™” ì´í›„ ì‹¤í–‰
public class MarineStationInitializer implements CommandLineRunner {

    private final NifsRisaClient nifsRisaClient;
    private final KmaSeaObsClient kmaSeaObsClient;
    private final MarineStationRepository marineStationRepository;

    @Override
    @Transactional
    public void run(String... args) {
        log.info("í•´ì–‘ ê´€ì¸¡ì†Œ ë°ì´í„° ì´ˆê¸°í™” ì‹œì‘...");

        try {
            // NIFS RISA ê´€ì¸¡ì†Œ ë°ì´í„° ì´ˆê¸°í™” (CSV íŒŒì¼ì—ì„œ ì½ê¸°)
            initializeNifsRisaStationsFromCsv();

            // KMA ê´€ì¸¡ì†Œ ë°ì´í„° ì´ˆê¸°í™”
            initializeKmaStations();

            // KHOA ì¡°ìœ„ê´€ì¸¡ì†Œ ë°ì´í„° ì´ˆê¸°í™” (CSV íŒŒì¼ì—ì„œ ì½ê¸°)
            initializeKhoaStationsFromCsv();

        } catch (Exception e) {
            log.error("í•´ì–‘ ê´€ì¸¡ì†Œ ë°ì´í„° ì´ˆê¸°í™” ì‹¤íŒ¨", e);
        }
    }

    /**
     * NIFS RISA ê´€ì¸¡ì†Œ ë°ì´í„° ì´ˆê¸°í™”
     * 1. CSV íŒŒì¼(ê´€ì¸¡ì†Œ ì •ë³´.csv)ì—ì„œ ëª¨ë“  ê´€ì¸¡ì†Œ ì¢Œí‘œ ì •ë³´ ì½ê¸°
     * 2. NIFS RISA APIì—ì„œ ê´€ì¸¡ì†Œ ëª©ë¡ ì¡°íšŒ (ì´ë¦„ ë§¤ì¹­ìš©)
     * 3. DBì— ì €ì¥: CSVì˜ ëª¨ë“  ê´€ì¸¡ì†Œë¥¼ ì €ì¥ (APIì—ì„œ ì œê³µí•˜ì§€ ì•Šë”ë¼ë„ ì¢Œí‘œ ê¸°ë°˜ ë§¤ì¹­ì„ ìœ„í•´)
     */
    private void initializeNifsRisaStationsFromCsv() {
        // ê¸°ì¡´ NIFS RISA ê´€ì¸¡ì†Œ ë°ì´í„° ì‚­ì œ (ì¢Œí‘œ ì—…ë°ì´íŠ¸ë¥¼ ìœ„í•´)
        marineStationRepository.deleteByExternalSource(StationSource.NIFS_RISA);
        log.info("ê¸°ì¡´ NIFS RISA ê´€ì¸¡ì†Œ ë°ì´í„° ì‚­ì œ ì™„ë£Œ.");

        try {
            // 1. CSV íŒŒì¼ì—ì„œ ëª¨ë“  NIFS ê´€ì¸¡ì†Œ ì¢Œí‘œ ì •ë³´ ì½ê¸°
            log.info("CSV íŒŒì¼ì—ì„œ NIFS ê´€ì¸¡ì†Œ ì¢Œí‘œ ì •ë³´ ì½ê¸° ì¤‘...");
            Map<String, NifsStationCsvRecord> csvStations = loadNifsStationsFromCsv();
            log.info("CSVì—ì„œ {}ê°œì˜ NIFS ê´€ì¸¡ì†Œ ì¢Œí‘œ ì •ë³´ ë°œê²¬", csvStations.size());

            // 2. NIFS RISA APIì—ì„œ ê´€ì¸¡ì†Œ ëª©ë¡ ì¡°íšŒ (ì´ë¦„ ë§¤ì¹­ìš©, ì„ íƒì )
            Map<String, String> apiStationNames = new java.util.HashMap<>();
            try {
                log.info("NIFS RISA APIì—ì„œ ê´€ì¸¡ì†Œ ëª©ë¡ ì¡°íšŒ ì¤‘...");
                List<NifsRisaResponse.NifsRisaItem> apiStations = nifsRisaClient.fetchStations().block();
                
                if (apiStations != null && !apiStations.isEmpty()) {
                    apiStations.stream()
                            .filter(item -> item.getStaCde() != null && !item.getStaCde().isEmpty())
                            .forEach(item -> apiStationNames.put(item.getStaCde(), item.getStaNamKor()));
                    log.info("NIFS RISA APIì—ì„œ {}ê°œì˜ ê´€ì¸¡ì†Œ ì´ë¦„ ì •ë³´ ë°œê²¬", apiStationNames.size());
                }
            } catch (Exception e) {
                log.warn("NIFS RISA APIì—ì„œ ê´€ì¸¡ì†Œ ëª©ë¡ì„ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. CSV ë°ì´í„°ë§Œ ì‚¬ìš©í•©ë‹ˆë‹¤: {}", e.getMessage());
            }

            // 3. CSVì˜ ëª¨ë“  ê´€ì¸¡ì†Œë¥¼ DBì— ì €ì¥
            int savedCount = 0;
            int apiMatchedCount = 0;

            for (NifsStationCsvRecord csvRecord : csvStations.values()) {
                String stationId = csvRecord.stationId;
                String stationName = csvRecord.stationName;
                Double lat = csvRecord.lat;
                Double lon = csvRecord.lon;

                // ì´ë¯¸ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
                if (marineStationRepository
                        .findByExternalSourceAndExternalStationId(StationSource.NIFS_RISA, stationId)
                        .isPresent()) {
                    continue;
                }

                // APIì—ì„œ ì´ë¦„ì´ ìˆìœ¼ë©´ ì‚¬ìš©, ì—†ìœ¼ë©´ CSV ì´ë¦„ ì‚¬ìš©
                String finalName = apiStationNames.getOrDefault(stationId, stationName);
                if (apiStationNames.containsKey(stationId)) {
                    apiMatchedCount++;
                }

                // NIFS RISA ê´€ì¸¡ì†Œ ì €ì¥
                MarineStation station = MarineStation.builder()
                        .externalSource(StationSource.NIFS_RISA)
                        .externalStationId(stationId)
                        .name(finalName != null ? finalName : "ê´€ì¸¡ì†Œ_" + stationId)
                        .lat(lat)
                        .lon(lon)
                        .isActive(true)
                        .build();

                try {
                    marineStationRepository.save(station);
                    savedCount++;
                    log.debug("NIFS ê´€ì¸¡ì†Œ ì €ì¥: ID={}, name={}, lat={}, lon={}", 
                            stationId, finalName, lat, lon);
                } catch (Exception e) {
                    log.error("NIFS ê´€ì¸¡ì†Œ ì €ì¥ ì‹¤íŒ¨: ID={}, ì´ë¦„={}", stationId, finalName, e);
                }
            }

            log.info("NIFS RISA ê´€ì¸¡ì†Œ ë°ì´í„° ì €ì¥ ì™„ë£Œ: ì´ {}ê°œ ì €ì¥ (CSV ê¸°ì¤€), {}ê°œ API ì´ë¦„ ë§¤ì¹­", savedCount, apiMatchedCount);

        } catch (Exception e) {
            log.error("NIFS RISA ê´€ì¸¡ì†Œ ë°ì´í„° ì´ˆê¸°í™” ì‹¤íŒ¨", e);
        }
    }

    /**
     * NIFS ê´€ì¸¡ì†Œ CSV íŒŒì¼ì—ì„œ ì¢Œí‘œ ì •ë³´ ì½ê¸°
     * CSV í˜•ì‹: í•´ì—­ì½”ë“œ, í•´ì—­, ê´€ì¸¡ì†Œ, ì„¤ì¹˜ì¼ì, ì¢…ë£Œì¼ì, ìœ„ë„(Â°N), ê²½ë„(Â°E), ...
     */
    private Map<String, NifsStationCsvRecord> loadNifsStationsFromCsv() {
        Map<String, NifsStationCsvRecord> records = new java.util.HashMap<>();

        try {
            ClassPathResource resource = new ClassPathResource("nifs-tide-stations.csv");

            // CSV íŒŒì¼ ì½ê¸° (ì¸ì½”ë”©: UTF-8 ì‹œë„ í›„ EUC-KR)
            List<Charset> charsets = List.of(StandardCharsets.UTF_8, Charset.forName("EUC-KR"));

            for (Charset charset : charsets) {
                try (BufferedReader reader = new BufferedReader(
                        new InputStreamReader(resource.getInputStream(), charset))) {
                    String line;
                    int lineNumber = 0;

                    while ((line = reader.readLine()) != null) {
                        lineNumber++;
                        
                        // í—¤ë” ë¼ì¸ ê±´ë„ˆë›°ê¸° (ì²« 2ì¤„)
                        if (lineNumber <= 2) {
                            continue;
                        }
                        
                        if (line.trim().isEmpty()) {
                            continue;
                        }

                        String[] parts = parseCsvLine(line);
                        // CSV í˜•ì‹: í•´ì—­ì½”ë“œ, í•´ì—­, ê´€ì¸¡ì†Œ, ì„¤ì¹˜ì¼ì, ì¢…ë£Œì¼ì, ìœ„ë„(Â°N), ê²½ë„(Â°E), ...
                        if (parts.length < 7) {
                            log.warn("CSV ë¼ì¸ ì»¬ëŸ¼ ìˆ˜ ë¶€ì¡±: parts.length={}, line={}", parts.length, line);
                            continue;
                        }

                        try {
                            String stationId = parts[0].trim(); // í•´ì—­ì½”ë“œ (sta_cdeì™€ ë§¤ì¹­)
                            String region = parts[1].trim(); // í•´ì—­
                            String stationName = parts[2].trim(); // ê´€ì¸¡ì†Œ ì´ë¦„
                            String installDate = parts[3].trim(); // ì„¤ì¹˜ì¼ì
                            String endDate = parts[4].trim(); // ì¢…ë£Œì¼ì
                            Double lat = Double.parseDouble(parts[5].trim()); // ìœ„ë„
                            Double lon = Double.parseDouble(parts[6].trim()); // ê²½ë„

                            if (stationId.isEmpty() || lat == null || lon == null) {
                                continue;
                            }

                            // ì¢…ë£Œì¼ìê°€ ìˆìœ¼ë©´ ì œì™¸ (ìš´ì˜ ì¤‘ì¸ ê´€ì¸¡ì†Œë§Œ)
                            if (!endDate.isEmpty()) {
                                continue;
                            }

                            records.put(stationId, new NifsStationCsvRecord(stationId, stationName, lat, lon));
                        } catch (NumberFormatException e) {
                            log.warn("CSV ë¼ì¸ ìˆ«ì íŒŒì‹± ì‹¤íŒ¨: line={}, error={}", line, e.getMessage());
                            continue;
                        }
                    }
                    
                    if (!records.isEmpty()) {
                        log.info("CSV íŒŒì¼ ì½ê¸° ì„±ê³µ (ì¸ì½”ë”©: {}): {}ê°œ ê´€ì¸¡ì†Œ", charset.name(), records.size());
                        return records;
                    }
                } catch (Exception e) {
                    log.warn("CSV íŒŒì¼ ì½ê¸° ì‹¤íŒ¨ (ì¸ì½”ë”©: {}): {}", charset.name(), e.getMessage());
                    records.clear();
                }
            }
        } catch (Exception e) {
            log.error("CSV íŒŒì¼ ì½ê¸° ì‹¤íŒ¨", e);
        }

        return records;
    }

    /**
     * NIFS ê´€ì¸¡ì†Œ CSV ë ˆì½”ë“œ
     */
    private static class NifsStationCsvRecord {
        final String stationId;
        final String stationName;
        final Double lat;
        final Double lon;

        NifsStationCsvRecord(String stationId, String stationName, Double lat, Double lon) {
            this.stationId = stationId;
            this.stationName = stationName;
            this.lat = lat;
            this.lon = lon;
        }
    }

    /**
     * CSV íŒŒì¼ì—ì„œ ê´€ì¸¡ì†Œ ìœ„ì¹˜ ì •ë³´ ì½ê¸°
     */
    private List<CsvStationRecord> loadCsvStations() {
        List<CsvStationRecord> records = new ArrayList<>();

        try {
            ClassPathResource resource = new ClassPathResource("nifs-tide-stations.csv");

            // CSV íŒŒì¼ ì½ê¸° (ì¸ì½”ë”©: UTF-8 ì‹œë„ í›„ EUC-KR)
            try (BufferedReader reader = new BufferedReader(
                    new InputStreamReader(resource.getInputStream(), StandardCharsets.UTF_8))) {
                String line;
                boolean isFirstLine = true;

                while ((line = reader.readLine()) != null) {
                    if (isFirstLine) {
                        isFirstLine = false;
                        continue;
                    }
                    if (line.trim().isEmpty()) {
                        continue;
                    }

                    String[] parts = parseCsvLine(line);
                    if (parts.length < 5) {
                        continue;
                    }

                    try {
                        // CSV í˜•ì‹: ê´€ì¸¡ì†ŒID, ê´€ì¸¡ì†Œ ìœ í˜•, ì¡°ìœ„ê´€ì¸¡ì†Œ ëª…(í•œê¸€ëª…), ì¡°ìœ„ê´€ì¸¡ì†Œ ìœ„ë„, ì¡°ìœ„ê´€ì¸¡ì†Œ ê²½ë„, ì¡°ìœ„ê´€ì¸¡ì†Œ ì˜ë¬¸ëª…
                        if (parts.length < 5) {
                            log.warn("CSV ë¼ì¸ ì»¬ëŸ¼ ìˆ˜ ë¶€ì¡±: parts.length={}, line={}", parts.length, line);
                            continue;
                        }
                        String stationId = parts[0].trim();
                        String stationType = parts[1].trim(); // ê´€ì¸¡ì†Œ ìœ í˜• (ì‚¬ìš© ì•ˆ í•¨)
                        String nameKor = parts[2].trim(); // ì¡°ìœ„ê´€ì¸¡ì†Œ ëª…
                        Double lat = Double.parseDouble(parts[3].trim()); // ì¡°ìœ„ê´€ì¸¡ì†Œ ìœ„ë„
                        Double lon = Double.parseDouble(parts[4].trim()); // ì¡°ìœ„ê´€ì¸¡ì†Œ ê²½ë„
                        String nameEng = parts.length > 5 ? parts[5].trim() : "";

                        if (stationId.isEmpty() || lat == null || lon == null) {
                            continue;
                        }

                        records.add(new CsvStationRecord(stationId, nameKor, nameEng, lat, lon));
                    } catch (NumberFormatException e) {
                        continue;
                    }
                }
            } catch (Exception e) {
                // UTF-8 ì‹¤íŒ¨ ì‹œ EUC-KRë¡œ ì¬ì‹œë„
                log.warn("UTF-8 ì¸ì½”ë”© ì‹¤íŒ¨, EUC-KRë¡œ ì¬ì‹œë„: {}", e.getMessage());
                try (BufferedReader reader = new BufferedReader(
                        new InputStreamReader(resource.getInputStream(), "EUC-KR"))) {
                    String line;
                    boolean isFirstLine = true;

                    while ((line = reader.readLine()) != null) {
                        if (isFirstLine) {
                            isFirstLine = false;
                            continue;
                        }
                        if (line.trim().isEmpty()) {
                            continue;
                        }

                        String[] parts = parseCsvLine(line);
                        if (parts.length < 5) {
                            continue;
                        }

                        try {
                            // CSV í˜•ì‹: ê´€ì¸¡ì†ŒID, ê´€ì¸¡ì†Œ ìœ í˜•, ì¡°ìœ„ê´€ì¸¡ì†Œ ëª…(í•œê¸€ëª…), ì¡°ìœ„ê´€ì¸¡ì†Œ ìœ„ë„, ì¡°ìœ„ê´€ì¸¡ì†Œ ê²½ë„, ì¡°ìœ„ê´€ì¸¡ì†Œ ì˜ë¬¸ëª…
                            if (parts.length < 5) {
                                log.warn("CSV ë¼ì¸ ì»¬ëŸ¼ ìˆ˜ ë¶€ì¡±: parts.length={}, line={}", parts.length, line);
                                continue;
                            }
                            String stationId = parts[0].trim();
                            String stationType = parts[1].trim(); // ê´€ì¸¡ì†Œ ìœ í˜• (ì‚¬ìš© ì•ˆ í•¨)
                            String nameKor = parts[2].trim(); // ì¡°ìœ„ê´€ì¸¡ì†Œ ëª…
                            Double lat = Double.parseDouble(parts[3].trim()); // ì¡°ìœ„ê´€ì¸¡ì†Œ ìœ„ë„
                            Double lon = Double.parseDouble(parts[4].trim()); // ì¡°ìœ„ê´€ì¸¡ì†Œ ê²½ë„
                            String nameEng = parts.length > 5 ? parts[5].trim() : "";

                            if (stationId.isEmpty() || lat == null || lon == null) {
                                continue;
                            }

                            records.add(new CsvStationRecord(stationId, nameKor, nameEng, lat, lon));
                        } catch (NumberFormatException ex) {
                            continue;
                        }
                    }
                }
            }
        } catch (Exception e) {
            log.error("CSV íŒŒì¼ ì½ê¸° ì‹¤íŒ¨", e);
        }

        return records;
    }

    /**
     * CSVì—ì„œ ë§¤ì¹­í•˜ëŠ” ê´€ì¸¡ì†Œ ì°¾ê¸° (ì´ë¦„ ë§¤ì¹­ ìš°ì„ , ì‹¤íŒ¨ ì‹œ ì¢Œí‘œ ê¸°ë°˜)
     */
    private Optional<CsvStationRecord> findMatchingCsvStation(String apiStationName, List<CsvStationRecord> csvRecords) {
        if (apiStationName == null || apiStationName.isEmpty()) {
            return Optional.empty();
        }

        // 1. ì´ë¦„ ì •í™• ë§¤ì¹­ ì‹œë„
        Optional<CsvStationRecord> exactMatch = csvRecords.stream()
                .filter(csv -> csv.nameKor != null && csv.nameKor.equals(apiStationName))
                .findFirst();

        if (exactMatch.isPresent()) {
            return exactMatch;
        }

        // 2. ì´ë¦„ ë¶€ë¶„ ë§¤ì¹­ ì‹œë„ (ê³µë°± ì œê±° í›„ ë¹„êµ)
        String normalizedApiName = apiStationName.replaceAll("\\s+", "");
        Optional<CsvStationRecord> partialMatch = csvRecords.stream()
                .filter(csv -> csv.nameKor != null) 
                .filter(csv -> {
                    String normalizedCsvName = csv.nameKor.replaceAll("\\s+", "");
                    return normalizedCsvName.contains(normalizedApiName) || 
                           normalizedApiName.contains(normalizedCsvName);
                })
                .findFirst();

        if (partialMatch.isPresent()) {
            return partialMatch;
        }

        // 3. ì´ë¦„ í‚¤ì›Œë“œ ë§¤ì¹­ ì‹œë„ (ì£¼ìš” ì§€ì—­ëª… ì¶”ì¶œ)
        String[] keywords = extractKeywords(apiStationName);
        if (keywords.length > 0) {
            Optional<CsvStationRecord> keywordMatch = csvRecords.stream()
                    .filter(csv -> csv.nameKor != null)
                    .filter(csv -> {
                        for (String keyword : keywords) {
                            if (csv.nameKor.contains(keyword)) {
                                return true;
                            }
                        }
                        return false;
                    })
                    .findFirst();

            if (keywordMatch.isPresent()) {
                return keywordMatch;
            }
        }

        return Optional.empty();
    }

    /**
     * ê´€ì¸¡ì†Œ ì´ë¦„ì—ì„œ ì£¼ìš” í‚¤ì›Œë“œ ì¶”ì¶œ
     */
    private String[] extractKeywords(String name) {
        // ì£¼ìš” ì§€ì—­ëª… í‚¤ì›Œë“œ (ì˜ˆ: í¬í•­, ë¶€ì‚°, ì œì£¼ ë“±)
        String[] commonKeywords = {"í¬í•­", "ë¶€ì‚°", "ì œì£¼", "ìš¸ì‚°", "ëª©í¬", "ì—¬ìˆ˜", "ê±°ì œ", "í†µì˜", 
                                   "ì™„ë„", "ì§„ë„", "ì•ˆì‚°", "ì¸ì²œ", "í‰íƒ", "ì˜ê´‘", "ë¬´ì•ˆ", "ê°•í™”",
                                   "ìš¸ì§„", "ë™í•´", "ì†ì´ˆ", "ë¬µí˜¸", "ê±°ë¬¸ë„", "ë§ˆë¼ë„", "ì¶”ìë„",
                                   "ì„œê·€í¬", "ì™„ë„", "ì§„ë„", "ì•ˆí¥", "ëŒ€ì‚°", "íƒœì•ˆ", "ì˜ë•"};
        
        List<String> found = new ArrayList<>();
        for (String keyword : commonKeywords) {
            if (name.contains(keyword)) {
                found.add(keyword);
            }
        }
        return found.toArray(new String[0]);
    }

    /**
     * ì¢Œí‘œ ê¸°ë°˜ìœ¼ë¡œ ê°€ì¥ ê°€ê¹Œìš´ CSV ê´€ì¸¡ì†Œ ì°¾ê¸°
     * NIFS RISA API ê´€ì¸¡ì†Œ ì´ë¦„ì—ì„œ ì§€ì—­ í‚¤ì›Œë“œë¥¼ ì¶”ì¶œí•˜ì—¬, í•´ë‹¹ ì§€ì—­ì˜ CSV ê´€ì¸¡ì†Œë¥¼ ì°¾ìŠµë‹ˆë‹¤.
     * í‚¤ì›Œë“œ ë§¤ì¹­ì´ ì‹¤íŒ¨í•˜ë©´ ëª¨ë“  CSV ê´€ì¸¡ì†Œ ì¤‘ì—ì„œ ì²« ë²ˆì§¸ë¥¼ ë°˜í™˜ (ì„ì‹œ)
     */
    private Optional<CsvStationRecord> findNearestCsvByCoordinates(String apiStationName, List<CsvStationRecord> csvRecords) {
        if (apiStationName == null || apiStationName.isEmpty() || csvRecords.isEmpty()) {
            return Optional.empty();
        }

        // ì§€ì—­ í‚¤ì›Œë“œ ì¶”ì¶œ
        String[] keywords = extractKeywords(apiStationName);
        if (keywords.length > 0) {
            // í‚¤ì›Œë“œê°€ í¬í•¨ëœ CSV ê´€ì¸¡ì†Œ ì°¾ê¸°
            List<CsvStationRecord> candidateRecords = csvRecords.stream()
                    .filter(csv -> csv.nameKor != null)
                    .filter(csv -> {
                        for (String keyword : keywords) {
                            if (csv.nameKor.contains(keyword)) {
                                return true;
                            }
                        }
                        return false;
                    })
                    .toList();

            if (!candidateRecords.isEmpty()) {
                return Optional.of(candidateRecords.get(0));
            }
        }

        // í‚¤ì›Œë“œ ë§¤ì¹­ ì‹¤íŒ¨ ì‹œ, ëª¨ë“  CSV ê´€ì¸¡ì†Œ ì¤‘ ì²« ë²ˆì§¸ ë°˜í™˜ (ì„ì‹œ)
        // ì‹¤ì œë¡œëŠ” ë” ì •êµí•œ ë§¤ì¹­ ë¡œì§ì´ í•„ìš”í•˜ì§€ë§Œ, ì¼ë‹¨ ëª¨ë“  ê´€ì¸¡ì†Œì— ì¢Œí‘œë¥¼ í• ë‹¹
        log.warn("í‚¤ì›Œë“œ ë§¤ì¹­ ì‹¤íŒ¨, ì²« ë²ˆì§¸ CSV ê´€ì¸¡ì†Œ ì‚¬ìš©: apiStationName={}", apiStationName);
        return csvRecords.stream().findFirst();
    }

    /**
     * NIFS RISA ê´€ì¸¡ì†Œì™€ CSV ê´€ì¸¡ì†Œ ìˆ˜ë™ ë§¤í•‘
     * API ê´€ì¸¡ì†Œ ì´ë¦„ê³¼ CSV ê´€ì¸¡ì†Œ ì´ë¦„ì´ ì •í™•íˆ ì¼ì¹˜í•˜ì§€ ì•ŠëŠ” ê²½ìš°ë¥¼ ìœ„í•œ ìˆ˜ë™ ë§¤í•‘
     * 
     * ì£¼ì˜: CSV íŒŒì¼ì˜ ê´€ì¸¡ì†Œ IDëŠ” KHOA ì¡°ìœ„ê´€ì¸¡ì†Œ IDì´ë¯€ë¡œ, 
     * NIFS RISA ê´€ì¸¡ì†Œì™€ëŠ” ë‹¤ë¥¸ ì‹œìŠ¤í…œì…ë‹ˆë‹¤.
     * ë”°ë¼ì„œ ì´ë¦„ ê¸°ë°˜ ë§¤ì¹­ë§Œ ì‚¬ìš©í•©ë‹ˆë‹¤.
     */
    private Optional<CsvStationRecord> findManualMapping(String apiStationId, String apiStationName, List<CsvStationRecord> csvRecords) {
        // í˜„ì¬ëŠ” ìˆ˜ë™ ë§¤í•‘ í…Œì´ë¸” ì—†ìŒ (ì´ë¦„ ê¸°ë°˜ ë§¤ì¹­ë§Œ ì‚¬ìš©)
        // í•„ìš”ì‹œ ì—¬ê¸°ì— íŠ¹ì • ê´€ì¸¡ì†Œì— ëŒ€í•œ ìˆ˜ë™ ë§¤í•‘ ì¶”ê°€ ê°€ëŠ¥
        return Optional.empty();
    }

    /**
     * CSV ë¼ì¸ íŒŒì‹± (ì‰¼í‘œë¡œ êµ¬ë¶„, ì¸ìš©ë¶€í˜¸ ì²˜ë¦¬)
     */
    private String[] parseCsvLine(String line) {
        List<String> parts = new ArrayList<>();
        StringBuilder current = new StringBuilder();
        boolean inQuotes = false;

        for (int i = 0; i < line.length(); i++) {
            char c = line.charAt(i);
            if (c == '"') {
                inQuotes = !inQuotes;
            } else if (c == ',' && !inQuotes) {
                parts.add(current.toString());
                current = new StringBuilder();
            } else {
                current.append(c);
            }
        }
        parts.add(current.toString());

        return parts.toArray(new String[0]);
    }

    /**
     * CSV ë ˆì½”ë“œ ì„ì‹œ í´ë˜ìŠ¤
     */
    private static class CsvStationRecord {
        final String stationId;
        final String nameKor;
        final String nameEng;
        final Double lat;
        final Double lon;

        CsvStationRecord(String stationId, String nameKor, String nameEng, Double lat, Double lon) {
            this.stationId = stationId;
            this.nameKor = nameKor;
            this.nameEng = nameEng;
            this.lat = lat;
            this.lon = lon;
        }
    }

    /**
     * KMA ê´€ì¸¡ì†Œ ë°ì´í„° ì´ˆê¸°í™”
     */
    private void initializeKmaStations() {
        if (marineStationRepository.findByExternalSourceAndIsActiveTrue(StationSource.KMA_SEA_OBS).size() > 0) {
            log.info("KMA ê´€ì¸¡ì†Œ ë°ì´í„°ê°€ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤. ì´ˆê¸°í™”ë¥¼ ê±´ë„ˆëœë‹ˆë‹¤.");
            return;
        }

        try {
            // KMA APIì—ì„œ ì „ì²´ ê´€ì¸¡ì†Œ ëª©ë¡ ì¡°íšŒ (stn=0)
            List<KmaSeaObsResponse.Item> kmaItems = kmaSeaObsClient
                    .fetchObservations("0", LocalDateTime.now())
                    .block();

            if (kmaItems == null || kmaItems.isEmpty()) {
                log.warn("KMA ê´€ì¸¡ì†Œ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                return;
            }

            log.info("KMA ê´€ì¸¡ì†Œ {}ê°œ ë°œê²¬", kmaItems.size());

            // ê´€ì¸¡ì†Œ IDë³„ë¡œ ê·¸ë£¹í™” (ê°™ì€ ê´€ì¸¡ì†Œì˜ ì¤‘ë³µ ë°ì´í„° ì œê±°)
            Map<String, KmaSeaObsResponse.Item> uniqueStations = kmaItems.stream()
                    .filter(item -> item.getStn() != null && item.getLat() != null && item.getLon() != null)
                    .collect(Collectors.toMap(
                            KmaSeaObsResponse.Item::getStn,
                            item -> item,
                            (existing, replacement) -> existing // ì¤‘ë³µ ì‹œ ê¸°ì¡´ ê²ƒ ìœ ì§€
                    ));

            int savedCount = 0;
            for (KmaSeaObsResponse.Item item : uniqueStations.values()) {
                // ì´ë¯¸ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
                if (marineStationRepository
                        .findByExternalSourceAndExternalStationId(StationSource.KMA_SEA_OBS, item.getStn())
                        .isEmpty()) {
                    MarineStation station = MarineStation.builder()
                            .externalSource(StationSource.KMA_SEA_OBS)
                            .externalStationId(item.getStn())
                            .name(item.getStnNm() != null ? item.getStnNm() : "KMA_" + item.getStn())
                            .lat(item.getLat())
                            .lon(item.getLon())
                            .isActive(true)
                            .build();
                    marineStationRepository.save(station);
                    savedCount++;
                }
            }

            log.info("{}ê°œì˜ KMA ê´€ì¸¡ì†Œ ë°ì´í„° ì €ì¥ ì™„ë£Œ", savedCount);

        } catch (Exception e) {
            log.error("KMA ê´€ì¸¡ì†Œ ë°ì´í„° ì´ˆê¸°í™” ì‹¤íŒ¨", e);
        }
    }

    /**
     * KHOA ì¡°ìœ„ê´€ì¸¡ì†Œ ë°ì´í„° ì´ˆê¸°í™” (CSV íŒŒì¼ì—ì„œ ì½ê¸°)
     * CSV íŒŒì¼ì˜ ì¡°ìœ„ê´€ì¸¡ì†Œ ë°ì´í„°ë¥¼ DBì— ì €ì¥
     */
    private void initializeKhoaStationsFromCsv() {
        // ì´ë¯¸ ë°ì´í„°ê°€ ìˆìœ¼ë©´ ê±´ë„ˆë›°ê¸°
        if (marineStationRepository.findByExternalSourceAndIsActiveTrue(StationSource.KHOA_SURVEY_TIDE).size() > 0) {
            log.info("KHOA ì¡°ìœ„ê´€ì¸¡ì†Œ ë°ì´í„°ê°€ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤. ì´ˆê¸°í™”ë¥¼ ê±´ë„ˆëœë‹ˆë‹¤.");
            return;
        }

        try {
            // CSV íŒŒì¼ì—ì„œ ì¡°ìœ„ê´€ì¸¡ì†Œ ìœ„ì¹˜ ì •ë³´ ì½ê¸°
            log.info("CSV íŒŒì¼ì—ì„œ KHOA ì¡°ìœ„ê´€ì¸¡ì†Œ ìœ„ì¹˜ ì •ë³´ ì½ê¸° ì¤‘...");
            List<CsvStationRecord> csvRecords = loadCsvStations();
            log.info("CSVì—ì„œ {}ê°œì˜ ì¡°ìœ„ê´€ì¸¡ì†Œ ìœ„ì¹˜ ì •ë³´ ë°œê²¬", csvRecords.size());

            int savedCount = 0;
            for (CsvStationRecord csvRecord : csvRecords) {
                // ì´ë¯¸ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸ (stationId ê¸°ì¤€)
                if (marineStationRepository
                        .findByExternalSourceAndExternalStationId(StationSource.KHOA_SURVEY_TIDE, csvRecord.stationId)
                        .isPresent()) {
                    continue;
                }

                // ìœ íš¨í•œ ì¢Œí‘œì¸ì§€ í™•ì¸
                if (csvRecord.lat == null || csvRecord.lon == null || 
                    csvRecord.lat == 0.0 || csvRecord.lon == 0.0) {
                    log.warn("ìœ íš¨í•˜ì§€ ì•Šì€ ì¢Œí‘œ: stationId={}, lat={}, lon={}", 
                            csvRecord.stationId, csvRecord.lat, csvRecord.lon);
                    continue;
                }

                MarineStation station = MarineStation.builder()
                        .externalSource(StationSource.KHOA_SURVEY_TIDE)
                        .externalStationId(csvRecord.stationId) // CSVì˜ stationId ì‚¬ìš© (ì˜ˆ: DT_0009)
                        .name(csvRecord.nameKor != null ? csvRecord.nameKor : csvRecord.nameEng)
                        .lat(csvRecord.lat)
                        .lon(csvRecord.lon)
                        .isActive(true)
                        .build();

                try {
                    marineStationRepository.save(station);
                    savedCount++;
                } catch (Exception e) {
                    log.error("KHOA ê´€ì¸¡ì†Œ ì €ì¥ ì‹¤íŒ¨: ID={}, ì´ë¦„={}", csvRecord.stationId, csvRecord.nameKor, e);
                }
            }

            log.info("KHOA ì¡°ìœ„ê´€ì¸¡ì†Œ ë°ì´í„° ì €ì¥ ì™„ë£Œ: ì´ {}ê°œ ì €ì¥", savedCount);

        } catch (Exception e) {
            log.error("KHOA ì¡°ìœ„ê´€ì¸¡ì†Œ ë°ì´í„° ì´ˆê¸°í™” ì‹¤íŒ¨", e);
        }
    }
}



================================================================================
File Path: .\src\main\java\com\ocean\piuda\environment\ProjectExporter.java
================================================================================

package com.ocean.piuda.environment;

import java.io.IOException;
import java.nio.charset.StandardCharsets;
import java.nio.file.*;
import java.nio.file.attribute.BasicFileAttributes;
import java.util.*;
import java.util.stream.Collectors;
import java.util.stream.Stream;

public class ProjectExporter {

    // ê²°ê³¼ íŒŒì¼ëª…
    private static final String OUTPUT_FILE = "project_context.txt";

    // ê¸°ë³¸ì ìœ¼ë¡œ ì œì™¸í•  ë””ë ‰í† ë¦¬/íŒŒì¼ (gitignoreê°€ ì—†ê±°ë‚˜ ë†“ì¹  ê²½ìš° ëŒ€ë¹„)
    private static final Set<String> DEFAULT_IGRORES = new HashSet<>(Arrays.asList(
            ".git", ".idea", ".gradle", "build", "target", "out", ".mvn", "wrapper", "gradlew", "gradlew.bat", OUTPUT_FILE
    ));

    // í…ìŠ¤íŠ¸ íŒŒì¼ë¡œ ê°„ì£¼í•  í™•ì¥ì (ë°”ì´ë„ˆë¦¬ ì œì™¸ìš©)
    private static final Set<String> TEXT_EXTENSIONS = new HashSet<>(Arrays.asList(
            "java", "xml", "yml", "yaml", "properties", "gradle", "sql", "md", "txt", "html", "css", "js", "json", "dockerfile"
    ));

    public static void main(String[] args) {
        Path startPath = Paths.get(".");
        Path outputPath = Paths.get(OUTPUT_FILE);
        List<PathMatcher> gitIgnoreMatchers = loadGitIgnore(startPath);

        try (java.io.BufferedWriter writer = Files.newBufferedWriter(outputPath, StandardCharsets.UTF_8)) {
            System.out.println(" í”„ë¡œì íŠ¸ ì¶”ì¶œì„ ì‹œì‘í•©ë‹ˆë‹¤... (Target: " + OUTPUT_FILE + ")");

            Files.walkFileTree(startPath, new SimpleFileVisitor<Path>() {
                @Override
                public FileVisitResult preVisitDirectory(Path dir, BasicFileAttributes attrs) {
                    if (shouldIgnore(startPath, dir, gitIgnoreMatchers)) {
                        return FileVisitResult.SKIP_SUBTREE;
                    }
                    return FileVisitResult.CONTINUE;
                }

                @Override
                public FileVisitResult visitFile(Path file, BasicFileAttributes attrs) {
                    if (shouldIgnore(startPath, file, gitIgnoreMatchers)) {
                        return FileVisitResult.CONTINUE;
                    }

                    if (isTextFile(file)) {
                        writeFileContent(writer, file);
                    }
                    return FileVisitResult.CONTINUE;
                }
            });

            System.out.println("ì™„ë£Œ! '" + OUTPUT_FILE + "' íŒŒì¼ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.");

        } catch (IOException e) {
            e.printStackTrace();
        }
    }

    // .gitignore íŒŒì¼ ë¡œë“œ ë° PathMatcher ë³€í™˜
    private static List<PathMatcher> loadGitIgnore(Path rootPath) {
        List<PathMatcher> matchers = new ArrayList<>();
        Path gitIgnorePath = rootPath.resolve(".gitignore");
        FileSystem fs = FileSystems.getDefault();

        if (Files.exists(gitIgnorePath)) {
            try (Stream<String> lines = Files.lines(gitIgnorePath)) {
                lines.map(String::trim)
                        .filter(line -> !line.isEmpty() && !line.startsWith("#"))
                        .forEach(line -> {
                            // ê°„ë‹¨í•œ glob íŒ¨í„´ ë³€í™˜ (í´ë”ì¸ ê²½ìš° /** ì¶”ê°€ ë“±)
                            String pattern = "glob:**/" + line;
                            if (line.endsWith("/")) {
                                pattern += "**";
                            }
                            try {
                                matchers.add(fs.getPathMatcher(pattern));
                            } catch (Exception e) {
                                // ë³µì¡í•œ ì •ê·œì‹ íŒ¨í„´ì€ ë¬´ì‹œ
                            }
                        });
                System.out.println("â„¹ .gitignore íŒŒì¼ì„ ë°œê²¬í•˜ì—¬ ê·œì¹™ì„ ì ìš©í•©ë‹ˆë‹¤.");
            } catch (IOException e) {
                System.err.println("âš  .gitignore ì½ê¸° ì‹¤íŒ¨: " + e.getMessage());
            }
        }
        return matchers;
    }

    // ì œì™¸ ëŒ€ìƒ í™•ì¸ ë¡œì§
    private static boolean shouldIgnore(Path root, Path path, List<PathMatcher> gitIgnoreMatchers) {
        String fileName = path.getFileName().toString();

        // 1. ê¸°ë³¸ ì œì™¸ ëª©ë¡ í™•ì¸
        if (DEFAULT_IGRORES.contains(fileName)) return true;

        // 2. .gitignore ê·œì¹™ í™•ì¸
        for (PathMatcher matcher : gitIgnoreMatchers) {
            if (matcher.matches(path)) return true;
        }

        return false;
    }

    // í…ìŠ¤íŠ¸ íŒŒì¼ ì—¬ë¶€ í™•ì¸ (í™•ì¥ì ê¸°ë°˜)
    private static boolean isTextFile(Path path) {
        String fileName = path.getFileName().toString().toLowerCase();
        if (fileName.equals("dockerfile")) return true;

        int lastDot = fileName.lastIndexOf('.');
        if (lastDot == -1) return false;

        String ext = fileName.substring(lastDot + 1);
        return TEXT_EXTENSIONS.contains(ext);
    }

    private static void writeFileContent(java.io.BufferedWriter writer, Path file) {
        try {
            writer.write("\n" + "=".repeat(80) + "\n");
            writer.write("File Path: " + file.toString() + "\n");
            writer.write("=".repeat(80) + "\n\n");

            // íŒŒì¼ ë‚´ìš©ì„ í•œ ë²ˆì— ì½ì–´ì„œ ì“°ê¸°
            Files.lines(file).forEach(line -> {
                try {
                    writer.write(line);
                    writer.newLine();
                } catch (IOException e) {
                    throw new RuntimeException(e);
                }
            });
            writer.write("\n");
        } catch (Exception e) {
            System.err.println(" íŒŒì¼ ì½ê¸° ì‹¤íŒ¨ (" + file + "): " + e.getMessage());
        }
    }
}


================================================================================
File Path: .\src\main\java\com\ocean\piuda\environment\properties\MarineApiProperties.java
================================================================================

package com.ocean.piuda.environment.properties;

import lombok.Getter;
import lombok.Setter;
import org.springframework.boot.context.properties.ConfigurationProperties;
import org.springframework.stereotype.Component;

/**
 * í•´ì–‘ í™˜ê²½ API í‚¤ ì„¤ì • Properties
 */
@Component
@ConfigurationProperties(prefix = "marine")
@Getter
@Setter
public class MarineApiProperties {

    private Nifs nifs = new Nifs();
    private Khoa khoa = new Khoa();
    private Kma kma = new Kma();

    @Getter
    @Setter
    public static class Nifs {
        /**
         * NIFS RISA API í‚¤
         */
        private String key;
    }

    @Getter
    @Setter
    public static class Khoa {
        /**
         * KHOA ì¡°ìœ„ API í‚¤ (URL Encoding)
         */
        private String keyEncoding;

        /**
         * KHOA ì¡°ìœ„ API í‚¤ (Decoding)
         */
        private String keyDecoding;
    }

    @Getter
    @Setter
    public static class Kma {
        /**
         * KMA í•´ì–‘ê¸°ìƒì¢…í•©ê´€ì¸¡ API í‚¤
         */
        private String key;
    }
}



================================================================================
File Path: .\src\main\java\com\ocean\piuda\environment\README.md
================================================================================

# í•´ì–‘ í™˜ê²½ ìš”ì•½ API ëª¨ë“ˆ

OC Community(OC Underwater) ì•±ì—ì„œ ì‚¬ìš©í•˜ëŠ” í•´ì–‘ í™˜ê²½ ìš”ì•½ ì •ë³´ë¥¼ ì œê³µí•˜ëŠ” REST API ëª¨ë“ˆì…ë‹ˆë‹¤.

## ğŸ“‹ ëª©ì°¨

- [ê°œìš”](#ê°œìš”)
- [ê¸°ëŠ¥](#ê¸°ëŠ¥)
- [API ì—”ë“œí¬ì¸íŠ¸](#api-ì—”ë“œí¬ì¸íŠ¸)
- [ì™¸ë¶€ API ì—°ë™](#ì™¸ë¶€-api-ì—°ë™)
- [ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ](#ë°ì´í„°ë² ì´ìŠ¤-ìŠ¤í‚¤ë§ˆ)
- [ì„¤ì •](#ì„¤ì •)
- [ì‚¬ìš© ë°©ë²•](#ì‚¬ìš©-ë°©ë²•)
- [í…ŒìŠ¤íŠ¸](#í…ŒìŠ¤íŠ¸)

---

## ê°œìš”

ì´ ëª¨ë“ˆì€ ë‹¤ìŒ 3ê°œì˜ ì™¸ë¶€ í•´ì–‘ ê´€ì¸¡ APIë¥¼ í†µí•©í•˜ì—¬ ì‹¤ì‹œê°„ í•´ì–‘ í™˜ê²½ ì •ë³´ë¥¼ ì œê³µí•©ë‹ˆë‹¤:

1. **NIFS RISA** - êµ­ë¦½ìˆ˜ì‚°ê³¼í•™ì› ì‹¤ì‹œê°„ í•´ì–‘ìˆ˜ì‚°í™˜ê²½ ê´€ì¸¡ (ìˆ˜ì˜¨/ì—¼ë¶„/ìš©ì¡´ì‚°ì†Œ)
2. **KHOA** - êµ­ë¦½í•´ì–‘ì¡°ì‚¬ì› ì¡°ìœ„ ê´€ì¸¡
3. **KMA** - ê¸°ìƒì²­ í•´ì–‘ê¸°ìƒì¢…í•©ê´€ì¸¡ (íŒŒê³ /í’í–¥/í’ì†)

ì‚¬ìš©ìê°€ ì œê³µí•œ ì¢Œí‘œ ë˜ëŠ” ë‹¤ì´ë¹™ í¬ì¸íŠ¸ IDë¥¼ ê¸°ë°˜ìœ¼ë¡œ ê°€ì¥ ê°€ê¹Œìš´ ê´€ì¸¡ì†Œë¥¼ ìë™ìœ¼ë¡œ ë§¤ì¹­í•˜ì—¬ í†µí•© í™˜ê²½ ì •ë³´ë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤.

---

## ê¸°ëŠ¥

### ì£¼ìš” ê¸°ëŠ¥

- âœ… ì¢Œí‘œ ê¸°ë°˜ í™˜ê²½ ìš”ì•½ ì¡°íšŒ
- âœ… ë‹¤ì´ë¹™ í¬ì¸íŠ¸ ID ê¸°ë°˜ í™˜ê²½ ìš”ì•½ ì¡°íšŒ
- âœ… Haversine ê³µì‹ì„ ì‚¬ìš©í•œ ê±°ë¦¬ ê¸°ë°˜ ê´€ì¸¡ì†Œ ìë™ ë§¤ì¹­
- âœ… 3ê°œ ì™¸ë¶€ API í†µí•© (NIFS, KHOA, KMA)
- âœ… ì‹¤ì‹œê°„ ê´€ì¸¡ ë°ì´í„° ì¡°íšŒ
- âœ… ê´€ì¸¡ì†Œ ì •ë³´ ë° ê±°ë¦¬ ì •ë³´ í¬í•¨

### ì œê³µ ì •ë³´

- **ìˆ˜ì˜¨/ì—¼ë¶„/ìš©ì¡´ì‚°ì†Œ**: NIFS RISA ì¤‘ì¸µ ë°ì´í„° ìš°ì„  ì‚¬ìš©
- **íŒŒê³ /í’í–¥/í’ì†**: KMA í•´ì–‘ê¸°ìƒ ê´€ì¸¡ ë°ì´í„°
- **ì¡°ìœ„**: KHOA ì¡°ìœ„ ê´€ì¸¡ ë°ì´í„°
- **ê´€ì¸¡ì†Œ ì •ë³´**: ê° ì†ŒìŠ¤ë³„ ê°€ì¥ ê°€ê¹Œìš´ ê´€ì¸¡ì†Œ ë° ê±°ë¦¬

---

## API ì—”ë“œí¬ì¸íŠ¸

### í™˜ê²½ ìš”ì•½ ì¡°íšŒ

**ì—”ë“œí¬ì¸íŠ¸**: `GET /api/environment/summary`

#### Query Parameters

| íŒŒë¼ë¯¸í„° | íƒ€ì… | í•„ìˆ˜ | ì„¤ëª… |
|---------|------|------|------|
| `lat` | Double | ì¡°ê±´ë¶€ | ìœ„ë„ (í•œêµ­ í•´ì—­: ì•½ 33 ~ 38ë„) |
| `lon` | Double | ì¡°ê±´ë¶€ | ê²½ë„ (í•œêµ­ í•´ì—­: ì•½ 124 ~ 132ë„) |
| `pointId` | Long | ì¡°ê±´ë¶€ | ë‹¤ì´ë¹™ í¬ì¸íŠ¸ ID |

**ì°¸ê³ **: `pointId`ê°€ ì œê³µë˜ë©´ `lat`/`lon`ì€ ë¬´ì‹œë©ë‹ˆë‹¤. `pointId`ê°€ ì—†ìœ¼ë©´ `lat`ê³¼ `lon`ì´ ëª¨ë‘ í•„ìš”í•©ë‹ˆë‹¤.

#### ì‘ë‹µ ì˜ˆì‹œ

```json
{
  "location": {
    "lat": 36.3500,
    "lon": 129.7833,
    "nearestStations": {
      "nifs": {
        "id": "fjdfc",
        "name": "í‰íƒ ì¡°ìœ„",
        "distanceKm": 250.6
      },
      "kma": {
        "id": "22106",
        "name": "í¬í•­",
        "distanceKm": 0.5
      },
      "khoa": {
        "id": "DT_0009",
        "name": "í¬í•­",
        "distanceKm": 2.1
      }
    }
  },
  "timestamp": "2025-11-30T12:00:00+09:00",
  "water": {
    "midLayerTemp": 18.3,
    "surfaceTemp": 17.9,
    "salinity": null,
    "dissolvedOxygen": null
  },
  "wave": {
    "significantWaveHeight": 3.4,
    "windDirectionDeg": 304,
    "windSpeedMs": 14.0
  },
  "tide": {
    "tideLevelCm": 87.0,
    "tideObservedAt": "2025-11-30T11:50:00+09:00"
  },
  "meta": {
    "rawSources": ["NIFS_RISA", "KMA_SEA_OBS", "KHOA_SURVEY_TIDE"],
    "note": "ì‹¤ì‹œê°„ ê´€ì¸¡ìë£ŒëŠ” í’ˆì§ˆ ê²€ì¦ ì „ ë°ì´í„°ì¼ ìˆ˜ ìˆìŒ"
  }
}
```

**ì°¸ê³ **: 
- KMA ê´€ì¸¡ì†ŒëŠ” **B íƒ€ì… (BUOY)**ì„ ì‚¬ìš©í•˜ë©´ í’í–¥/í’ì† ë°ì´í„°ë¥¼ ì œê³µí•©ë‹ˆë‹¤.
- C íƒ€ì… (íŒŒê³ BUOY) ê´€ì¸¡ì†ŒëŠ” í’í–¥/í’ì† ë°ì´í„°ê°€ ì—†ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
- ì˜ˆì‹œ ì¢Œí‘œëŠ” í¬í•­ í•´ì—­ (B íƒ€ì… ê´€ì¸¡ì†Œ 22106 ê·¼ì²˜)ì…ë‹ˆë‹¤.

#### ì‚¬ìš© ì˜ˆì‹œ

**ì¢Œí‘œ ê¸°ë°˜ ì¡°íšŒ (í¬í•­ í•´ì—­ - B íƒ€ì… ê´€ì¸¡ì†Œ ì‚¬ìš©):**
```bash
# í¬í•­ í•´ì—­ (B íƒ€ì… ê´€ì¸¡ì†Œ 22106 ê·¼ì²˜)
curl -X GET "http://localhost:8080/api/environment/summary?lat=36.3500&lon=129.7833"
```

**í¬ì¸íŠ¸ ID ê¸°ë°˜ ì¡°íšŒ:**
```bash
curl -X GET "http://localhost:8080/api/environment/summary?pointId=1"
```

---

## ì™¸ë¶€ API ì—°ë™

### 1. NIFS RISA (êµ­ë¦½ìˆ˜ì‚°ê³¼í•™ì›)

- **URL**: `https://www.nifs.go.kr/OpenAPI_json`
- **API Key**: `application.yml`ì˜ `marine.nifs.key` ì„¤ì •ê°’ ì‚¬ìš©
- **ì œê³µ ë°ì´í„°**: ìˆ˜ì˜¨, ì—¼ë¶„, ìš©ì¡´ì‚°ì†Œ
- **ìˆ˜ì¸µ ìš°ì„ ìˆœìœ„**: ì¤‘ì¸µ(2) â†’ í‘œì¸µ(1) â†’ ì €ì¸µ(3)

### 2. KHOA ì¡°ìœ„ ê´€ì¸¡ (êµ­ë¦½í•´ì–‘ì¡°ì‚¬ì›)

- **URL**: `https://apis.data.go.kr/1192136/surveyTideLevel`
- **API Key**: `application.yml`ì˜ `marine.khoa.key-encoding` ì„¤ì •ê°’ ì‚¬ìš© (URL Encoding)
- **ì œê³µ ë°ì´í„°**: ì¡°ìœ„(cm), ê´€ì¸¡ì‹œê°

### 3. KMA í•´ì–‘ê¸°ìƒì¢…í•©ê´€ì¸¡ (ê¸°ìƒì²­)

- **URL**: `https://apihub.kma.go.kr/api/typ01/url/sea_obs.php`
- **API Key**: `application.yml`ì˜ `marine.kma.key` ì„¤ì •ê°’ ì‚¬ìš©
- **ì œê³µ ë°ì´í„°**: íŒŒê³ (WH), í’í–¥(WD), í’ì†(WS), í•´ìˆ˜ë©´ ì˜¨ë„(TW)
- **ê´€ì¸¡ì†Œ íƒ€ì…**:
  - **B íƒ€ì… (BUOY)**: íŒŒê³ , í’í–¥, í’ì†, í•´ìˆ˜ì˜¨ ëª¨ë‘ ì œê³µ âœ…
  - **C íƒ€ì… (íŒŒê³ BUOY)**: íŒŒê³ , í•´ìˆ˜ì˜¨ë§Œ ì œê³µ (í’í–¥/í’ì† ì—†ìŒ)
  - **ê¶Œì¥**: í’í–¥/í’ì† ë°ì´í„°ê°€ í•„ìš”í•œ ê²½ìš° B íƒ€ì… ê´€ì¸¡ì†Œ ì‚¬ìš©

---

## ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ

### MarineStation (ê´€ì¸¡ì†Œ)

| ì»¬ëŸ¼ | íƒ€ì… | ì„¤ëª… |
|------|------|------|
| `id` | BIGINT | PK, ìë™ì¦ê°€ |
| `external_source` | VARCHAR(50) | ì™¸ë¶€ API ì†ŒìŠ¤ (NIFS_RISA, KMA_SEA_OBS, KHOA_SURVEY_TIDE) |
| `external_station_id` | VARCHAR(100) | ì™¸ë¶€ APIì—ì„œ ì‚¬ìš©í•˜ëŠ” ê´€ì¸¡ì†Œ ID |
| `name` | VARCHAR(200) | ê´€ì¸¡ì†Œ ì´ë¦„ |
| `lat` | DECIMAL(9,6) | ìœ„ë„ |
| `lon` | DECIMAL(9,6) | ê²½ë„ |
| `is_active` | BOOLEAN | í™œì„±í™” ì—¬ë¶€ |
| `created_at` | TIMESTAMP | ìƒì„± ì‹œê° |
| `modified_at` | TIMESTAMP | ìˆ˜ì • ì‹œê° |

**ì¸ë±ìŠ¤**:
- `idx_source_ext`: `(external_source, external_station_id)`
- `idx_lat_lon`: `(lat, lon)`

### MarineObservation (ê´€ì¸¡ê°’)

| ì»¬ëŸ¼ | íƒ€ì… | ì„¤ëª… |
|------|------|------|
| `id` | BIGINT | PK, ìë™ì¦ê°€ |
| `station_id` | BIGINT | FK, ê´€ì¸¡ì†Œ ID |
| `observed_at` | TIMESTAMP WITH TIME ZONE | ê´€ì¸¡ ì‹œê° |
| `layer` | VARCHAR(50) | ìˆ˜ì¸µ ì •ë³´ |
| `water_temp` | DECIMAL(5,2) | ìˆ˜ì˜¨ (â„ƒ) |
| `salinity` | DECIMAL(5,2) | ì—¼ë¶„ (psu) |
| `dissolved_oxygen` | DECIMAL(5,2) | ìš©ì¡´ì‚°ì†Œ (mg/L) |
| `wave_height` | DECIMAL(5,2) | íŒŒê³  (m) |
| `wind_direction` | DECIMAL(5,2) | í’í–¥ (ë„) |
| `wind_speed` | DECIMAL(5,2) | í’ì† (m/s) |
| `tide_level` | DECIMAL(6,2) | ì¡°ìœ„ (cm) |
| `raw_payload` | TEXT | ì›ë³¸ API ì‘ë‹µ JSON |
| `created_at` | TIMESTAMP | ìƒì„± ì‹œê° |
| `modified_at` | TIMESTAMP | ìˆ˜ì • ì‹œê° |

**ì¸ë±ìŠ¤**:
- `idx_station_observed`: `(station_id, observed_at)`

### DivePoint (ë‹¤ì´ë¹™ í¬ì¸íŠ¸)

| ì»¬ëŸ¼ | íƒ€ì… | ì„¤ëª… |
|------|------|------|
| `id` | BIGINT | PK, ìë™ì¦ê°€ |
| `name` | VARCHAR(200) | í¬ì¸íŠ¸ ì´ë¦„ |
| `lat` | DECIMAL(9,6) | ìœ„ë„ |
| `lon` | DECIMAL(9,6) | ê²½ë„ |
| `region_name` | VARCHAR(200) | ì§€ì—­ëª… |
| `description` | TEXT | ì„¤ëª… |
| `created_at` | TIMESTAMP | ìƒì„± ì‹œê° |
| `modified_at` | TIMESTAMP | ìˆ˜ì • ì‹œê° |

**ì¸ë±ìŠ¤**:
- `idx_dive_point_lat_lon`: `(lat, lon)`

---

## ì„¤ì •

### application.yml ì„¤ì •

```yaml
marine:
  nifs:
    key: qPwOeIrU-2511-VFADBV-1349
  khoa:
    key-encoding: "Mw1rP8Brftnpf8vM%2BR%2FA4E%2FA9lhDJDLGNHoe6hmcFPpqGvHF4HdQGXWYHsKSqw2%2Bz5BWuJGa1Db9jTqeHcWe0Q%3D%3D"
    key-decoding: "Mw1rP8Brftnpf8vM+R/A4E/A9lhDJDLGNHoe6hmcFPpqGvHF4HdQGXWYHsKSqw2+z5BWuJGa1Db9jTqeHcWe0Q=="
  kma:
    key: WgCdt_1OQHOAnbf9TpBzWA
```

### WebClient ì„¤ì •

`MarineWebClientConfig`ì—ì„œ í•´ì–‘ í™˜ê²½ API í˜¸ì¶œìš© WebClientë¥¼ ì„¤ì •í•©ë‹ˆë‹¤:
- íƒ€ì„ì•„ì›ƒ ì„¤ì •
- ìµœëŒ€ ë©”ëª¨ë¦¬ ë²„í¼ í¬ê¸°: 10MB

---

## ì‚¬ìš© ë°©ë²•

### 1. ì„œë²„ ì‹¤í–‰

```bash
./gradlew bootRun
```

### 2. ê´€ì¸¡ì†Œ ë°ì´í„° ì´ˆê¸°í™”

**ì¤‘ìš”**: APIë¥¼ ì‚¬ìš©í•˜ê¸° ì „ì— ê´€ì¸¡ì†Œ ë°ì´í„°ë¥¼ ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥í•´ì•¼ í•©ë‹ˆë‹¤.

ê´€ì¸¡ì†Œ ë°ì´í„°ëŠ” ë‹¤ìŒ ë°©ë²•ìœ¼ë¡œ ì´ˆê¸°í™”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

1. **NIFS RISA ê´€ì¸¡ì†Œ ëª©ë¡ ì¡°íšŒ ë° ì €ì¥**
   - `NifsRisaClient.fetchStations()` í˜¸ì¶œ
   - ì‘ë‹µ ë°ì´í„°ë¥¼ `MarineStation` ì—”í‹°í‹°ë¡œ ë³€í™˜í•˜ì—¬ ì €ì¥

2. **KMA í•´ì–‘ê¸°ìƒ ê´€ì¸¡ì†Œ ëª©ë¡ ì¡°íšŒ ë° ì €ì¥**
   - KMA APIì—ì„œ ê´€ì¸¡ì†Œ ëª©ë¡ ì¡°íšŒ
   - `MarineStation` ì—”í‹°í‹°ë¡œ ì €ì¥

3. **KHOA ì¡°ìœ„ ê´€ì¸¡ì†Œ ëª©ë¡ ì¡°íšŒ ë° ì €ì¥**
   - KHOA APIì—ì„œ ê´€ì¸¡ì†Œ ëª©ë¡ ì¡°íšŒ
   - `MarineStation` ì—”í‹°í‹°ë¡œ ì €ì¥

**ì´ˆê¸°í™” ìŠ¤í¬ë¦½íŠ¸ ì˜ˆì‹œ** (ë³„ë„ êµ¬í˜„ í•„ìš”):

```java
@Service
@RequiredArgsConstructor
public class MarineStationInitializer {
    private final NifsRisaClient nifsRisaClient;
    private final MarineStationRepository stationRepository;
    
    @Transactional
    public void initializeStations() {
        // NIFS ê´€ì¸¡ì†Œ ëª©ë¡ ì¡°íšŒ ë° ì €ì¥
        List<NifsRisaResponse.NifsRisaItem> stations = 
            nifsRisaClient.fetchStations().block();
        
        stations.forEach(item -> {
            MarineStation station = MarineStation.builder()
                .externalSource(StationSource.NIFS_RISA)
                .externalStationId(item.getObsPostId())
                .name(item.getObsPostNm())
                .lat(item.getObsLat())
                .lon(item.getObsLon())
                .isActive(true)
                .build();
            stationRepository.save(station);
        });
    }
}
```

### 3. API í˜¸ì¶œ

**ì¢Œí‘œ ê¸°ë°˜ ì¡°íšŒ (í¬í•­ í•´ì—­ - B íƒ€ì… ê´€ì¸¡ì†Œ ì‚¬ìš©):**
```bash
# í¬í•­ í•´ì—­ (B íƒ€ì… ê´€ì¸¡ì†Œ 22106 ê·¼ì²˜) - í’í–¥/í’ì† ë°ì´í„° í¬í•¨
curl -X GET "http://localhost:8080/api/environment/summary?lat=36.3500&lon=129.7833"
```

**ë‹¤ë¥¸ B íƒ€ì… ê´€ì¸¡ì†Œ ì˜ˆì‹œ:**
```bash
# ë•ì ë„ í•´ì—­ (B íƒ€ì… ê´€ì¸¡ì†Œ 22101)
curl -X GET "http://localhost:8080/api/environment/summary?lat=37.2361&lon=126.0188"

# ì¹ ë°œë„ í•´ì—­ (B íƒ€ì… ê´€ì¸¡ì†Œ 22102)
curl -X GET "http://localhost:8080/api/environment/summary?lat=34.7933&lon=125.7769"
```

**í¬ì¸íŠ¸ ID ê¸°ë°˜ ì¡°íšŒ:**
```bash
curl -X GET "http://localhost:8080/api/environment/summary?pointId=1"
```

---

## í…ŒìŠ¤íŠ¸

### 1. ë‹¨ìœ„ í…ŒìŠ¤íŠ¸

ê° í´ë¼ì´ì–¸íŠ¸ì™€ ì„œë¹„ìŠ¤ì˜ ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ë¥¼ ì‘ì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

```java
@SpringBootTest
class EnvironmentSummaryServiceTest {
    @Autowired
    private EnvironmentSummaryService service;
    
    @Test
    void testGetEnvironmentSummary() {
        EnvironmentSummaryRequest request = EnvironmentSummaryRequest.builder()
            .lat(36.3500)  // í¬í•­ í•´ì—­ ìœ„ë„ (B íƒ€ì… ê´€ì¸¡ì†Œ 22106 ê·¼ì²˜)
            .lon(129.7833)  // í¬í•­ í•´ì—­ ê²½ë„ (B íƒ€ì… ê´€ì¸¡ì†Œ 22106 ê·¼ì²˜)
            .build();
        
        EnvironmentSummaryResponse response = 
            service.getEnvironmentSummary(request);
        
        assertNotNull(response);
        assertNotNull(response.getLocation());
    }
}
```

### 2. í†µí•© í…ŒìŠ¤íŠ¸

ì‹¤ì œ ì™¸ë¶€ APIë¥¼ í˜¸ì¶œí•˜ëŠ” í†µí•© í…ŒìŠ¤íŠ¸:

```bash
# 1. ì„œë²„ ì‹¤í–‰
./gradlew bootRun

# 2. API í˜¸ì¶œ í…ŒìŠ¤íŠ¸ (B íƒ€ì… ê´€ì¸¡ì†Œ ì‚¬ìš© - í’í–¥/í’ì† ë°ì´í„° í¬í•¨)
curl -X GET "http://localhost:8080/api/environment/summary?lat=36.3500&lon=129.7833" \
  -H "Content-Type: application/json"
```

### 3. í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤

#### ì„±ê³µ ì¼€ì´ìŠ¤
- âœ… ìœ íš¨í•œ ì¢Œí‘œë¡œ ì¡°íšŒ
- âœ… ìœ íš¨í•œ í¬ì¸íŠ¸ IDë¡œ ì¡°íšŒ
- âœ… ëª¨ë“  ì™¸ë¶€ APIê°€ ì •ìƒ ì‘ë‹µ

#### ì‹¤íŒ¨ ì¼€ì´ìŠ¤
- âŒ ì¢Œí‘œì™€ í¬ì¸íŠ¸ ID ëª¨ë‘ ì—†ìŒ
- âŒ ì¡´ì¬í•˜ì§€ ì•ŠëŠ” í¬ì¸íŠ¸ ID
- âŒ ì™¸ë¶€ API í˜¸ì¶œ ì‹¤íŒ¨ (ì—ëŸ¬ ì²˜ë¦¬ í™•ì¸)
- âŒ ê´€ì¸¡ì†Œ ë°ì´í„°ê°€ ì—†ëŠ” ê²½ìš°

---

## ì£¼ì˜ì‚¬í•­

1. **ê´€ì¸¡ì†Œ ë°ì´í„° ì´ˆê¸°í™” í•„ìˆ˜**: APIë¥¼ ì‚¬ìš©í•˜ê¸° ì „ì— ê´€ì¸¡ì†Œ ë°ì´í„°ë¥¼ ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥í•´ì•¼ í•©ë‹ˆë‹¤.

2. **ì™¸ë¶€ API ì˜ì¡´ì„±**: ì´ ëª¨ë“ˆì€ ì™¸ë¶€ APIì˜ ê°€ìš©ì„±ì— ì˜ì¡´í•©ë‹ˆë‹¤. ì™¸ë¶€ APIê°€ ë‹¤ìš´ë˜ê±°ë‚˜ ì‘ë‹µì´ ì§€ì—°ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

3. **ë°ì´í„° í’ˆì§ˆ**: ì‹¤ì‹œê°„ ê´€ì¸¡ ë°ì´í„°ëŠ” í’ˆì§ˆ ê²€ì¦ ì „ ë°ì´í„°ì¼ ìˆ˜ ìˆìœ¼ë¯€ë¡œ, ì‹¤ì œ ì‚¬ìš© ì‹œ ì£¼ì˜ê°€ í•„ìš”í•©ë‹ˆë‹¤.

4. **ë¹„ë™ê¸° ì²˜ë¦¬**: í˜„ì¬ êµ¬í˜„ì€ `block()`ì„ ì‚¬ìš©í•˜ì—¬ ë™ê¸°ì ìœ¼ë¡œ ì²˜ë¦¬í•˜ì§€ë§Œ, í–¥í›„ ì™„ì „í•œ ë¹„ë™ê¸° ì²˜ë¦¬ë¡œ ê°œì„ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

5. **ì—ëŸ¬ ì²˜ë¦¬**: ì™¸ë¶€ API í˜¸ì¶œ ì‹¤íŒ¨ ì‹œ í•´ë‹¹ í•„ë“œëŠ” `null`ë¡œ ë°˜í™˜ë©ë‹ˆë‹¤. í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì´ë¥¼ ê³ ë ¤í•´ì•¼ í•©ë‹ˆë‹¤.

---

## í–¥í›„ ê°œì„  ì‚¬í•­

- [ ] ì™„ì „í•œ ë¹„ë™ê¸° ì²˜ë¦¬ (Mono/Flux í™œìš©)
- [ ] ê´€ì¸¡ì†Œ ë°ì´í„° ìë™ ë™ê¸°í™” ìŠ¤ì¼€ì¤„ëŸ¬
- [ ] ê´€ì¸¡ê°’ ìºì‹± (Redis ë“±)
- [ ] ê´€ì¸¡ì†Œ ë°ì´í„° ì´ˆê¸°í™” ìŠ¤í¬ë¦½íŠ¸ ìë™í™”
- [ ] ë” ìƒì„¸í•œ ì—ëŸ¬ ë©”ì‹œì§€ ë° ìƒíƒœ ì½”ë“œ
- [ ] API ì‘ë‹µ ì‹œê°„ ëª¨ë‹ˆí„°ë§

---

## ê´€ë ¨ íŒŒì¼

- **ì—”í‹°í‹°**: `domain/MarineStation.java`, `domain/MarineObservation.java`, `domain/DivePoint.java`
- **í´ë¼ì´ì–¸íŠ¸**: `client/NifsRisaClient.java`, `client/KhoaTideClient.java`, `client/KmaSeaObsClient.java`
- **ì„œë¹„ìŠ¤**: `service/EnvironmentSummaryServiceImpl.java`
- **ì»¨íŠ¸ë¡¤ëŸ¬**: `controller/EnvironmentSummaryController.java`
- **ì„¤ì •**: `config/MarineWebClientConfig.java`, `properties/MarineApiProperties.java`



================================================================================
File Path: .\src\main\java\com\ocean\piuda\environment\repository\DivePointRepository.java
================================================================================

package com.ocean.piuda.environment.repository;

import com.ocean.piuda.divePoint.entity.DivePoint;
import org.springframework.data.jpa.repository.JpaRepository;

import java.util.Optional;

/**
 * ë‹¤ì´ë¹™ í¬ì¸íŠ¸ Repository
 */
public interface DivePointRepository extends JpaRepository<DivePoint, Long> {
    Optional<DivePoint> findById(Long id);
}



================================================================================
File Path: .\src\main\java\com\ocean\piuda\environment\repository\MarineObservationRepository.java
================================================================================

package com.ocean.piuda.environment.repository;

import com.ocean.piuda.environment.domain.MarineObservation;
import com.ocean.piuda.environment.domain.MarineStation;
import org.springframework.data.jpa.repository.JpaRepository;

import java.time.ZonedDateTime;
import java.util.Optional;

/**
 * í•´ì–‘ ê´€ì¸¡ê°’ Repository
 */
public interface MarineObservationRepository extends JpaRepository<MarineObservation, Long> {

    /**
     * ê´€ì¸¡ì†Œì™€ ê´€ì¸¡ ì‹œê°ìœ¼ë¡œ ìµœì‹  ê´€ì¸¡ê°’ ì¡°íšŒ
     */
    Optional<MarineObservation> findTopByStationOrderByObservedAtDesc(MarineStation station);

    /**
     * ê´€ì¸¡ì†Œì™€ ì‹œê°„ ë²”ìœ„ë¡œ ê´€ì¸¡ê°’ ì¡°íšŒ
     */
    Optional<MarineObservation> findTopByStationAndObservedAtBetweenOrderByObservedAtDesc(
            MarineStation station, ZonedDateTime start, ZonedDateTime end);
}



================================================================================
File Path: .\src\main\java\com\ocean\piuda\environment\repository\MarineStationRepository.java
================================================================================

package com.ocean.piuda.environment.repository;

import com.ocean.piuda.environment.domain.MarineStation;
import com.ocean.piuda.environment.domain.StationSource;
import org.springframework.data.jpa.repository.JpaRepository;

import java.util.List;
import java.util.Optional;

/**
 * í•´ì–‘ ê´€ì¸¡ì†Œ Repository
 */
public interface MarineStationRepository extends JpaRepository<MarineStation, Long> {

    /**
     * ì™¸ë¶€ ì†ŒìŠ¤ì™€ ì™¸ë¶€ IDë¡œ ê´€ì¸¡ì†Œ ì¡°íšŒ
     */
    Optional<MarineStation> findByExternalSourceAndExternalStationId(
            StationSource source, String externalStationId);

    /**
     * í™œì„±í™”ëœ ê´€ì¸¡ì†Œë§Œ ì¡°íšŒ
     */
    List<MarineStation> findByExternalSourceAndIsActiveTrue(StationSource source);

    /**
     * ì™¸ë¶€ ì†ŒìŠ¤ë¡œ ê´€ì¸¡ì†Œ ì‚­ì œ
     */
    void deleteByExternalSource(StationSource source);
}



================================================================================
File Path: .\src\main\java\com\ocean\piuda\environment\service\EnvironmentSummaryService.java
================================================================================

package com.ocean.piuda.environment.service;

import com.ocean.piuda.environment.dto.EnvironmentSummaryRequest;
import com.ocean.piuda.environment.dto.EnvironmentSummaryResponse;

/**
 * í•´ì–‘ í™˜ê²½ ìš”ì•½ ì„œë¹„ìŠ¤ ì¸í„°í˜ì´ìŠ¤
 */
public interface EnvironmentSummaryService {

    /**
     * í•´ì–‘ í™˜ê²½ ìš”ì•½ ì¡°íšŒ
     *
     * @param request ìš”ì²­ íŒŒë¼ë¯¸í„° (lat/lon ë˜ëŠ” pointId)
     * @return í™˜ê²½ ìš”ì•½ ì •ë³´
     */
    EnvironmentSummaryResponse getEnvironmentSummary(EnvironmentSummaryRequest request);
}



================================================================================
File Path: .\src\main\java\com\ocean\piuda\environment\service\EnvironmentSummaryServiceImpl.java
================================================================================

package com.ocean.piuda.environment.service;

import com.ocean.piuda.environment.client.KhoaTideClient;
import com.ocean.piuda.environment.client.KmaSeaObsClient;
import com.ocean.piuda.environment.client.NifsRisaClient;
import com.ocean.piuda.environment.client.dto.KhoaTideResponse;
import com.ocean.piuda.environment.client.dto.KmaSeaObsResponse;
import com.ocean.piuda.environment.client.dto.NifsRisaResponse;
import com.ocean.piuda.environment.domain.*;
import com.ocean.piuda.environment.dto.EnvironmentSummaryRequest;
import com.ocean.piuda.environment.dto.EnvironmentSummaryResponse;
import com.ocean.piuda.divePoint.repository.DivePointRepository;
import com.ocean.piuda.environment.repository.MarineStationRepository;
import com.ocean.piuda.environment.util.DistanceCalculator;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.time.LocalDate;
import java.time.LocalTime;
import java.time.ZoneId;
import java.time.ZonedDateTime;
import java.time.format.DateTimeFormatter;
import java.util.ArrayList;
import java.util.Comparator;
import java.util.List;
import java.util.Optional;

/**
 * í•´ì–‘ í™˜ê²½ ìš”ì•½ ì„œë¹„ìŠ¤ êµ¬í˜„ì²´
 */
@Slf4j
@Service
@RequiredArgsConstructor
@Transactional(readOnly = true)
public class EnvironmentSummaryServiceImpl implements EnvironmentSummaryService {

    private final NifsRisaClient nifsRisaClient;
    private final KhoaTideClient khoaTideClient;
    private final KmaSeaObsClient kmaSeaObsClient;
    private final MarineStationRepository marineStationRepository;
    private final DivePointRepository divePointRepository;

    private static final DateTimeFormatter NIFS_DATE_FORMATTER = DateTimeFormatter.ofPattern("yyyy-MM-dd HH:mm:ss");

    @Override
    public EnvironmentSummaryResponse getEnvironmentSummary(EnvironmentSummaryRequest request) {
        // 1. ê¸°ì¤€ ì¢Œí‘œ í™•ë³´
        double lat, lon;
        if (request.isPointIdBased()) {
            DivePoint point = divePointRepository.findById(request.pointId())
                    .orElseThrow(() -> new IllegalArgumentException("ë‹¤ì´ë¹™ í¬ì¸íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: " + request.pointId()));
            lat = point.getLat();
            lon = point.getLon();
        } else if (request.isCoordinateBased()) {
            lat = request.lat();
            lon = request.lon();
        } else {
            throw new IllegalArgumentException("lat/lon ë˜ëŠ” pointIdê°€ í•„ìš”í•©ë‹ˆë‹¤.");
        }

        log.info("í™˜ê²½ ìš”ì•½ ì¡°íšŒ ì‹œì‘: lat={}, lon={}, pointId={}", lat, lon, request.pointId());

        // 2. ê°€ì¥ ê°€ê¹Œìš´ ê´€ì¸¡ì†Œ ë§¤ì¹­
        MarineStation nifsStation = findNearestStation(lat, lon, StationSource.NIFS_RISA);
        MarineStation kmaStation = findNearestStation(lat, lon, StationSource.KMA_SEA_OBS);
        MarineStation khoaStation = findNearestStation(lat, lon, StationSource.KHOA_SURVEY_TIDE);

        if (nifsStation == null && kmaStation == null && khoaStation == null) {
            log.warn("ëª¨ë“  ê´€ì¸¡ì†Œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ê´€ì¸¡ì†Œ ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í•´ì•¼ í•©ë‹ˆë‹¤.");
        }

        // 3. ê° API í˜¸ì¶œ (ë¹„ë™ê¸°ë¡œ ë³‘ë ¬ ì²˜ë¦¬ ê°€ëŠ¥í•˜ì§€ë§Œ, ì—¬ê¸°ì„œëŠ” ìˆœì°¨ ì²˜ë¦¬)
        EnvironmentSummaryResponse.Water water = fetchWaterData(nifsStation, lat, lon);
        EnvironmentSummaryResponse.Wave wave = fetchWaveData(kmaStation, lat, lon);
        EnvironmentSummaryResponse.Tide tide = fetchTideData(khoaStation);

        // 4. ìµœì¢… JSON ì¡°ë¦½
        return EnvironmentSummaryResponse.builder()
                .location(EnvironmentSummaryResponse.Location.builder()
                        .lat(lat)
                        .lon(lon)
                        .nearestStations(EnvironmentSummaryResponse.NearestStations.builder()
                                .nifs(buildStationInfo(nifsStation, lat, lon))
                                .kma(buildStationInfo(kmaStation, lat, lon))
                                .khoa(buildStationInfo(khoaStation, lat, lon))
                                .build())
                        .build())
                .timestamp(ZonedDateTime.now(ZoneId.of("Asia/Seoul")))
                .water(water)
                .wave(wave)
                .tide(tide)
                .meta(EnvironmentSummaryResponse.Meta.builder()
                        .rawSources(List.of("NIFS_RISA", "KMA_SEA_OBS", "KHOA_SURVEY_TIDE"))
                        .note("ì‹¤ì‹œê°„ ê´€ì¸¡ìë£ŒëŠ” í’ˆì§ˆ ê²€ì¦ ì „ ë°ì´í„°ì¼ ìˆ˜ ìˆìŒ")
                        .build())
                .build();
    }

    /**
     * ê°€ì¥ ê°€ê¹Œìš´ ê´€ì¸¡ì†Œ ì°¾ê¸°
     * NIFS RISAì˜ ê²½ìš° ì¢Œí‘œê°€ ì—†ëŠ” ê²½ìš° KHOA ì¡°ìœ„ê´€ì¸¡ì†Œ ì¢Œí‘œë¥¼ ì°¸ê³ í•˜ì—¬ ë§¤ì¹­
     */
    private MarineStation findNearestStation(double lat, double lon, StationSource source) {
        List<MarineStation> stations = marineStationRepository.findByExternalSourceAndIsActiveTrue(source);

        if (stations.isEmpty()) {
            log.warn("ê´€ì¸¡ì†Œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤: source={}, lat={}, lon={}", source, lat, lon);
            return null;
        }

        // ìœ„ì¹˜ ì •ë³´ê°€ ìˆëŠ” ê´€ì¸¡ì†Œë§Œ í•„í„°ë§ (0.0, 0.0 ì¢Œí‘œ ì œì™¸ - ì„ì‹œ ì¢Œí‘œ)
        List<MarineStation> stationsWithLocation = stations.stream()
                .filter(station -> station.getLat() != null && station.getLon() != null)
                .filter(station -> station.getLat() != 0.0 && station.getLon() != 0.0)
                .toList();

        // NIFS RISAì˜ ê²½ìš° ì¢Œí‘œê°€ ì—†ëŠ” ê´€ì¸¡ì†Œê°€ ìˆìœ¼ë©´ KHOA ì¡°ìœ„ê´€ì¸¡ì†Œ ì¢Œí‘œë¥¼ ì°¸ê³ í•˜ì—¬ ë§¤ì¹­
        if (source == StationSource.NIFS_RISA && stationsWithLocation.isEmpty()) {
            log.info("NIFS RISA ê´€ì¸¡ì†Œì— ì¢Œí‘œê°€ ì—†ì–´ KHOA ì¡°ìœ„ê´€ì¸¡ì†Œ ì¢Œí‘œë¥¼ ì°¸ê³ í•˜ì—¬ ë§¤ì¹­ ì‹œë„");
            List<MarineStation> khoaStations = marineStationRepository.findByExternalSourceAndIsActiveTrue(StationSource.KHOA_SURVEY_TIDE);
            List<MarineStation> khoaWithLocation = khoaStations.stream()
                    .filter(station -> station.getLat() != null && station.getLon() != null)
                    .filter(station -> station.getLat() != 0.0 && station.getLon() != 0.0)
                    .toList();

            if (!khoaWithLocation.isEmpty()) {
                // ê°€ì¥ ê°€ê¹Œìš´ KHOA ê´€ì¸¡ì†Œ ì°¾ê¸°
                MarineStation nearestKhoa = khoaWithLocation.stream()
                        .min(Comparator.comparingDouble(station ->
                                DistanceCalculator.calculateDistance(lat, lon, station.getLat(), station.getLon())))
                        .orElse(null);

                if (nearestKhoa != null) {
                    // NIFS ê´€ì¸¡ì†ŒëŠ” ì¢Œí‘œê°€ ì—†ìœ¼ë¯€ë¡œ, ê°€ì¥ ê°€ê¹Œìš´ KHOA ê´€ì¸¡ì†Œë¥¼ ê¸°ì¤€ìœ¼ë¡œ 
                    // ì²« ë²ˆì§¸ NIFS ê´€ì¸¡ì†Œë¥¼ ë°˜í™˜ (ì‹¤ì œë¡œëŠ” ëª¨ë“  NIFS ê´€ì¸¡ì†Œê°€ ë™ì¼í•˜ê²Œ ì²˜ë¦¬ë¨)
                    // ê±°ë¦¬ëŠ” KHOA ê´€ì¸¡ì†Œ ê¸°ì¤€ìœ¼ë¡œ ê³„ì‚°
                    MarineStation nifsStation = stations.get(0);
                    double distance = DistanceCalculator.calculateDistance(lat, lon, nearestKhoa.getLat(), nearestKhoa.getLon());
                    log.info("NIFS RISA ê´€ì¸¡ì†Œ ë§¤ì¹­ (KHOA ì¢Œí‘œ ì°¸ê³ ): stationId={}, name={}, khoaStation={}, distance={}km",
                            nifsStation.getExternalStationId(), nifsStation.getName(), nearestKhoa.getName(), Math.round(distance * 10.0) / 10.0);
                    return nifsStation; // NIFS ê´€ì¸¡ì†Œ ë°˜í™˜ (ê´€ì¸¡ì†Œ IDëŠ” ìœ íš¨í•˜ì§€ë§Œ ì¢Œí‘œëŠ” ì—†ìŒ)
                }
            }
        }

        if (stationsWithLocation.isEmpty()) {
            log.warn("ìœ„ì¹˜ ì •ë³´ê°€ ìˆëŠ” ê´€ì¸¡ì†Œê°€ ì—†ìŠµë‹ˆë‹¤: source={}, lat={}, lon={}", source, lat, lon);
            return null;
        }

        MarineStation nearest = stationsWithLocation.stream()
                .min(Comparator.comparingDouble(station ->
                        DistanceCalculator.calculateDistance(lat, lon, station.getLat(), station.getLon())))
                .orElse(null);

        if (nearest != null) {
            double distance = DistanceCalculator.calculateDistance(lat, lon, nearest.getLat(), nearest.getLon());
            log.debug("ê°€ì¥ ê°€ê¹Œìš´ ê´€ì¸¡ì†Œ ì°¾ìŒ: source={}, stationId={}, name={}, distance={}km", 
                    source, nearest.getExternalStationId(), nearest.getName(), Math.round(distance * 10.0) / 10.0);
        }

        return nearest;
    }

    /**
     * ìˆ˜ì˜¨/ì—¼ë¶„/ìš©ì¡´ì‚°ì†Œ ë°ì´í„° ì¡°íšŒ
     * ê´€ì¸¡ì†Œê°€ NIFS RISA APIì—ì„œ ì œê³µí•˜ì§€ ì•Šìœ¼ë©´ ë‹¤ìŒ ê°€ê¹Œìš´ ê´€ì¸¡ì†Œë¥¼ ì‹œë„
     * 
     * @param station ì²« ë²ˆì§¸ ê´€ì¸¡ì†Œ
     * @param requestLat ìš”ì²­í•œ ìœ„ë„
     * @param requestLon ìš”ì²­í•œ ê²½ë„
     */
    private EnvironmentSummaryResponse.Water fetchWaterData(MarineStation station, double requestLat, double requestLon) {
        if (station == null) {
            log.warn("ìˆ˜ì˜¨ ë°ì´í„° ì¡°íšŒ ì‹¤íŒ¨: ê´€ì¸¡ì†Œê°€ nullì…ë‹ˆë‹¤");
            return EnvironmentSummaryResponse.Water.builder().build();
        }

        // ì²« ë²ˆì§¸ ê´€ì¸¡ì†Œ ì‹œë„
        EnvironmentSummaryResponse.Water result = fetchWaterDataFromStation(station);
        
        // ìˆ˜ì˜¨ ë°ì´í„°ê°€ nullì¸ ê²½ìš° ë‹¤ìŒ ê°€ê¹Œìš´ ê´€ì¸¡ì†Œ ì‹œë„
        if (result.midLayerTemp() == null && result.surfaceTemp() == null) {
            log.info("ìˆ˜ì˜¨ ë°ì´í„°ê°€ ì—†ì–´ ë‹¤ìŒ ê°€ê¹Œìš´ NIFS RISA ê´€ì¸¡ì†Œë¥¼ ì‹œë„í•©ë‹ˆë‹¤: stationId={}", station.getExternalStationId());
            
            // ìš”ì²­ ì¢Œí‘œ ê¸°ì¤€ìœ¼ë¡œ ë‹¤ìŒ ê°€ê¹Œìš´ ê´€ì¸¡ì†Œ ì°¾ê¸°
            List<MarineStation> allNifsStations = marineStationRepository.findByExternalSourceAndIsActiveTrue(StationSource.NIFS_RISA);
            List<MarineStation> stationsWithLocation = allNifsStations.stream()
                    .filter(s -> s.getLat() != null && s.getLon() != null)
                    .filter(s -> s.getLat() != 0.0 && s.getLon() != 0.0)
                    .filter(s -> !s.getExternalStationId().equals(station.getExternalStationId())) // í˜„ì¬ ê´€ì¸¡ì†Œ ì œì™¸
                    .toList();
            
            if (!stationsWithLocation.isEmpty()) {
                // ìš”ì²­ ì¢Œí‘œ ê¸°ì¤€ìœ¼ë¡œ ê±°ë¦¬ìˆœ ì •ë ¬í•˜ì—¬ ë‹¤ìŒ ê°€ê¹Œìš´ ê´€ì¸¡ì†Œ ì°¾ê¸°
                MarineStation nextStation = stationsWithLocation.stream()
                        .min(Comparator.comparingDouble(s ->
                                DistanceCalculator.calculateDistance(
                                        requestLat, requestLon,
                                        s.getLat(), s.getLon())))
                        .orElse(null);
                
                if (nextStation != null) {
                    double distance = DistanceCalculator.calculateDistance(
                            requestLat, requestLon,
                            nextStation.getLat(), nextStation.getLon());
                    log.info("ë‹¤ìŒ ê°€ê¹Œìš´ NIFS RISA ê´€ì¸¡ì†Œ ì‹œë„: stationId={}, name={}, distance={}km",
                            nextStation.getExternalStationId(), nextStation.getName(), Math.round(distance * 10.0) / 10.0);
                    
                    EnvironmentSummaryResponse.Water nextResult = fetchWaterDataFromStation(nextStation);
                    
                    // ë‹¤ìŒ ê´€ì¸¡ì†Œì—ì„œ ìˆ˜ì˜¨ ë°ì´í„°ë¥¼ ì–»ì—ˆìœ¼ë©´ ë°˜í™˜
                    if (nextResult.midLayerTemp() != null || nextResult.surfaceTemp() != null) {
                        log.info("ë‹¤ìŒ ê´€ì¸¡ì†Œì—ì„œ ìˆ˜ì˜¨ ë°ì´í„° íšë“: stationId={}, temp={}",
                                nextStation.getExternalStationId(), nextResult.midLayerTemp());
                        return nextResult;
                    } else {
                        log.warn("ë‹¤ìŒ ê´€ì¸¡ì†Œì—ì„œë„ ìˆ˜ì˜¨ ë°ì´í„°ë¥¼ ì–»ì§€ ëª»í–ˆìŠµë‹ˆë‹¤: stationId={}", nextStation.getExternalStationId());
                    }
                }
            } else {
                log.warn("ë‹¤ìŒ ê°€ê¹Œìš´ NIFS RISA ê´€ì¸¡ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            }
        }
        
        return result;
    }

    /**
     * íŠ¹ì • ê´€ì¸¡ì†Œì—ì„œ ìˆ˜ì˜¨/ì—¼ë¶„/ìš©ì¡´ì‚°ì†Œ ë°ì´í„° ì¡°íšŒ
     */
    private EnvironmentSummaryResponse.Water fetchWaterDataFromStation(MarineStation station) {
        String stationId = station.getExternalStationId();
        log.info("ìˆ˜ì˜¨ ë°ì´í„° ì¡°íšŒ ì‹œì‘: stationId={}, name={}", stationId, station.getName());

        try {
            NifsRisaResponse.NifsRisaItem observation = nifsRisaClient
                    .fetchLatestObservation(stationId)
                    .block(); // ë¹„ë™ê¸° í˜¸ì¶œì„ ë™ê¸°ë¡œ ë³€í™˜

            if (observation == null) {
                log.warn("ìˆ˜ì˜¨ ë°ì´í„° ì¡°íšŒ ì‹¤íŒ¨: observationì´ nullì…ë‹ˆë‹¤. stationId={} (APIì—ì„œ ì œê³µí•˜ì§€ ì•Šì„ ìˆ˜ ìˆìŒ)", stationId);
                return EnvironmentSummaryResponse.Water.builder().build();
            }

            Double waterTemp = observation.getWaterTemp();
            log.info("ìˆ˜ì˜¨ ë°ì´í„° ì¡°íšŒ ì„±ê³µ: stationId={}, temp={}, layer={}", 
                    stationId, waterTemp, observation.getObsLayInt());

            return EnvironmentSummaryResponse.Water.builder()
                    .midLayerTemp(waterTemp)
                    .surfaceTemp(waterTemp) // ì¤‘ì¸µ ë°ì´í„°ë¥¼ í‘œì¸µìœ¼ë¡œë„ ì‚¬ìš©
                    .salinity(observation.getSalinity()) // í˜„ì¬ APIì—ì„œ ì œê³µí•˜ì§€ ì•ŠìŒ
                    .dissolvedOxygen(observation.getDissolvedOxygen()) // í˜„ì¬ APIì—ì„œ ì œê³µí•˜ì§€ ì•ŠìŒ
                    .build();
        } catch (Exception e) {
            log.error("ìˆ˜ì˜¨ ë°ì´í„° ì¡°íšŒ ì‹¤íŒ¨: stationId={}", stationId, e);
            return EnvironmentSummaryResponse.Water.builder().build();
        }
    }

    /**
     * íŒŒê³ /í’í–¥/í’ì† ë°ì´í„° ì¡°íšŒ
     * í’í–¥/í’ì†ì´ nullì´ë©´ ìµœëŒ€ 3ë²ˆì§¸ ê´€ì¸¡ì†Œê¹Œì§€ ì‹œë„
     * 
     * @param station ì²« ë²ˆì§¸ ê´€ì¸¡ì†Œ
     * @param requestLat ìš”ì²­í•œ ìœ„ë„
     * @param requestLon ìš”ì²­í•œ ê²½ë„
     */
    private EnvironmentSummaryResponse.Wave fetchWaveData(MarineStation station, double requestLat, double requestLon) {
        if (station == null) {
            log.warn("íŒŒê³  ë°ì´í„° ì¡°íšŒ ì‹¤íŒ¨: ê´€ì¸¡ì†Œê°€ nullì…ë‹ˆë‹¤");
            return EnvironmentSummaryResponse.Wave.builder().build();
        }

        // ì²« ë²ˆì§¸ ê´€ì¸¡ì†Œ ì‹œë„
        EnvironmentSummaryResponse.Wave result = fetchWaveDataFromStation(station);
        Double significantWaveHeight = result.significantWaveHeight(); // ì²« ë²ˆì§¸ ê´€ì¸¡ì†Œì˜ íŒŒê³  ì €ì¥
        
        // í’í–¥/í’ì†ì´ ëª¨ë‘ nullì´ê³ , íŒŒê³  ë°ì´í„°ëŠ” ìˆëŠ” ê²½ìš° ë‹¤ìŒ ê°€ê¹Œìš´ ê´€ì¸¡ì†Œ ì‹œë„ (ìµœëŒ€ 10ê°œê¹Œì§€ ë˜ëŠ” í’í–¥/í’ì† ë°ì´í„°ë¥¼ ì°¾ì„ ë•Œê¹Œì§€)
        if (result.windDirectionDeg() == null && result.windSpeedMs() == null && significantWaveHeight != null) {
            log.info("í’í–¥/í’ì† ë°ì´í„°ê°€ ì—†ì–´ ë‹¤ìŒ ê°€ê¹Œìš´ KMA ê´€ì¸¡ì†Œë¥¼ ì‹œë„í•©ë‹ˆë‹¤: stationId={}", station.getExternalStationId());
            
            // ìš”ì²­ ì¢Œí‘œ ê¸°ì¤€ìœ¼ë¡œ ë‹¤ìŒ ê°€ê¹Œìš´ ê´€ì¸¡ì†Œ ì°¾ê¸°
            List<MarineStation> allKmaStations = marineStationRepository.findByExternalSourceAndIsActiveTrue(StationSource.KMA_SEA_OBS);
            List<MarineStation> stationsWithLocation = allKmaStations.stream()
                    .filter(s -> s.getLat() != null && s.getLon() != null)
                    .filter(s -> s.getLat() != 0.0 && s.getLon() != 0.0)
                    .filter(s -> !s.getExternalStationId().equals(station.getExternalStationId())) // í˜„ì¬ ê´€ì¸¡ì†Œ ì œì™¸
                    .sorted(Comparator.comparingDouble(s ->
                            DistanceCalculator.calculateDistance(requestLat, requestLon, s.getLat(), s.getLon())))
                    .toList();
            
            // ì´ë¯¸ ì‹œë„í•œ ê´€ì¸¡ì†Œ ëª©ë¡
            List<String> triedStationIds = new ArrayList<>();
            triedStationIds.add(station.getExternalStationId());
            
            // ìµœëŒ€ 9ê°œ ë” ì‹œë„ (ì´ 10ê°œê¹Œì§€) ë˜ëŠ” í’í–¥/í’ì† ë°ì´í„°ë¥¼ ì°¾ì„ ë•Œê¹Œì§€
            int maxAttempts = Math.min(9, stationsWithLocation.size());
            for (int i = 0; i < maxAttempts; i++) {
                MarineStation nextStation = stationsWithLocation.get(i);
                
                if (triedStationIds.contains(nextStation.getExternalStationId())) {
                    continue;
                }
                
                double distance = DistanceCalculator.calculateDistance(
                        requestLat, requestLon,
                        nextStation.getLat(), nextStation.getLon());
                log.info("ë‹¤ìŒ ê°€ê¹Œìš´ KMA ê´€ì¸¡ì†Œ ì‹œë„ ({}/{}): stationId={}, name={}, distance={}km",
                        i + 2, maxAttempts + 1, nextStation.getExternalStationId(), nextStation.getName(), Math.round(distance * 10.0) / 10.0);
                
                EnvironmentSummaryResponse.Wave nextResult = fetchWaveDataFromStation(nextStation);
                triedStationIds.add(nextStation.getExternalStationId());
                
                // ë‹¤ìŒ ê´€ì¸¡ì†Œì—ì„œ í’í–¥/í’ì† ë°ì´í„°ë¥¼ ì–»ì—ˆìœ¼ë©´ ë³‘í•©
                if (nextResult.windDirectionDeg() != null || nextResult.windSpeedMs() != null) {
                    log.info("ê´€ì¸¡ì†Œì—ì„œ í’í–¥/í’ì† ë°ì´í„° íšë“: stationId={}, wd={}, ws={}",
                            nextStation.getExternalStationId(), nextResult.windDirectionDeg(), nextResult.windSpeedMs());
                    return EnvironmentSummaryResponse.Wave.builder()
                            .significantWaveHeight(significantWaveHeight) // ì²« ë²ˆì§¸ ê´€ì¸¡ì†Œì˜ íŒŒê³  ì‚¬ìš©
                            .windDirectionDeg(nextResult.windDirectionDeg())
                            .windSpeedMs(nextResult.windSpeedMs())
                            .build();
                } else {
                    log.warn("ê´€ì¸¡ì†Œì—ì„œ í’í–¥/í’ì† ë°ì´í„°ë¥¼ ì–»ì§€ ëª»í–ˆìŠµë‹ˆë‹¤: stationId={}", nextStation.getExternalStationId());
                }
            }
            
            log.warn("{}ê°œ ê´€ì¸¡ì†Œë¥¼ ëª¨ë‘ ì‹œë„í–ˆì§€ë§Œ í’í–¥/í’ì† ë°ì´í„°ë¥¼ ì–»ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.", maxAttempts + 1);
        }
        
        return result;
    }

    /**
     * íŠ¹ì • ê´€ì¸¡ì†Œì—ì„œ íŒŒê³ /í’í–¥/í’ì† ë°ì´í„° ì¡°íšŒ
     */
    private EnvironmentSummaryResponse.Wave fetchWaveDataFromStation(MarineStation station) {
        String stationId = station.getExternalStationId();
        log.info("íŒŒê³  ë°ì´í„° ì¡°íšŒ ì‹œì‘: stationId={}, name={}", stationId, station.getName());

        try {
            KmaSeaObsResponse.Item observation = kmaSeaObsClient
                    .fetchLatestObservation(stationId)
                    .block();

            if (observation == null) {
                log.warn("íŒŒê³  ë°ì´í„° ì¡°íšŒ ì‹¤íŒ¨: observationì´ nullì…ë‹ˆë‹¤. stationId={}", stationId);
                return EnvironmentSummaryResponse.Wave.builder().build();
            }

            log.info("íŒŒê³  ë°ì´í„° ì¡°íšŒ ì„±ê³µ: stationId={}, wh={}, wd={}, ws={}", 
                    stationId, observation.getWh(), observation.getWd(), observation.getWs());

            return EnvironmentSummaryResponse.Wave.builder()
                    .significantWaveHeight(observation.getWh())
                    .windDirectionDeg(observation.getWd())
                    .windSpeedMs(observation.getWs())
                    .build();
        } catch (Exception e) {
            log.error("íŒŒê³  ë°ì´í„° ì¡°íšŒ ì‹¤íŒ¨: stationId={}", stationId, e);
            return EnvironmentSummaryResponse.Wave.builder().build();
        }
    }

    /**
     * ì¡°ìœ„ ë°ì´í„° ì¡°íšŒ
     */
    private EnvironmentSummaryResponse.Tide fetchTideData(MarineStation station) {
        if (station == null) {
            return EnvironmentSummaryResponse.Tide.builder().build();
        }

        try {
            KhoaTideResponse.Item observation = khoaTideClient
                    .fetchLatestTideLevel(station.getExternalStationId())
                    .block();

            if (observation == null) {
                return EnvironmentSummaryResponse.Tide.builder().build();
            }

            // ê´€ì¸¡ì‹œê° íŒŒì‹± (yyyyMMddHHmm í˜•ì‹)
            ZonedDateTime observedAt = null;
            if (observation.getObsDt() != null && observation.getObsDt().length() >= 12) {
                try {
                    String dtStr = observation.getObsDt();
                    LocalDate date = LocalDate.parse(dtStr.substring(0, 8), DateTimeFormatter.ofPattern("yyyyMMdd"));
                    LocalTime time = LocalTime.parse(dtStr.substring(8, 12), DateTimeFormatter.ofPattern("HHmm"));
                    observedAt = ZonedDateTime.of(date, time, ZoneId.of("Asia/Seoul"));
                } catch (Exception e) {
                    log.warn("ì¡°ìœ„ ê´€ì¸¡ì‹œê° íŒŒì‹± ì‹¤íŒ¨: {}", observation.getObsDt(), e);
                }
            }

            return EnvironmentSummaryResponse.Tide.builder()
                    .tideLevelCm(observation.getTideLevel())
                    .tideObservedAt(observedAt)
                    .build();
        } catch (Exception e) {
            log.error("ì¡°ìœ„ ë°ì´í„° ì¡°íšŒ ì‹¤íŒ¨: stationId={}", station.getExternalStationId(), e);
            return EnvironmentSummaryResponse.Tide.builder().build();
        }
    }

    /**
     * ê´€ì¸¡ì†Œ ì •ë³´ ë¹Œë“œ
     */
    private EnvironmentSummaryResponse.StationInfo buildStationInfo(MarineStation station, double lat, double lon) {
        if (station == null) {
            return null;
        }

        // NIFS RISA ê´€ì¸¡ì†Œì˜ ê²½ìš° ì¢Œí‘œê°€ ì—†ìœ¼ë©´ (0.0, 0.0)ì´ë¯€ë¡œ, KHOA ì¡°ìœ„ê´€ì¸¡ì†Œ ì¢Œí‘œë¥¼ ì°¸ê³ í•˜ì—¬ ê±°ë¦¬ ê³„ì‚°
        double stationLat = station.getLat();
        double stationLon = station.getLon();
        
        if (station.getExternalSource() == StationSource.NIFS_RISA && 
            (stationLat == 0.0 || stationLon == 0.0)) {
            // ê°€ì¥ ê°€ê¹Œìš´ KHOA ì¡°ìœ„ê´€ì¸¡ì†Œ ì¢Œí‘œë¥¼ ì°¸ê³ í•˜ì—¬ ê±°ë¦¬ ê³„ì‚°
            List<MarineStation> khoaStations = marineStationRepository.findByExternalSourceAndIsActiveTrue(StationSource.KHOA_SURVEY_TIDE);
            List<MarineStation> khoaWithLocation = khoaStations.stream()
                    .filter(s -> s.getLat() != null && s.getLon() != null)
                    .filter(s -> s.getLat() != 0.0 && s.getLon() != 0.0)
                    .toList();

            if (!khoaWithLocation.isEmpty()) {
                MarineStation nearestKhoa = khoaWithLocation.stream()
                        .min(Comparator.comparingDouble(s ->
                                DistanceCalculator.calculateDistance(lat, lon, s.getLat(), s.getLon())))
                        .orElse(null);

                if (nearestKhoa != null) {
                    stationLat = nearestKhoa.getLat();
                    stationLon = nearestKhoa.getLon();
                }
            }
        }

        double distance = DistanceCalculator.calculateDistance(lat, lon, stationLat, stationLon);

        return EnvironmentSummaryResponse.StationInfo.builder()
                .id(station.getExternalStationId())
                .name(station.getName())
                .distanceKm(Math.round(distance * 10.0) / 10.0) // ì†Œìˆ˜ì  ì²«ì§¸ìë¦¬ê¹Œì§€
                .build();
    }
}



================================================================================
File Path: .\src\main\java\com\ocean\piuda\environment\util\DistanceCalculator.java
================================================================================

package com.ocean.piuda.environment.util;

/**
 * ê±°ë¦¬ ê³„ì‚° ìœ í‹¸ë¦¬í‹°
 * Haversine ê³µì‹ì„ ì‚¬ìš©í•˜ì—¬ ì§€êµ¬ìƒì˜ ë‘ ì§€ì  ê°„ ê±°ë¦¬ë¥¼ ê³„ì‚°
 */
public class DistanceCalculator {

    /**
     * ì§€êµ¬ ë°˜ê²½ (km)
     */
    private static final double EARTH_RADIUS_KM = 6371.0;

    /**
     * Haversine ê³µì‹ì„ ì‚¬ìš©í•˜ì—¬ ë‘ ì§€ì  ê°„ ê±°ë¦¬ ê³„ì‚° (km)
     *
     * @param lat1 ì²« ë²ˆì§¸ ì§€ì ì˜ ìœ„ë„
     * @param lon1 ì²« ë²ˆì§¸ ì§€ì ì˜ ê²½ë„
     * @param lat2 ë‘ ë²ˆì§¸ ì§€ì ì˜ ìœ„ë„
     * @param lon2 ë‘ ë²ˆì§¸ ì§€ì ì˜ ê²½ë„
     * @return ë‘ ì§€ì  ê°„ ê±°ë¦¬ (km)
     */
    public static double calculateDistance(double lat1, double lon1, double lat2, double lon2) {
        // ìœ„ë„ì™€ ê²½ë„ë¥¼ ë¼ë””ì•ˆìœ¼ë¡œ ë³€í™˜
        double lat1Rad = Math.toRadians(lat1);
        double lon1Rad = Math.toRadians(lon1);
        double lat2Rad = Math.toRadians(lat2);
        double lon2Rad = Math.toRadians(lon2);

        // ìœ„ë„ì™€ ê²½ë„ì˜ ì°¨ì´
        double deltaLat = lat2Rad - lat1Rad;
        double deltaLon = lon2Rad - lon1Rad;

        // Haversine ê³µì‹
        double a = Math.sin(deltaLat / 2) * Math.sin(deltaLat / 2)
                + Math.cos(lat1Rad) * Math.cos(lat2Rad)
                * Math.sin(deltaLon / 2) * Math.sin(deltaLon / 2);

        double c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

        // ê±°ë¦¬ ê³„ì‚°
        return EARTH_RADIUS_KM * c;
    }
}



================================================================================
File Path: .\src\main\java\com\ocean\piuda\garmin\controller\GarminActivityController.java
================================================================================

package com.ocean.piuda.garmin.controller;


import com.ocean.piuda.garmin.dto.request.ActivitySessionRequest;
import com.ocean.piuda.garmin.dto.request.GarminActivityPageRequest;
import com.ocean.piuda.garmin.dto.response.ActivitySessionResponse;
import com.ocean.piuda.garmin.service.GarminActivityCommandService;
import com.ocean.piuda.garmin.service.GarminActivityQueryService;
import com.ocean.piuda.garmin.util.WatchApiKeyValidator;
import com.ocean.piuda.global.api.dto.ApiData;
import com.ocean.piuda.global.api.dto.PageResponse;
import com.ocean.piuda.security.jwt.service.TokenUserService;
import io.swagger.v3.oas.annotations.Operation;
import io.swagger.v3.oas.annotations.security.SecurityRequirement;
import lombok.RequiredArgsConstructor;
import org.springframework.web.bind.annotation.*;

import jakarta.validation.Valid;

@RestController
@RequestMapping("/api/v1/activities")
@RequiredArgsConstructor
public class GarminActivityController {

    private final GarminActivityQueryService activityQueryService;
    private final GarminActivityCommandService activityCommandService;
    private final WatchApiKeyValidator apiKeyValidator;
    private final TokenUserService tokenUserService;

    @PostMapping
    @Operation(summary = "ì›Œì¹˜ í™œë™ ë¡œê·¸ ìˆ˜ì‹ ", description = "í™œë™ ë°ì´í„°ë¥¼ ì €ì¥í•˜ê³ , ì €ì¥ëœ ì „ì²´ êµ¬ì¡°(Session)ë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤.")
    public ApiData<ActivitySessionResponse> createActivityLog(
            @RequestHeader(value = "X-WATCH-API-KEY", required = false) String watchApiKey,
            @RequestBody ActivitySessionRequest request
    ) {
        apiKeyValidator.validate(watchApiKey);

        ActivitySessionResponse response = activityCommandService.createActivityLog(request);

        return ApiData.created(response);
    }

    @GetMapping("/{id}")
    @Operation(summary = "ë¡œê·¸ ID ê¸°ì¤€ ë‹¨ê±´ ì¡°íšŒ", description = "ì €ì¥ëœ í™œë™ ë¡œê·¸ ë‹¨ê±´ì„ ë¡œê·¸ ID ê¸°ì¤€ìœ¼ë¡œ ì¡°íšŒí•©ë‹ˆë‹¤.")
    public ApiData<ActivitySessionResponse> searchByLogId(
            @PathVariable Long id
    ) {
        return ApiData.ok(activityQueryService.searchByLogId(id));
    }

    @GetMapping("/session/{sessionId}")
    @Operation(summary = "ì„¸ì…˜ ID ê¸°ì¤€ ì¡°íšŒ", description = "sessionId ê¸°ì¤€ìœ¼ë¡œ í•œ ì„¸ì…˜ ì „ì²´ë¥¼ ì¡°íšŒí•©ë‹ˆë‹¤.")
    public ApiData<ActivitySessionResponse> searchBySessionId(
            @PathVariable String sessionId
    ) {
        return ApiData.ok(activityQueryService.searchBySessionId(sessionId));
    }

    @PostMapping("/my/sessions")
    @Operation(
            summary = "ë‚´ í™œë™ ì„¸ì…˜ ëª©ë¡ ì¡°íšŒ",
            description = "ë¡œê·¸ì¸í•œ ìœ ì € ê¸°ì¤€ìœ¼ë¡œ ì„¸ì…˜ ë‹¨ìœ„ í™œë™ ë¡œê·¸ë¥¼ í˜ì´ì§€ë„¤ì´ì…˜í•˜ì—¬ ì¡°íšŒí•©ë‹ˆë‹¤."
    )
    @SecurityRequirement(name = "bearerAuth")
    public ApiData<PageResponse<ActivitySessionResponse>> getMySessions(
            @RequestBody @Valid GarminActivityPageRequest req
    ) {
        Long userId = tokenUserService.getCurrentUser().getId();
        PageResponse<ActivitySessionResponse> res = activityQueryService.searchMySessions(userId, req);
        return ApiData.ok(res);
    }

    @PostMapping("/user/{userId}/sessions")
    @Operation(
            summary = "íŠ¹ì • ìœ ì €ì˜ í™œë™ ì„¸ì…˜ ëª©ë¡ ì¡°íšŒ",
            description = "ì§€ì •í•œ userId ê¸°ì¤€ìœ¼ë¡œ ì„¸ì…˜ ë‹¨ìœ„ í™œë™ ë¡œê·¸ë¥¼ í˜ì´ì§€ë„¤ì´ì…˜í•˜ì—¬ ì¡°íšŒí•©ë‹ˆë‹¤."
    )
    @SecurityRequirement(name = "bearerAuth")
    public ApiData<PageResponse<ActivitySessionResponse>> getUserSessions(
            @PathVariable Long userId,
            @RequestBody @Valid GarminActivityPageRequest req
    ) {
        PageResponse<ActivitySessionResponse> res = activityQueryService.searchMySessions(userId, req);
        return ApiData.ok(res);
    }




}



================================================================================
File Path: .\src\main\java\com\ocean\piuda\garmin\controller\WatchController.java
================================================================================

package com.ocean.piuda.garmin.controller;

import com.ocean.piuda.garmin.dto.request.WatchPairRequest;
import com.ocean.piuda.garmin.dto.response.WatchPairResponse;
import com.ocean.piuda.garmin.service.WatchPairingCommandService;
import com.ocean.piuda.garmin.service.WatchPairingQueryService;
import com.ocean.piuda.global.api.dto.ApiData;
import com.ocean.piuda.security.jwt.service.TokenUserService;
import io.swagger.v3.oas.annotations.Operation;
import io.swagger.v3.oas.annotations.tags.Tag;
import jakarta.validation.Valid;
import lombok.RequiredArgsConstructor;
import org.springframework.web.bind.annotation.*;


@RestController
@RequestMapping("/api/pair")
@RequiredArgsConstructor
@Tag(name = "Watch API", description = "ì‹œê³„ í˜ì–´ë§/ì—°ê²° í•´ì œ")
public class WatchController {

    private final TokenUserService tokenUserService;
    private final WatchPairingCommandService watchPairingService;
    private final WatchPairingQueryService watchPairingQueryService;

    @PostMapping("/my/watch")
    @Operation(summary = "ë‚´ ì›Œì¹˜ ë“±ë¡(í˜ì–´ë§)", description = "í˜„ì¬ ë¡œê·¸ì¸í•œ ìœ ì € ê³„ì •ì— ì›Œì¹˜ë¥¼ ì—°ê²°í•©ë‹ˆë‹¤.")
    public ApiData<Boolean> pairMyWatch(@RequestBody @Valid WatchPairRequest req) {
        Long userId = tokenUserService.getCurrentUser().getId();
        watchPairingService.pair(userId, req.deviceId());
        return ApiData.ok(true);
    }

    @DeleteMapping("/my/watch")
    @Operation(summary = "ë‚´ ì›Œì¹˜ ì—°ê²° í•´ì œ", description = "í˜„ì¬ ë¡œê·¸ì¸í•œ ìœ ì € ê³„ì •ì—ì„œ ì›Œì¹˜ë¥¼ í•´ì œí•©ë‹ˆë‹¤.")
    public ApiData<Boolean> unpairMyWatch() {
        Long userId = tokenUserService.getCurrentUser().getId();
        watchPairingService.unpair(userId);
        return ApiData.ok(true);
    }


    @GetMapping("/my/watch")
    @Operation(summary = "ë‚´ ì›Œì¹˜ ID ì¡°íšŒ", description = "í˜„ì¬ ë¡œê·¸ì¸í•œ ìœ ì € ê³„ì •ì— ì—°ê²°ëœ ì›Œì¹˜ IDë¥¼ ì¡°íšŒí•©ë‹ˆë‹¤.")
    public ApiData<WatchPairResponse> getMyWatch() {
        Long userId = tokenUserService.getCurrentUser().getId();
        WatchPairResponse res = watchPairingQueryService.getByUserId(userId);
        return ApiData.ok(res);
    }
}


================================================================================
File Path: .\src\main\java\com\ocean\piuda\garmin\dto\request\ActivitySessionRequest.java
================================================================================

package com.ocean.piuda.garmin.dto.request;

import com.fasterxml.jackson.annotation.JsonIgnoreProperties;
import com.fasterxml.jackson.annotation.JsonProperty;
import com.ocean.piuda.garmin.entity.GarminActivityLog;
import com.ocean.piuda.garmin.enums.GarminActivityType;
import com.ocean.piuda.global.api.exception.BusinessException;
import com.ocean.piuda.global.api.exception.ExceptionType;

import java.time.Instant;
import java.time.LocalDateTime;
import java.time.ZoneId;
import java.util.ArrayList;
import java.util.List;

@JsonIgnoreProperties(ignoreUnknown = true)
public record ActivitySessionRequest(
        Summary summary,
        List<ActivityItem> activities
) {
    @JsonIgnoreProperties(ignoreUnknown = true)
    public record Summary(
            @JsonProperty("userId")
            String deviceId,   // ì›Œì¹˜ì—ì„œ ì˜¨ ì•”í˜¸í™”ëœ deviceId
            Long startTime,
            Long endTime,
            Double startLat,
            Double startLon,
            Double endLat,
            Double endLon
    ) {}

    @JsonIgnoreProperties(ignoreUnknown = true)
    public record ActivityItem(
            String activityType, // "URCHIN_REMOVAL" | "SEAWEED_TRANSPLANT" | "OTHER_ACTIVITY"
            String gridId,
            Integer totalCount,
            @JsonProperty("work_logs")
            List<List<Object>> workLogs  // JSONì˜ "work_logs" [[time, depth, temp, ...], ...]
    ) {}

    /**
     * ì„œë¹„ìŠ¤ ë ˆì´ì–´ì—ì„œ ìƒì„±ëœ sessionId, ìµœì¢… userIdë¥¼ ë°›ì•„
     * ìš”ì²­ì„ ì—”í‹°í‹° ë¦¬ìŠ¤íŠ¸ë¡œ ë³€í™˜.
     */
    public List<GarminActivityLog> toEntities(Long userId, String sessionId) {
        // activities == nullë§Œ ë§‰ê³  ìˆê³ , [](ë¹ˆ ë¦¬ìŠ¤íŠ¸)ëŠ” í—ˆìš©í•œë‹¤.
        if (summary == null || activities == null) {
            throw new BusinessException(ExceptionType.INVALID_PAYLOAD);
        }

        Summary s = summary;

        LocalDateTime startDt = toLocalDateTime(s.startTime());
        LocalDateTime endDt   = toLocalDateTime(s.endTime());
        String deviceId       = s.deviceId(); // ì›Œì¹˜ê°€ ë³´ë‚¸ ì•”í˜¸í™”ëœ deviceId

        List<GarminActivityLog> logs = new ArrayList<>();

        for (ActivityItem item : activities) {
            GarminActivityType type;
            try {
                type = GarminActivityType.valueOf(item.activityType());
            } catch (Exception e) {
                type = GarminActivityType.OTHER_ACTIVITY;
            }

            GarminActivityLog log = GarminActivityLog.builder()
                    .sessionId(sessionId)
                    .userId(userId)
                    .deviceId(deviceId)
                    .garminActivityType(type)
                    .gridId(item.gridId())
                    .totalCount(item.totalCount())
                    .workLogs(item.workLogs())
                    .startTime(startDt)
                    .endTime(endDt)
                    .startLat(s.startLat())
                    .startLon(s.startLon())
                    .endLat(s.endLat())
                    .endLon(s.endLon())
                    .build();

            logs.add(log);
        }

        return logs;
    }

    private static LocalDateTime toLocalDateTime(Long epochSeconds) {
        if (epochSeconds == null) return null;
        return LocalDateTime.ofInstant(Instant.ofEpochSecond(epochSeconds), ZoneId.of("Asia/Seoul"));
    }
}


================================================================================
File Path: .\src\main\java\com\ocean\piuda\garmin\dto\request\GarminActivityPageRequest.java
================================================================================

package com.ocean.piuda.garmin.dto.request;

import com.ocean.piuda.garmin.enums.GarminActivitySort;
import com.ocean.piuda.global.api.dto.PageRequest;
import jakarta.validation.constraints.NotNull;
import lombok.Getter;
import lombok.Setter;

@Getter
@Setter
public class GarminActivityPageRequest extends PageRequest<GarminActivitySort> {

    public GarminActivityPageRequest() {
        // ê¸°ë³¸ ì •ë ¬ê°’ ì§€ì • (ì˜ˆ: ìµœì‹  ìˆœ)
        setSort(GarminActivitySort.START_TIME_DESC);
    }

    @Override
    @NotNull
    public GarminActivitySort getSort() {
        return super.getSort();
    }
}


================================================================================
File Path: .\src\main\java\com\ocean\piuda\garmin\dto\request\WatchPairRequest.java
================================================================================

package com.ocean.piuda.garmin.dto.request;

import jakarta.validation.constraints.NotBlank;

public record WatchPairRequest(
        @NotBlank
        String deviceId   // ì›Œì¹˜ì—ì„œ ë³´ì—¬ì¤€ ì•”í˜¸í™”ëœ deviceId (ë˜ëŠ” short IDë¥¼ ì„œë²„ì—ì„œ í’€ì–´ì“´ ê°’)
) {}


================================================================================
File Path: .\src\main\java\com\ocean\piuda\garmin\dto\response\ActivitySessionResponse.java
================================================================================

package com.ocean.piuda.garmin.dto.response;

import com.fasterxml.jackson.annotation.JsonProperty;
import com.ocean.piuda.garmin.entity.GarminActivityLog;
import com.ocean.piuda.garmin.enums.GarminActivityType;

import java.util.List;
import java.util.stream.Collectors;

import static com.ocean.piuda.garmin.util.GarminUtils.*;

public record ActivitySessionResponse(
        Summary summary,
        List<ActivityItem> activities
) {
    public static ActivitySessionResponse fromEntities(List<GarminActivityLog> logs) {

        if (logs == null || logs.isEmpty()) {
            return new ActivitySessionResponse(null, List.of());
        }

        GarminActivityLog first = logs.get(0);

        // ì„¸ì…˜ ì „ì²´ work_logs(flatten) ëª¨ìœ¼ê¸°
        List<List<Object>> allRows = logs.stream()
                .filter(log -> log.getWorkLogs() != null)
                .flatMap(log -> log.getWorkLogs().stream())
                .toList();

        // í‰ê·  ìˆ˜ì‹¬/ìˆ˜ì˜¨ ê³„ì‚° (ì—†ìœ¼ë©´ null)
        Double avgDepth = computeAverageDepth(allRows);
        Double avgTemperature = computeAverageTemperature(allRows);

        Summary summary = Summary.from(first, avgDepth, avgTemperature);
        List<ActivityItem> items = logs.stream()
                .map(ActivityItem::fromEntity)
                .collect(Collectors.toList());

        return new ActivitySessionResponse(summary, items);
    }

    public record Summary(
            String sessionId,    // ì„¸ì…˜ ID
            String userId,       // deviceId (ì›Œì¹˜ ì•”í˜¸í™” ID)
            String startTime,    // ISO ë¬¸ìì—´ (ì˜ˆ: 2025-11-27T21:01:23)
            String endTime,      // ISO ë¬¸ìì—´
            Double startLat,
            Double startLon,
            Double endLat,
            Double endLon,
            Double avgDepth,         // work_logs ê¸°ë°˜ í‰ê·  ìˆ˜ì‹¬
            Double avgTemperature    // work_logs ê¸°ë°˜ í‰ê·  ìˆ˜ì˜¨
    ) {
        public static Summary from(GarminActivityLog log,
                                   Double avgDepth,
                                   Double avgTemperature) {

            return new Summary(
                    log.getSessionId(),
                    log.getDeviceId(),
                    toIsoString(log.getStartTime()),
                    toIsoString(log.getEndTime()),
                    log.getStartLat(),
                    log.getStartLon(),
                    log.getEndLat(),
                    log.getEndLon(),
                    avgDepth,
                    avgTemperature
            );
        }
    }

    public record ActivityItem(
            Long id,
            GarminActivityType activityType,
            String gridId,
            Integer totalCount,

            @JsonProperty("work_logs")
            List<List<Object>> workLogs
    ) {
        public static ActivityItem fromEntity(GarminActivityLog log) {
            return new ActivityItem(
                    log.getId(),
                    log.getGarminActivityType(),
                    log.getGridId(),
                    log.getTotalCount(),
                    mapWorkLogsEpochToIso(log.getWorkLogs())
            );
        }
    }

}


================================================================================
File Path: .\src\main\java\com\ocean\piuda\garmin\dto\response\WatchPairResponse.java
================================================================================

package com.ocean.piuda.garmin.dto.response;


public record WatchPairResponse(
        String deviceId,   // ì›Œì¹˜ì—ì„œ ë³´ì—¬ì¤€ ì•”í˜¸í™”ëœ deviceId (ë˜ëŠ” short IDë¥¼ ì„œë²„ì—ì„œ í’€ì–´ì“´ ê°’)
        Long userId
) {}


================================================================================
File Path: .\src\main\java\com\ocean\piuda\garmin\entity\GarminActivityLog.java
================================================================================

package com.ocean.piuda.garmin.entity;

import com.ocean.piuda.garmin.enums.GarminActivityType;
import com.ocean.piuda.global.api.domain.BaseEntity;
import jakarta.persistence.*;
import lombok.*;
import org.hibernate.annotations.JdbcTypeCode;
import org.hibernate.type.SqlTypes;

import java.time.LocalDateTime;
import java.util.List;

@Entity
@Table(name = "activity_logs")
@Getter
@NoArgsConstructor(access = AccessLevel.PROTECTED)
@AllArgsConstructor
@Builder
public class GarminActivityLog extends BaseEntity {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    /** í•œ ë²ˆì˜ ì„¸ì…˜ ìš”ì²­ ë‹¨ìœ„ ì‹ë³„ì */
    @Column(name = "session_id", length = 64)
    private String sessionId;

    /** ë¡œê·¸ì¸ ì‚¬ìš©ì(ì›¹/ì•± ì—°ë™ ì‹œ). ì›Œì¹˜ ë‹¨ë…ì´ë©´ null ê°€ëŠ¥ */
    @Column(name = "user_id")
    private Long userId;

    /** ì›Œì¹˜ ê¸°ê¸° ê³ ìœ  ID (String, ì•”í˜¸í™”/í•´ì‹œëœ ê°’) */
    @Column(name = "device_id", length = 100)
    private String deviceId;

    @Enumerated(EnumType.STRING)
    @Column(nullable = false, length = 50)
    private GarminActivityType garminActivityType;

    @Column(length = 20)
    private String gridId;

    private LocalDateTime startTime;
    private LocalDateTime endTime;

    private Integer totalCount;

    // ìœ„ì¹˜ ì •ë³´ (GPS) - ì„¸ì…˜ ë‹¨ìœ„ ì •ë³´ë¥¼ ê° í™œë™ ë¡œê·¸ì— ë³µì‚¬í•´ì„œ ì €ì¥
    private Double startLat;
    private Double startLon;
    private Double endLat;
    private Double endLon;

    /** DB: jsonb, Java: List<List<Object>> */
    @JdbcTypeCode(SqlTypes.JSON)
    @Column(columnDefinition = "jsonb")
    private List<List<Object>> workLogs;
}


================================================================================
File Path: .\src\main\java\com\ocean\piuda\garmin\enums\GarminActivitySort.java
================================================================================

package com.ocean.piuda.garmin.enums;

import com.ocean.piuda.global.enums.SortEnum;
import org.springframework.data.domain.Sort;

public enum GarminActivitySort implements SortEnum {

    START_TIME_DESC,
    START_TIME_ASC;

    @Override
    public Sort toSort() {
        return switch (this) {
            case START_TIME_DESC -> Sort.by(Sort.Direction.DESC, "startTime", "id");
            case START_TIME_ASC  -> Sort.by(Sort.Direction.ASC, "startTime", "id");
        };
    }
}


================================================================================
File Path: .\src\main\java\com\ocean\piuda\garmin\enums\GarminActivityType.java
================================================================================

package com.ocean.piuda.garmin.enums;

public enum GarminActivityType {
    URCHIN_REMOVAL,      // ì„±ê²Œ ì œê±°
    SEAWEED_TRANSPLANT,   // í•´ì¡°ë¥˜ ì´ì‹
    OTHER_ACTIVITY       // ê¸°íƒ€ í™œë™
}


================================================================================
File Path: .\src\main\java\com\ocean\piuda\garmin\enums\TransplantStatus.java
================================================================================

package com.ocean.piuda.garmin.enums;

public enum TransplantStatus {
    NEW, GOOD, FAIR, POOR, DEAD, LOST
}


================================================================================
File Path: .\src\main\java\com\ocean\piuda\garmin\repository\GarminActivityLogRepository.java
================================================================================

package com.ocean.piuda.garmin.repository;

import com.ocean.piuda.garmin.entity.GarminActivityLog;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.stereotype.Repository;

import java.time.LocalDateTime;
import java.util.List;

import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;

@Repository
public interface GarminActivityLogRepository extends JpaRepository<GarminActivityLog, Long> {

    // ê°™ì€ ê¸°ê¸° + ê°™ì€ ì‹œì‘ ì‹œê°„ ê¸°ì¤€ íƒìƒ‰
    List<GarminActivityLog> findAllByDeviceIdAndStartTime(String deviceId, LocalDateTime startTime);

    // sessionId ê¸°ì¤€ìœ¼ë¡œ ì„¸ì…˜ ì „ì²´ ì¡°íšŒ
    List<GarminActivityLog> findAllBySessionId(String sessionId);


    @Query("""
        SELECT l
        FROM GarminActivityLog l
        WHERE l.userId = :userId
          AND l.sessionId IS NOT NULL
          AND l.id = (
              SELECT MIN(l2.id)
              FROM GarminActivityLog l2
              WHERE l2.userId = :userId
                AND l2.sessionId = l.sessionId
          )
        """)
    Page<GarminActivityLog> findSessionHeadsByUserId(@Param("userId") Long userId,
                                                     Pageable pageable);


}


================================================================================
File Path: .\src\main\java\com\ocean\piuda\garmin\service\GarminActivityCommandService.java
================================================================================

package com.ocean.piuda.garmin.service;

import com.ocean.piuda.garmin.dto.request.ActivitySessionRequest;
import com.ocean.piuda.garmin.dto.response.ActivitySessionResponse;
import com.ocean.piuda.garmin.entity.GarminActivityLog;
import com.ocean.piuda.garmin.repository.GarminActivityLogRepository;
import com.ocean.piuda.global.api.exception.BusinessException;
import com.ocean.piuda.global.api.exception.ExceptionType;
import com.ocean.piuda.user.entity.User;
import com.ocean.piuda.user.repository.UserRepository;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.nio.charset.StandardCharsets;
import java.util.List;
import java.util.UUID;

@Service
@RequiredArgsConstructor
@Transactional
public class GarminActivityCommandService {

    private final GarminActivityLogRepository repository;
    private final UserRepository userRepository;

    /**
     * ì›Œì¹˜ í™œë™ ìˆ˜ì‹ 
     * - í•œ ì›Œì¹˜ë‹¹ í•œ ìœ ì €ì—ë§Œ í˜ì–´ë§
     * - í˜ì–´ë§ë˜ì§€ ì•Šì€ ì›Œì¹˜ì˜ ìš”ì²­ì€ ê±°ì ˆ(WATCH_NOT_PAIRED)
     */
    public ActivitySessionResponse createActivityLog(ActivitySessionRequest request) {
        if (request == null || request.summary() == null) {
            throw new BusinessException(ExceptionType.INVALID_PAYLOAD);
        }

        String deviceId = request.summary().deviceId();  // ì›Œì¹˜ì—ì„œ ì˜¨ ì•”í˜¸í™”ëœ deviceId
        if (deviceId == null || deviceId.isBlank()) {
            throw new BusinessException(ExceptionType.INVALID_PAYLOAD);
        }

        // ì´ deviceIdê°€ ì–´ë–¤ ìœ ì €ì— í˜ì–´ë§ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
        User pairedUser = userRepository.findByWatchDeviceId(deviceId)
                .orElseThrow(() -> new BusinessException(ExceptionType.WATCH_NOT_PAIRED));

        Long pairedUserId = pairedUser.getId();

        // sessionId ìƒì„± (deviceId + startTime ê¸°ì¤€ deterministic)
        Long startTimeEpoch = request.summary().startTime();
        String sessionId = generateSessionId(deviceId, startTimeEpoch);

        // DTO â†’ ì—”í‹°í‹° ë³€í™˜
        List<GarminActivityLog> entities = request.toEntities(pairedUserId, sessionId);
        if (entities.isEmpty()) {
            throw new BusinessException(ExceptionType.INVALID_PAYLOAD); // or custom
        }
        List<GarminActivityLog> savedLogs = repository.saveAll(entities);

        return ActivitySessionResponse.fromEntities(savedLogs);
    }

    private String generateSessionId(String deviceId, Long startTimeEpochSec) {
        if (deviceId == null || startTimeEpochSec == null) {
            return UUID.randomUUID().toString();
        }
        String raw = deviceId + ":" + startTimeEpochSec;
        return UUID.nameUUIDFromBytes(raw.getBytes(StandardCharsets.UTF_8)).toString();
    }
}


================================================================================
File Path: .\src\main\java\com\ocean\piuda\garmin\service\GarminActivityQueryService.java
================================================================================

package com.ocean.piuda.garmin.service;


import com.ocean.piuda.garmin.dto.request.GarminActivityPageRequest;
import com.ocean.piuda.garmin.dto.response.ActivitySessionResponse;
import com.ocean.piuda.garmin.entity.GarminActivityLog;
import com.ocean.piuda.garmin.repository.GarminActivityLogRepository;
import com.ocean.piuda.global.api.dto.PageResponse;
import com.ocean.piuda.global.api.exception.BusinessException;
import com.ocean.piuda.global.api.exception.ExceptionType;
import lombok.RequiredArgsConstructor;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.PageImpl;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;
import java.util.List;

@Service
@RequiredArgsConstructor
@Transactional(readOnly = true)
public class GarminActivityQueryService {

    private final GarminActivityLogRepository repository;

    public ActivitySessionResponse searchByLogId(Long id) {
        GarminActivityLog referenceLog = repository.findById(id)
                .orElseThrow(() -> new BusinessException(ExceptionType.RESOURCE_NOT_FOUND));

        List<GarminActivityLog> sessionLogs;
        sessionLogs = repository.findAllBySessionId(referenceLog.getSessionId());

        return ActivitySessionResponse.fromEntities(sessionLogs);
    }

    /**
     * ë¡œê·¸ì¸ ìœ ì € ê¸°ì¤€ ì„¸ì…˜ ë‹¨ìœ„ ëª©ë¡ ì¡°íšŒ (í˜ì´ì§€ë„¤ì´ì…˜)
     */
    public PageResponse<ActivitySessionResponse> searchMySessions(Long userId, GarminActivityPageRequest req) {
        var pageable = req.toPageable();

        // ì„¸ì…˜ë‹¹ ëŒ€í‘œ ë¡œê·¸ë“¤ë§Œ í˜ì´ì§€ë„¤ì´ì…˜ ì¡°íšŒ
        Page<GarminActivityLog> headPage = repository.findSessionHeadsByUserId(userId, pageable);

        // ê° ëŒ€í‘œ ë¡œê·¸ì˜ sessionId ê¸°ì¤€ìœ¼ë¡œ ì„¸ì…˜ ì „ì²´ë¥¼ ë‹¤ì‹œ ì¡°íšŒ â†’ ì„¸ì…˜ ë‹¨ìœ„ ì‘ë‹µìœ¼ë¡œ ë³€í™˜
        List<ActivitySessionResponse> content = headPage.getContent().stream()
                .map(head -> {
                    List<GarminActivityLog> sessionLogs = repository.findAllBySessionId(head.getSessionId());
                    return ActivitySessionResponse.fromEntities(sessionLogs);
                })
                .toList();

        // PageResponse.ofë¥¼ ì“°ê¸° ìœ„í•´ Page<T> í˜•íƒœë¡œ í•œë²ˆ ë˜í•‘
        Page<ActivitySessionResponse> mapped = new PageImpl<>(
                content,
                pageable,
                headPage.getTotalElements()
        );

        return PageResponse.of(mapped);
    }

    /**
     * sessionId(String) ê¸°ì¤€ ì„¸ì…˜ ì¡°íšŒ
     */
    public ActivitySessionResponse searchBySessionId(String sessionId) {
        if (sessionId == null || sessionId.isBlank()) {
            throw new BusinessException(ExceptionType.INVALID_PAYLOAD);
        }

        List<GarminActivityLog> sessionLogs = repository.findAllBySessionId(sessionId);

        if (sessionLogs == null || sessionLogs.isEmpty()) {
            throw new BusinessException(ExceptionType.RESOURCE_NOT_FOUND);
        }

        return ActivitySessionResponse.fromEntities(sessionLogs);
    }


}


================================================================================
File Path: .\src\main\java\com\ocean\piuda\garmin\service\WatchPairingCommandService.java
================================================================================

package com.ocean.piuda.garmin.service;


import com.ocean.piuda.global.api.exception.BusinessException;
import com.ocean.piuda.global.api.exception.ExceptionType;
import com.ocean.piuda.user.entity.User;
import com.ocean.piuda.user.repository.UserRepository;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

@Service
@RequiredArgsConstructor
@Transactional
public class WatchPairingCommandService {

    private final UserRepository userRepository;

    /**
     * í•œ ìœ ì €ë‹¹ ìµœëŒ€ 1 ì›Œì¹˜.
     * - ë™ì¼ ìœ ì €ê°€ ë‹¤ì‹œ ê°™ì€ ì›Œì¹˜ë¥¼ ë“±ë¡í•˜ë©´ no-op (idempotent)
     * - ê°™ì€ ìœ ì €ê°€ ë‹¤ë¥¸ ì›Œì¹˜ë¥¼ ë“±ë¡í•˜ë©´ ê¸°ì¡´ ì›Œì¹˜ì—ì„œ êµì²´ (upsert)
     * - ì´ë¯¸ ë‹¤ë¥¸ ìœ ì €ì— ë¬¶ì¸ ì›Œì¹˜ëŠ” ê±°ì ˆ.
     */
    public void pair(Long userId, String deviceId) {
        if (deviceId == null || deviceId.isBlank()) {
            throw new BusinessException(ExceptionType.INVALID_PAYLOAD);
        }

        User user = userRepository.findById(userId)
                .orElseThrow(() -> new BusinessException(ExceptionType.USER_NOT_FOUND));

        // ì´ deviceIdë¥¼ ì´ë¯¸ ì“°ê³  ìˆëŠ” "ë‹¤ë¥¸ ìœ ì €"ê°€ ìˆëŠ”ì§€ í™•ì¸
        userRepository.findByWatchDeviceId(deviceId)
                .filter(other -> !other.getId().equals(userId))
                .ifPresent(other -> {
                    // ë‹¤ë¥¸ ê³„ì •ì— ì´ë¯¸ ë¬¶ì¸ ì›Œì¹˜ â†’ í›”ì³ì˜¤ì§€ ëª»í•˜ê²Œ ì°¨ë‹¨
                    throw new BusinessException(ExceptionType.WATCH_ALREADY_PAIRED);
                });

        user.pairWatch(deviceId);
    }

    public void unpair(Long userId) {
        User user = userRepository.findById(userId)
                .orElseThrow(() -> new BusinessException(ExceptionType.USER_NOT_FOUND));
        user.unpairWatch();
    }
}


================================================================================
File Path: .\src\main\java\com\ocean\piuda\garmin\service\WatchPairingQueryService.java
================================================================================

package com.ocean.piuda.garmin.service;


import com.ocean.piuda.garmin.dto.response.WatchPairResponse;
import com.ocean.piuda.global.api.exception.BusinessException;
import com.ocean.piuda.global.api.exception.ExceptionType;
import com.ocean.piuda.user.entity.User;
import com.ocean.piuda.user.repository.UserRepository;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

@Service
@RequiredArgsConstructor
@Transactional(readOnly = true)
public class WatchPairingQueryService {

    private final UserRepository userRepository;

    /**
     * í˜„ì¬ ìœ ì €ì— í˜ì–´ë§ëœ ì›Œì¹˜ ID ì¡°íšŒ
     * - í˜ì–´ë§ ì•ˆ ë˜ì–´ ìˆìœ¼ë©´ null ë°˜í™˜
     */
    public WatchPairResponse getByUserId(Long userId) {
        User user = userRepository.findById(userId)
                .orElseThrow(() -> new BusinessException(ExceptionType.USER_NOT_FOUND));

        return new WatchPairResponse(user.getWatchDeviceId(), userId);   // í˜ì–´ë§ ì—†ìœ¼ë©´ null
    }
}


================================================================================
File Path: .\src\main\java\com\ocean\piuda\garmin\util\GarminUtils.java
================================================================================

package com.ocean.piuda.garmin.util;

import com.ocean.piuda.global.api.exception.BusinessException;
import com.ocean.piuda.global.api.exception.ExceptionType;

import java.time.Instant;
import java.time.LocalDateTime;
import java.time.ZoneId;
import java.util.ArrayList;
import java.util.List;

public final class GarminUtils {

    private static final ZoneId ZONE_SEOUL = ZoneId.of("Asia/Seoul");

    private GarminUtils() {
    }

    public static String toIsoString(LocalDateTime dt) {
        return dt == null ? null : dt.toString();
    }

    public static Long toEpoch(LocalDateTime dt) {
        if (dt == null) return null;
        return dt.atZone(ZONE_SEOUL).toEpochSecond();
    }

    public static LocalDateTime epochToLocalDateTime(Long epochSeconds) {
        if (epochSeconds == null) return null;
        return LocalDateTime.ofInstant(Instant.ofEpochSecond(epochSeconds), ZONE_SEOUL);
    }

    public static Long toLong(Object o) {
        if (o instanceof Number n) return n.longValue();
        if (o instanceof String s) return Long.parseLong(s);
        throw new BusinessException(ExceptionType.INVALID_PAYLOAD);
    }

    private static Double toDouble(Object o) {
        if (o instanceof Number n) return n.doubleValue();
        if (o instanceof String s) return Double.parseDouble(s);
        throw new BusinessException(ExceptionType.INVALID_PAYLOAD);
    }

    /**
     * work_logs: ì²« ë²ˆì§¸ ì»¬ëŸ¼(epoch) â†’ ISO ë¬¸ìì—´ë¡œ ë³€í™˜
     */
    public static List<List<Object>> mapWorkLogsEpochToIso(List<List<Object>> raw) {
        if (raw == null || raw.isEmpty()) return List.of();

        return raw.stream()
                .map(row -> {
                    if (row == null || row.isEmpty() || row.get(0) == null) return row;

                    Object first = row.get(0);
                    Long epoch = toLong(first);
                    LocalDateTime ldt = epochToLocalDateTime(epoch);

                    var copy = new ArrayList<>(row);
                    copy.set(0, ldt.toString());
                    return copy;
                })
                .toList();
    }

    /**
     * work_logsì—ì„œ íŠ¹ì • ì¸ë±ìŠ¤(ìˆ˜ì‹¬/ìˆ˜ì˜¨)ì˜ í‰ê· ê°’ ê³„ì‚°
     * - row = [ì‹œê°„, ìˆ˜ì‹¬, ìˆ˜ì˜¨, ...] êµ¬ì¡°ë¥¼ ê°€ì •
     * - ìœ íš¨í•œ ìˆ«ì ê°’ì´ í•˜ë‚˜ë„ ì—†ìœ¼ë©´ null ë°˜í™˜
     */
    private static Double computeAverage(List<List<Object>> rows, int index) {
        if (rows == null || rows.isEmpty()) return null;

        double sum = 0.0;
        long count = 0L;

        for (List<Object> row : rows) {
            if (row == null || row.size() <= index) continue;
            Object val = row.get(index);
            if (val == null) continue;

            Double d = toDouble(val);
            sum += d;
            count++;
        }

        if (count == 0L) return null;
        return sum / count;
    }

    /**
     * í‰ê·  ìˆ˜ì‹¬ (index = 1)
     */
    public static Double computeAverageDepth(List<List<Object>> rows) {
        return computeAverage(rows, 1);
    }

    /**
     * í‰ê·  ìˆ˜ì˜¨ (index = 2)
     */
    public static Double computeAverageTemperature(List<List<Object>> rows) {
        return computeAverage(rows, 2);
    }
}


================================================================================
File Path: .\src\main\java\com\ocean\piuda\garmin\util\WatchApiKeyValidator.java
================================================================================

package com.ocean.piuda.garmin.util;


import com.ocean.piuda.global.api.exception.BusinessException;
import com.ocean.piuda.global.api.exception.ExceptionType; // WATCH_API_KEY_INVALID í•„ìš”
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Component;

@Slf4j
@Component
public class WatchApiKeyValidator {

    @Value("${ocean.watch.api-key:}")
    private String configuredKey;

    public void validate(String incomingKey) {
        if (incomingKey == null || !incomingKey.equals(configuredKey)) {
            log.warn("Suspicious Watch Access Attempt. Key: {}", incomingKey);
            throw new BusinessException(ExceptionType.WATCH_API_KEY_INVALID);
        }
    }
}


================================================================================
File Path: .\src\main\java\com\ocean\piuda\global\api\domain\BaseEntity.java
================================================================================

package com.ocean.piuda.global.api.domain;


import jakarta.persistence.Column;
import jakarta.persistence.EntityListeners;
import jakarta.persistence.MappedSuperclass;
import lombok.AccessLevel;
import lombok.Getter;
import lombok.NoArgsConstructor;
import lombok.experimental.SuperBuilder;
import org.springframework.data.annotation.CreatedDate;
import org.springframework.data.annotation.LastModifiedDate;
import org.springframework.data.jpa.domain.support.AuditingEntityListener;

import java.time.LocalDateTime;

@NoArgsConstructor(access = AccessLevel.PROTECTED)
@SuperBuilder(toBuilder = true)
@EntityListeners(AuditingEntityListener.class)
@MappedSuperclass
@Getter
public abstract class BaseEntity {

    @CreatedDate
    @Column(nullable = false, updatable = false)
    private LocalDateTime createdAt;

    @LastModifiedDate
    @Column(nullable = false)
    private LocalDateTime modifiedAt;
}


================================================================================
File Path: .\src\main\java\com\ocean\piuda\global\api\dto\ApiData.java
================================================================================

package com.ocean.piuda.global.api.dto;

import com.fasterxml.jackson.annotation.JsonIgnore;
import com.fasterxml.jackson.annotation.JsonInclude;
import com.fasterxml.jackson.databind.annotation.JsonSerialize;
import com.ocean.piuda.global.api.exception.ExceptionType;
import lombok.Builder;
import lombok.Getter;
import lombok.ToString;
import org.springframework.http.HttpStatus;
import org.springframework.http.MediaType;

import java.util.ArrayList;
import java.util.List;
import java.util.Map;


/**
 * ApiData ëŠ” JSON ì²˜ë¦¬ ì „ìš©
 * ê¸°íƒ€ CSV ë‚˜ íŒŒì¼ì€ ì»¨íŠ¸ë¡¤ëŸ¬ì—ì„œ byte[] ë¡œ ì§ì ‘ ë°˜í™˜ ì²˜ë¦¬
 */
@JsonSerialize
@JsonInclude(JsonInclude.Include.NON_NULL)
@Builder
@Getter
@ToString
public class ApiData<T> {

  private static final String SUCCESS_CODE = "0";
  private static final String SUCCESS_MESSAGE = "ìš”ì²­ì— ì„±ê³µí–ˆìŠµë‹ˆë‹¤.";


  @JsonIgnore
  private HttpStatus httpStatus;

  @JsonIgnore
  private final List<ApiHeader> headers = new ArrayList<>();

  @JsonIgnore
  private MediaType contentType;

  private boolean success;
  private T data;
  private Map<String, ?> errors;
  private String code;
  private Object message;


  public static <T> ApiData<T> ok(T data) {
    return ApiData.<T>builder()
        .httpStatus(HttpStatus.OK)
        .success(true)
        .data(data)
        .contentType(MediaType.APPLICATION_JSON)
        .code(SUCCESS_CODE)
        .message(SUCCESS_MESSAGE)
        .build();
  }

  public static <T> ApiData<T> created(T data) {
    return ApiData.<T>builder()
        .httpStatus(HttpStatus.CREATED)
        .success(true)
        .data(data)
        .contentType(MediaType.APPLICATION_JSON)
        .code(SUCCESS_CODE)
        .message(SUCCESS_MESSAGE)
        .build();
  }

  public static ApiData<Void> noContent() {
        return ApiData.<Void>builder()
            .httpStatus(HttpStatus.NO_CONTENT)
            .success(true)
            .data(null)
            .contentType(MediaType.APPLICATION_JSON)
            .code(SUCCESS_CODE)
            .message(SUCCESS_MESSAGE)
            .build();
    }


  public static <T> ApiData<T> from(HttpStatus httpStatus, T data) {
    return ApiData.<T>builder()
        .httpStatus(httpStatus)
        .success(true)
        .data(data)
        .contentType(MediaType.APPLICATION_JSON)
        .code(SUCCESS_CODE)
        .message(SUCCESS_MESSAGE)
        .build();
  }

  public static ApiData<Void> error(ExceptionType exceptionType) {
    return ApiData.error(exceptionType,Map.of());
  }

  public static ApiData<Void> error(ExceptionType exceptionType,Map<String, ?> details) {

    return ApiData.<Void>builder()
            .contentType(MediaType.APPLICATION_JSON)
            .success(false)
            .code(exceptionType.getCode())
            .message(exceptionType.getMessage())
            .httpStatus(exceptionType.getStatus())
            .data(null)                // ì‹¤íŒ¨ëŠ” data ë¹„ì›€
            .errors(details == null ? Map.of() : details)
            .build();

  }



}


================================================================================
File Path: .\src\main\java\com\ocean\piuda\global\api\dto\ApiDataAdvice.java
================================================================================

package com.ocean.piuda.global.api.dto;

import com.ocean.piuda.global.api.exception.BusinessException;
import com.ocean.piuda.global.api.exception.ExceptionType;
import org.springframework.core.MethodParameter;
import org.springframework.http.HttpHeaders;
import org.springframework.http.MediaType;
import org.springframework.http.converter.HttpMessageConverter;
import org.springframework.http.server.ServerHttpRequest;
import org.springframework.http.server.ServerHttpResponse;
import org.springframework.web.bind.annotation.RestControllerAdvice;
import org.springframework.web.servlet.mvc.method.annotation.ResponseBodyAdvice;

@RestControllerAdvice
public class ApiDataAdvice implements ResponseBodyAdvice<Object> {

  @Override
  public boolean supports(MethodParameter returnType,
      Class<? extends HttpMessageConverter<?>> converterType) {
    return ApiData.class.isAssignableFrom(returnType.getParameterType());
  }

  @Override
  public Object beforeBodyWrite(Object body,
      MethodParameter returnType,
      MediaType selectedContentType,
      Class<? extends HttpMessageConverter<?>> selectedConverterType,
      ServerHttpRequest request,
      ServerHttpResponse response) {

    if (!(body instanceof ApiData<?> apiResult)) return body;

    response.setStatusCode(apiResult.getHttpStatus());
    response.getHeaders().addAll(buildHeaders(apiResult));

    if (apiResult.getContentType() != null &&
            apiResult.getContentType().isCompatibleWith(MediaType.APPLICATION_JSON))  return apiResult;

    throw new BusinessException(ExceptionType.MEDIA_TYPE_MISMATCHED);

  }

  private HttpHeaders buildHeaders(ApiData<?> apiResult) {
    HttpHeaders headers = new HttpHeaders();
    headers.setContentType(apiResult.getContentType());
    apiResult.getHeaders().forEach(header -> headers.add(header.name(), header.value()));

    return headers;
  }
}


================================================================================
File Path: .\src\main\java\com\ocean\piuda\global\api\dto\ApiHeader.java
================================================================================

package com.ocean.piuda.global.api.dto;

public record ApiHeader(
    String name,
    String value
) {

  public static ApiHeader of(String name, String value) {
    return new ApiHeader(name, value);
  }
}


================================================================================
File Path: .\src\main\java\com\ocean\piuda\global\api\dto\PageRequest.java
================================================================================

package com.ocean.piuda.global.api.dto;

import com.ocean.piuda.global.enums.SortEnum;
import jakarta.validation.constraints.Min;
import jakarta.validation.constraints.NotNull;
import lombok.Data;
import org.springframework.data.domain.Pageable;
import org.springframework.data.domain.Sort;

@Data
public class PageRequest<T extends Enum<T> & SortEnum> {
    
    @Min(value = 1, message = "í˜ì´ì§€ëŠ” 1ë¶€í„° ì‹œì‘í•©ë‹ˆë‹¤.")
    private int page = 1;
    
    @Min(value = 1, message = "ì‚¬ì´ì¦ˆëŠ” 1 ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.")
    private int size = 10;
    
    @NotNull
    private T sort;
    
    public PageRequest() {}
    
    public PageRequest(int page, int size, T sort) {
        this.page = page;
        this.size = size;
        this.sort = sort;
    }
    
    public Pageable toPageable() {
        // 1-based pageë¥¼ 0-basedë¡œ ë³€í™˜
        Sort springSort = sort.toSort();
        return org.springframework.data.domain.PageRequest.of(page - 1, size, springSort);
    }

    public Pageable toPageableWithoutSort() {
        return org.springframework.data.domain.PageRequest.of(page - 1, size);
    }
}


================================================================================
File Path: .\src\main\java\com\ocean\piuda\global\api\dto\PageResponse.java
================================================================================

package com.ocean.piuda.global.api.dto;

import org.springframework.data.domain.Page;

import java.util.List;

public record PageResponse<T>(
        List<T> content,
        int page,        // 1ë¶€í„° ì‹œì‘
        int size,
        int totalPages,
        long totalElements,
        boolean first,
        boolean last,
        boolean hasNext,
        boolean hasPrevious
) {
    public static <T> PageResponse<T> of(Page<T> page) {
        return new PageResponse<>(
                page.getContent(),
                page.getNumber() + 1, // 0-basedë¥¼ 1-basedë¡œ ë³€í™˜
                page.getSize(),
                page.getTotalPages(),
                page.getTotalElements(),
                page.isFirst(),
                page.isLast(),
                page.hasNext(),
                page.hasPrevious()
        );
    }
}


================================================================================
File Path: .\src\main\java\com\ocean\piuda\global\api\exception\BusinessException.java
================================================================================

package com.ocean.piuda.global.api.exception;


import lombok.Getter;

import java.util.Map;

@Getter
public class BusinessException extends RuntimeException {

    private final ExceptionType exceptionType;
    private final Map<String, ?> details;


    // details ì—†ìŒ
    public BusinessException(ExceptionType exceptionType) {
        this.exceptionType = exceptionType;
        this.details = Map.of();
    }


    // details ìˆìŒ
    public BusinessException(ExceptionType exceptionType, Map<String, ?> details) {
        this.exceptionType = exceptionType;
        this.details = details;
    }
}



================================================================================
File Path: .\src\main\java\com\ocean\piuda\global\api\exception\ExceptionType.java
================================================================================

package com.ocean.piuda.global.api.exception;


import lombok.AllArgsConstructor;
import lombok.Getter;
import org.springframework.http.HttpStatus;

import static org.springframework.http.HttpStatus.*;

@Getter
@AllArgsConstructor
public enum ExceptionType {
    // common
    UNEXPECTED_SERVER_ERROR(INTERNAL_SERVER_ERROR, "C001", "ì˜ˆìƒì¹˜ëª»í•œ ì„œë²„ì—ëŸ¬ ë°œìƒ"),
    BINDING_ERROR(BAD_REQUEST, "C002", "ì˜ëª»ëœ ë°”ì¸ë”©/ì¡°í•©"),
    ESSENTIAL_FIELD_MISSING_ERROR(NO_CONTENT , "C003","í•„ìˆ˜ì ì¸ í•„ë“œ ë¶€ì¬"),
    INVALID_VALUE_ERROR(NOT_ACCEPTABLE , "C004","ê°’ì´ ìœ íš¨í•˜ì§€ ì•ŠìŒ"),
    DUPLICATE_VALUE_ERROR(NOT_ACCEPTABLE , "C005","ê°’ì´ ì¤‘ë³µë¨"),
    NOT_VALID_REQUEST_FIELDS_ERROR(BAD_REQUEST , "C006","ìš”ì²­ í•„ë“œ ê²€ì¦ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."),
    MEDIA_TYPE_MISMATCHED(BAD_REQUEST, "C007","ì˜ëª»ëœ ì½˜í…ì¸  íƒ€ì… ì‚¬ìš©"),
    RESOURCE_NOT_FOUND(NOT_FOUND,"C008","í•´ë‹¹ ìì›ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."),

    // auth
    INVALID_REFRESH_TOKEN(NOT_ACCEPTABLE , "A001","ìœ íš¨í•˜ì§€ ì•Šì€ ë¦¬í”„ë ˆì‹œ í† í°"),
    REFRESH_TOKEN_EXPIRED(UNAUTHORIZED,"A002","ë¦¬í”„ë ˆì‹œ í† í° ë§Œë£Œ"),
    PASSWORD_NOT_MATCHED(NOT_ACCEPTABLE , "A003","ë¹„ë°€ë²ˆí˜¸ ë¶ˆì¼ì¹˜"),
    ACCESS_DENIED(FORBIDDEN, "A004", "ìš”ì²­í•œ ë¦¬ì†ŒìŠ¤ì— ëŒ€í•œ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤."),
    AUTH_PRINCIPAL_INVALID(UNAUTHORIZED,"A005","principal ê´€ë ¨ ì—ëŸ¬ ë°œìƒ"),

    // oauth2
    INVALID_PROVIDER_TYPE_ERROR(NOT_ACCEPTABLE , "O001","ì§€ì›í•˜ì§€ ì•ŠëŠ” provider"),

    // user
    USER_NOT_FOUND(NOT_FOUND, "U001", "ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ì‚¬ìš©ì"),
    DUPLICATED_USER_ID(CONFLICT, "U002", "ì¤‘ë³µ ì•„ì´ë””(PK)"),
    DUPLICATED_USERNAME(CONFLICT, "U003", "ì¤‘ë³µ ì•„ì´ë””(username)"),
    ALREADY_REGISTERED_USER(NOT_ACCEPTABLE , "U006","ì´ë¯¸ ìµœì¢… íšŒì› ê°€ì…ëœ ì‚¬ìš©ì"),
    NOT_REGISTERED_USER(FORBIDDEN , "U007","ìµœì¢… íšŒì› ê°€ì… ë˜ì§€ ì•Šì€ ì‚¬ìš©ì"),
    UNAUTHORIZED_USER(UNAUTHORIZED, "U005","ë¡œê·¸ì¸ ë˜ì§€ ì•Šì€ ì‚¬ìš©ì"),



    //store
    STORE_NOT_FOUND(NOT_FOUND, "S001", "ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ê°€ê²Œ"),

    // admin
    SUBMISSION_NOT_FOUND(NOT_FOUND, "AD001", "ì œì¶œ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."),
    SUBMISSION_ALREADY_APPROVED(CONFLICT, "AD002", "ì´ë¯¸ ìŠ¹ì¸ëœ ì œì¶œì…ë‹ˆë‹¤."),
    SUBMISSION_ALREADY_REJECTED(CONFLICT, "AD003", "ì´ë¯¸ ë°˜ë ¤ëœ ì œì¶œì…ë‹ˆë‹¤."),
    SUBMISSION_ALREADY_DELETED(CONFLICT, "AD004", "ì´ë¯¸ ì‚­ì œëœ ì œì¶œì…ë‹ˆë‹¤."),
    REJECT_REASON_REQUIRED(UNPROCESSABLE_ENTITY, "AD005", "ë°˜ë ¤ ì‚¬ìœ ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”."),
    EXPORT_NOT_FOUND(NOT_FOUND, "AD006", "ë‚´ë³´ë‚´ê¸° ì‘ì—…ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."),
    EXPORT_NOT_READY(UNPROCESSABLE_ENTITY, "AD007", "ë‚´ë³´ë‚´ê¸° íŒŒì¼ì´ ì•„ì§ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."),
    EXPORT_FAILED(INTERNAL_SERVER_ERROR, "AD008", "ë‚´ë³´ë‚´ê¸° ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."),

    //mission
    MISSION_ACCESS_DENIED(FORBIDDEN, "M001", "í•´ë‹¹ ë¯¸ì…˜ì— ëŒ€í•œ ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤."),
    MISSION_NOT_FOUND(NOT_FOUND, "M002", "í•´ë‹¹ ë¯¸ì…˜ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."),

    //garmin
    WATCH_API_KEY_INVALID(UNAUTHORIZED, "W001", "ìœ íš¨í•˜ì§€ ì•Šì€ ì‹œê³„ API í‚¤"),
    INVALID_PAYLOAD(BAD_REQUEST, "W002", "ìœ íš¨í•˜ì§€ ì•Šì€ í˜ì´ë¡œë“œ"),
    WATCH_NOT_PAIRED(HttpStatus.FORBIDDEN, "WATCH_NOT_PAIRED", "í•´ë‹¹ ì›Œì¹˜ëŠ” ì•„ì§ ê³„ì •ì— ë“±ë¡ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."),
    WATCH_ALREADY_PAIRED(HttpStatus.CONFLICT, "WATCH_ALREADY_PAIRED", "ì´ë¯¸ í˜ì–´ë§ëœ ì›Œì¹˜ì…ë‹ˆë‹¤."),
    WATCH_DEVICE_NOT_FOUND(HttpStatus.NOT_FOUND, "WATCH_DEVICE_NOT_FOUND", "ë“±ë¡ëœ ì›Œì¹˜ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
    ;


    private final HttpStatus status;
    private final String code;
    private final String message;}


================================================================================
File Path: .\src\main\java\com\ocean\piuda\global\api\exception\GlobalExceptionHandler.java
================================================================================

package com.ocean.piuda.global.api.exception;

import com.ocean.piuda.global.api.dto.ApiData;
import lombok.extern.slf4j.Slf4j;
import org.springframework.expression.EvaluationException;
import org.springframework.expression.spel.SpelEvaluationException;
import org.springframework.http.HttpStatus;
import org.springframework.validation.FieldError;
import org.springframework.web.bind.MethodArgumentNotValidException;
import org.springframework.web.bind.annotation.ExceptionHandler;
import org.springframework.web.bind.annotation.ResponseStatus;
import org.springframework.web.bind.annotation.RestControllerAdvice;

import java.util.HashMap;
import java.util.List;
import java.util.Map;

@RestControllerAdvice
@Slf4j
public class GlobalExceptionHandler {

  @ExceptionHandler(BusinessException.class)
  public ApiData<Void> handleApplicationException(BusinessException e) {
    return ApiData.error(e.getExceptionType(), e.getDetails());
  }



  @ExceptionHandler(MethodArgumentNotValidException.class)
  public  ApiData<Void> handleMethodArgumentNotValidException(MethodArgumentNotValidException e) {
    Map<String, String> details = new HashMap<>();
    List<FieldError> fieldErrors = e.getFieldErrors();
    fieldErrors.forEach(fieldError -> details.put(fieldError.getField(), fieldError.getDefaultMessage()));
    return ApiData.error(ExceptionType.NOT_VALID_REQUEST_FIELDS_ERROR, details);

  }

  /** @AuthenticationPrincipal(expression=...) í‰ê°€/ìºìŠ¤íŒ… ì‹¤íŒ¨ */
  @ExceptionHandler({ SpelEvaluationException.class, EvaluationException.class, ClassCastException.class, IllegalArgumentException.class })
  @ResponseStatus(HttpStatus.UNAUTHORIZED)
  public ApiData<Void> handleAuthPrincipalBinding(Exception e) {
    return ApiData.error(ExceptionType.AUTH_PRINCIPAL_INVALID, Map.of("message",e.getMessage() ));
  }



  @ExceptionHandler(Exception.class)
  public ApiData<Void> exception(Exception e) {
    Map<String, Object> details = Map.of("message",  e.getMessage());
    return ApiData.error(ExceptionType.UNEXPECTED_SERVER_ERROR,details);
  }

}


================================================================================
File Path: .\src\main\java\com\ocean\piuda\global\config\JpaConfig.java
================================================================================

package com.ocean.piuda.global.config;

import org.springframework.context.annotation.Configuration;
import org.springframework.data.jpa.repository.config.EnableJpaAuditing;

@EnableJpaAuditing
@Configuration
public class JpaConfig {
}


================================================================================
File Path: .\src\main\java\com\ocean\piuda\global\config\RestClientConfig.java
================================================================================

package com.ocean.piuda.global.config;

import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.web.client.RestClient;

@Configuration
public class RestClientConfig {

    @Bean
    public RestClient restClient() {
        return RestClient.create();
    }
}


================================================================================
File Path: .\src\main\java\com\ocean\piuda\global\config\RestTemplateConfig.java
================================================================================

package com.ocean.piuda.global.config;

import org.springframework.boot.web.client.RestTemplateBuilder;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.web.client.RestTemplate;

@Configuration
public class RestTemplateConfig {
    @Bean
    public RestTemplate restTemplate(RestTemplateBuilder restTemplateBuilder) {
        return restTemplateBuilder.build();
    }
}



================================================================================
File Path: .\src\main\java\com\ocean\piuda\global\config\SwaggerConfig.java
================================================================================

package com.ocean.piuda.global.config;


import io.swagger.v3.oas.models.Components;
import io.swagger.v3.oas.models.OpenAPI;
import io.swagger.v3.oas.models.info.Info;
import io.swagger.v3.oas.models.security.SecurityRequirement;
import io.swagger.v3.oas.models.security.SecurityScheme;
import io.swagger.v3.oas.models.servers.Server;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

@Configuration
public class SwaggerConfig {


    @Bean
    public OpenAPI openAPI() {
        return new OpenAPI()
                .addServersItem(new Server().url("/"))
                .components(new Components().addSecuritySchemes(
                        "bearerAuth",
                        new SecurityScheme()
                                .name("bearerAuth")
                                .type(SecurityScheme.Type.HTTP)
                                .scheme("bearer")
                                .bearerFormat("JWT")
                ))
                .addSecurityItem(new SecurityRequirement().addList("bearerAuth"))
                .info(new Info().title("PIUDA API").version("v1.0.0"));
    }
}


================================================================================
File Path: .\src\main\java\com\ocean\piuda\global\config\WebClientConfig.java
================================================================================

package com.ocean.piuda.global.config;

import org.springframework.beans.factory.annotation.Qualifier;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.web.reactive.function.client.WebClient;

@Configuration
public class WebClientConfig {


    /**
     * ê³µí†µ REST API í˜¸ì¶œìš© ê¸°ë³¸ WebClient
     */
    @Bean
    @Qualifier("defaultWebClient")
    public WebClient defaultWebClient(WebClient.Builder builder) {
        return builder.build();
    }
}



================================================================================
File Path: .\src\main\java\com\ocean\piuda\global\enums\SortEnum.java
================================================================================

package com.ocean.piuda.global.enums;

import org.springframework.data.domain.Sort;

/**
 * ì •ë ¬ ê¸°ì¤€ì„ ì •ì˜í•˜ëŠ” ì¸í„°í˜ì´ìŠ¤
 * ê° ë„ë©”ì¸ë³„ë¡œ ì´ ì¸í„°í˜ì´ìŠ¤ë¥¼ êµ¬í˜„í•˜ì—¬ ê³ ìœ í•œ ì •ë ¬ ê¸°ì¤€ì„ ì •ì˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
 */
public interface SortEnum {

    /**
     * Spring Dataì˜ Sort ê°ì²´ë¡œ ë³€í™˜í•©ë‹ˆë‹¤.
     * @return Sort ê°ì²´
     */
    Sort toSort();
}


================================================================================
File Path: .\src\main\java\com\ocean\piuda\global\util\MultipartJackson2HttpMessageConverter.java
================================================================================

package com.ocean.piuda.global.util;
import com.fasterxml.jackson.databind.ObjectMapper;
import org.springframework.http.MediaType;
import org.springframework.http.converter.json.AbstractJackson2HttpMessageConverter;
import org.springframework.stereotype.Component;

import java.lang.reflect.Type;

/**
 * Swaggerê°€ multipart/form-dataì˜ JSON íŒŒíŠ¸ë¥¼ Content-Type ì—†ì´ ë³´ë‚´
 * application/octet-streamìœ¼ë¡œ ì²˜ë¦¬ë˜ëŠ” ê²½ìš°ë¥¼ í¡ìˆ˜í•˜ê¸° ìœ„í•œ ì»¨ë²„í„°.
 * ì½ê¸°(read)ë§Œ ì§€ì›í•˜ê³  ì“°ê¸°(write)ëŠ” ë§‰ìŒ.
 */
@Component
public class MultipartJackson2HttpMessageConverter extends AbstractJackson2HttpMessageConverter {

    public MultipartJackson2HttpMessageConverter(ObjectMapper objectMapper) {
        // ì´ ì»¨ë²„í„°ê°€ ì²˜ë¦¬í•  ë¯¸ë””ì–´íƒ€ì…ì„ octet-streamìœ¼ë¡œ ëª…ì‹œ
        super(objectMapper, MediaType.APPLICATION_OCTET_STREAM);
    }

    @Override
    protected boolean canWrite(MediaType mediaType) {
        return false; // ì“°ê¸°ëŠ” ì§€ì›í•˜ì§€ ì•ŠìŒ
    }

    @Override
    public boolean canWrite(Class<?> clazz, MediaType mediaType) {
        return false;
    }

    @Override
    public boolean canWrite(Type type, Class<?> clazz, MediaType mediaType) {
        return false;
    }
}


================================================================================
File Path: .\src\main\java\com\ocean\piuda\mission\controller\MissionController.java
================================================================================

package com.ocean.piuda.mission.controller;

import com.ocean.piuda.bio.enums.BioGroup;
import com.ocean.piuda.mission.enums.MissionStatus;
import com.ocean.piuda.mission.dto.*;
import com.ocean.piuda.mission.service.MissionService;
import jakarta.validation.Valid;
import lombok.RequiredArgsConstructor;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.PageRequest;
import org.springframework.data.domain.Pageable;
import org.springframework.http.HttpStatus;
import org.springframework.web.bind.annotation.*;

/**
 * Mission ê´€ë ¨ REST API ì»¨íŠ¸ë¡¤ëŸ¬
 */
@RestController
@RequestMapping("/api/missions")
@RequiredArgsConstructor
public class MissionController {

    private final MissionService missionService;

    /**
     * ë¯¸ì…˜ ìƒì„± (ADMINë§Œ ê°€ëŠ¥)
     * POST /api/missions
     */
    @PostMapping
    @ResponseStatus(HttpStatus.CREATED)
    public MissionResponse createMission(@Valid @RequestBody MissionCreateRequest request) {
        return missionService.createMission(request);
    }

    /**
     * ë¯¸ì…˜ ë‹¨ê±´ ì¡°íšŒ (ëª¨ë“  ì‚¬ìš©ì ì ‘ê·¼ ê°€ëŠ¥)
     * GET /api/missions/{id}
     */
    @GetMapping("/{id}")
    public MissionResponse getMission(@PathVariable Long id) {
        return missionService.getMission(id);
    }

    /**
     * ë¯¸ì…˜ ëª©ë¡ ì¡°íšŒ (í•„í„°ë§ ì§€ì›, ëª¨ë“  ì‚¬ìš©ì ì ‘ê·¼ ê°€ëŠ¥)
     * GET /api/missions?status=ACTIVE&targetBioGroup=FISH&regionName=í¬í•­&page=0&size=20
     */
    @GetMapping
    public Page<MissionResponse> getMissions(
            @RequestParam(required = false) MissionStatus status,
            @RequestParam(required = false) BioGroup targetBioGroup,
            @RequestParam(required = false) String regionName,
            @RequestParam(defaultValue = "0") int page,
            @RequestParam(defaultValue = "20") int size
    ) {
        MissionSearchCondition condition = MissionSearchCondition.builder()
                .status(status)
                .targetBioGroup(targetBioGroup)
                .regionName(regionName)
                .build();

        Pageable pageable = PageRequest.of(page, size);
        return missionService.getMissions(condition, pageable);
    }

    /**
     * ë¯¸ì…˜ ìˆ˜ì • (ADMIN ë˜ëŠ” ownerë§Œ ê°€ëŠ¥)
     * PATCH /api/missions/{id}
     */
    @PatchMapping("/{id}")
    public MissionResponse updateMission(
            @PathVariable Long id,
            @Valid @RequestBody MissionUpdateRequest request
    ) {
        return missionService.updateMission(id, request);
    }

    /**
     * ë¯¸ì…˜ ì‚­ì œ (ADMIN ë˜ëŠ” ownerë§Œ ê°€ëŠ¥)
     * DELETE /api/missions/{id}
     */
    @DeleteMapping("/{id}")
    @ResponseStatus(HttpStatus.NO_CONTENT)
    public void deleteMission(@PathVariable Long id) {
        missionService.deleteMission(id);
    }
}



================================================================================
File Path: .\src\main\java\com\ocean\piuda\mission\domain\Mission.java
================================================================================

package com.ocean.piuda.mission.domain;

import com.ocean.piuda.bio.enums.BioGroup;
import com.ocean.piuda.global.api.domain.BaseEntity;
import com.ocean.piuda.mission.enums.MissionStatus;
import jakarta.persistence.*;
import lombok.*;
import lombok.experimental.SuperBuilder;

import java.time.LocalDate;

@Entity
@Table(name = "missions")
@SuperBuilder(toBuilder = true)
@Getter
@NoArgsConstructor(access = AccessLevel.PROTECTED)
@AllArgsConstructor
public class Mission extends BaseEntity {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @Column(nullable = false, length = 200)
    private String title;

    @Enumerated(EnumType.STRING)
    @Column(nullable = false, length = 30)
    private BioGroup targetBioGroup;

    @Column(nullable = false)
    private Long ownerId;

    @Column(nullable = false)
    private Long pointId;

    @Column(columnDefinition = "TEXT")
    private String description;

    private String regionName;

    @Column(nullable = false)
    private LocalDate startDate;

    private LocalDate endDate;

    @Enumerated(EnumType.STRING)
    @Column(nullable = false, length = 20)
    @Builder.Default
    private MissionStatus status = MissionStatus.PLANNED;

    private String coverMediaUrl;

    public void update(MissionUpdater updater) {
        if (updater.getTitle() != null) {
            this.title = updater.getTitle();
        }
        if (updater.getTargetBioGroup() != null) {
            this.targetBioGroup = updater.getTargetBioGroup();
        }
        if (updater.getPointId() != null) {
            this.pointId = updater.getPointId();
        }
        if (updater.getDescription() != null) {
            this.description = updater.getDescription();
        }
        if (updater.getRegionName() != null) {
            this.regionName = updater.getRegionName();
        }
        if (updater.getStartDate() != null) {
            this.startDate = updater.getStartDate();
        }
        if (updater.getEndDate() != null) {
            this.endDate = updater.getEndDate();
        }
        if (updater.getStatus() != null) {
            this.status = updater.getStatus();
        }
        if (updater.getCoverMediaUrl() != null) {
            this.coverMediaUrl = updater.getCoverMediaUrl();
        }
    }

    @Getter
    @Builder
    @AllArgsConstructor
    public static class MissionUpdater {
        private final String title;
        private final BioGroup targetBioGroup;
        private final Long pointId;
        private final String description;
        private final String regionName;
        private final LocalDate startDate;
        private final LocalDate endDate;
        private final MissionStatus status;
        private final String coverMediaUrl;
    }
}



================================================================================
File Path: .\src\main\java\com\ocean\piuda\mission\dto\MissionCreateRequest.java
================================================================================

package com.ocean.piuda.mission.dto;

import com.ocean.piuda.bio.enums.BioGroup;
import com.ocean.piuda.mission.domain.Mission;
import com.ocean.piuda.mission.enums.MissionStatus;
import jakarta.validation.constraints.NotBlank;
import jakarta.validation.constraints.NotNull;
import jakarta.validation.constraints.Size;

import java.time.LocalDate;

public record MissionCreateRequest(
        @NotBlank(message = "ì œëª©ì€ í•„ìˆ˜ì…ë‹ˆë‹¤")
        @Size(max = 200, message = "ì œëª©ì€ 200ì ì´í•˜ì—¬ì•¼ í•©ë‹ˆë‹¤")
        String title,

        @NotNull(message = "ëŒ€ìƒ ìƒë¬¼ ë¶„ë¥˜ëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤")
        BioGroup targetBioGroup,

        @NotNull(message = "í¬ì¸íŠ¸ IDëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤")
        Long pointId,

        String description,

        String regionName,

        @NotNull(message = "ì‹œì‘ì¼ì€ í•„ìˆ˜ì…ë‹ˆë‹¤")
        LocalDate startDate,

        LocalDate endDate,

        MissionStatus status,

        String coverMediaUrl
) {
    public Mission toEntity(Long ownerId) {
        return Mission.builder()
                .title(title)
                .targetBioGroup(targetBioGroup)
                .ownerId(ownerId)
                .pointId(pointId)
                .description(description)
                .regionName(regionName)
                .startDate(startDate)
                .endDate(endDate)
                .status(status != null ? status : MissionStatus.PLANNED)
                .coverMediaUrl(coverMediaUrl)
                .build();
    }
}



================================================================================
File Path: .\src\main\java\com\ocean\piuda\mission\dto\MissionResponse.java
================================================================================

package com.ocean.piuda.mission.dto;

import com.ocean.piuda.bio.enums.BioGroup;
import com.ocean.piuda.mission.domain.Mission;
import com.ocean.piuda.mission.enums.MissionStatus;

import java.time.LocalDate;
import java.time.LocalDateTime;

public record MissionResponse(
        Long id,
        String title,
        BioGroup targetBioGroup,
        Long ownerId,
        Long pointId,
        String description,
        String regionName,
        LocalDate startDate,
        LocalDate endDate,
        MissionStatus status,
        String coverMediaUrl,
        LocalDateTime createdAt,
        LocalDateTime modifiedAt
) {
    public static MissionResponse from(Mission mission) {
        return new MissionResponse(
                mission.getId(),
                mission.getTitle(),
                mission.getTargetBioGroup(),
                mission.getOwnerId(),
                mission.getPointId(),
                mission.getDescription(),
                mission.getRegionName(),
                mission.getStartDate(),
                mission.getEndDate(),
                mission.getStatus(),
                mission.getCoverMediaUrl(),
                mission.getCreatedAt(),
                mission.getModifiedAt()
        );
    }
}



================================================================================
File Path: .\src\main\java\com\ocean\piuda\mission\dto\MissionSearchCondition.java
================================================================================

package com.ocean.piuda.mission.dto;

import com.ocean.piuda.bio.enums.BioGroup;
import com.ocean.piuda.mission.enums.MissionStatus;
import lombok.Builder;

@Builder
public record MissionSearchCondition(
        MissionStatus status,
        BioGroup targetBioGroup,
        String regionName
) {}



================================================================================
File Path: .\src\main\java\com\ocean\piuda\mission\dto\MissionUpdateRequest.java
================================================================================

package com.ocean.piuda.mission.dto;

import com.ocean.piuda.bio.enums.BioGroup;
import com.ocean.piuda.mission.enums.MissionStatus;

import java.time.LocalDate;

public record MissionUpdateRequest(
        String title,
        BioGroup targetBioGroup,
        Long pointId,
        String description,
        String regionName,
        LocalDate startDate,
        LocalDate endDate,
        MissionStatus status,
        String coverMediaUrl
) {}



================================================================================
File Path: .\src\main\java\com\ocean\piuda\mission\enums\MissionStatus.java
================================================================================

package com.ocean.piuda.mission.enums;

public enum MissionStatus {
    PLANNED,
    ACTIVE,
    CLOSED
}



================================================================================
File Path: .\src\main\java\com\ocean\piuda\mission\repository\MissionRepository.java
================================================================================

package com.ocean.piuda.mission.repository;

import com.ocean.piuda.bio.enums.BioGroup;
import com.ocean.piuda.mission.domain.Mission;
import com.ocean.piuda.mission.enums.MissionStatus;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.JpaSpecificationExecutor;

public interface MissionRepository extends JpaRepository<Mission, Long>, JpaSpecificationExecutor<Mission> {

    Page<Mission> findByStatus(MissionStatus status, Pageable pageable);

    Page<Mission> findByTargetBioGroup(BioGroup targetBioGroup, Pageable pageable);
}



================================================================================
File Path: .\src\main\java\com\ocean\piuda\mission\service\MissionService.java
================================================================================

package com.ocean.piuda.mission.service;

import com.ocean.piuda.mission.dto.*;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;

public interface MissionService {

    /**
     * ë¯¸ì…˜ ìƒì„± (ADMINë§Œ ê°€ëŠ¥)
     */
    MissionResponse createMission(MissionCreateRequest request);

    /**
     * ë¯¸ì…˜ ë‹¨ê±´ ì¡°íšŒ (ëª¨ë“  ì‚¬ìš©ì ì ‘ê·¼ ê°€ëŠ¥)
     */
    MissionResponse getMission(Long id);

    /**
     * ë¯¸ì…˜ ëª©ë¡ ì¡°íšŒ (í•„í„°ë§ ì§€ì›, ëª¨ë“  ì‚¬ìš©ì ì ‘ê·¼ ê°€ëŠ¥)
     */
    Page<MissionResponse> getMissions(MissionSearchCondition condition, Pageable pageable);

    /**
     * ë¯¸ì…˜ ìˆ˜ì • (ADMIN ë˜ëŠ” ownerë§Œ ê°€ëŠ¥)
     */
    MissionResponse updateMission(Long id, MissionUpdateRequest request);

    /**
     * ë¯¸ì…˜ ì‚­ì œ (ADMIN ë˜ëŠ” ownerë§Œ ê°€ëŠ¥)
     */
    void deleteMission(Long id);
}



================================================================================
File Path: .\src\main\java\com\ocean\piuda\mission\service\MissionServiceImpl.java
================================================================================

package com.ocean.piuda.mission.service;

import com.ocean.piuda.global.api.exception.BusinessException;
import com.ocean.piuda.global.api.exception.ExceptionType;
import com.ocean.piuda.security.jwt.service.TokenUserService;
import com.ocean.piuda.mission.domain.Mission;
import com.ocean.piuda.mission.dto.*;
import com.ocean.piuda.mission.repository.MissionRepository;
import com.ocean.piuda.security.jwt.enums.Role;
import jakarta.persistence.criteria.Predicate;
import lombok.RequiredArgsConstructor;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.data.jpa.domain.Specification;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.ArrayList;
import java.util.List;

@Service
@RequiredArgsConstructor
@Transactional(readOnly = true)
public class MissionServiceImpl implements MissionService {

    private final MissionRepository missionRepository;
    private final TokenUserService tokenUserService;

    @Override
    @Transactional
    public MissionResponse createMission(MissionCreateRequest request) {
        // ê¶Œí•œ ì²´í¬: ADMINë§Œ ê°€ëŠ¥
        ensureAdmin();

        Long ownerId = tokenUserService.getCurrentUserId();
        Mission mission = request.toEntity(ownerId);
        mission = missionRepository.save(mission);
        return MissionResponse.from(mission);
    }

    @Override
    public MissionResponse getMission(Long id) {
        Mission mission = findMission(id);
        return MissionResponse.from(mission);
    }

    @Override
    public Page<MissionResponse> getMissions(MissionSearchCondition condition, Pageable pageable) {
        Specification<Mission> spec = buildSpecification(condition);
        return missionRepository.findAll(spec, pageable)
                .map(MissionResponse::from);
    }

    @Override
    @Transactional
    public MissionResponse updateMission(Long id, MissionUpdateRequest request) {
        Mission mission = findMission(id);

        // ê¶Œí•œ ì²´í¬: ADMIN ë˜ëŠ” ownerë§Œ ê°€ëŠ¥
        ensureOwnerOrAdmin(mission.getOwnerId());

        Mission.MissionUpdater updater = Mission.MissionUpdater.builder()
                .title(request.title())
                .targetBioGroup(request.targetBioGroup())
                .pointId(request.pointId())
                .description(request.description())
                .regionName(request.regionName())
                .startDate(request.startDate())
                .endDate(request.endDate())
                .status(request.status())
                .coverMediaUrl(request.coverMediaUrl())
                .build();

        mission.update(updater);
        return MissionResponse.from(mission);
    }

    @Override
    @Transactional
    public void deleteMission(Long id) {
        Mission mission = findMission(id);

        // ê¶Œí•œ ì²´í¬: ADMIN ë˜ëŠ” ownerë§Œ ê°€ëŠ¥
        ensureOwnerOrAdmin(mission.getOwnerId());

        missionRepository.delete(mission);
    }

    private Mission findMission(Long id) {
        return missionRepository.findById(id)
                .orElseThrow(() -> new BusinessException(ExceptionType.MISSION_NOT_FOUND));
    }

    private void ensureAdmin() {
        Role currentRole = tokenUserService.getCurrentUserRole();
        if (currentRole != Role.ADMIN) {
            throw new BusinessException(ExceptionType.MISSION_ACCESS_DENIED);
        }
    }

    private void ensureOwnerOrAdmin(Long ownerId) {
        Role currentRole = tokenUserService.getCurrentUserRole();
        Long currentUserId = tokenUserService.getCurrentUserId();

        if (currentRole != Role.ADMIN && !ownerId.equals(currentUserId)) {
            throw new BusinessException(ExceptionType.MISSION_ACCESS_DENIED);
        }
    }

    private Specification<Mission> buildSpecification(MissionSearchCondition condition) {
        return (root, query, cb) -> {
            List<Predicate> predicates = new ArrayList<>();

            if (condition != null) {
                if (condition.status() != null) {
                    predicates.add(cb.equal(root.get("status"), condition.status()));
                }
                if (condition.targetBioGroup() != null) {
                    predicates.add(cb.equal(root.get("targetBioGroup"), condition.targetBioGroup()));
                }
                if (condition.regionName() != null && !condition.regionName().isBlank()) {
                    predicates.add(cb.like(
                            cb.lower(root.get("regionName")),
                            "%" + condition.regionName().toLowerCase() + "%"
                    ));
                }
            }

            return cb.and(predicates.toArray(new Predicate[0]));
        };
    }
}



================================================================================
File Path: .\src\main\java\com\ocean\piuda\notification\config\FirebaseConfig.java
================================================================================

package com.ocean.piuda.notification.config;

import com.google.auth.oauth2.GoogleCredentials;
import com.google.firebase.FirebaseApp;
import com.google.firebase.FirebaseOptions;
import com.google.firebase.messaging.FirebaseMessaging;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.core.io.Resource;
import org.springframework.core.io.ResourceLoader;

import java.io.InputStream;

@Configuration
public class FirebaseConfig {

    @Value("${notification.firebase.credentials-location:classpath:firebase/service-account.json}")
    private String credentialsLocation;

    @Bean
    public FirebaseApp firebaseApp(ResourceLoader loader) throws Exception {
        Resource resource = loader.getResource(credentialsLocation);
        try (InputStream in = resource.getInputStream()) {
            FirebaseOptions options = FirebaseOptions.builder()
                    .setCredentials(GoogleCredentials.fromStream(in))
                    .build();
            if (FirebaseApp.getApps().isEmpty()) {
                return FirebaseApp.initializeApp(options);
            }
            return FirebaseApp.getInstance();
        }
    }

    @Bean
    public FirebaseMessaging firebaseMessaging(FirebaseApp app) {
        return FirebaseMessaging.getInstance(app);
    }
}


================================================================================
File Path: .\src\main\java\com\ocean\piuda\notification\controller\FcmController.java
================================================================================

package com.ocean.piuda.notification.controller;

import com.ocean.piuda.global.api.dto.ApiData;
import com.ocean.piuda.notification.dto.request.SaveTokenRequest;
import com.ocean.piuda.notification.dto.request.SendNotificationRequest;
import com.ocean.piuda.notification.dto.response.FcmTokensResponse;
import com.ocean.piuda.notification.dto.response.SendResultResponse;
import com.ocean.piuda.notification.service.FcmCommandService;
import com.ocean.piuda.notification.service.FcmQueryService;
import com.ocean.piuda.security.oauth2.principal.PrincipalDetails;
import io.swagger.v3.oas.annotations.Operation;
import io.swagger.v3.oas.annotations.Parameter;
import io.swagger.v3.oas.annotations.security.SecurityRequirement;
import io.swagger.v3.oas.annotations.tags.Tag;
import lombok.RequiredArgsConstructor;
import org.springframework.security.core.annotation.AuthenticationPrincipal;
import org.springframework.web.bind.annotation.*;


@Tag(name = "Push/FCM API", description = "ì›¹í‘¸ì‹œ(FCM) ê´€ë ¨ API")
@RestController
@RequestMapping("/api/push")
@RequiredArgsConstructor
public class FcmController {

    private final FcmCommandService fcmCommandService;
    private final FcmQueryService fcmQueryService;


    /** í† í° ì €ì¥/ê°±ì‹  (ë¡œê·¸ì¸ ìœ ì € ê¸°ì¤€) */
    @PostMapping("/tokens")
    @Operation(
            summary = "FCM í† í° ì €ì¥/ê°±ì‹ ",
            description = "í˜„ì¬ ë¡œê·¸ì¸í•œ ì‚¬ìš©ì ê¸°ì¤€ìœ¼ë¡œ FCM/WebPush í† í°ì„ ì €ì¥í•˜ê±°ë‚˜ ê°±ì‹ í•©ë‹ˆë‹¤."
    )
    @SecurityRequirement(name = "bearerAuth")
    public ApiData<Boolean> upsertToken(
            @AuthenticationPrincipal PrincipalDetails principalDetails,
            @io.swagger.v3.oas.annotations.parameters.RequestBody(
                    description = "ì €ì¥/ê°±ì‹ í•  í† í° ì •ë³´", required = true
            )
            @RequestBody SaveTokenRequest req
    ) {


            fcmCommandService.upsert(principalDetails.getUser().getId(), req);
            return ApiData.ok(true);

    }

    /** í† í° ì‚­ì œ */
    @DeleteMapping("/tokens/{token}")
    @Operation(
            summary = "FCM í† í° ì‚­ì œ",
            description = "ì§€ì •í•œ FCM/WebPush í† í°ì„ ì‚­ì œí•©ë‹ˆë‹¤."
    )
    @SecurityRequirement(name = "bearerAuth")
    public ApiData<Boolean>  removeToken(
            @Parameter(description = "ì‚­ì œí•  FCM/WebPush í† í° ê°’", required = true)
            @PathVariable String token
    ) {
        fcmCommandService.removeByToken(token);
        return ApiData.ok(true);

    }

    /** (ê´€ë¦¬/í…ŒìŠ¤íŠ¸) ì•Œë¦¼ ë°œì†¡ */
    @PostMapping("/send")
    @Operation(
            summary = "ì•Œë¦¼ ë°œì†¡(ê´€ë¦¬/í…ŒìŠ¤íŠ¸)",
            description = "íŠ¹ì • í† í° ë˜ëŠ” ì‚¬ìš©ì ëŒ€ìƒìœ¼ë¡œ ì•Œë¦¼ì„ ë°œì†¡í•©ë‹ˆë‹¤. ìš´ì˜ í™˜ê²½ì—ì„œëŠ” ê´€ë¦¬ì ê¶Œí•œì—ì„œë§Œ ì‚¬ìš©í•˜ì‹­ì‹œì˜¤."
    )
    @SecurityRequirement(name = "bearerAuth")
    public ApiData<SendResultResponse> send(
            @io.swagger.v3.oas.annotations.parameters.RequestBody(
                    description = "ì•Œë¦¼ ë°œì†¡ ìš”ì²­ ë°”ë””", required = true
            )
            @RequestBody SendNotificationRequest req
    ) throws Exception {
        return ApiData.ok(fcmCommandService.send(req));
    }

    /** í† í° ì¡°íšŒ (ë¡œê·¸ì¸ ìœ ì € ë³¸ì¸) */
    @GetMapping("/tokens")
    @Operation(
            summary = "ë‚´ FCM í† í° ëª©ë¡ ì¡°íšŒ",
            description = "í˜„ì¬ ë¡œê·¸ì¸í•œ ì‚¬ìš©ìì˜ ëª¨ë“  FCM/WebPush í† í°ì„ ì¡°íšŒí•©ë‹ˆë‹¤."
    )
    @SecurityRequirement(name = "bearerAuth")
    public ApiData<FcmTokensResponse> getLoginedUserFcmTokens(
            @Parameter(hidden = true)
            @AuthenticationPrincipal PrincipalDetails principalDetails
    ) throws Exception {
        return ApiData.ok(
                FcmTokensResponse.fromEntities(
                        fcmQueryService.getByUser(principalDetails.getUser())
                )
        );
    }


}


================================================================================
File Path: .\src\main\java\com\ocean\piuda\notification\dto\request\SaveTokenRequest.java
================================================================================

package com.ocean.piuda.notification.dto.request;


import com.ocean.piuda.notification.enums.Platform;

public record SaveTokenRequest(
        String token,
        String deviceId,
        Platform platform
) {}


================================================================================
File Path: .\src\main\java\com\ocean\piuda\notification\dto\request\SendNotificationRequest.java
================================================================================

package com.ocean.piuda.notification.dto.request;

import java.util.List;

public record SendNotificationRequest(
        List<Long> userIds,
        List<String> tokens,
        String title,
        String body,
        String url
) { }



================================================================================
File Path: .\src\main\java\com\ocean\piuda\notification\dto\response\FcmTokenResponse.java
================================================================================

package com.ocean.piuda.notification.dto.response;


import com.ocean.piuda.notification.entity.FcmToken;
import lombok.Builder;

/**
 * í•˜ë‚˜ì˜ FCM í† í° ë°˜í™˜
 */
@Builder
public record FcmTokenResponse(
        Long id, String token
){
    public static FcmTokenResponse from(FcmToken e) {
        return FcmTokenResponse.builder()
                .id(e.getId())
                .token(e.getToken())
                .build();
    }

}


================================================================================
File Path: .\src\main\java\com\ocean\piuda\notification\dto\response\FcmTokensResponse.java
================================================================================

package com.ocean.piuda.notification.dto.response;

import com.ocean.piuda.notification.entity.FcmToken;
import lombok.Builder;

import java.util.List;

/**
 * ì—¬ëŸ¬ FCM í† í° í•œ ë²ˆì— ë°˜í™˜
 */
@Builder
public record FcmTokensResponse(
        List<FcmTokenResponse> tokens
) {
    public static FcmTokensResponse fromEntities(List<FcmToken> entities) {
        return FcmTokensResponse.builder()
                .tokens(entities.stream().map(FcmTokenResponse::from).toList())
                .build();
    }

}


================================================================================
File Path: .\src\main\java\com\ocean\piuda\notification\dto\response\SendResultResponse.java
================================================================================

package com.ocean.piuda.notification.dto.response;

import lombok.Builder;

import java.util.List;

@Builder
public record SendResultResponse(
        int successCount,
        int failureCount,
        List<String> messageIds
) {}


================================================================================
File Path: .\src\main\java\com\ocean\piuda\notification\entity\FcmToken.java
================================================================================

package com.ocean.piuda.notification.entity;


import com.ocean.piuda.global.api.domain.BaseEntity;
import com.ocean.piuda.notification.enums.Platform;
import com.ocean.piuda.user.entity.User;
import jakarta.persistence.*;
import lombok.*;

@Entity
@Getter
@NoArgsConstructor(access = AccessLevel.PROTECTED)
@AllArgsConstructor
@Builder
public class FcmToken extends BaseEntity {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @ManyToOne(fetch = FetchType.LAZY, optional = false)
    @JoinColumn(name = "user_id", nullable = false)
    private User user;

    /**
     * ë¸Œë¼ìš°ì €/ê¸°ê¸° ì‹ë³„ì (optional)
     */
    @Column(length = 100)
    private String deviceId;

    /**
     * í”Œë«í¼/OS (optional)
     */
    @Enumerated(EnumType.STRING)
    private Platform platform;

    /** FCM ë“±ë¡ í† í° */
    @Column(nullable = false, unique = true, length = 512)
    private String token;


    public void upsertUser(User user) {
        this.user = user;
    }

    public void updateClientInfo(String deviceId, Platform platform) {
        this.deviceId = deviceId;
        this.platform = platform;
    }

}


================================================================================
File Path: .\src\main\java\com\ocean\piuda\notification\enums\Platform.java
================================================================================

package com.ocean.piuda.notification.enums;

public enum Platform {
    WEB, ANDROID, IOS,ETC
}


================================================================================
File Path: .\src\main\java\com\ocean\piuda\notification\repository\FcmTokenRepository.java
================================================================================

package com.ocean.piuda.notification.repository;


import com.ocean.piuda.notification.entity.FcmToken;
import com.ocean.piuda.user.entity.User;
import org.springframework.data.jpa.repository.JpaRepository;

import java.util.List;
import java.util.Optional;

public interface FcmTokenRepository extends JpaRepository<FcmToken, Long> {
    Optional<FcmToken> findByToken(String token);
    List<FcmToken> findAllByUser(User user);
    void deleteByToken(String token);
    void deleteAllByUser(User user);
}


================================================================================
File Path: .\src\main\java\com\ocean\piuda\notification\service\FcmCommandService.java
================================================================================

package com.ocean.piuda.notification.service;

import com.google.firebase.messaging.*;
import com.ocean.piuda.notification.dto.request.SaveTokenRequest;
import com.ocean.piuda.notification.dto.request.SendNotificationRequest;
import com.ocean.piuda.notification.dto.response.SendResultResponse;
import com.ocean.piuda.notification.entity.FcmToken;
import com.ocean.piuda.notification.repository.FcmTokenRepository;
import com.ocean.piuda.user.entity.User;
import com.ocean.piuda.user.repository.UserRepository;
import com.ocean.piuda.user.service.UserQueryService;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.time.Duration;
import java.util.*;

@Service
@RequiredArgsConstructor
@Transactional
public class FcmCommandService {

    private static final int FCM_MULTICAST_LIMIT = 500;

    private final FirebaseMessaging messaging;
    private final FcmTokenRepository fcmTokenRepository;
    private final UserQueryService userQueryService;

    public FcmToken upsert(Long userId, SaveTokenRequest req) {
        User user = userQueryService.getUserById(userId);
        FcmToken existing = fcmTokenRepository.findByToken(req.token()).orElse(null);
        if (existing != null) {
            // ì†Œìœ ì/í´ë¼ì´ì–¸íŠ¸ ì •ë³´ ê°±ì‹ ë§Œ í—ˆìš©
            existing.upsertUser(user);
            existing.updateClientInfo(req.deviceId(), req.platform());
            return existing;
        }
        return fcmTokenRepository.save(
                FcmToken.builder()
                        .user(user)
                        .token(req.token())
                        .deviceId(req.deviceId())
                        .platform(req.platform())
                        .build()
        );
    }

    public void removeByToken(String token) {
        fcmTokenRepository.deleteByToken(token);
    }


    /**
     * ë‹¨ì²´/ê°œì¸ ì•Œë¦¼ ë°œì†¡ ì²˜ë¦¬
     */
    public SendResultResponse send(SendNotificationRequest req) throws FirebaseMessagingException {

        // 1) ëŒ€ìƒ í† í° ìˆ˜ì§‘ (userIds + tokens í•©ì§‘í•©)
        Set<String> targetTokens = new LinkedHashSet<>();



       if (req.userIds() != null && !req.userIds().isEmpty()) {
            // ìœ ì €ë³„ ëª¨ë“  í† í° ì¡°íšŒ
            List<User> users = req.userIds().stream()
                    .map(userQueryService::getUserById)
                    .toList();

            users.forEach(u -> fcmTokenRepository.findAllByUser(u).forEach(t -> targetTokens.add(t.getToken())));
        }

        if (req.tokens() != null && !req.tokens().isEmpty()) targetTokens.addAll(req.tokens());


        if (targetTokens.isEmpty()) {
            return SendResultResponse.builder()
                    .successCount(0).failureCount(0).messageIds(List.of())
                    .build();
        }

        // 2) 500ê°œì”© ì²­í¬ë¡œ ìª¼ê°œ ì „ì†¡
        int success = 0, failure = 0;
        List<String> messageIds = new ArrayList<>();

        for (List<String> chunk : partition(new ArrayList<>(targetTokens), FCM_MULTICAST_LIMIT)) {
            SendResultResponse res = sendToTokens(chunk, req.title(), req.body(), req.url());
            success += res.successCount();
            failure += res.failureCount();
            if (res.messageIds() != null) messageIds.addAll(res.messageIds());
        }

        return SendResultResponse.builder()
                .successCount(success)
                .failureCount(failure)
                .messageIds(messageIds)
                .build();
    }

    /**
     * í—¬í¼
     */
    public SendResultResponse sendToUser(Long userId, String title, String body, String url) throws FirebaseMessagingException {
        User user = userQueryService.getUserById(userId);
        List<String> tokens = fcmTokenRepository.findAllByUser(user).stream().map(FcmToken::getToken).toList();
        return sendToTokens(tokens, title, body, url);
    }

    public SendResultResponse sendToTokens(List<String> tokens, String title, String body, String url) throws FirebaseMessagingException {
        if (tokens == null || tokens.isEmpty()) {
            return SendResultResponse.builder().successCount(0).failureCount(0).messageIds(List.of()).build();
        }

        MulticastMessage msg = MulticastMessage.builder()
                .putData("url", url == null ? "/" : url)
                .setWebpushConfig(WebpushConfig.builder()
                        .setNotification(WebpushNotification.builder()
                                .setTitle(Objects.requireNonNullElse(title, "ì•Œë¦¼"))
                                .setBody(Objects.requireNonNullElse(body, ""))
                                .build())
                        .setFcmOptions(WebpushFcmOptions.withLink(url == null ? "/" : url))
                        .putHeader("TTL", String.valueOf(Duration.ofMinutes(5).toSeconds()))
                        .build())
                .addAllTokens(tokens)
                .build();

        BatchResponse batch = messaging.sendEachForMulticast(msg);

        // ì‹¤íŒ¨ í† í° ì •ë¦¬
        List<String> toDelete = new ArrayList<>();
        List<String> messageIds = new ArrayList<>();

        for (int i = 0; i < batch.getResponses().size(); i++) {
            SendResponse r = batch.getResponses().get(i);
            if (r.isSuccessful()) {
                if (r.getMessageId() != null) {
                    messageIds.add(r.getMessageId());
                }
            } else if (r.getException() instanceof FirebaseMessagingException fme) {
                MessagingErrorCode code = fme.getMessagingErrorCode();
                if (code == MessagingErrorCode.UNREGISTERED || code == MessagingErrorCode.INVALID_ARGUMENT) {
                    toDelete.add(tokens.get(i));
                }
            }
        }
        toDelete.forEach(fcmTokenRepository::deleteByToken);

        // MulticastëŠ” ê°œë³„ messageId ìˆ˜ì§‘ì„ ë³´ì¥í•˜ì§„ ì•Šìœ¼ë‹ˆ ë¹ˆ ë¦¬ìŠ¤íŠ¸ë¡œ ë°˜í™˜(í•„ìš”ì‹œ ì¶”í›„ í™•ì¥)
        return SendResultResponse.builder()
                .successCount(batch.getSuccessCount())
                .failureCount(batch.getFailureCount())
                .messageIds(messageIds)
                .build();
    }

    /**
     *ìœ í‹¸
     */
    private static <T> List<List<T>> partition(List<T> list, int size) {
        if (size <= 0) throw new IllegalArgumentException("size must be > 0");
        int n = list.size();
        List<List<T>> parts = new ArrayList<>((n + size - 1) / size);
        for (int i = 0; i < n; i += size) {
            parts.add(list.subList(i, Math.min(n, i + size)));
        }
        return parts;
    }
}





================================================================================
File Path: .\src\main\java\com\ocean\piuda\notification\service\FcmQueryService.java
================================================================================

package com.ocean.piuda.notification.service;

import com.ocean.piuda.notification.entity.FcmToken;
import com.ocean.piuda.notification.repository.FcmTokenRepository;
import com.ocean.piuda.user.entity.User;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.List;

@Service
@RequiredArgsConstructor
@Transactional(readOnly = true)
public class FcmQueryService {

    private final FcmTokenRepository fcmTokenRepository;

    public List<FcmToken> getByUser(User user) {
        return fcmTokenRepository.findAllByUser(user);
    }
}


================================================================================
File Path: .\src\main\java\com\ocean\piuda\PiudaApplication.java
================================================================================

package com.ocean.piuda;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;

@SpringBootApplication
public class PiudaApplication {

	public static void main(String[] args) {
		SpringApplication.run(PiudaApplication.class, args);
	}

}


================================================================================
File Path: .\src\main\java\com\ocean\piuda\security\jwt\config\PasswordConfig.java
================================================================================

package com.ocean.piuda.security.jwt.config;

import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;
import org.springframework.security.crypto.password.PasswordEncoder;
@Configuration
public class PasswordConfig {

    @Bean
    public PasswordEncoder passwordEncoder() {
        return new BCryptPasswordEncoder();
    }
}


================================================================================
File Path: .\src\main\java\com\ocean\piuda\security\jwt\config\SecurityConfig.java
================================================================================

package com.ocean.piuda.security.jwt.config;

import com.ocean.piuda.security.jwt.util.JwtTokenProvider;
import lombok.RequiredArgsConstructor;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
import org.springframework.security.config.http.SessionCreationPolicy;
import org.springframework.security.web.SecurityFilterChain;
import org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter;
import com.ocean.piuda.security.jwt.enums.Role;
import com.ocean.piuda.security.jwt.filter.JwtAuthenticationFilter;
import com.ocean.piuda.security.jwt.handler.CustomAccessDeniedHandler;
import com.ocean.piuda.security.jwt.handler.CustomAuthenticationEntryPoint;
import com.ocean.piuda.security.jwt.service.CustomUserDetailsService;
import com.ocean.piuda.security.oauth2.handler.OAuth2FailureHandler;
import com.ocean.piuda.security.oauth2.handler.OAuth2SuccessHandler;
import com.ocean.piuda.security.oauth2.service.CustomOAuth2UserService;

import static org.springframework.security.config.Customizer.withDefaults;

@Configuration
@EnableWebSecurity
@RequiredArgsConstructor
public class SecurityConfig {

    private final JwtTokenProvider jwtTokenProvider;
    private final CustomUserDetailsService customUserDetailsService;
    private final CustomOAuth2UserService customOAuth2UserService;
    private final OAuth2SuccessHandler oAuth2SuccessHandler;
    private final OAuth2FailureHandler oAuth2FailureHandler;
    private final CustomAuthenticationEntryPoint authenticationEntryPoint;
    private final CustomAccessDeniedHandler accessDeniedHandler;




    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        http
                .cors(withDefaults())
                .csrf(csrf -> csrf.disable())
                .httpBasic(httpBasic -> httpBasic.disable())
                .formLogin(form -> form.disable())
                .sessionManagement(session -> session
                        .sessionCreationPolicy(SessionCreationPolicy.STATELESS))
                .exceptionHandling(ex -> ex
                        .authenticationEntryPoint(authenticationEntryPoint)
                        .accessDeniedHandler(accessDeniedHandler)
                )
                .authorizeHttpRequests(auth -> auth
                        .requestMatchers("/api/auth/login", "/api/auth/sign-up").permitAll()
                        .requestMatchers("/api/v1/activities").permitAll()
                        .requestMatchers("/api/auth/complete-sign-up/**").hasAuthority(Role.NOT_REGISTERED.getKey())
                        
                        // Admin ì „ìš© API
                        .requestMatchers("/api/admin/**").hasAuthority(Role.ADMIN.getKey())
                        
        // ê·¸ ì™¸ ë¹„ë¡œê·¸ì¸ ì‚¬ìš©ìë„ í—ˆìš©
                        .anyRequest().permitAll()
                )

                // oauth2 ì„¤ì •
                .oauth2Login(oauth -> oauth
                        .userInfoEndpoint(c -> c.userService(customOAuth2UserService)) // ì‚¬ìš©ì ì •ë³´ë¥¼ ì–´ë””ì„œ load í• ì§€ ì„¤ì •
                        .successHandler(oAuth2SuccessHandler) // ë¡œê·¸ì¸ ì„±ê³µ ì‹œ í•¸ë“¤ëŸ¬
                        .failureHandler(oAuth2FailureHandler) // ë¡œê·¸ì¸ ì‹¤íŒ¨ ì‹œ í•¸ë“¤ëŸ¬
                )

                // jwt ì„¤ì •
                .addFilterBefore(new JwtAuthenticationFilter(jwtTokenProvider, customUserDetailsService), UsernamePasswordAuthenticationFilter.class);  // JWT ì¸ì¦ í•„í„° ì¶”ê°€;


        return http.build();
    }


}


================================================================================
File Path: .\src\main\java\com\ocean\piuda\security\jwt\config\WebConfig.java
================================================================================

package com.ocean.piuda.security.jwt.config;

import org.springframework.context.annotation.Configuration;
import org.springframework.web.servlet.config.annotation.CorsRegistry;
import org.springframework.web.servlet.config.annotation.WebMvcConfigurer;

@Configuration
public class WebConfig implements WebMvcConfigurer {

    @Override
    public void addCorsMappings(CorsRegistry registry) {
        registry.addMapping("/**")
                // allowCredentials(true)ì¼ ë•ŒëŠ” allowedOrigins("*") ëŒ€ì‹  allowedOriginPatterns("*")ë¥¼ ì‚¬ìš©í•´ì•¼ í•©ë‹ˆë‹¤.
                .allowedOriginPatterns("*")
                .allowedMethods("GET", "POST", "PUT", "DELETE", "PATCH", "OPTIONS")
                .allowedHeaders("*")
                .allowCredentials(true);
    }

}


================================================================================
File Path: .\src\main\java\com\ocean\piuda\security\jwt\controller\AuthController.java
================================================================================

package com.ocean.piuda.security.jwt.controller;

import com.ocean.piuda.global.api.dto.ApiData;
import com.ocean.piuda.security.jwt.util.TokenCookieFactory;
import io.swagger.v3.oas.annotations.Operation;
import io.swagger.v3.oas.annotations.Parameter;
import io.swagger.v3.oas.annotations.security.SecurityRequirement;
import io.swagger.v3.oas.annotations.tags.Tag;
import jakarta.servlet.http.HttpServletResponse;
import lombok.RequiredArgsConstructor;
import org.springframework.http.HttpHeaders;
import org.springframework.http.ResponseCookie;
import org.springframework.http.ResponseEntity;
import org.springframework.security.core.annotation.AuthenticationPrincipal;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;
import com.ocean.piuda.security.jwt.dto.request.SignUpRequestDto;
import com.ocean.piuda.security.jwt.dto.request.UserUpdateRequestDto;
import com.ocean.piuda.security.jwt.dto.request.UsernameLoginRequestDto;
import com.ocean.piuda.security.jwt.dto.response.SignUpResponseDto;
import com.ocean.piuda.security.jwt.dto.response.TokenResponseDto;
import com.ocean.piuda.security.jwt.service.AuthService;
import com.ocean.piuda.security.oauth2.principal.PrincipalDetails;

@Tag(name = "Auth API", description = "ìœ ì € ë° íšŒì›ê°€ì… ê´€ë ¨ API")
@RestController
@RequestMapping("/api/auth")
@RequiredArgsConstructor
public class AuthController {

    private final AuthService authService;
    private final TokenCookieFactory tokenCookieFactory;


    /** ìì²´ íšŒì›ê°€ì… ìœ ì €ì˜ ë¡œê·¸ì¸ (ê³µê°œ) */
    @PostMapping("/login")
    @Operation(summary = "ë¡œê·¸ì¸", description = "ìì²´ íšŒì›ê°€ì… ìœ ì €ì˜ ì•„ì´ë””/ë¹„ë°€ë²ˆí˜¸ ë¡œê·¸ì¸")
    public ApiData<TokenResponseDto> usernameLogin(
            @io.swagger.v3.oas.annotations.parameters.RequestBody(
                    description = "ë¡œê·¸ì¸ ìš”ì²­ ë°”ë””", required = true
            )
            @RequestBody UsernameLoginRequestDto request,
            HttpServletResponse response
    ) {
        TokenResponseDto dto = authService.usernameLogin(request); // ì„œë¹„ìŠ¤ëŠ” í† í°ë§Œ ìƒì„±/ê²€ì¦
        ResponseCookie cookie = tokenCookieFactory.buildAccessTokenCookie(dto.getAccess());
        response.addHeader(HttpHeaders.SET_COOKIE, cookie.toString());
        return ApiData.ok(dto);
    }

    /** ìì²´ íšŒì› ê°€ì… (1ì°¨, ê³µê°œ) */
    @Operation(summary = "ìì²´ íšŒì›ê°€ì… 1ë‹¨ê³„", description = "ìì²´ ë¡œê·¸ì¸ ê¸°ë°˜ íšŒì›ê°€ì… 1ë‹¨ê³„ ìˆ˜í–‰")
    @PostMapping("/sign-up")
    public ApiData<SignUpResponseDto> signup(
            @io.swagger.v3.oas.annotations.parameters.RequestBody(
                    description = "íšŒì›ê°€ì… ìš”ì²­ ë°”ë””", required = true
            )
            @RequestBody SignUpRequestDto requestDto
    ) {
        SignUpResponseDto responseDto = authService.signup(requestDto);
        return ApiData.created(responseDto);
    }

    /** ROLE_USER ìµœì¢…(2ì°¨) íšŒì›ê°€ì… (ë³´í˜¸) */
    @PostMapping("/complete-sign-up/user")
    @Operation(summary = "íšŒì›ê°€ì… 2ë‹¨ê³„(ì¼ë°˜ ì‚¬ìš©ì)", description = "ì¼ë°˜ ì‚¬ìš©ìì— ëŒ€í•œ ìµœì¢… íšŒì›ê°€ì… ì™„ë£Œ")
    @SecurityRequirement(name = "bearerAuth")
    public ApiData<Void> completeUserSignup(
            @Parameter(hidden = true)
            @AuthenticationPrincipal PrincipalDetails principal,
            @io.swagger.v3.oas.annotations.parameters.RequestBody(
                    description = "íšŒì›ê°€ì… 2ë‹¨ê³„ ìš”ì²­ ë°”ë””", required = true
            )
            @RequestBody UserUpdateRequestDto requestDto
    ) {
        authService.completeUserSignup(principal.getUser().getId(), requestDto);
        return ApiData.created(null);
    }

    /** ë¡œê·¸ì•„ì›ƒ */
    @PostMapping("/logout")
    @Operation(summary = "ë¡œê·¸ì•„ì›ƒ", description = "ì‚¬ìš©ì ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬. Access Token ì¿ í‚¤ë¥¼ ì‚­ì œí•©ë‹ˆë‹¤.")
    @SecurityRequirement(name = "bearerAuth")
    public ResponseEntity<ApiData<Void>> logout(
            @Parameter(hidden = true)
            @AuthenticationPrincipal PrincipalDetails principal,
            HttpServletResponse response
    ) {
        // ì¿ í‚¤ ì‚­ì œ
        ResponseCookie logoutCookie = tokenCookieFactory.buildLogoutCookie();
        response.addHeader(HttpHeaders.SET_COOKIE, logoutCookie.toString());
        
        return ResponseEntity.ok(ApiData.ok(null));
    }

}


================================================================================
File Path: .\src\main\java\com\ocean\piuda\security\jwt\dto\request\SignUpRequestDto.java
================================================================================

package com.ocean.piuda.security.jwt.dto.request;


import com.ocean.piuda.security.jwt.enums.Role;
import com.ocean.piuda.user.entity.User;
import lombok.*;

/**
 * ìì²´ íšŒì›ê°€ì…ì„ ìœ„í•œ dto
 */
@Getter
@Setter
@NoArgsConstructor
@AllArgsConstructor
@Builder
public class SignUpRequestDto {
    private String username;
    private String password;

    public User toEntity() {
        return User.builder()
                .username(username)
                .password(password)
                .role(Role.NOT_REGISTERED) // OAuth2 íšŒì›ê°€ì…ê³¼ ë§ˆì°¬ê°€ì§€ë¡œ, ì²˜ìŒ ê¸°ë³¸ ì •ë³´ë§Œìœ¼ë¡œëŠ” ì™„ì „í•œ íšŒì›ê°€ì… ì²˜ë¦¬ ì‹œí‚¤ì§„ ì•ŠìŒ
                .build();
    }
}


================================================================================
File Path: .\src\main\java\com\ocean\piuda\security\jwt\dto\request\UsernameLoginRequestDto.java
================================================================================

package com.ocean.piuda.security.jwt.dto.request;

import lombok.*;


/**
 * ìì²´ ë¡œê·¸ì¸ì„ ìœ„í•œ dto
 */
@Getter
@Setter
@NoArgsConstructor
@AllArgsConstructor
@Builder
public class UsernameLoginRequestDto {
    private String username;
    private String password;
}


================================================================================
File Path: .\src\main\java\com\ocean\piuda\security\jwt\dto\request\UserUpdateRequestDto.java
================================================================================

package com.ocean.piuda.security.jwt.dto.request;

import lombok.*;


/**
 * ë¶€ê°€ì ì¸ ì •ë³´ì˜ ì—…ë°ì´íŠ¸ë¥¼ ìœ„í•œ dto
 */
@Getter
@Setter
@NoArgsConstructor
@AllArgsConstructor
@Builder
public class UserUpdateRequestDto {
    private String nickname;
    private String email;
    private String phone;
}


================================================================================
File Path: .\src\main\java\com\ocean\piuda\security\jwt\dto\response\SignUpResponseDto.java
================================================================================

package com.ocean.piuda.security.jwt.dto.response;

import lombok.Builder;
import lombok.Getter;
import com.ocean.piuda.user.entity.User;

@Getter
@Builder
public class SignUpResponseDto {
    private Long id;
    private String username;

    public static SignUpResponseDto fromEntity(User user) {
        return SignUpResponseDto.builder()
                .id(user.getId())
                .username(user.getUsername())
                .build();
    }
}


================================================================================
File Path: .\src\main\java\com\ocean\piuda\security\jwt\dto\response\TokenResponseDto.java
================================================================================

package com.ocean.piuda.security.jwt.dto.response;

import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Getter;

@Getter
@AllArgsConstructor
@Builder
public class TokenResponseDto {
    private String access;
}


================================================================================
File Path: .\src\main\java\com\ocean\piuda\security\jwt\dto\response\UsernameLoginResponseDto.java
================================================================================

package com.ocean.piuda.security.jwt.dto.response;


import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Getter;



/**
 * ìì²´ ë¡œê·¸ì¸ì„ ìœ„í•œ dto
 */
@Getter
@AllArgsConstructor
@Builder
public class UsernameLoginResponseDto {
    private String access;
}


================================================================================
File Path: .\src\main\java\com\ocean\piuda\security\jwt\enums\Role.java
================================================================================

package com.ocean.piuda.security.jwt.enums;

import lombok.Getter;
import lombok.RequiredArgsConstructor;

@Getter
@RequiredArgsConstructor
public enum Role {

    /**
     * NOT_REGISTERED ì´ë©´ -> íšŒì›ê°€ì… í˜ì´ì§€ë¡œ redirect
     * NOT_REGISTEREDê°€ ì•„ë‹ˆë©´ -> ì„œë¹„ìŠ¤ í˜ì´ì§€ë¡œ redirect
     */
    NOT_REGISTERED("ROLE_NOT_REGISTERED", "íšŒì›ê°€ì… ì´ì „ ìœ ì €"),
    USER("ROLE_USER", "íšŒì›ê°€ì… ì™„ë£Œëœ ì¼ë°˜ ìœ ì €"),
    DIVER("ROLE_DIVER", "íšŒì›ê°€ì… ì™„ë£Œëœ ë‹¤ì´ë²„ ìœ ì €"),
    RESEARCHER("ROLE_RESEARCHER", "íšŒì›ê°€ì… ì™„ë£Œëœ ì—°êµ¬ì› ìœ ì €"),
    ADMIN("ROLE_ADMIN", "ì• í”Œë¦¬ì¼€ì´ì…˜ ê´€ë¦¬ì");

    private final String key;
    private final String title;
}


================================================================================
File Path: .\src\main\java\com\ocean\piuda\security\jwt\filter\JwtAuthenticationFilter.java
================================================================================

package com.ocean.piuda.security.jwt.filter;



import jakarta.servlet.FilterChain;
import jakarta.servlet.ServletException;
import jakarta.servlet.http.Cookie;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.web.filter.OncePerRequestFilter;
import com.ocean.piuda.security.jwt.service.CustomUserDetailsService;
import com.ocean.piuda.security.jwt.util.JwtTokenProvider;
import com.ocean.piuda.security.oauth2.principal.PrincipalDetails;

import java.io.IOException;


@RequiredArgsConstructor
@Slf4j
public class JwtAuthenticationFilter extends OncePerRequestFilter {

    private final JwtTokenProvider jwtTokenProvider;
    private final CustomUserDetailsService customUserDetailsService;


    @Override
    protected void doFilterInternal(HttpServletRequest request, HttpServletResponse response, FilterChain chain)
            throws ServletException, IOException {

        String token = JwtTokenProvider.extractToken(request.getHeader("Authorization"));  // JWT í† í° ì¶”ì¶œ

        log.debug("[JwtAuthenticationFilter] token: {}", token);

        // ì¿ í‚¤ì—ì„œ ACCESS_TOKEN ì°¾ê¸° (oauth2 ë¦¬ë‹¤ì´ë ‰íŠ¸ ì‹œ ì¿ í‚¤ì— access token ì €ì¥)
        if (token == null) {
            if (request.getCookies() != null) {
                for (Cookie c : request.getCookies()) {
                    if ("ACCESS_TOKEN".equals(c.getName())) {
                        token = c.getValue();
                        break;
                    }
                }
            }
        }

        // ì„ì‹œ/ì •ì‹ access í† í°ì´ ì¡´ì¬í•˜ê³  ìœ íš¨í•œ ê²½ìš°
        if (token != null && jwtTokenProvider.isValidToken(token)) {
            Long id =jwtTokenProvider.extractId(token);  // JWTì—ì„œ ì‚¬ìš©ìëª… ì¶”ì¶œ

            log.debug("[JwtAuthenticationFilter] deviceId from token: {}", id);

            // UserDetailsService ë¥¼ í†µí•´ ì‚¬ìš©ì ì •ë³´ ë¡œë“œ
            PrincipalDetails userDetails = (PrincipalDetails) customUserDetailsService.loadUserById(id);

            // ì¸ì¦ ê°ì²´ ìƒì„± ë° SecurityContextì— ì„¤ì •
            UsernamePasswordAuthenticationToken authentication =
                    new UsernamePasswordAuthenticationToken(userDetails, null, userDetails.getAuthorities());

            SecurityContextHolder.getContext().setAuthentication(authentication);
        }

        chain.doFilter(request, response);
    }


}


================================================================================
File Path: .\src\main\java\com\ocean\piuda\security\jwt\handler\CustomAccessDeniedHandler.java
================================================================================

package com.ocean.piuda.security.jwt.handler;


import com.fasterxml.jackson.databind.ObjectMapper;
import com.ocean.piuda.global.api.dto.ApiData;
import com.ocean.piuda.global.api.exception.ExceptionType;
import jakarta.servlet.ServletException;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import org.springframework.security.access.AccessDeniedException;
import org.springframework.security.web.access.AccessDeniedHandler;
import org.springframework.stereotype.Component;

import java.io.IOException;

/**
 * ë¡œê·¸ì¸ì€ í–ˆì§€ë§Œ ê¶Œí•œì´ ë¶€ì¡±í•˜ì—¬ ì ‘ê·¼ íŠ•ê¸¸ë•Œì˜ ì²˜ë¦¬ ë‹´ë‹¹
 * (ì˜ˆ: NOT_REGISTERED ê¶Œí•œ ì‚¬ìš©ìê°€ USER ê¶Œí•œ path ì ‘ê·¼ ì‹œë„í•˜ì—¬ ì˜ˆì™¸ ë°œìƒ )
 *
 */
@Component
public class CustomAccessDeniedHandler implements AccessDeniedHandler {
    private final ObjectMapper objectMapper = new ObjectMapper();

    @Override
    public void handle(HttpServletRequest request,
                       HttpServletResponse response,
                       AccessDeniedException accessDeniedException) throws IOException, ServletException {

        ApiData<?> apiData = ApiData.error(ExceptionType.ACCESS_DENIED);

        response.setStatus(HttpServletResponse.SC_FORBIDDEN);
        response.setContentType("application/json;charset=UTF-8");

        response.getWriter().write(objectMapper.writeValueAsString(apiData));
    }
}


================================================================================
File Path: .\src\main\java\com\ocean\piuda\security\jwt\handler\CustomAuthenticationEntryPoint.java
================================================================================

package com.ocean.piuda.security.jwt.handler;

import com.fasterxml.jackson.databind.ObjectMapper;
import com.ocean.piuda.global.api.dto.ApiData;
import com.ocean.piuda.global.api.exception.ExceptionType;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import org.springframework.security.core.AuthenticationException;
import org.springframework.security.web.AuthenticationEntryPoint;
import org.springframework.stereotype.Component;

import java.io.IOException;

/**
 * ë¡œê·¸ì¸ ì¡°ì°¨ ì•ˆí•œ ìƒíƒœì—ì„œ ì ‘ê·¼ íŠ•ê¸¸ë•Œì˜ ì²˜ë¦¬ ë‹´ë‹¹
 */
@Component
public class CustomAuthenticationEntryPoint implements AuthenticationEntryPoint {

    private final ObjectMapper objectMapper = new ObjectMapper();

    @Override
    public void commence(HttpServletRequest request, HttpServletResponse response,
                         AuthenticationException authException) throws IOException {


        ApiData<?> apiData = ApiData.error(ExceptionType.ACCESS_DENIED);

        response.setStatus(HttpServletResponse.SC_UNAUTHORIZED);
        response.setContentType("application/json;charset=UTF-8");

        response.getWriter().write(objectMapper.writeValueAsString(apiData));

    }
}


================================================================================
File Path: .\src\main\java\com\ocean\piuda\security\jwt\principal\CustomUserDetails.java
================================================================================

package com.ocean.piuda.security.jwt.principal;


/**
 * ìì²´ë¡œê·¸ì¸ë§Œì„ ìœ„í•œ principal êµ¬í˜„ì²´,
 * PrincipalDetails( ìì²´ë¡œê·¸ì¸ + oauth2 ) ë¡œ í‰ì¹©ë‹ˆë‹¤.
 */
//@Getter
//@Builder
//public class CustomUserDetails implements UserDetails {
//    private final User user;
//    private final Collection<? extends GrantedAuthority> authorities;
//
//    public CustomUserDetails(User user) {
//        this.user = user;
//        this.authorities = List.of(new SimpleGrantedAuthority(user.getRole().getKey()));
//    }
//
//    @Override
//    public String getUsername() {
//        return user.getUsername();
//    }
//
//    @Override
//    public String getPassword() {
//        return user.getPassword();
//    }
//
//    @Override public boolean isAccountNonExpired() { return true; }
//    @Override public boolean isAccountNonLocked() { return true; }
//    @Override public boolean isCredentialsNonExpired() { return true; }
//    @Override public boolean isEnabled() { return true; }
//
//}
//
//


================================================================================
File Path: .\src\main\java\com\ocean\piuda\security\jwt\service\AuthService.java
================================================================================

package com.ocean.piuda.security.jwt.service;

import com.ocean.piuda.global.api.exception.BusinessException;
import com.ocean.piuda.global.api.exception.ExceptionType;
import lombok.RequiredArgsConstructor;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;
import com.ocean.piuda.user.entity.User;
import com.ocean.piuda.user.repository.UserRepository;
import com.ocean.piuda.security.jwt.dto.request.SignUpRequestDto;
import com.ocean.piuda.security.jwt.dto.request.UserUpdateRequestDto;
import com.ocean.piuda.security.jwt.dto.request.UsernameLoginRequestDto;
import com.ocean.piuda.security.jwt.dto.response.SignUpResponseDto;
import com.ocean.piuda.security.jwt.dto.response.TokenResponseDto;
import com.ocean.piuda.security.jwt.enums.Role;
import com.ocean.piuda.security.jwt.util.JwtTokenProvider;


@Transactional
@Service
@RequiredArgsConstructor
public class AuthService {


    private final UserRepository userRepository;
    private final JwtTokenProvider jwtTokenProvider;
    private final PasswordEncoder passwordEncoder;



    /**
     * username, pw ë¥¼ í†µí•œ ìì²´ ë¡œê·¸ì¸ ë¡œì§
     * @param request
     * @return
     */
    public TokenResponseDto usernameLogin(UsernameLoginRequestDto request) {

        /**
         * ìœ íš¨í•œ username, pw ì„ í†µí•œ ë¡œê·¸ì¸ì¸ì§€ í™•ì¸
         * access token ì‹ ê·œ ë°œê¸‰
         */
        User user = userRepository.findByUsername(request.getUsername())
                .orElseThrow(() -> new BusinessException(ExceptionType.USER_NOT_FOUND));

        // db ì— ì´ë¯¸ ì•”í˜¸í™”ëœ í˜•íƒœë¡œ ì €ì¥ë˜ìˆê¸°ì— request ì— ë‹´ê¸´ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì•”í˜¸í™” í•˜ì—¬ ë¹„êµ ìˆ˜í–‰
        if (!passwordEncoder.matches(request.getPassword(), user.getPassword())) {
            throw new BusinessException(ExceptionType.PASSWORD_NOT_MATCHED);
        }

        /**
         * ìµœì¢… íšŒì› ê°€ì…ê¹Œì§€ ì™„ë£Œëœ ì‚¬ìš©ìê°€ ì•„ë‹Œ ê²½ìš° "ì„ì‹œ" access token ë°œê¸‰
         * ìµœì¢… íšŒì› ê°€ì…ê¹Œì§€ ì™„ë£Œëœ ì‚¬ìš©ìì¸ ê²½ìš° "ì •ì‹" access token ë°œê¸‰
         */
        return TokenResponseDto.builder()
                .access(issueTokensFor(user.getId()))
                .build();
    }




    /**
     * íŠ¹ì • ìœ ì €ì— ëŒ€í•œ ì„ì‹œ/ì •ì‹ access token ë°œê¸‰
     * @return
     */
    public String issueTokensFor(Long userId) {
        return jwtTokenProvider.generateAccessToken(userId);
    }





    public SignUpResponseDto signup(SignUpRequestDto request) {
        if (userRepository.findByUsername(request.getUsername()).isPresent()) {
            throw new BusinessException(ExceptionType.DUPLICATED_USERNAME);
        }

        // ë¹„ë°€ë²ˆí˜¸ ì•”í˜¸í™” ë° ì €ì¥
        request.setPassword(passwordEncoder.encode(request.getPassword()));
        User user = request.toEntity();
        user = userRepository.save(user);

        return SignUpResponseDto.fromEntity(user);
    }

    public SignUpResponseDto completeUserSignup(Long userId, UserUpdateRequestDto request) {
        User user = findAndUpdateUserForCompleteSignup(userId,request);
        user.updateRole(Role.USER);// USER ê¶Œí•œìœ¼ë¡œ ìŠ¹ê²©
        return SignUpResponseDto.fromEntity(user);
    }



    private User findAndUpdateUserForCompleteSignup(Long userId, UserUpdateRequestDto request){
        User user = userRepository
                .findById(userId)
                .orElseThrow(()->new BusinessException(ExceptionType.USER_NOT_FOUND));

        if (user.getRole() != Role.NOT_REGISTERED) {
            throw new BusinessException(ExceptionType.ALREADY_REGISTERED_USER);
        }

        // ìµœì¢… íšŒì› ê°€ì…ì„ ìœ„í•œ ì¶”ê°€ ì‘ì—… ì •ì˜
        user.update(request);
        return user;


    }





}


================================================================================
File Path: .\src\main\java\com\ocean\piuda\security\jwt\service\CustomUserDetailsService.java
================================================================================

package com.ocean.piuda.security.jwt.service;




import com.ocean.piuda.global.api.exception.BusinessException;
import com.ocean.piuda.global.api.exception.ExceptionType;
import com.ocean.piuda.user.entity.User;
import com.ocean.piuda.user.repository.UserRepository;
import lombok.RequiredArgsConstructor;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.security.core.userdetails.UserDetailsService;
import org.springframework.security.core.userdetails.UsernameNotFoundException;
import org.springframework.stereotype.Service;
import com.ocean.piuda.security.oauth2.principal.PrincipalDetails;


@RequiredArgsConstructor
@Service
public class CustomUserDetailsService implements UserDetailsService {

    private final UserRepository userRepository;

    // ì‚¬ì‹¤ìƒ ì–˜ë§Œ í˜„ì¬ ì‚¬ìš©
    public UserDetails loadUserById(Long id) {
        User user = userRepository.findById(id)
                .orElseThrow(() -> new BusinessException(ExceptionType.USER_NOT_FOUND));
        return new PrincipalDetails(user);
    }

    // í•„ìˆ˜ override
    @Override
    public UserDetails loadUserByUsername(String username) throws UsernameNotFoundException {
        User user = userRepository.findByUsername(username)
                .orElseThrow(() -> new BusinessException(ExceptionType.USER_NOT_FOUND));
        return new PrincipalDetails(user);
    }
}


================================================================================
File Path: .\src\main\java\com\ocean\piuda\security\jwt\service\TokenUserService.java
================================================================================

package com.ocean.piuda.security.jwt.service;


import com.ocean.piuda.global.api.exception.BusinessException;
import com.ocean.piuda.global.api.exception.ExceptionType;
import com.ocean.piuda.security.jwt.enums.Role;
import lombok.RequiredArgsConstructor;
import org.springframework.security.core.Authentication;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.stereotype.Service;
import com.ocean.piuda.security.oauth2.principal.PrincipalDetails;
import com.ocean.piuda.user.entity.User;

/**
 * ì‹œíë¦¬í‹° ì»¨í…ìŠ¤íŠ¸ì—ì„œ í˜„ì¬ ì¸ì¦ëœ ì‚¬ìš©ì ì •ë³´ë¥¼ ì¡°íšŒí•˜ëŠ” ì„œë¹„ìŠ¤
 */
@Service
@RequiredArgsConstructor
public class TokenUserService {

    /**
     * í˜„ì¬ ì¸ì¦ëœ ì‚¬ìš©ìì˜ User ì—”í‹°í‹°ë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤.
     */
    public User getCurrentUser() {
        Authentication authentication = SecurityContextHolder.getContext().getAuthentication();

        if (authentication == null || !authentication.isAuthenticated()) {
            throw new BusinessException(ExceptionType.UNAUTHORIZED_USER);
        }

        Object principal = authentication.getPrincipal();

        if (!(principal instanceof PrincipalDetails principalDetails)) {
            throw new BusinessException(ExceptionType.UNAUTHORIZED_USER);
        }

        return principalDetails.getUser();
    }



    /**
     * í˜„ì¬ ì¸ì¦ëœ ì‚¬ìš©ìì˜ IDë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤.
     */
    public Long getCurrentUserId() {
        return getCurrentUser().getId();
    }



    /**
     * í˜„ì¬ ì¸ì¦ëœ ì‚¬ìš©ìì˜ IDë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤.
     */
    public Role getCurrentUserRole() {
        return getCurrentUser().getRole();
    }



    /**
     * í˜„ì¬ ì‚¬ìš©ìê°€ ì¸ì¦ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.
     *
     * @return ì¸ì¦ëœ ê²½ìš° true, ê·¸ë ‡ì§€ ì•Šìœ¼ë©´ false
     */
    public boolean isAuthenticated() {
        try {
            getCurrentUser();
            return true;
        } catch (Exception e) {
            return false;
        }
    }

}


================================================================================
File Path: .\src\main\java\com\ocean\piuda\security\jwt\util\JwtTokenProvider.java
================================================================================

package com.ocean.piuda.security.jwt.util;


import io.jsonwebtoken.Claims;
import io.jsonwebtoken.JwtException;
import io.jsonwebtoken.Jwts;
import io.jsonwebtoken.security.Keys;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Component;

import javax.crypto.SecretKey;
import java.nio.charset.StandardCharsets;
import java.time.LocalDateTime;
import java.time.ZoneId;
import java.util.Date;


@Component
public class JwtTokenProvider {

    @Value("${jwt.secret}")
    private String secretKey;

    @Value("${jwt.expiration.access}")
    private long accessTokenExpiration;




    // string key ê¸°ë°˜ key ê°ì²´ ìƒì„±
    private SecretKey getSigningKey() {
        return Keys.hmacShaKeyFor(secretKey.getBytes(StandardCharsets.UTF_8));
    }


    // AccessToken ìƒì„±
    public String generateAccessToken(Long userId) {
        Date now = new Date();
        Date expiry = new Date(now.getTime() + accessTokenExpiration);
        return Jwts.builder()
                .subject(String.valueOf(userId))
                .issuedAt(now)
                .expiration(expiry)
                .signWith(getSigningKey())
                .compact();
    }




    public static String extractToken(String bearerToken) {
        return bearerToken != null && bearerToken.toLowerCase().startsWith("bearer ")
                ? bearerToken.substring(7)
                : null;
    }

    // claims íŒŒì„œ
    private Claims parseClaims(String token) {
        return Jwts.parser()
                .verifyWith(getSigningKey())
                .build()
                .parseSignedClaims(token) // ìœ íš¨ì„± ê²€ì¦ ë° íŒŒì‹±
                .getPayload();
    }

    public boolean isValidToken(String token) {
        try {
            parseClaims(token); // ì„±ê³µ ì‹œ ìœ íš¨
            return true;
        } catch (JwtException | IllegalArgumentException e) {
            return false;
        }
    }
    /**
     * claim ì—ì„œ íŠ¹ì • ì •ë³´ ì¶”ì¶œí•˜ëŠ” ë©”ì„œë“œë“¤
     * @param token
     */
    public Long extractId(String token) { return Long.parseLong(parseClaims(token).getSubject()); }

    public LocalDateTime extractExpiration(String token) {
        Date expiration = parseClaims(token).getExpiration();
        return expiration.toInstant()
                .atZone(ZoneId.systemDefault())
                .toLocalDateTime();
    }







}


================================================================================
File Path: .\src\main\java\com\ocean\piuda\security\jwt\util\TokenCookieFactory.java
================================================================================

package com.ocean.piuda.security.jwt.util;

import lombok.RequiredArgsConstructor;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.http.ResponseCookie;
import org.springframework.stereotype.Component;
import org.springframework.util.StringUtils;

import java.time.Duration;
import java.time.LocalDateTime;
import java.time.ZoneId;

@Component
@RequiredArgsConstructor
public class TokenCookieFactory {
    private final JwtTokenProvider jwtTokenProvider;
    private static final String ACCESS_TOKEN_COOKIE = "ACCESS_TOKEN";
    // í™˜ê²½ë³„ ì„¤ì • (prod/dev ë¶„ë¦¬)
    @Value("${app.cookie.domain:}")        // ì˜ˆ: jungjiyu.com  (ì•ì— ì  ë¶™ì´ì§€ ë§ ê²ƒ!)
    private String cookieDomain;

    @Value("${app.cookie.secure:true}")    // prod: true, dev(http): false
    private boolean cookieSecure;

    @Value("${app.cookie.same-site:None}") // prod: None, dev: Lax
    private String cookieSameSite;

    public ResponseCookie buildAccessTokenCookie(String accessToken) {
        ResponseCookie.ResponseCookieBuilder b = ResponseCookie
                .from(ACCESS_TOKEN_COOKIE, accessToken)
                .httpOnly(true)
                .secure(cookieSecure)
                .sameSite(cookieSameSite)  // PWA ì´ìŠˆ íšŒí”¼: None + Secure
                .path("/")
                .maxAge(computeMaxAgeSeconds(accessToken));

        if (StringUtils.hasText(cookieDomain)) {
            // "jungjiyu.com" ìœ¼ë¡œ ë„£ì–´ì•¼ í•¨ (".jungjiyu.com" ê¸ˆì§€)
            b = b.domain(cookieDomain);
        }
        return b.build();
    }

    public ResponseCookie deleteAccessTokenCookie() {
        ResponseCookie.ResponseCookieBuilder b = ResponseCookie
                .from(ACCESS_TOKEN_COOKIE, "")
                .httpOnly(true)
                .secure(cookieSecure)
                .sameSite(cookieSameSite)
                .path("/")
                .maxAge(0);

        if (StringUtils.hasText(cookieDomain)) {
            b = b.domain(cookieDomain);
        }
        return b.build();
    }


    private long computeMaxAgeSeconds(String accessToken) {
        try {
            LocalDateTime exp = jwtTokenProvider.extractExpiration(accessToken);
            long seconds = Duration.between(LocalDateTime.now(ZoneId.systemDefault()), exp).getSeconds();
            return Math.max(seconds, 1L); // ìŒìˆ˜/0 ë°©ì§€
        } catch (Exception e) {
            return Duration.ofHours(1).getSeconds();  // ë³´ìˆ˜ì ìœ¼ë¡œ 1ì‹œê°„ë¡œ ì„¤ì •
        }
    }

    /**
     * ë¡œê·¸ì•„ì›ƒìš© ì¿ í‚¤ ì‚­ì œ (maxAge=0)
     */
    public ResponseCookie buildLogoutCookie() {
        return ResponseCookie.from(ACCESS_TOKEN_COOKIE, "")
                .httpOnly(true)
                .sameSite("None")
                .secure(true)
                .path("/")
                .maxAge(0)  // ì¦‰ì‹œ ì‚­ì œ
                .build();
    }

}


================================================================================
File Path: .\src\main\java\com\ocean\piuda\security\oauth2\enums\ProviderType.java
================================================================================

package com.ocean.piuda.security.oauth2.enums;

import java.util.Arrays;

public enum ProviderType {
    KAKAO,
    NAVER,
    GOOGLE;

    public static ProviderType from(String provider) {
        String upperCastedProvider = provider.toUpperCase();

        return Arrays.stream(ProviderType.values())
                .filter(item -> item.name().equals(upperCastedProvider))
                .findFirst()
                .orElseThrow();
    }


}


================================================================================
File Path: .\src\main\java\com\ocean\piuda\security\oauth2\handler\OAuth2FailureHandler.java
================================================================================

package com.ocean.piuda.security.oauth2.handler;

import jakarta.servlet.ServletException;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.security.core.AuthenticationException;
import org.springframework.security.web.authentication.SimpleUrlAuthenticationFailureHandler;
import org.springframework.stereotype.Component;
import org.springframework.web.util.UriComponentsBuilder;

import java.io.IOException;

@Component
public class OAuth2FailureHandler extends SimpleUrlAuthenticationFailureHandler {
    @Value("${oauth2.url.base}")
    private String BASE_URL;

    private final String ERROR_PARAM_PREFIX = "error";


    @Override
    public void onAuthenticationFailure(HttpServletRequest request, HttpServletResponse response,
                                        AuthenticationException exception) throws IOException, ServletException {
        // ë¦¬ë‹¤ì´ë ‰íŠ¸í•  ì£¼ì†Œ ìƒì„±, query stringì— ì—ëŸ¬ ë©”ì„¸ì§€ ì¶”ê°€
        String redirectUrl = UriComponentsBuilder.fromUriString(BASE_URL)
                .queryParam(ERROR_PARAM_PREFIX, exception.getLocalizedMessage())
                .build()
                .toUriString();

        getRedirectStrategy().sendRedirect(request, response, redirectUrl);
    }
}


================================================================================
File Path: .\src\main\java\com\ocean\piuda\security\oauth2\handler\OAuth2SuccessHandler.java
================================================================================

package com.ocean.piuda.security.oauth2.handler;

import com.ocean.piuda.security.jwt.util.TokenCookieFactory;
import com.ocean.piuda.user.entity.User;
import jakarta.servlet.ServletException;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import lombok.Getter;
import lombok.RequiredArgsConstructor;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.http.HttpHeaders;
import org.springframework.http.ResponseCookie;
import org.springframework.security.core.Authentication;
import org.springframework.security.web.authentication.SimpleUrlAuthenticationSuccessHandler;
import org.springframework.stereotype.Component;
import org.springframework.web.util.UriComponentsBuilder;
import com.ocean.piuda.security.jwt.enums.Role;
import com.ocean.piuda.security.jwt.service.AuthService;
import com.ocean.piuda.security.jwt.util.JwtTokenProvider;
import com.ocean.piuda.security.oauth2.principal.PrincipalDetails;

import java.io.IOException;
import java.time.Duration;
import java.time.LocalDateTime;
import java.time.ZoneId;

@Getter
@Component
@RequiredArgsConstructor
public class OAuth2SuccessHandler extends SimpleUrlAuthenticationSuccessHandler {
    @Value("${oauth2.url.base}")
    private String BASE_URL;

    @Value("${oauth2.url.path.signup}")
    private String SIGNUP_PATH;

    @Value("${oauth2.url.path.auth}")
    private String AUTH_PATH;


    private final AuthService authService;
    private final JwtTokenProvider jwtTokenProvider;
    private final TokenCookieFactory tokenCookieFactory;


    @Override
    public void onAuthenticationSuccess(HttpServletRequest request, HttpServletResponse response,
                                        Authentication authentication) throws IOException, ServletException {

        PrincipalDetails principalDetails = (PrincipalDetails) authentication.getPrincipal();

        User user = principalDetails.getUser();

        // ì•¡ì„¸ìŠ¤ í† í° ë°œê¸‰
        String accessToken = authService.issueTokensFor(user.getId());

        /**
         * access token ì„ ì¿ í‚¤ë¡œ ì „ë‹¬
         */
        ResponseCookie cookie = tokenCookieFactory.buildAccessTokenCookie(accessToken);
        response.addHeader(HttpHeaders.SET_COOKIE, cookie.toString());

        // ë¦¬ë‹¤ì´ë ‰íŠ¸ URL ìƒì„±
        String redirectUrl = getRedirectUrlByRole(user);

        getRedirectStrategy().sendRedirect(request, response, redirectUrl);

    }



    private String getRedirectUrlByRole(User user) {
        Role role = user.getRole();
        Long userId = user.getId();


        /**
         * ìµœì¢… íšŒì›ê°€ì… ì´ì „ì˜ ì‚¬ìš©ìì— ëŒ€í•œ ë¦¬ë‹¤ì´ë ‰íŠ¸
         * ì—¬ê¸°ê¹Œì§€ ì™”ëŠ”ë° íšŒì›ê°€ì… ë˜ì§€ ì•Šì•˜ë‹¤ì˜ ì˜ë¯¸ : provider ìƒì— ë“±ë¡ ì™„ë£Œë¬ê³ , ìš°ë¦¬ dbì— ì €ì¥ê¹Œì§€ ë¬ëŠ”ë° ì¶”ê°€ì ì¸ ë¶€ê°€ì •ë³´ë¥¼ ì…ë ¥í•˜ì§€ ì•Šì•„ ìš°ë¦¬ ì• í”Œë¦¬ì¼€ì´ì…˜ ìƒì—ì„œ ìµœì¢… íšŒì›ê°€ì… ì™„ë£ŒëŠ” ì•ˆëœ ìƒíƒœ
         */
        if (role == Role.NOT_REGISTERED) {
            return UriComponentsBuilder
                    .fromUriString(BASE_URL + SIGNUP_PATH) // fromUriString -> ìƒëŒ€ê²½ë¡œ í¬í•¨ ê°€ëŠ¥
                    .queryParam("id", userId)
                    .build()
                    .toUriString();
        }

        /**
         * ìµœì¢… íšŒì›ê°€ì…ëœ ì‚¬ìš©ìì— ëŒ€í•œ ë¦¬ë‹¤ì´ë ‰íŠ¸
         */
        return UriComponentsBuilder
                .fromHttpUrl(BASE_URL + AUTH_PATH) // fromHttpUrl() -> ì ˆëŒ€ ê²½ë¡œë§Œ í—ˆìš©
                .queryParam("id", userId)
                .build()
                .toUriString();
    }
}


================================================================================
File Path: .\src\main\java\com\ocean\piuda\security\oauth2\info\OAuth2UserInfo.java
================================================================================

package com.ocean.piuda.security.oauth2.info;

import com.ocean.piuda.security.oauth2.enums.ProviderType;
import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Getter;

import java.util.Map;


/**
 * provider ê°€ ë„˜ê¸´ ì •ë³´ ì €ì¥ìš© í¸ì˜ OAuth2 ê°ì²´. dto.
 */
@Getter
@AllArgsConstructor
@Builder
public class OAuth2UserInfo {

    public final ProviderType providerType; // provider ë²¤ë”ëª…


    // provider ê°€ ë„˜ê¸´ ì „ì²´ ì •ë³´
    private Map<String, Object> attributes;

    // í•´ë‹¹ provider ìƒì˜ ì‹ë³„ì ê°’
    private String providerId;




    /**
     * ì´ì™¸ì˜ ì¶”ê°€ì ìœ¼ë¡œ ë‹¨ì¶• í˜¸ì¶œ ì›í•˜ëŠ” ì •ë³´ì— ëŒ€í•´ í•„ë“œ ì¶”ê°€
     */
    // í•´ë‹¹ provider ìƒì˜ ì‚¬ìš©ìëª…
    private String nickname;
    private String email;







}


================================================================================
File Path: .\src\main\java\com\ocean\piuda\security\oauth2\info\OAuth2UserInfoFactory.java
================================================================================

package com.ocean.piuda.security.oauth2.info;


import com.ocean.piuda.global.api.exception.BusinessException;
import com.ocean.piuda.global.api.exception.ExceptionType;
import com.ocean.piuda.security.oauth2.enums.ProviderType;

import java.util.Map;

public class OAuth2UserInfoFactory {
    public static OAuth2UserInfo getOAuth2UserInfo(ProviderType providerType, Map<String, Object> attributes) {
        switch (providerType) {
            case KAKAO -> {
                // ì¹´ì¹´ì˜¤ì˜ ê²½ìš° attributes ì— ë°”ë¡œ email ê³¼ nickname ì„ ë‹´ì§€ ì•Šê³  account ì™€ profile ë‚´ë¶€ì— ë‹´ê¸°ì— account ì™€ profile ì„ êµ¬í•´ë†”ì•¼ë¨
                Map<String, Object> account = (Map<String, Object>) attributes.getOrDefault("kakao_account", Map.of());
                Map<String, Object> profile = (Map<String, Object>) account.getOrDefault("profile", Map.of());



                return OAuth2UserInfo.builder()
                        .providerType(providerType)
                        .attributes(attributes)
                        .providerId(String.valueOf(attributes.get("id")))
                        .nickname((String) profile.getOrDefault("nickname", ""))
                        .email((String) account.getOrDefault("email", ""))
                        .build();
            }
            case NAVER -> {
                //  naver ì˜ ê²½ìš° ì‘ë‹µ ìì²´ê°€ response ë‚´ë¶€ì— ìˆìŒ
                Map<String, Object> response = (Map<String, Object>) attributes.getOrDefault("response", Map.of());

                return OAuth2UserInfo.builder()
                        .providerType(providerType)
                        .attributes(response)
                        .providerId((String) response.getOrDefault("id", ""))
                        .nickname((String) response.getOrDefault("name", ""))
                        .email((String) response.getOrDefault("email", ""))
                        .build();


            }
            case GOOGLE -> {
                return OAuth2UserInfo.builder()
                        .providerType(providerType)
                        .attributes(attributes)
                        .providerId((String) attributes.get("sub"))
                        .nickname((String) attributes.get("name"))
                        .email((String) attributes.get("email"))
                        .build();
            }
        }
        throw new BusinessException(ExceptionType.INVALID_PROVIDER_TYPE_ERROR);

    }
}


================================================================================
File Path: .\src\main\java\com\ocean\piuda\security\oauth2\principal\PrincipalDetails.java
================================================================================

package com.ocean.piuda.security.oauth2.principal;

import com.ocean.piuda.user.entity.User;
import lombok.Builder;
import lombok.Getter;
import org.springframework.security.core.GrantedAuthority;
import org.springframework.security.core.authority.SimpleGrantedAuthority;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.security.oauth2.core.user.OAuth2User;

import java.util.Collection;
import java.util.List;
import java.util.Map;


/**
 * SecurityContext ì €ì¥ìš© ìì²´ë¡œê·¸ì¸ + oauth2 ê°ì²´
 * jwt ë§Œ ì‚¬ìš©í•œ ìì²´ë¡œê·¸ì¸ ì‹œ UserDetails, Oauth2 ë§Œ ì‚¬ìš©í•œ ë¡œê·¸ì¸ ì‹œ OAuth2User ê°ê° ë§Œ implements í•˜ê³  ì´ë¥¼ seucritycontext ì— ì €ì¥í•´ ì‚¬ìš©í•˜ë©´ ë˜ëŠ”ë°
 * ìì²´ë¡œê·¸ì¸ê³¼ OAuth2 ë¥¼ ë‘˜ ë‹¤ êµ¬í˜„í•œ ê²½ìš° @AuthenticationPrincipal ì„ í†µí•´ ì‰½ê²Œ ë¶ˆëŸ¬ì˜¤ê¸° ìœ„í•´ì„  ë‘˜ ë‹¤ implements í•˜ëŠ”ê²Œ ì¢‹ë‹¤
 */
@Getter
@Builder
public class PrincipalDetails implements OAuth2User, UserDetails {
    private User user;
    private  Map<String, Object> attributes;

    //ì¼ë°˜ ë¡œê·¸ì¸ ìƒì„±ì
    public PrincipalDetails(User user) {
        this.user = user;
    }

    //OAuth ë¡œê·¸ì¸ ìƒì„±ì
    public PrincipalDetails(User user, Map<String, Object> attributes) {
        this.user = user;
        this.attributes = attributes;
    }


    @Override
    public String getName() {
        return user.getId() != null ? user.getId().toString() : "anonymous_name";
    }


    @Override
    public Collection<? extends GrantedAuthority> getAuthorities() {
        return List.of(new SimpleGrantedAuthority(user.getRole().getKey()));
    }

    @Override
    public String getPassword() {
        return user.getPassword();
    }

    @Override
    public String getUsername() {
        return user.getUsername() != null ? user.getUsername()  : "anonymous_username";
    }

    @Override public boolean isAccountNonExpired() { return true; }
    @Override public boolean isAccountNonLocked() { return true; }
    @Override public boolean isCredentialsNonExpired() { return true; }
    @Override public boolean isEnabled() { return true; }



}


================================================================================
File Path: .\src\main\java\com\ocean\piuda\security\oauth2\principal\UserPrincipal.java
================================================================================

package com.ocean.piuda.security.oauth2.principal;


/**
 * SecurityContext ì €ì¥ìš© oauth2 ê°ì²´.
 * PrincipalDetails( ìì²´ë¡œê·¸ì¸ + oauth2 ) ë¡œ í‰ì¹©ë‹ˆë‹¤.
 */
//@Getter
//@AllArgsConstructor
//@Builder
//public class CustomOAuth2User implements OAuth2User {
//    private final User user;
//    private final Map<String, Object> attributes;
//
//
//
//    @Override
//    public String getName() {
//        return user.getProviderId();  // provider ìƒì˜ ì‹ë³„ìë¥¼ ë°˜í™˜í•˜ë„ë¡ ì„¤ì •
//    }
//
//
//    @Override
//    public Collection<? extends GrantedAuthority> getAuthorities() {
//        return List.of(new SimpleGrantedAuthority(user.getRole().getKey()));
//    }
//
//
//
//}


================================================================================
File Path: .\src\main\java\com\ocean\piuda\security\oauth2\service\CustomOAuth2UserService.java
================================================================================

package com.ocean.piuda.security.oauth2.service;




import com.ocean.piuda.user.entity.User;
import com.ocean.piuda.user.repository.UserRepository;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.security.oauth2.client.userinfo.DefaultOAuth2UserService;
import org.springframework.security.oauth2.client.userinfo.OAuth2UserRequest;
import org.springframework.security.oauth2.core.OAuth2AuthenticationException;
import org.springframework.security.oauth2.core.user.OAuth2User;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;
import com.ocean.piuda.security.jwt.enums.Role;
import com.ocean.piuda.security.oauth2.enums.ProviderType;
import com.ocean.piuda.security.oauth2.info.OAuth2UserInfo;
import com.ocean.piuda.security.oauth2.info.OAuth2UserInfoFactory;
import com.ocean.piuda.security.oauth2.principal.PrincipalDetails;

import java.util.Map;
import java.util.Optional;

@Service
@RequiredArgsConstructor
@Slf4j
public class CustomOAuth2UserService extends DefaultOAuth2UserService {

    private final UserRepository userRepository;

    @Override
    @Transactional
    public OAuth2User loadUser(
            OAuth2UserRequest userRequest // OAuth2UserRequest ì—ëŠ” clientRegistration(ì„¤ì • íŒŒì¼ìƒ provider ì¸¡ì˜ í´ë¼ì´ì–¸íŠ¸,ì¦‰ ìš°ë¦¬ì˜ ë“±ë¡ ì •ë³´), accessToken ë‚´ì¥
    ) throws OAuth2AuthenticationException {

        // OAuth2UserRequest ì— ë‚´ì¥ëœ clientRegistration ì¶”ì¶œ
        String registrationId = userRequest.getClientRegistration().getRegistrationId(); // í•´ë‹¹ provider ëª…
        ProviderType providerType = ProviderType.from(registrationId); // ì“°ê¸° í¸í•˜ê²Œ enum í™”


        // OAuth2UserRequest ì— ë‚´ì¥ëœ accesstoken ì„ í™œìš©í•´ provider ë¡œë¶€í„° OAuth2User(ìœ ì € ì •ë³´)ë¥¼ response ë¡œ ë°›ìŒ
        // OAuth2User ì—ëŠ” attributes , authorities ë‚´ì¥
        OAuth2User oAuth2User = super.loadUser(userRequest);

        // OAuth2User ì— ë‚´ì¥ëœ attributes ì¶”ì¶œ
        Map<String, Object> attributes = oAuth2User.getAttributes();


        OAuth2UserInfo oAuth2UserInfo = OAuth2UserInfoFactory.getOAuth2UserInfo(providerType, attributes);

        User user = getOrSaveUser(providerType, oAuth2UserInfo);


        // Security contextì— ì €ì¥í•  ê°ì²´ ìƒì„±
        return PrincipalDetails.builder()
                .user(user)
                .attributes(attributes)
                .build();
    }



    private User getOrSaveUser(ProviderType providerType,  OAuth2UserInfo oAuth2UserInfo) {

        String providerId = oAuth2UserInfo.getProviderId();

        Optional<User> optionalUser = userRepository.findByOAuthInfo(providerType, providerId);

        // dbì— ì €ì¥ ì•ˆëœ. ì¦‰, ì‹ ê·œ oauth2 íšŒì› ê°€ì… ìœ ì €ì´ë©´
        if (optionalUser.isEmpty()) {
            User unregisteredUser = User.builder()
                    .providerType(providerType)
                    .providerId(providerId)
                    .role(Role.NOT_REGISTERED) // NOT_REGISTERED == ìµœì¢… íšŒì›ê°€ì…(2ì°¨)ì„ ë§ˆì¹˜ì§€ ì•Šì€ ìœ ì €
                    .nickname(oAuth2UserInfo.getNickname())
                    .email(oAuth2UserInfo.getEmail())
                    .build();

            return userRepository.save(unregisteredUser);
        }

        return optionalUser.get();

    }
}


================================================================================
File Path: .\src\main\java\com\ocean\piuda\user\controller\UserController.java
================================================================================

package com.ocean.piuda.user.controller;

import com.ocean.piuda.global.api.dto.ApiData;
import com.ocean.piuda.security.jwt.dto.request.UserUpdateRequestDto;
import com.ocean.piuda.security.jwt.service.TokenUserService;
import com.ocean.piuda.user.dto.request.UserSearchRequest;
import com.ocean.piuda.user.dto.response.DetailedUserResponse;
import com.ocean.piuda.user.service.UserAggregateBuilder;
import com.ocean.piuda.user.service.UserCommandService;
import com.ocean.piuda.user.service.UserQueryService;
import io.swagger.v3.oas.annotations.Operation;
import io.swagger.v3.oas.annotations.tags.Tag;
import jakarta.validation.Valid;
import lombok.RequiredArgsConstructor;
import org.springframework.data.domain.Page;
import org.springframework.web.bind.annotation.*;

@RestController
@RequestMapping("/api/user")
@RequiredArgsConstructor
@Tag(name = "ìœ ì € API", description = "ìœ ì € ì •ë³´ ì¡°íšŒ, ê²€ìƒ‰, ìˆ˜ì • ê¸°ëŠ¥")
public class UserController {

    private final UserCommandService userCommandService;
    private final UserQueryService userQueryService;
    private final TokenUserService tokenUserService;
    private final UserAggregateBuilder aggregateBuilder;

    @PatchMapping("/{deviceId}")
    @Operation(summary = "ìœ ì € ì •ë³´ ìˆ˜ì •", description = "íŠ¹ì • ìœ ì €ì˜ ë‹‰ë„¤ì„, ì´ë©”ì¼, ì „í™”ë²ˆí˜¸ ë“± ê¸°ë³¸ ì •ë³´ë¥¼ ìˆ˜ì •í•©ë‹ˆë‹¤.")
    public ApiData<Boolean> patchUser(
            @PathVariable Long userId,
            @io.swagger.v3.oas.annotations.parameters.RequestBody(description = "ìˆ˜ì •í•  ìœ ì € ì •ë³´", required = true)
            @RequestBody @Valid UserUpdateRequestDto req
    ) {
        userCommandService.patch(userId, req);
        return ApiData.ok(true);
    }

    @PostMapping("/search")
    @Operation(summary = "ìœ ì € ê²€ìƒ‰", description = "ë‹‰ë„¤ì„ ë˜ëŠ” usernameì„ ê¸°ì¤€ìœ¼ë¡œ ìœ ì €ë¥¼ ê²€ìƒ‰í•©ë‹ˆë‹¤.")
    public ApiData<Page<DetailedUserResponse>> searchByNicknameOrUsername(
            @io.swagger.v3.oas.annotations.parameters.RequestBody(description = "ê²€ìƒ‰ ìš”ì²­ ì •ë³´", required = true)
            @RequestBody @Valid UserSearchRequest req
    ) {
        return ApiData.ok(userQueryService.searchByNicknameOrUsername(req));
    }

    @GetMapping("/{deviceId}/info")
    @Operation(summary = "ìœ ì € ìƒì„¸ ì¡°íšŒ", description = "id ê¸°ë°˜ìœ¼ë¡œ íŠ¹ì • ìœ ì €ì˜ ìƒì„¸ ì •ë³´ë¥¼ ì¡°íšŒí•©ë‹ˆë‹¤.")
    public ApiData<DetailedUserResponse> getUserById(@PathVariable Long userId) {
        return ApiData.ok(aggregateBuilder.build(userQueryService.getUserById(userId)));
    }

    @GetMapping("/my/info")
    @Operation(summary = "ë‚´ ì •ë³´ ì¡°íšŒ", description = "Access Token ê¸°ë°˜ìœ¼ë¡œ í˜„ì¬ ë¡œê·¸ì¸í•œ ìœ ì €ì˜ ìƒì„¸ ì •ë³´ë¥¼ ì¡°íšŒí•©ë‹ˆë‹¤.")
    public ApiData<DetailedUserResponse> getLoginedUser() {
        return ApiData.ok(aggregateBuilder.build(tokenUserService.getCurrentUser()));
    }


}


================================================================================
File Path: .\src\main\java\com\ocean\piuda\user\dto\request\UserSearchRequest.java
================================================================================

package com.ocean.piuda.user.dto.request;

import lombok.Builder;

@Builder
public record UserSearchRequest(
        String q,
        Integer page,
        Integer size
) {

    public int pageOrDefault() { return page == null ? 0 : Math.max(0, page); }
    public int sizeOrDefault() { return size == null ? 20 : Math.max(1, size); }
    public String qOrEmpty()    { return q == null ? "" : q; }
}


================================================================================
File Path: .\src\main\java\com\ocean\piuda\user\dto\response\DetailedUserResponse.java
================================================================================

package com.ocean.piuda.user.dto.response;

import com.ocean.piuda.user.entity.User;
import lombok.Builder;

@Builder
public record DetailedUserResponse(
        Long id,
        String nickname,
        String email,
        String phone,

// TODO : ë‹¤ë¥¸ë„ë©”ì¸ì—ì„œ ì–»ì€ ê°’ë“¤
        String watchDeviceId   // ì—°ë™ëœ ì›Œì¹˜ ì•”í˜¸í™” ID

) {

    public static DetailedUserResponse fromEntity(
            User u
            // ì¶”ê°€í•œ ë‹¤ë¥¸ ë„ë©”ì¸ í•„ë“œë“¤ì— ëŒ€í•œ íŒŒë¼ë¯¸í„°ë“¤
    ){
        return DetailedUserResponse.builder()
                .id(u.getId())
                .nickname(u.getNickname())
                .email(u.getEmail())
                .phone(u.getPhone())
                // ê·¸ íŒŒë¼ë¯¸í„°ë“¤ ëŒ€í•œ ë¹Œë” íŒ¨í„´
                .watchDeviceId(u.getWatchDeviceId())
                .build();
    }
}


================================================================================
File Path: .\src\main\java\com\ocean\piuda\user\entity\User.java
================================================================================

package com.ocean.piuda.user.entity;

import com.ocean.piuda.global.api.domain.BaseEntity;
import com.ocean.piuda.security.jwt.dto.request.UserUpdateRequestDto;
import com.ocean.piuda.security.jwt.enums.Role;
import com.ocean.piuda.security.oauth2.enums.ProviderType;
import jakarta.persistence.*;
import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Getter;
import lombok.NoArgsConstructor;

@Table(name = "users")
@Entity
@Getter
@NoArgsConstructor @AllArgsConstructor
@Builder
public class User extends BaseEntity {

    @Id @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @Enumerated(EnumType.STRING)
    private ProviderType providerType;

    private String providerId;

    @Column(unique = true)
    private String username;

    @Column
    private String password;

    @Enumerated(EnumType.STRING)
    private Role role;

    // ë¶€ê°€ ì •ë³´
    private String nickname;
    private String email;
    private String phone;

    /**
     * í•œ ìœ ì €ë‹¹ ìµœëŒ€ 1ê°œì˜ ì›Œì¹˜ë§Œ ë“±ë¡ (0ê°œ í—ˆìš©)
     * ì•”í˜¸í™”ëœ deviceId ê¸°ì¤€ìœ¼ë¡œ ê´€ë¦¬
     */
    @Column(name = "watch_device_id", length = 100, unique = true)
    private String watchDeviceId;

    public void updateRole(Role role){
        this.role = role;
    }

    public void update(UserUpdateRequestDto dto) {
        if (dto.getNickname() != null && !dto.getNickname().isBlank()) {
            this.nickname = dto.getNickname();
        }
        if (dto.getEmail() != null && !dto.getEmail().isBlank()) {
            this.email = dto.getEmail();
        }
        if (dto.getPhone() != null && !dto.getPhone().isBlank()) {
            this.phone = dto.getPhone();
        }
    }

    public void pairWatch(String watchDeviceId) {
        this.watchDeviceId = watchDeviceId;
    }

    public void unpairWatch() {
        this.watchDeviceId = null;
    }
}


================================================================================
File Path: .\src\main\java\com\ocean\piuda\user\repository\UserRepository.java
================================================================================

package com.ocean.piuda.user.repository;

import com.ocean.piuda.security.oauth2.enums.ProviderType;
import com.ocean.piuda.user.entity.User;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import org.springframework.stereotype.Repository;

import java.util.Optional;

@Repository
public interface UserRepository extends JpaRepository<User , Long> {
    Optional<User> findByUsername(String username);

    @Query("select u from User u where u.providerType = :providerType and u.providerId = :providerId " )
    Optional<User> findByOAuthInfo(@Param("providerType") ProviderType providerType,
                                   @Param("providerId") String providerId);

    // ì›Œì¹˜ ì•”í˜¸í™” ID ê¸°ì¤€ ì¡°íšŒ
    Optional<User> findByWatchDeviceId(String watchDeviceId);

    @Query("""
           SELECT u FROM User u
           WHERE LOWER(u.nickname) LIKE LOWER(CONCAT('%', :q, '%'))
           """)
    Page<User> searchByNicknameFulltext(@Param("q") String q, Pageable pageable);

    @Query("""
           SELECT u FROM User u
           WHERE LOWER(u.username) LIKE LOWER(CONCAT('%', :q, '%'))
           """)
    Page<User> searchByUsernameFulltext(@Param("q") String q, Pageable pageable);

    @Query("""
           SELECT u FROM User u
           WHERE LOWER(u.nickname) LIKE LOWER(CONCAT('%', :q, '%'))
              OR LOWER(u.username) LIKE LOWER(CONCAT('%', :q, '%'))
           """)
    Page<User> searchByNicknameOrUsernameFulltext(@Param("q") String q, Pageable pageable);
}


================================================================================
File Path: .\src\main\java\com\ocean\piuda\user\service\UserAggregateBuilder.java
================================================================================

package com.ocean.piuda.user.service;

import com.ocean.piuda.user.dto.response.DetailedUserResponse;
import com.ocean.piuda.user.entity.User;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.List;


/**
 * ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ user ì™€ ê´€ë ¨ëœ ì¢…í•©ì ì¸ ì •ë³´
 * í•œë²ˆì— ë°˜í™˜í•˜ê¸° ìœ„í•œ builder.
 * í•´ë‹¹ ìœ ì €ì˜ ì¶•ì•½ëœ ì „ë°˜ì ì¸ ì •ë³´ ë°˜í™˜ì´ ëª©ì .
 */
@RequiredArgsConstructor
@Service
@Transactional(readOnly = true)
public class UserAggregateBuilder {


    public DetailedUserResponse build(User user) {
        // TODO: ë‹¤ë¥¸ ë„ë©”ì¸ ë¦¬íŒŒì§€í† ë¦¬ í™œìš©í•´ í•„ìš”í•œ ì •ë³´ ì–»ê¸°
        return DetailedUserResponse.fromEntity(
                user
                // ì—¬ê¸°ì— ì–»ì€ ì •ë³´ë“¤ ëŒ€ì…
        );
    }
}


================================================================================
File Path: .\src\main\java\com\ocean\piuda\user\service\UserCommandService.java
================================================================================

package com.ocean.piuda.user.service;

import com.ocean.piuda.security.jwt.dto.request.UserUpdateRequestDto;
import com.ocean.piuda.user.entity.User;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

@RequiredArgsConstructor
@Service
@Transactional
public class UserCommandService {
    private final UserQueryService userQueryService;

    public void patch( Long userId, UserUpdateRequestDto req) {
        User user = userQueryService.getUserById(userId);
        user.update(req);
    }











}


================================================================================
File Path: .\src\main\java\com\ocean\piuda\user\service\UserQueryService.java
================================================================================

package com.ocean.piuda.user.service;

import com.ocean.piuda.global.api.exception.BusinessException;
import com.ocean.piuda.global.api.exception.ExceptionType;
import com.ocean.piuda.user.dto.request.UserSearchRequest;
import com.ocean.piuda.user.dto.response.DetailedUserResponse;
import com.ocean.piuda.user.entity.User;
import com.ocean.piuda.user.repository.UserRepository;
import lombok.RequiredArgsConstructor;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.PageRequest;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

@RequiredArgsConstructor
@Service
@Transactional(readOnly = true)
public class UserQueryService {

    private final UserRepository userRepository;
    private final UserAggregateBuilder aggregateBuilder;

    public User getUserById(Long userId){
        return userRepository.findById(userId)
                .orElseThrow(() -> new BusinessException(ExceptionType.USER_NOT_FOUND));
    }

    public Page<DetailedUserResponse> searchByNickname(UserSearchRequest req) {
        String q = normalize(req.qOrEmpty());
        var pageable = PageRequest.of(req.pageOrDefault(), req.sizeOrDefault());
        Page<User> page = userRepository.searchByNicknameFulltext(q, pageable);
        return page.map(aggregateBuilder::build);
    }

    public Page<DetailedUserResponse> searchByUsername(UserSearchRequest req) {
        String q = normalize(req.qOrEmpty());
        var pageable = PageRequest.of(req.pageOrDefault(), req.sizeOrDefault());
        Page<User> page = userRepository.searchByUsernameFulltext(q, pageable);
        return page.map(aggregateBuilder::build);
    }

    public Page<DetailedUserResponse> searchByNicknameOrUsername(UserSearchRequest req) {
        String q = normalize(req.qOrEmpty());
        var pageable = PageRequest.of(req.pageOrDefault(), req.sizeOrDefault());
        Page<User> page = userRepository.searchByNicknameOrUsernameFulltext(q, pageable);
        return page.map(aggregateBuilder::build);
    }

    private String normalize(String q) {
        if (q == null) return "";
        return q.replaceAll("[+\\-><()~\"@]+", " ").trim();
    }
}


================================================================================
File Path: .\src\test\java\com\ocean\piuda\PiudaApplicationTests.java
================================================================================

package com.ocean.piuda;

import org.junit.jupiter.api.Test;
import org.springframework.boot.test.context.SpringBootTest;

@SpringBootTest
class PiudaApplicationTests {

	@Test
	void contextLoads() {
	}

}

